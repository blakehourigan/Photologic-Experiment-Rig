<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 15.0.1"/>
    <title>app_logic API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:.75rem center;margin-bottom:1rem;}.pdoc .alert > em{display:none;}.pdoc .alert > *:last-child{margin-bottom:0;}.pdoc .alert.note {color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .alert.warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .alert.danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .decorator-deprecated{color:#842029;}.pdoc .decorator-deprecated ~ span{filter:grayscale(1) opacity(0.8);}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="index.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;
                Module Index
            </a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="variable" href="#logger">logger</a>
            </li>
            <li>
                    <a class="variable" href="#console_handler">console_handler</a>
            </li>
            <li>
                    <a class="variable" href="#RIG_CONFIG">RIG_CONFIG</a>
            </li>
            <li>
                    <a class="variable" href="#DOOR_MOVE_TIME">DOOR_MOVE_TIME</a>
            </li>
            <li>
                    <a class="variable" href="#now">now</a>
            </li>
            <li>
                    <a class="variable" href="#logfile_name">logfile_name</a>
            </li>
            <li>
                    <a class="variable" href="#logfile_path">logfile_path</a>
            </li>
            <li>
                    <a class="variable" href="#file_handler">file_handler</a>
            </li>
            <li>
                    <a class="class" href="#StateMachine">StateMachine</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#StateMachine.__init__">StateMachine</a>
                        </li>
                        <li>
                                <a class="variable" href="#StateMachine.exp_data">exp_data</a>
                        </li>
                        <li>
                                <a class="variable" href="#StateMachine.arduino_controller">arduino_controller</a>
                        </li>
                        <li>
                                <a class="variable" href="#StateMachine.main_gui">main_gui</a>
                        </li>
                        <li>
                                <a class="variable" href="#StateMachine.state">state</a>
                        </li>
                        <li>
                                <a class="variable" href="#StateMachine.prev_state">prev_state</a>
                        </li>
                        <li>
                                <a class="variable" href="#StateMachine.app_result">app_result</a>
                        </li>
                        <li>
                                <a class="variable" href="#StateMachine.transitions">transitions</a>
                        </li>
                        <li>
                                <a class="function" href="#StateMachine.trigger">trigger</a>
                        </li>
                        <li>
                                <a class="function" href="#StateMachine.execute_state">execute_state</a>
                        </li>
                        <li>
                                <a class="function" href="#StateMachine.process_queue">process_queue</a>
                        </li>
                        <li>
                                <a class="function" href="#StateMachine.reject_actions">reject_actions</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#GenerateSchedule">GenerateSchedule</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#GenerateSchedule.__init__">GenerateSchedule</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#StartProgram">StartProgram</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#StartProgram.__init__">StartProgram</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#StopProgram">StopProgram</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#StopProgram.__init__">StopProgram</a>
                        </li>
                        <li>
                                <a class="function" href="#StopProgram.finalize_program">finalize_program</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#ResetProgram">ResetProgram</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#ResetProgram.__init__">ResetProgram</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#InitialTimeInterval">InitialTimeInterval</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#InitialTimeInterval.__init__">InitialTimeInterval</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#OpeningDoor">OpeningDoor</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#OpeningDoor.__init__">OpeningDoor</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#TimeToContact">TimeToContact</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#TimeToContact.__init__">TimeToContact</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#SampleTime">SampleTime</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#SampleTime.__init__">SampleTime</a>
                        </li>
                        <li>
                                <a class="function" href="#SampleTime.update_ttc_time">update_ttc_time</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#TrialEnd">TrialEnd</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#TrialEnd.__init__">TrialEnd</a>
                        </li>
                        <li>
                                <a class="function" href="#TrialEnd.arduino_trial_end">arduino_trial_end</a>
                        </li>
                        <li>
                                <a class="function" href="#TrialEnd.end_trial">end_trial</a>
                        </li>
                        <li>
                                <a class="function" href="#TrialEnd.update_ttc_actual">update_ttc_actual</a>
                        </li>
                        <li>
                                <a class="function" href="#TrialEnd.update_schedule_licks">update_schedule_licks</a>
                        </li>
                        <li>
                                <a class="function" href="#TrialEnd.update_raster_plots">update_raster_plots</a>
                        </li>
                </ul>

            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
app_logic    </h1>

                        <div class="docstring"><p>'app_logic' is the primary module in the Photologic-Experiment-Rig codebase. It contains the
StateMachine class which holds the logic for each 'state' an experiment can be in.</p>

<p>Before performing any actions, the StateMachine class initializes the instances of <code>models.experiment_process_data</code>,
<code>controllers.arduino_control</code>, and <code>views.main_gui</code> classes.
Launching main_gui initializes a tkinter root and allows for a GUI to be created for the program.</p>

<p>This module is launched from main to make restarting the program easier, which is done by destroying the
instance of state machine and launcing a new one.</p>
</div>

                        <input id="mod-app_logic-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-app_logic-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">  1</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">  2</span></a><span class="sd">&#39;app_logic&#39; is the primary module in the Photologic-Experiment-Rig codebase. It contains the</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">  3</span></a><span class="sd">StateMachine class which holds the logic for each &#39;state&#39; an experiment can be in.</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">  4</span></a>
</span><span id="L-5"><a href="#L-5"><span class="linenos">  5</span></a><span class="sd">Before performing any actions, the StateMachine class initializes the instances of `models.experiment_process_data`,</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">  6</span></a><span class="sd">`controllers.arduino_control`, and `views.main_gui` classes.</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">  7</span></a><span class="sd">Launching main_gui initializes a tkinter root and allows for a GUI to be created for the program.</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">  8</span></a>
</span><span id="L-9"><a href="#L-9"><span class="linenos">  9</span></a><span class="sd">This module is launched from main to make restarting the program easier, which is done by destroying the</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos"> 10</span></a><span class="sd">instance of state machine and launcing a new one.</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos"> 11</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos"> 12</span></a>
</span><span id="L-13"><a href="#L-13"><span class="linenos"> 13</span></a><span class="c1"># external imports</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos"> 14</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos"> 15</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">threading</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos"> 16</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos"> 17</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">toml</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos"> 18</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">queue</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos"> 19</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Callable</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos"> 20</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos"> 21</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">logging</span><span class="w"> </span><span class="kn">import</span> <span class="n">FileHandler</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos"> 22</span></a>
</span><span id="L-23"><a href="#L-23"><span class="linenos"> 23</span></a><span class="c1"># imports for locally used modules and classes</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos"> 24</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">models.experiment_process_data</span><span class="w"> </span><span class="kn">import</span> <span class="n">ExperimentProcessData</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos"> 25</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">views.gui_common</span><span class="w"> </span><span class="kn">import</span> <span class="n">GUIUtils</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos"> 26</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">system_config</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos"> 27</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">views.main_gui</span><span class="w"> </span><span class="kn">import</span> <span class="n">MainGUI</span>
</span><span id="L-28"><a href="#L-28"><span class="linenos"> 28</span></a>
</span><span id="L-29"><a href="#L-29"><span class="linenos"> 29</span></a><span class="c1"># these are just use for type hinting here</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos"> 30</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">controllers.arduino_control</span><span class="w"> </span><span class="kn">import</span> <span class="n">ArduinoManager</span>
</span><span id="L-31"><a href="#L-31"><span class="linenos"> 31</span></a>
</span><span id="L-32"><a href="#L-32"><span class="linenos"> 32</span></a><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos"> 33</span></a><span class="sd">&quot;&quot;&quot;Logger used to log program runtime details for debugging&quot;&quot;&quot;</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos"> 34</span></a><span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos"> 35</span></a>
</span><span id="L-36"><a href="#L-36"><span class="linenos"> 36</span></a><span class="n">console_handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos"> 37</span></a><span class="sd">&quot;&quot;&quot;The console handler is used to print errors to the console&quot;&quot;&quot;</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos"> 38</span></a><span class="n">console_handler</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos"> 39</span></a><span class="n">console_handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos"> 40</span></a>    <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%(asctime)s</span><span class="s2"> - </span><span class="si">%(levelname)s</span><span class="s2"> - </span><span class="si">%(message)s</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos"> 41</span></a><span class="p">)</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos"> 42</span></a><span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">console_handler</span><span class="p">)</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos"> 43</span></a>
</span><span id="L-44"><a href="#L-44"><span class="linenos"> 44</span></a><span class="n">RIG_CONFIG</span> <span class="o">=</span> <span class="n">system_config</span><span class="o">.</span><span class="n">get_rig_config</span><span class="p">()</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos"> 45</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos"> 46</span></a><span class="sd">This utilizes `system_config` module to obtain a constant path for this machine regardless of OS to the Rig Files foler </span>
</span><span id="L-47"><a href="#L-47"><span class="linenos"> 47</span></a><span class="sd">at the current users documents folder.</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos"> 48</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos"> 49</span></a>
</span><span id="L-50"><a href="#L-50"><span class="linenos"> 50</span></a><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">RIG_CONFIG</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos"> 51</span></a>    <span class="n">DOOR_CONFIG</span> <span class="o">=</span> <span class="n">toml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)[</span><span class="s2">&quot;door_motor_config&quot;</span><span class="p">]</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos"> 52</span></a>
</span><span id="L-53"><a href="#L-53"><span class="linenos"> 53</span></a><span class="n">DOOR_MOVE_TIME</span> <span class="o">=</span> <span class="n">DOOR_CONFIG</span><span class="p">[</span><span class="s2">&quot;DOOR_MOVE_TIME&quot;</span><span class="p">]</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos"> 54</span></a><span class="sd">&quot;&quot;&quot;Constant value stored in the door_motor_config section of `RIG CONFIG` config&quot;&quot;&quot;</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos"> 55</span></a>
</span><span id="L-56"><a href="#L-56"><span class="linenos"> 56</span></a>
</span><span id="L-57"><a href="#L-57"><span class="linenos"> 57</span></a><span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos"> 58</span></a><span class="c1"># configure logfile details such as name and the level at which information should be added to the log (INFO here)</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos"> 59</span></a><span class="n">logfile_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">now</span><span class="o">.</span><span class="n">hour</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">now</span><span class="o">.</span><span class="n">minute</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">now</span><span class="o">.</span><span class="n">second</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">now</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="si">}</span><span class="s2"> experiment log&quot;</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos"> 60</span></a><span class="n">logfile_path</span> <span class="o">=</span> <span class="n">system_config</span><span class="o">.</span><span class="n">get_log_path</span><span class="p">(</span><span class="n">logfile_name</span><span class="p">)</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos"> 61</span></a>
</span><span id="L-62"><a href="#L-62"><span class="linenos"> 62</span></a><span class="n">file_handler</span> <span class="o">=</span> <span class="n">FileHandler</span><span class="p">(</span><span class="n">logfile_path</span><span class="p">)</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos"> 63</span></a><span class="n">file_handler</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos"> 64</span></a><span class="n">file_handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos"> 65</span></a>    <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%(asctime)s</span><span class="s2"> - </span><span class="si">%(levelname)s</span><span class="s2"> - </span><span class="si">%(message)s</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos"> 66</span></a><span class="p">)</span>
</span><span id="L-67"><a href="#L-67"><span class="linenos"> 67</span></a><span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">file_handler</span><span class="p">)</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos"> 68</span></a>
</span><span id="L-69"><a href="#L-69"><span class="linenos"> 69</span></a>
</span><span id="L-70"><a href="#L-70"><span class="linenos"> 70</span></a><span class="k">class</span><span class="w"> </span><span class="nc">StateMachine</span><span class="p">:</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos"> 71</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos"> 72</span></a><span class="sd">    This class is the heart of the program. Defines and handles program state transitions.</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos"> 73</span></a><span class="sd">    It coordinates co-operation between view (gui) and models (data). We inherit a TkinterApp class to include</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos"> 74</span></a><span class="sd">    attributes of a tkinter app such as gui, arduino controller, etc.</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos"> 75</span></a>
</span><span id="L-76"><a href="#L-76"><span class="linenos"> 76</span></a><span class="sd">    Attributes</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos"> 77</span></a><span class="sd">    ----------</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos"> 78</span></a><span class="sd">    - **exp_data** (*ExperimentProcessData*): An instance of `models.experiment_process_data` ExperimentProcessData, this attribute allows for access and</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos"> 79</span></a><span class="sd">    modification of experiment variables, and access for to more specific models like `models.event_data` and `models.arduino_data`.</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos"> 80</span></a><span class="sd">    - **arduino_controller** (*ArduinoManager*): An instance of `controllers.arduino_control` ArduinoManager, this allows for communication between this program and the</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos"> 81</span></a><span class="sd">    Arduino board.</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos"> 82</span></a><span class="sd">    - **main_gui** (*MainGUI*): An instance of `views.main_gui` MainGUI, this allows for the creation and modification of all GUI attributes in the program. All GUI windows</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos"> 83</span></a><span class="sd">    are created and managed here.</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos"> 84</span></a><span class="sd">    - **state** (*str*): Contains the current state the program is in.</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos"> 85</span></a><span class="sd">    - **prev_state** (*str*): Contains the state the program was previously in. Useful to restore state in case of erroneous transitions.</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos"> 86</span></a><span class="sd">    - **app_result** (*list*): Mutable list with one element. Is a reference to list defined in `main`.</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos"> 87</span></a><span class="sd">    - **transitions**  (*dict*): Program state transition table.</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos"> 88</span></a>
</span><span id="L-89"><a href="#L-89"><span class="linenos"> 89</span></a><span class="sd">    Methods</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos"> 90</span></a><span class="sd">    -------</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos"> 91</span></a><span class="sd">    - `trigger`(event)</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos"> 92</span></a><span class="sd">        Handles state transition events. Decides if a transition is valid and warns user of destructive transitions. If valid,</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos"> 93</span></a><span class="sd">        passes state to `execute_state` method.</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos"> 94</span></a><span class="sd">    - `execute_state`(new_state: str)</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos"> 95</span></a><span class="sd">        Takes the state passed from trigger event and decides appropriate action.</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos"> 96</span></a><span class="sd">    - `process_queue`(data_queue)</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos"> 97</span></a><span class="sd">        Processes incoming data from the Arduino board. Reads from queue that is added to by `controllers.arduino_control` module</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos"> 98</span></a><span class="sd">        `listen_for_serial` method.</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos"> 99</span></a><span class="sd">    - `reject_actions`(event)</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos">100</span></a><span class="sd">        A static method that handles the rejection of actions that cannot be performed given a certain state transition.</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos">101</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos">102</span></a>
</span><span id="L-103"><a href="#L-103"><span class="linenos">103</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result_container</span><span class="p">):</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos">104</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;init method for `StateMachine`. Takes `main` module `result_container`.</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos">105</span></a><span class="sd">        the &#39;super&#39; parent class which is the gui&quot;&quot;&quot;</span>
</span><span id="L-106"><a href="#L-106"><span class="linenos">106</span></a>
</span><span id="L-107"><a href="#L-107"><span class="linenos">107</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">exp_data</span> <span class="o">=</span> <span class="n">ExperimentProcessData</span><span class="p">()</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos">108</span></a>
</span><span id="L-109"><a href="#L-109"><span class="linenos">109</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">arduino_controller</span> <span class="o">=</span> <span class="n">ArduinoManager</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exp_data</span><span class="p">)</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos">110</span></a>
</span><span id="L-111"><a href="#L-111"><span class="linenos">111</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">main_gui</span> <span class="o">=</span> <span class="n">MainGUI</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exp_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">arduino_controller</span><span class="p">)</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos">112</span></a>        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;GUI started successfully.&quot;</span><span class="p">)</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos">113</span></a>
</span><span id="L-114"><a href="#L-114"><span class="linenos">114</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="s2">&quot;IDLE&quot;</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos">115</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Default state for program is set at IDLE&quot;&quot;&quot;</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos">116</span></a>
</span><span id="L-117"><a href="#L-117"><span class="linenos">117</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">prev_state</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos">118</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Default previous state for program is set to None. Utilized in `trigger`.&quot;&quot;&quot;</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos">119</span></a>
</span><span id="L-120"><a href="#L-120"><span class="linenos">120</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">app_result</span> <span class="o">=</span> <span class="n">result_container</span>
</span><span id="L-121"><a href="#L-121"><span class="linenos">121</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos">122</span></a><span class="sd">        Here we store a reference to `main` module `result_container` to store decision of whether to restart the </span>
</span><span id="L-123"><a href="#L-123"><span class="linenos">123</span></a><span class="sd">        program or just terminate the current instance.</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos">124</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos">125</span></a>
</span><span id="L-126"><a href="#L-126"><span class="linenos">126</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">transitions</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos">127</span></a>            <span class="p">(</span><span class="s2">&quot;IDLE&quot;</span><span class="p">,</span> <span class="s2">&quot;GENERATE SCHEDULE&quot;</span><span class="p">):</span> <span class="s2">&quot;GENERATE SCHEDULE&quot;</span><span class="p">,</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos">128</span></a>            <span class="p">(</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos">129</span></a>                <span class="s2">&quot;GENERATE SCHEDULE&quot;</span><span class="p">,</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos">130</span></a>                <span class="s2">&quot;IDLE&quot;</span><span class="p">,</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos">131</span></a>            <span class="p">):</span> <span class="s2">&quot;IDLE&quot;</span><span class="p">,</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos">132</span></a>            <span class="p">(</span><span class="s2">&quot;IDLE&quot;</span><span class="p">,</span> <span class="s2">&quot;START&quot;</span><span class="p">):</span> <span class="s2">&quot;START PROGRAM&quot;</span><span class="p">,</span>
</span><span id="L-133"><a href="#L-133"><span class="linenos">133</span></a>            <span class="p">(</span><span class="s2">&quot;IDLE&quot;</span><span class="p">,</span> <span class="s2">&quot;RESET&quot;</span><span class="p">):</span> <span class="s2">&quot;RESET PROGRAM&quot;</span><span class="p">,</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos">134</span></a>            <span class="p">(</span><span class="s2">&quot;STOP PROGRAM&quot;</span><span class="p">,</span> <span class="s2">&quot;RESET&quot;</span><span class="p">):</span> <span class="s2">&quot;RESET PROGRAM&quot;</span><span class="p">,</span>
</span><span id="L-135"><a href="#L-135"><span class="linenos">135</span></a>            <span class="p">(</span><span class="s2">&quot;START PROGRAM&quot;</span><span class="p">,</span> <span class="s2">&quot;ITI&quot;</span><span class="p">):</span> <span class="s2">&quot;ITI&quot;</span><span class="p">,</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos">136</span></a>            <span class="p">(</span><span class="s2">&quot;ITI&quot;</span><span class="p">,</span> <span class="s2">&quot;DOOR OPEN&quot;</span><span class="p">):</span> <span class="s2">&quot;OPENING DOOR&quot;</span><span class="p">,</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos">137</span></a>            <span class="p">(</span><span class="s2">&quot;OPENING DOOR&quot;</span><span class="p">,</span> <span class="s2">&quot;TTC&quot;</span><span class="p">):</span> <span class="s2">&quot;TTC&quot;</span><span class="p">,</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos">138</span></a>            <span class="p">(</span><span class="s2">&quot;TTC&quot;</span><span class="p">,</span> <span class="s2">&quot;SAMPLE&quot;</span><span class="p">):</span> <span class="s2">&quot;SAMPLE&quot;</span><span class="p">,</span>  <span class="c1"># -&gt; if rat engages in trial</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos">139</span></a>            <span class="p">(</span><span class="s2">&quot;TTC&quot;</span><span class="p">,</span> <span class="s2">&quot;TRIAL END&quot;</span><span class="p">):</span> <span class="s2">&quot;TRIAL END&quot;</span><span class="p">,</span>  <span class="c1"># -&gt; if rat does NOT engage</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos">140</span></a>            <span class="p">(</span><span class="s2">&quot;SAMPLE&quot;</span><span class="p">,</span> <span class="s2">&quot;TRIAL END&quot;</span><span class="p">):</span> <span class="s2">&quot;TRIAL END&quot;</span><span class="p">,</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos">141</span></a>            <span class="p">(</span><span class="s2">&quot;TRIAL END&quot;</span><span class="p">,</span> <span class="s2">&quot;ITI&quot;</span><span class="p">):</span> <span class="s2">&quot;ITI&quot;</span><span class="p">,</span>  <span class="c1"># -&gt; save trial data, update gui, door up</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos">142</span></a>            <span class="p">(</span><span class="s2">&quot;ITI&quot;</span><span class="p">,</span> <span class="s2">&quot;STOP&quot;</span><span class="p">):</span> <span class="s2">&quot;STOP PROGRAM&quot;</span><span class="p">,</span>  <span class="c1"># can move to &#39;stop&#39; state in all states</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos">143</span></a>            <span class="p">(</span><span class="s2">&quot;OPENING DOOR&quot;</span><span class="p">,</span> <span class="s2">&quot;STOP&quot;</span><span class="p">):</span> <span class="s2">&quot;STOP PROGRAM&quot;</span><span class="p">,</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos">144</span></a>            <span class="p">(</span><span class="s2">&quot;TTC&quot;</span><span class="p">,</span> <span class="s2">&quot;STOP&quot;</span><span class="p">):</span> <span class="s2">&quot;STOP PROGRAM&quot;</span><span class="p">,</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos">145</span></a>            <span class="p">(</span><span class="s2">&quot;SAMPLE&quot;</span><span class="p">,</span> <span class="s2">&quot;STOP&quot;</span><span class="p">):</span> <span class="s2">&quot;STOP PROGRAM&quot;</span><span class="p">,</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos">146</span></a>            <span class="p">(</span><span class="s2">&quot;TRIAL END&quot;</span><span class="p">,</span> <span class="s2">&quot;STOP&quot;</span><span class="p">):</span> <span class="s2">&quot;STOP PROGRAM&quot;</span><span class="p">,</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos">147</span></a>        <span class="p">}</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos">148</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;State transition table defines all transitions that the program can possibly take&quot;&quot;&quot;</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos">149</span></a>
</span><span id="L-150"><a href="#L-150"><span class="linenos">150</span></a>        <span class="c1"># don&#39;t start the mainloop until AFTER the gui is setup so that the app_result property</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos">151</span></a>        <span class="c1"># is available if reset is desired</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos">152</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">main_gui</span><span class="o">.</span><span class="n">mainloop</span><span class="p">()</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos">153</span></a>
</span><span id="L-154"><a href="#L-154"><span class="linenos">154</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">trigger</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos">155</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos">156</span></a><span class="sd">        This function takes a requested state and decides if the transition from this state is allowed.</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos">157</span></a>
</span><span id="L-158"><a href="#L-158"><span class="linenos">158</span></a><span class="sd">        Parameters</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos">159</span></a><span class="sd">        ----------</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos">160</span></a><span class="sd">        - **event** (*str*): Contains the desired state to move to.</span>
</span><span id="L-161"><a href="#L-161"><span class="linenos">161</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos">162</span></a>
</span><span id="L-163"><a href="#L-163"><span class="linenos">163</span></a>        <span class="n">transition</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="n">event</span><span class="p">)</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos">164</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">prev_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos">165</span></a>        <span class="n">new_state</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos">166</span></a>
</span><span id="L-167"><a href="#L-167"><span class="linenos">167</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;state transition -&gt; </span><span class="si">{</span><span class="n">transition</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-168"><a href="#L-168"><span class="linenos">168</span></a>
</span><span id="L-169"><a href="#L-169"><span class="linenos">169</span></a>        <span class="c1"># checking if the attemped transition is valid according to the table</span>
</span><span id="L-170"><a href="#L-170"><span class="linenos">170</span></a>        <span class="k">if</span> <span class="n">transition</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">transitions</span><span class="p">:</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos">171</span></a>            <span class="n">new_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transitions</span><span class="p">[</span><span class="n">transition</span><span class="p">]</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos">172</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-173"><a href="#L-173"><span class="linenos">173</span></a>            <span class="c1"># if the key is not in the transition table, handle rejection based on desired state</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos">174</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">reject_actions</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
</span><span id="L-175"><a href="#L-175"><span class="linenos">175</span></a>
</span><span id="L-176"><a href="#L-176"><span class="linenos">176</span></a>        <span class="c1"># if the key was in the transition table, and the new state wants to reset the program, that means this is a valid action at this time. MAKE SURE the</span>
</span><span id="L-177"><a href="#L-177"><span class="linenos">177</span></a>        <span class="c1"># user REALLY wants to do that</span>
</span><span id="L-178"><a href="#L-178"><span class="linenos">178</span></a>        <span class="k">if</span> <span class="n">new_state</span> <span class="o">==</span> <span class="s2">&quot;RESET PROGRAM&quot;</span><span class="p">:</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos">179</span></a>            <span class="n">response</span> <span class="o">=</span> <span class="n">GUIUtils</span><span class="o">.</span><span class="n">askyesno</span><span class="p">(</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos">180</span></a>                <span class="s2">&quot;============WARNING============&quot;</span><span class="p">,</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos">181</span></a>                <span class="s2">&quot;THIS ACTION WILL ERASE ALL DATA CURRENTLY STORED FOR THIS EXPERIMENT... ARE YOU SURE YOU WANT TO CONTINUE?&quot;</span><span class="p">,</span>
</span><span id="L-182"><a href="#L-182"><span class="linenos">182</span></a>            <span class="p">)</span>
</span><span id="L-183"><a href="#L-183"><span class="linenos">183</span></a>            <span class="c1"># if true, go ahead with the reset, if false return to prev_state</span>
</span><span id="L-184"><a href="#L-184"><span class="linenos">184</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="p">:</span>
</span><span id="L-185"><a href="#L-185"><span class="linenos">185</span></a>                <span class="n">new_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_state</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos">186</span></a>
</span><span id="L-187"><a href="#L-187"><span class="linenos">187</span></a>        <span class="c1"># if attempt to start program with no experiment schedule, tell user to do that</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos">188</span></a>        <span class="k">if</span> <span class="n">new_state</span> <span class="o">==</span> <span class="s2">&quot;START PROGRAM&quot;</span><span class="p">:</span>
</span><span id="L-189"><a href="#L-189"><span class="linenos">189</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_data</span><span class="o">.</span><span class="n">program_schedule_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos">190</span></a>                <span class="n">GUIUtils</span><span class="o">.</span><span class="n">display_error</span><span class="p">(</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos">191</span></a>                    <span class="s2">&quot;Experiement Schedule Not Yet Generated!!!&quot;</span><span class="p">,</span>
</span><span id="L-192"><a href="#L-192"><span class="linenos">192</span></a>                    <span class="s2">&quot;Please generate the program schedule before attempting to start the experiment. You can do this by clicking the &#39;Valve / Stimuli&#39; button in the main screen.&quot;</span><span class="p">,</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos">193</span></a>                <span class="p">)</span>
</span><span id="L-194"><a href="#L-194"><span class="linenos">194</span></a>                <span class="n">new_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_state</span>
</span><span id="L-195"><a href="#L-195"><span class="linenos">195</span></a>
</span><span id="L-196"><a href="#L-196"><span class="linenos">196</span></a>        <span class="c1"># if we have a new state, perform the associated action for that state</span>
</span><span id="L-197"><a href="#L-197"><span class="linenos">197</span></a>        <span class="k">if</span> <span class="n">new_state</span><span class="p">:</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos">198</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;new state -&gt; </span><span class="si">{</span><span class="n">new_state</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos">199</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">execute_state</span><span class="p">(</span><span class="n">new_state</span><span class="p">)</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos">200</span></a>
</span><span id="L-201"><a href="#L-201"><span class="linenos">201</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">execute_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_state</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-202"><a href="#L-202"><span class="linenos">202</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos">203</span></a><span class="sd">        Executes the action corresponding to new_state. if the action is defined under state_target,</span>
</span><span id="L-204"><a href="#L-204"><span class="linenos">204</span></a><span class="sd">        that action will be taken in a new thread to avoid overloading the main tkinter thread. otherwise</span>
</span><span id="L-205"><a href="#L-205"><span class="linenos">205</span></a><span class="sd">        it is executed immediately in the main thread.</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos">206</span></a>
</span><span id="L-207"><a href="#L-207"><span class="linenos">207</span></a><span class="sd">        Parameters</span>
</span><span id="L-208"><a href="#L-208"><span class="linenos">208</span></a><span class="sd">        ----------</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos">209</span></a><span class="sd">        - **new_state** (*str*): Contains the desired state to move to. Used to locate the desired action.</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos">210</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos">211</span></a>
</span><span id="L-212"><a href="#L-212"><span class="linenos">212</span></a>        <span class="n">thread_target</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos">213</span></a>
</span><span id="L-214"><a href="#L-214"><span class="linenos">214</span></a>        <span class="k">match</span> <span class="n">new_state</span><span class="p">:</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos">215</span></a>            <span class="k">case</span> <span class="s2">&quot;START PROGRAM&quot;</span><span class="p">:</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos">216</span></a>
</span><span id="L-217"><a href="#L-217"><span class="linenos">217</span></a>                <span class="k">def</span><span class="w"> </span><span class="nf">thread_target</span><span class="p">():</span>
</span><span id="L-218"><a href="#L-218"><span class="linenos">218</span></a>                    <span class="n">StartProgram</span><span class="p">(</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos">219</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">exp_data</span><span class="p">,</span>
</span><span id="L-220"><a href="#L-220"><span class="linenos">220</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">main_gui</span><span class="p">,</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos">221</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">arduino_controller</span><span class="p">,</span>
</span><span id="L-222"><a href="#L-222"><span class="linenos">222</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">,</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos">223</span></a>                    <span class="p">)</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos">224</span></a>            <span class="k">case</span> <span class="s2">&quot;RESET PROGRAM&quot;</span><span class="p">:</span>
</span><span id="L-225"><a href="#L-225"><span class="linenos">225</span></a>                <span class="n">ResetProgram</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">main_gui</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">app_result</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">arduino_controller</span><span class="p">)</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos">226</span></a>            <span class="k">case</span> <span class="s2">&quot;STOP PROGRAM&quot;</span><span class="p">:</span>
</span><span id="L-227"><a href="#L-227"><span class="linenos">227</span></a>                <span class="n">StopProgram</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">main_gui</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">arduino_controller</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">)</span>
</span><span id="L-228"><a href="#L-228"><span class="linenos">228</span></a>            <span class="k">case</span> <span class="s2">&quot;GENERATE SCHEDULE&quot;</span><span class="p">:</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos">229</span></a>                <span class="c1"># because this will run in main thread, we need to return early to avoid self.state</span>
</span><span id="L-230"><a href="#L-230"><span class="linenos">230</span></a>                <span class="c1"># assignment confusion</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos">231</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">new_state</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos">232</span></a>                <span class="n">GenerateSchedule</span><span class="p">(</span>
</span><span id="L-233"><a href="#L-233"><span class="linenos">233</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">main_gui</span><span class="p">,</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos">234</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">arduino_controller</span><span class="p">,</span>
</span><span id="L-235"><a href="#L-235"><span class="linenos">235</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">process_queue</span><span class="p">,</span>
</span><span id="L-236"><a href="#L-236"><span class="linenos">236</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">,</span>
</span><span id="L-237"><a href="#L-237"><span class="linenos">237</span></a>                <span class="p">)</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos">238</span></a>                <span class="k">return</span>
</span><span id="L-239"><a href="#L-239"><span class="linenos">239</span></a>            <span class="k">case</span> <span class="s2">&quot;ITI&quot;</span><span class="p">:</span>
</span><span id="L-240"><a href="#L-240"><span class="linenos">240</span></a>
</span><span id="L-241"><a href="#L-241"><span class="linenos">241</span></a>                <span class="k">def</span><span class="w"> </span><span class="nf">thread_target</span><span class="p">():</span>
</span><span id="L-242"><a href="#L-242"><span class="linenos">242</span></a>                    <span class="n">InitialTimeInterval</span><span class="p">(</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos">243</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">exp_data</span><span class="p">,</span>
</span><span id="L-244"><a href="#L-244"><span class="linenos">244</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">main_gui</span><span class="p">,</span>
</span><span id="L-245"><a href="#L-245"><span class="linenos">245</span></a>                        <span class="n">new_state</span><span class="p">,</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos">246</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">,</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos">247</span></a>                    <span class="p">)</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos">248</span></a>            <span class="k">case</span> <span class="s2">&quot;OPENING DOOR&quot;</span><span class="p">:</span>
</span><span id="L-249"><a href="#L-249"><span class="linenos">249</span></a>
</span><span id="L-250"><a href="#L-250"><span class="linenos">250</span></a>                <span class="k">def</span><span class="w"> </span><span class="nf">thread_target</span><span class="p">():</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos">251</span></a>                    <span class="n">OpeningDoor</span><span class="p">(</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos">252</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">exp_data</span><span class="p">,</span>
</span><span id="L-253"><a href="#L-253"><span class="linenos">253</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">main_gui</span><span class="p">,</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos">254</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">arduino_controller</span><span class="p">,</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos">255</span></a>                        <span class="n">new_state</span><span class="p">,</span>
</span><span id="L-256"><a href="#L-256"><span class="linenos">256</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">,</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos">257</span></a>                    <span class="p">)</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos">258</span></a>            <span class="k">case</span> <span class="s2">&quot;TTC&quot;</span><span class="p">:</span>
</span><span id="L-259"><a href="#L-259"><span class="linenos">259</span></a>
</span><span id="L-260"><a href="#L-260"><span class="linenos">260</span></a>                <span class="k">def</span><span class="w"> </span><span class="nf">thread_target</span><span class="p">():</span>
</span><span id="L-261"><a href="#L-261"><span class="linenos">261</span></a>                    <span class="n">TimeToContact</span><span class="p">(</span>
</span><span id="L-262"><a href="#L-262"><span class="linenos">262</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">exp_data</span><span class="p">,</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos">263</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">arduino_controller</span><span class="p">,</span>
</span><span id="L-264"><a href="#L-264"><span class="linenos">264</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">main_gui</span><span class="p">,</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos">265</span></a>                        <span class="n">new_state</span><span class="p">,</span>
</span><span id="L-266"><a href="#L-266"><span class="linenos">266</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">,</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos">267</span></a>                    <span class="p">)</span>
</span><span id="L-268"><a href="#L-268"><span class="linenos">268</span></a>            <span class="k">case</span> <span class="s2">&quot;SAMPLE&quot;</span><span class="p">:</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos">269</span></a>
</span><span id="L-270"><a href="#L-270"><span class="linenos">270</span></a>                <span class="k">def</span><span class="w"> </span><span class="nf">thread_target</span><span class="p">():</span>
</span><span id="L-271"><a href="#L-271"><span class="linenos">271</span></a>                    <span class="n">SampleTime</span><span class="p">(</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos">272</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">exp_data</span><span class="p">,</span>
</span><span id="L-273"><a href="#L-273"><span class="linenos">273</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">main_gui</span><span class="p">,</span>
</span><span id="L-274"><a href="#L-274"><span class="linenos">274</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">arduino_controller</span><span class="p">,</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos">275</span></a>                        <span class="n">new_state</span><span class="p">,</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos">276</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">,</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos">277</span></a>                    <span class="p">)</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos">278</span></a>            <span class="k">case</span> <span class="s2">&quot;TRIAL END&quot;</span><span class="p">:</span>
</span><span id="L-279"><a href="#L-279"><span class="linenos">279</span></a>
</span><span id="L-280"><a href="#L-280"><span class="linenos">280</span></a>                <span class="k">def</span><span class="w"> </span><span class="nf">thread_target</span><span class="p">():</span>
</span><span id="L-281"><a href="#L-281"><span class="linenos">281</span></a>                    <span class="n">TrialEnd</span><span class="p">(</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos">282</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">exp_data</span><span class="p">,</span>
</span><span id="L-283"><a href="#L-283"><span class="linenos">283</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">main_gui</span><span class="p">,</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos">284</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">arduino_controller</span><span class="p">,</span>
</span><span id="L-285"><a href="#L-285"><span class="linenos">285</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">prev_state</span><span class="p">,</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos">286</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">,</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos">287</span></a>                    <span class="p">)</span>
</span><span id="L-288"><a href="#L-288"><span class="linenos">288</span></a>
</span><span id="L-289"><a href="#L-289"><span class="linenos">289</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">prev_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos">290</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">new_state</span>
</span><span id="L-291"><a href="#L-291"><span class="linenos">291</span></a>
</span><span id="L-292"><a href="#L-292"><span class="linenos">292</span></a>        <span class="k">if</span> <span class="n">thread_target</span><span class="p">:</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos">293</span></a>            <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">thread_target</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span><span id="L-294"><a href="#L-294"><span class="linenos">294</span></a>
</span><span id="L-295"><a href="#L-295"><span class="linenos">295</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">process_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_queue</span><span class="p">:</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-296"><a href="#L-296"><span class="linenos">296</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos">297</span></a><span class="sd">        Process the data queue. Pulls in data from the thread that is reading data from the arduinos constantly. if there is anything</span>
</span><span id="L-298"><a href="#L-298"><span class="linenos">298</span></a><span class="sd">        in the queue at time of function call, we will stay here until its all been dealt with.</span>
</span><span id="L-299"><a href="#L-299"><span class="linenos">299</span></a>
</span><span id="L-300"><a href="#L-300"><span class="linenos">300</span></a><span class="sd">        Parameters</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos">301</span></a><span class="sd">        ----------</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos">302</span></a><span class="sd">        - **data_queue** (*tuple[str, str]*): This is a shared queue between a thread initiated in the `controllers.arduino_control` module&#39;s</span>
</span><span id="L-303"><a href="#L-303"><span class="linenos">303</span></a><span class="sd">        `listen_for_serial` method. That thread constantly reads info from Arduino so it is not missed, and the main thread calls this process method</span>
</span><span id="L-304"><a href="#L-304"><span class="linenos">304</span></a><span class="sd">        to process accumulated data to avoid overloading the thread.</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos">305</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos">306</span></a>
</span><span id="L-307"><a href="#L-307"><span class="linenos">307</span></a>        <span class="n">arduino_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_data</span><span class="o">.</span><span class="n">arduino_data</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos">308</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-309"><a href="#L-309"><span class="linenos">309</span></a>            <span class="k">while</span> <span class="ow">not</span> <span class="n">data_queue</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
</span><span id="L-310"><a href="#L-310"><span class="linenos">310</span></a>                <span class="n">source</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">data_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos">311</span></a>                <span class="n">arduino_data</span><span class="o">.</span><span class="n">process_data</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">)</span>
</span><span id="L-312"><a href="#L-312"><span class="linenos">312</span></a>
</span><span id="L-313"><a href="#L-313"><span class="linenos">313</span></a>            <span class="c1"># run this command every 250ms</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos">314</span></a>            <span class="n">queue_ps_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">main_gui</span><span class="o">.</span><span class="n">after</span><span class="p">(</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos">315</span></a>                <span class="mi">250</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_queue</span><span class="p">(</span><span class="n">data_queue</span><span class="p">)</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos">316</span></a>            <span class="p">)</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos">317</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">main_gui</span><span class="o">.</span><span class="n">scheduled_tasks</span><span class="p">[</span><span class="s2">&quot;PROCESS QUEUE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">queue_ps_id</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos">318</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos">319</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing data queue: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-320"><a href="#L-320"><span class="linenos">320</span></a>            <span class="k">raise</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos">321</span></a>
</span><span id="L-322"><a href="#L-322"><span class="linenos">322</span></a>    <span class="nd">@staticmethod</span>
</span><span id="L-323"><a href="#L-323"><span class="linenos">323</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">reject_actions</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos">324</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos">325</span></a><span class="sd">        This method handles the rejection of the &#39;START&#39; and &#39;RESET&#39; actions. These are rejected when there is no state transition for their current state.</span>
</span><span id="L-326"><a href="#L-326"><span class="linenos">326</span></a><span class="sd">        This is usually during program runtime for reset or before schedule generation for start.</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos">327</span></a>
</span><span id="L-328"><a href="#L-328"><span class="linenos">328</span></a><span class="sd">        Parameters</span>
</span><span id="L-329"><a href="#L-329"><span class="linenos">329</span></a><span class="sd">        ----------</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos">330</span></a><span class="sd">        - **event** (*str*): This is the desired state being rejected here.</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos">331</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-332"><a href="#L-332"><span class="linenos">332</span></a>        <span class="k">match</span> <span class="n">event</span><span class="p">:</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos">333</span></a>            <span class="k">case</span> <span class="s2">&quot;RESET&quot;</span><span class="p">:</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos">334</span></a>                <span class="n">GUIUtils</span><span class="o">.</span><span class="n">display_error</span><span class="p">(</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos">335</span></a>                    <span class="s2">&quot;CANNOT PERFORM THIS ACTION&quot;</span><span class="p">,</span>
</span><span id="L-336"><a href="#L-336"><span class="linenos">336</span></a>                    <span class="s2">&quot;RESET cannot be performed during runtime. Stop the program to reset.&quot;</span><span class="p">,</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos">337</span></a>                <span class="p">)</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos">338</span></a>            <span class="c1"># if key is not in table but we try to start (for example, STOP PROGRAM -&gt; START) we do NOT want to allow this until a full reset has been completed</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos">339</span></a>            <span class="k">case</span> <span class="s2">&quot;START&quot;</span><span class="p">:</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos">340</span></a>                <span class="n">GUIUtils</span><span class="o">.</span><span class="n">display_error</span><span class="p">(</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos">341</span></a>                    <span class="s2">&quot;CANNOT PERFORM THIS ACTION&quot;</span><span class="p">,</span>
</span><span id="L-342"><a href="#L-342"><span class="linenos">342</span></a>                    <span class="s2">&quot;Experiement has already been executed. Before running another, you need to RESET the application to ensure all data is reset to defaults&quot;</span><span class="p">,</span>
</span><span id="L-343"><a href="#L-343"><span class="linenos">343</span></a>                <span class="p">)</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos">344</span></a>            <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
</span><span id="L-345"><a href="#L-345"><span class="linenos">345</span></a>                <span class="k">return</span>
</span><span id="L-346"><a href="#L-346"><span class="linenos">346</span></a>
</span><span id="L-347"><a href="#L-347"><span class="linenos">347</span></a>
</span><span id="L-348"><a href="#L-348"><span class="linenos">348</span></a><span class="k">class</span><span class="w"> </span><span class="nc">GenerateSchedule</span><span class="p">:</span>
</span><span id="L-349"><a href="#L-349"><span class="linenos">349</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos">350</span></a><span class="sd">    This class handles the schedule generation state. It is called once the user has input the amount of simuli for this experiment, the</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos">351</span></a><span class="sd">    number of trial blocks, changed the names of the stimuli in each cylinder/valve in the &#39;Valve / Stimuli&#39; window, and pressed generate schedule.</span>
</span><span id="L-352"><a href="#L-352"><span class="linenos">352</span></a>
</span><span id="L-353"><a href="#L-353"><span class="linenos">353</span></a><span class="sd">    The main things handled here are the updating of gui objects that needed the previously discussed info to be created (e.g raster plots need</span>
</span><span id="L-354"><a href="#L-354"><span class="linenos">354</span></a><span class="sd">    total trials, program schedule window needed the experiment data, etc.)</span>
</span><span id="L-355"><a href="#L-355"><span class="linenos">355</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos">356</span></a>
</span><span id="L-357"><a href="#L-357"><span class="linenos">357</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos">358</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-359"><a href="#L-359"><span class="linenos">359</span></a>        <span class="n">main_gui</span><span class="p">:</span> <span class="n">MainGUI</span><span class="p">,</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos">360</span></a>        <span class="n">arduino_controller</span><span class="p">:</span> <span class="n">ArduinoManager</span><span class="p">,</span>
</span><span id="L-361"><a href="#L-361"><span class="linenos">361</span></a>        <span class="n">process_queue</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]],</span> <span class="kc">None</span><span class="p">],</span>
</span><span id="L-362"><a href="#L-362"><span class="linenos">362</span></a>        <span class="n">trigger</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="kc">None</span><span class="p">],</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos">363</span></a>    <span class="p">):</span>
</span><span id="L-364"><a href="#L-364"><span class="linenos">364</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos">365</span></a><span class="sd">        Initialize and handle the GenerateSchedule class state.</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos">366</span></a>
</span><span id="L-367"><a href="#L-367"><span class="linenos">367</span></a><span class="sd">        Parameters</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos">368</span></a><span class="sd">        ----------</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos">369</span></a><span class="sd">        - **main_gui** (*MainGUI*): A reference to the `views.main_gui` MainGUI instance, this is used to update elements inside the GUI window(s). Here we use it to</span>
</span><span id="L-370"><a href="#L-370"><span class="linenos">370</span></a><span class="sd">        update show the program schedule and create raster plots.</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos">371</span></a><span class="sd">        - **arduino_controller** (*ArduinoManager*): A reference to the `controllers.arduino_control` Arduino controller instance, this is the method by which the Arduino is communicated</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos">372</span></a><span class="sd">        with in the program. Used to send schedules, variables, and valve durations here.</span>
</span><span id="L-373"><a href="#L-373"><span class="linenos">373</span></a><span class="sd">        - **process_queue** (*Callback method*): This callback method is passed here so that the Arduino listener process thread can be started once the listener thread</span>
</span><span id="L-374"><a href="#L-374"><span class="linenos">374</span></a><span class="sd">        is running. It does NOT run prior to this so that sending individual bytes (send schedule, etc.) is performed without having data stolen away by the constantly running</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos">375</span></a><span class="sd">        listener thread.</span>
</span><span id="L-376"><a href="#L-376"><span class="linenos">376</span></a><span class="sd">        - **trigger** (*Callback method*): This callback is passed in so that this state can trigger a transition back to `IDLE` when it is finished with its work.</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos">377</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos">378</span></a>
</span><span id="L-379"><a href="#L-379"><span class="linenos">379</span></a>        <span class="c1"># show the program sched window via the callback passed into the class at initialization</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos">380</span></a>        <span class="n">main_gui</span><span class="o">.</span><span class="n">show_secondary_window</span><span class="p">(</span><span class="s2">&quot;Program Schedule&quot;</span><span class="p">)</span>
</span><span id="L-381"><a href="#L-381"><span class="linenos">381</span></a>
</span><span id="L-382"><a href="#L-382"><span class="linenos">382</span></a>        <span class="c1"># create plots using generated number of trials as max Y values</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos">383</span></a>        <span class="k">for</span> <span class="n">window</span> <span class="ow">in</span> <span class="n">main_gui</span><span class="o">.</span><span class="n">windows</span><span class="p">[</span><span class="s2">&quot;Raster Plot&quot;</span><span class="p">]:</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos">384</span></a>            <span class="n">window</span><span class="o">.</span><span class="n">create_plot</span><span class="p">()</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos">385</span></a>
</span><span id="L-386"><a href="#L-386"><span class="linenos">386</span></a>        <span class="c1"># send exp variables, schedule, and valve open durations stored in arduino_data.toml to the arduino</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos">387</span></a>        <span class="n">arduino_controller</span><span class="o">.</span><span class="n">send_experiment_variables</span><span class="p">()</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos">388</span></a>        <span class="n">arduino_controller</span><span class="o">.</span><span class="n">send_schedule_data</span><span class="p">()</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos">389</span></a>        <span class="n">arduino_controller</span><span class="o">.</span><span class="n">send_valve_durations</span><span class="p">()</span>
</span><span id="L-390"><a href="#L-390"><span class="linenos">390</span></a>
</span><span id="L-391"><a href="#L-391"><span class="linenos">391</span></a>        <span class="c1"># start Arduino process queue and listener thread so we know when Arduino tries to tell us something</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos">392</span></a>        <span class="n">process_queue</span><span class="p">(</span><span class="n">arduino_controller</span><span class="o">.</span><span class="n">data_queue</span><span class="p">)</span>
</span><span id="L-393"><a href="#L-393"><span class="linenos">393</span></a>
</span><span id="L-394"><a href="#L-394"><span class="linenos">394</span></a>        <span class="n">arduino_controller</span><span class="o">.</span><span class="n">listener_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos">395</span></a>            <span class="n">target</span><span class="o">=</span><span class="n">arduino_controller</span><span class="o">.</span><span class="n">listen_for_serial</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos">396</span></a>        <span class="p">)</span>
</span><span id="L-397"><a href="#L-397"><span class="linenos">397</span></a>
</span><span id="L-398"><a href="#L-398"><span class="linenos">398</span></a>        <span class="n">arduino_controller</span><span class="o">.</span><span class="n">listener_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span><span id="L-399"><a href="#L-399"><span class="linenos">399</span></a>
</span><span id="L-400"><a href="#L-400"><span class="linenos">400</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Started listening thread for Arduino serial input.&quot;</span><span class="p">)</span>
</span><span id="L-401"><a href="#L-401"><span class="linenos">401</span></a>
</span><span id="L-402"><a href="#L-402"><span class="linenos">402</span></a>        <span class="c1"># transition back to idle</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos">403</span></a>        <span class="n">trigger</span><span class="p">(</span><span class="s2">&quot;IDLE&quot;</span><span class="p">)</span>
</span><span id="L-404"><a href="#L-404"><span class="linenos">404</span></a>
</span><span id="L-405"><a href="#L-405"><span class="linenos">405</span></a>
</span><span id="L-406"><a href="#L-406"><span class="linenos">406</span></a><span class="k">class</span><span class="w"> </span><span class="nc">StartProgram</span><span class="p">:</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos">407</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-408"><a href="#L-408"><span class="linenos">408</span></a><span class="sd">    This class handles the remaining set-up steps to prepare for experiment runtime. It then triggers the experiment.</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos">409</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos">410</span></a>
</span><span id="L-411"><a href="#L-411"><span class="linenos">411</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos">412</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-413"><a href="#L-413"><span class="linenos">413</span></a>        <span class="n">exp_data</span><span class="p">:</span> <span class="n">ExperimentProcessData</span><span class="p">,</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos">414</span></a>        <span class="n">main_gui</span><span class="p">:</span> <span class="n">MainGUI</span><span class="p">,</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos">415</span></a>        <span class="n">arduino_controller</span><span class="p">:</span> <span class="n">ArduinoManager</span><span class="p">,</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos">416</span></a>        <span class="n">trigger</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="kc">None</span><span class="p">],</span>
</span><span id="L-417"><a href="#L-417"><span class="linenos">417</span></a>    <span class="p">):</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos">418</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-419"><a href="#L-419"><span class="linenos">419</span></a><span class="sd">        Parameters</span>
</span><span id="L-420"><a href="#L-420"><span class="linenos">420</span></a><span class="sd">        ----------</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos">421</span></a><span class="sd">        - **exp_data** (*ExperimentProcessData*): Reference to the `models.experiment_process_data`. Here we use it to mark experiment and state start times.</span>
</span><span id="L-422"><a href="#L-422"><span class="linenos">422</span></a><span class="sd">        - **main_gui** (*MainGUI*): A reference to `views.main_gui` MainGUI instance, this is used to update elements inside the GUI window(s). Here we use it to</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos">423</span></a><span class="sd">        update clock labels and max program runtime.</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos">424</span></a><span class="sd">        - **arduino_controller** (*ArduinoManager*): A reference to the `controllers.arduino_control` instance, this is the method by which the Arduino is communicated</span>
</span><span id="L-425"><a href="#L-425"><span class="linenos">425</span></a><span class="sd">        with in the program. Used to tell Arduino that program begins now.</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos">426</span></a><span class="sd">        - **trigger** (*Callback method*): This callback is passed in so that this state can trigger a transition to `ITI` when it is finished with its work.</span>
</span><span id="L-427"><a href="#L-427"><span class="linenos">427</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-428"><a href="#L-428"><span class="linenos">428</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos">429</span></a>            <span class="c1"># update experiment data model program start time and state start time variables with current time</span>
</span><span id="L-430"><a href="#L-430"><span class="linenos">430</span></a>            <span class="n">exp_data</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="L-431"><a href="#L-431"><span class="linenos">431</span></a>            <span class="n">exp_data</span><span class="o">.</span><span class="n">state_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="L-432"><a href="#L-432"><span class="linenos">432</span></a>
</span><span id="L-433"><a href="#L-433"><span class="linenos">433</span></a>            <span class="c1"># tell Arduino that experiment starts now so it knows how to calculate timestamps</span>
</span><span id="L-434"><a href="#L-434"><span class="linenos">434</span></a>            <span class="n">start_command</span> <span class="o">=</span> <span class="s2">&quot;T=0</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos">435</span></a>            <span class="n">arduino_controller</span><span class="o">.</span><span class="n">send_command</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">start_command</span><span class="p">)</span>
</span><span id="L-436"><a href="#L-436"><span class="linenos">436</span></a>
</span><span id="L-437"><a href="#L-437"><span class="linenos">437</span></a>            <span class="n">main_gui</span><span class="o">.</span><span class="n">update_clock_label</span><span class="p">()</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos">438</span></a>            <span class="n">main_gui</span><span class="o">.</span><span class="n">update_max_time</span><span class="p">()</span>
</span><span id="L-439"><a href="#L-439"><span class="linenos">439</span></a>
</span><span id="L-440"><a href="#L-440"><span class="linenos">440</span></a>            <span class="c1"># change the green start button into a red stop button, update the associated command</span>
</span><span id="L-441"><a href="#L-441"><span class="linenos">441</span></a>            <span class="n">main_gui</span><span class="o">.</span><span class="n">start_button</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos">442</span></a>                <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Stop&quot;</span><span class="p">,</span> <span class="n">bg</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">trigger</span><span class="p">(</span><span class="s2">&quot;STOP&quot;</span><span class="p">)</span>
</span><span id="L-443"><a href="#L-443"><span class="linenos">443</span></a>            <span class="p">)</span>
</span><span id="L-444"><a href="#L-444"><span class="linenos">444</span></a>
</span><span id="L-445"><a href="#L-445"><span class="linenos">445</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;==========EXPERIMENT BEGINS NOW==========&quot;</span><span class="p">)</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos">446</span></a>
</span><span id="L-447"><a href="#L-447"><span class="linenos">447</span></a>            <span class="n">trigger</span><span class="p">(</span><span class="s2">&quot;ITI&quot;</span><span class="p">)</span>
</span><span id="L-448"><a href="#L-448"><span class="linenos">448</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos">449</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error starting program: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos">450</span></a>            <span class="k">raise</span>
</span><span id="L-451"><a href="#L-451"><span class="linenos">451</span></a>
</span><span id="L-452"><a href="#L-452"><span class="linenos">452</span></a>
</span><span id="L-453"><a href="#L-453"><span class="linenos">453</span></a><span class="k">class</span><span class="w"> </span><span class="nc">StopProgram</span><span class="p">:</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos">454</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos">455</span></a><span class="sd">    Stops and updates program to reflect `IDLE` state.</span>
</span><span id="L-456"><a href="#L-456"><span class="linenos">456</span></a>
</span><span id="L-457"><a href="#L-457"><span class="linenos">457</span></a><span class="sd">    Methods</span>
</span><span id="L-458"><a href="#L-458"><span class="linenos">458</span></a><span class="sd">    -------</span>
</span><span id="L-459"><a href="#L-459"><span class="linenos">459</span></a><span class="sd">    - `finalize_program`(main_gui, arduino_controller)</span>
</span><span id="L-460"><a href="#L-460"><span class="linenos">460</span></a><span class="sd">        This method waits until the door closes for the last time, then cancels the last scheduled task, stops the listener thread, closes Arduino connections, and</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos">461</span></a><span class="sd">        instructs the user to save their data.</span>
</span><span id="L-462"><a href="#L-462"><span class="linenos">462</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-463"><a href="#L-463"><span class="linenos">463</span></a>
</span><span id="L-464"><a href="#L-464"><span class="linenos">464</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="L-465"><a href="#L-465"><span class="linenos">465</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-466"><a href="#L-466"><span class="linenos">466</span></a>        <span class="n">main_gui</span><span class="p">:</span> <span class="n">MainGUI</span><span class="p">,</span>
</span><span id="L-467"><a href="#L-467"><span class="linenos">467</span></a>        <span class="n">arduino_controller</span><span class="p">:</span> <span class="n">ArduinoManager</span><span class="p">,</span>
</span><span id="L-468"><a href="#L-468"><span class="linenos">468</span></a>        <span class="n">trigger</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="kc">None</span><span class="p">],</span>
</span><span id="L-469"><a href="#L-469"><span class="linenos">469</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-470"><a href="#L-470"><span class="linenos">470</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-471"><a href="#L-471"><span class="linenos">471</span></a><span class="sd">        Parameters</span>
</span><span id="L-472"><a href="#L-472"><span class="linenos">472</span></a><span class="sd">        ----------</span>
</span><span id="L-473"><a href="#L-473"><span class="linenos">473</span></a><span class="sd">        - **main_gui** (*MainGUI*): A reference to `views.main_gui` MainGUI instance, this is used to update elements inside the GUI window(s). Here we use it to</span>
</span><span id="L-474"><a href="#L-474"><span class="linenos">474</span></a><span class="sd">        call update_on_stop, configure the start/stop button back to start, and cancel tkinter scheduled tasks.</span>
</span><span id="L-475"><a href="#L-475"><span class="linenos">475</span></a><span class="sd">        - **arduino_controller** (*ArduinoManager*): A reference to the `controllers.arduino_control` instance, this is the method by which the Arduino is communicated</span>
</span><span id="L-476"><a href="#L-476"><span class="linenos">476</span></a><span class="sd">        with in the program. Used to reset Arduino and clear all left-over experiment data.</span>
</span><span id="L-477"><a href="#L-477"><span class="linenos">477</span></a><span class="sd">        - **trigger** (*Callback method*): This callback is passed in so the start button can be configured to command a `START` state.</span>
</span><span id="L-478"><a href="#L-478"><span class="linenos">478</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-479"><a href="#L-479"><span class="linenos">479</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos">480</span></a>            <span class="n">main_gui</span><span class="o">.</span><span class="n">update_on_stop</span><span class="p">()</span>
</span><span id="L-481"><a href="#L-481"><span class="linenos">481</span></a>            <span class="c1"># change the command back to start for the start button. (STOP PROGRAM, START) is not a defined transition, so the</span>
</span><span id="L-482"><a href="#L-482"><span class="linenos">482</span></a>            <span class="c1"># trigger function will call reject_actions to let the user know the program has already ran and they need to reset the app.</span>
</span><span id="L-483"><a href="#L-483"><span class="linenos">483</span></a>            <span class="n">main_gui</span><span class="o">.</span><span class="n">start_button</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span>
</span><span id="L-484"><a href="#L-484"><span class="linenos">484</span></a>                <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Start&quot;</span><span class="p">,</span> <span class="n">bg</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">trigger</span><span class="p">(</span><span class="s2">&quot;START&quot;</span><span class="p">)</span>
</span><span id="L-485"><a href="#L-485"><span class="linenos">485</span></a>            <span class="p">)</span>
</span><span id="L-486"><a href="#L-486"><span class="linenos">486</span></a>
</span><span id="L-487"><a href="#L-487"><span class="linenos">487</span></a>            <span class="c1"># stop all scheduled tasks EXCEPT for the process queue, we are still waiting for the last door close timestamp</span>
</span><span id="L-488"><a href="#L-488"><span class="linenos">488</span></a>            <span class="k">for</span> <span class="n">desc</span><span class="p">,</span> <span class="n">sched_task</span> <span class="ow">in</span> <span class="n">main_gui</span><span class="o">.</span><span class="n">scheduled_tasks</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-489"><a href="#L-489"><span class="linenos">489</span></a>                <span class="k">if</span> <span class="n">desc</span> <span class="o">!=</span> <span class="s2">&quot;PROCESS QUEUE&quot;</span><span class="p">:</span>
</span><span id="L-490"><a href="#L-490"><span class="linenos">490</span></a>                    <span class="n">main_gui</span><span class="o">.</span><span class="n">after_cancel</span><span class="p">(</span><span class="n">sched_task</span><span class="p">)</span>
</span><span id="L-491"><a href="#L-491"><span class="linenos">491</span></a>
</span><span id="L-492"><a href="#L-492"><span class="linenos">492</span></a>            <span class="c1"># schedule finalization after door will be down</span>
</span><span id="L-493"><a href="#L-493"><span class="linenos">493</span></a>            <span class="n">main_gui</span><span class="o">.</span><span class="n">scheduled_tasks</span><span class="p">[</span><span class="s2">&quot;FINALIZE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">main_gui</span><span class="o">.</span><span class="n">after</span><span class="p">(</span>
</span><span id="L-494"><a href="#L-494"><span class="linenos">494</span></a>                <span class="mi">5000</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">finalize_program</span><span class="p">(</span><span class="n">main_gui</span><span class="p">,</span> <span class="n">arduino_controller</span><span class="p">)</span>
</span><span id="L-495"><a href="#L-495"><span class="linenos">495</span></a>            <span class="p">)</span>
</span><span id="L-496"><a href="#L-496"><span class="linenos">496</span></a>
</span><span id="L-497"><a href="#L-497"><span class="linenos">497</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Program stopped... waiting to finalize...&quot;</span><span class="p">)</span>
</span><span id="L-498"><a href="#L-498"><span class="linenos">498</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-499"><a href="#L-499"><span class="linenos">499</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error stopping program: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-500"><a href="#L-500"><span class="linenos">500</span></a>            <span class="k">raise</span>
</span><span id="L-501"><a href="#L-501"><span class="linenos">501</span></a>
</span><span id="L-502"><a href="#L-502"><span class="linenos">502</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">finalize_program</span><span class="p">(</span>
</span><span id="L-503"><a href="#L-503"><span class="linenos">503</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">main_gui</span><span class="p">:</span> <span class="n">MainGUI</span><span class="p">,</span> <span class="n">arduino_controller</span><span class="p">:</span> <span class="n">ArduinoManager</span>
</span><span id="L-504"><a href="#L-504"><span class="linenos">504</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-505"><a href="#L-505"><span class="linenos">505</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-506"><a href="#L-506"><span class="linenos">506</span></a><span class="sd">        Finalize the program by resetting the Arduino board, offer to save the data frames into xlsx files.</span>
</span><span id="L-507"><a href="#L-507"><span class="linenos">507</span></a>
</span><span id="L-508"><a href="#L-508"><span class="linenos">508</span></a><span class="sd">        Parameters</span>
</span><span id="L-509"><a href="#L-509"><span class="linenos">509</span></a><span class="sd">        ----------</span>
</span><span id="L-510"><a href="#L-510"><span class="linenos">510</span></a><span class="sd">        - **main_gui** (*MainGUI*): A reference to `views.main_gui` MainGUI instance, this is used to update elements inside the GUI window(s). Here we use it to</span>
</span><span id="L-511"><a href="#L-511"><span class="linenos">511</span></a><span class="sd">        cancel the last tkinter.after call.</span>
</span><span id="L-512"><a href="#L-512"><span class="linenos">512</span></a><span class="sd">        - **arduino_controller** (*ArduinoManager*): A reference to the `controllers.arduino_control` instance, this is the method by which the Arduino is communicated</span>
</span><span id="L-513"><a href="#L-513"><span class="linenos">513</span></a><span class="sd">        with in the program. Used to reset Arduino board and close the connection to it.</span>
</span><span id="L-514"><a href="#L-514"><span class="linenos">514</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-515"><a href="#L-515"><span class="linenos">515</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-516"><a href="#L-516"><span class="linenos">516</span></a>            <span class="c1"># stop the arduino listener so that the program can shut down</span>
</span><span id="L-517"><a href="#L-517"><span class="linenos">517</span></a>            <span class="c1"># and not be blocked</span>
</span><span id="L-518"><a href="#L-518"><span class="linenos">518</span></a>            <span class="n">arduino_controller</span><span class="o">.</span><span class="n">stop_listener_thread</span><span class="p">()</span>
</span><span id="L-519"><a href="#L-519"><span class="linenos">519</span></a>
</span><span id="L-520"><a href="#L-520"><span class="linenos">520</span></a>            <span class="n">queue_id</span> <span class="o">=</span> <span class="n">main_gui</span><span class="o">.</span><span class="n">scheduled_tasks</span><span class="p">[</span><span class="s2">&quot;PROCESS QUEUE&quot;</span><span class="p">]</span>
</span><span id="L-521"><a href="#L-521"><span class="linenos">521</span></a>            <span class="n">main_gui</span><span class="o">.</span><span class="n">after_cancel</span><span class="p">(</span><span class="n">queue_id</span><span class="p">)</span>
</span><span id="L-522"><a href="#L-522"><span class="linenos">522</span></a>
</span><span id="L-523"><a href="#L-523"><span class="linenos">523</span></a>            <span class="n">arduino_controller</span><span class="o">.</span><span class="n">close_connection</span><span class="p">()</span>
</span><span id="L-524"><a href="#L-524"><span class="linenos">524</span></a>
</span><span id="L-525"><a href="#L-525"><span class="linenos">525</span></a>            <span class="n">main_gui</span><span class="o">.</span><span class="n">save_button_handler</span><span class="p">()</span>
</span><span id="L-526"><a href="#L-526"><span class="linenos">526</span></a>
</span><span id="L-527"><a href="#L-527"><span class="linenos">527</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Program finalized, arduino boards reset.&quot;</span><span class="p">)</span>
</span><span id="L-528"><a href="#L-528"><span class="linenos">528</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-529"><a href="#L-529"><span class="linenos">529</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error completing program: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-530"><a href="#L-530"><span class="linenos">530</span></a>            <span class="k">raise</span>
</span><span id="L-531"><a href="#L-531"><span class="linenos">531</span></a>
</span><span id="L-532"><a href="#L-532"><span class="linenos">532</span></a>
</span><span id="L-533"><a href="#L-533"><span class="linenos">533</span></a><span class="k">class</span><span class="w"> </span><span class="nc">ResetProgram</span><span class="p">:</span>
</span><span id="L-534"><a href="#L-534"><span class="linenos">534</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-535"><a href="#L-535"><span class="linenos">535</span></a><span class="sd">    Handle resetting the program on click of the reset button. This class has no instance variable or methods.</span>
</span><span id="L-536"><a href="#L-536"><span class="linenos">536</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-537"><a href="#L-537"><span class="linenos">537</span></a>
</span><span id="L-538"><a href="#L-538"><span class="linenos">538</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="L-539"><a href="#L-539"><span class="linenos">539</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">main_gui</span><span class="p">:</span> <span class="n">MainGUI</span><span class="p">,</span> <span class="n">app_result</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">arduino_controller</span><span class="p">:</span> <span class="n">ArduinoManager</span>
</span><span id="L-540"><a href="#L-540"><span class="linenos">540</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-541"><a href="#L-541"><span class="linenos">541</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-542"><a href="#L-542"><span class="linenos">542</span></a>            <span class="c1"># these two calls will stop the gui, halting the programs mainloop.</span>
</span><span id="L-543"><a href="#L-543"><span class="linenos">543</span></a>            <span class="n">main_gui</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>
</span><span id="L-544"><a href="#L-544"><span class="linenos">544</span></a>            <span class="n">main_gui</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>
</span><span id="L-545"><a href="#L-545"><span class="linenos">545</span></a>
</span><span id="L-546"><a href="#L-546"><span class="linenos">546</span></a>            <span class="c1"># cancel all scheduled tasks</span>
</span><span id="L-547"><a href="#L-547"><span class="linenos">547</span></a>            <span class="k">for</span> <span class="n">sched_task</span> <span class="ow">in</span> <span class="n">main_gui</span><span class="o">.</span><span class="n">scheduled_tasks</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
</span><span id="L-548"><a href="#L-548"><span class="linenos">548</span></a>                <span class="n">main_gui</span><span class="o">.</span><span class="n">after_cancel</span><span class="p">(</span><span class="n">sched_task</span><span class="p">)</span>
</span><span id="L-549"><a href="#L-549"><span class="linenos">549</span></a>            <span class="c1"># if we have an listener thread and arduino connected, stop the thread and close the connection.</span>
</span><span id="L-550"><a href="#L-550"><span class="linenos">550</span></a>            <span class="k">if</span> <span class="n">arduino_controller</span><span class="o">.</span><span class="n">listener_thread</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-551"><a href="#L-551"><span class="linenos">551</span></a>                <span class="n">arduino_controller</span><span class="o">.</span><span class="n">stop_listener_thread</span><span class="p">()</span>
</span><span id="L-552"><a href="#L-552"><span class="linenos">552</span></a>            <span class="k">if</span> <span class="n">arduino_controller</span><span class="o">.</span><span class="n">arduino</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-553"><a href="#L-553"><span class="linenos">553</span></a>                <span class="n">arduino_controller</span><span class="o">.</span><span class="n">close_connection</span><span class="p">()</span>
</span><span id="L-554"><a href="#L-554"><span class="linenos">554</span></a>
</span><span id="L-555"><a href="#L-555"><span class="linenos">555</span></a>            <span class="c1"># set first bit in app_result list to 1 to instruct main to restart.</span>
</span><span id="L-556"><a href="#L-556"><span class="linenos">556</span></a>            <span class="n">app_result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-557"><a href="#L-557"><span class="linenos">557</span></a>
</span><span id="L-558"><a href="#L-558"><span class="linenos">558</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-559"><a href="#L-559"><span class="linenos">559</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error resetting the program: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-560"><a href="#L-560"><span class="linenos">560</span></a>
</span><span id="L-561"><a href="#L-561"><span class="linenos">561</span></a>
</span><span id="L-562"><a href="#L-562"><span class="linenos">562</span></a><span class="k">class</span><span class="w"> </span><span class="nc">InitialTimeInterval</span><span class="p">:</span>
</span><span id="L-563"><a href="#L-563"><span class="linenos">563</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-564"><a href="#L-564"><span class="linenos">564</span></a><span class="sd">    State class for initial time interval experiment state.</span>
</span><span id="L-565"><a href="#L-565"><span class="linenos">565</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-566"><a href="#L-566"><span class="linenos">566</span></a>
</span><span id="L-567"><a href="#L-567"><span class="linenos">567</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="L-568"><a href="#L-568"><span class="linenos">568</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-569"><a href="#L-569"><span class="linenos">569</span></a>        <span class="n">exp_data</span><span class="p">:</span> <span class="n">ExperimentProcessData</span><span class="p">,</span>
</span><span id="L-570"><a href="#L-570"><span class="linenos">570</span></a>        <span class="n">main_gui</span><span class="p">:</span> <span class="n">MainGUI</span><span class="p">,</span>
</span><span id="L-571"><a href="#L-571"><span class="linenos">571</span></a>        <span class="n">state</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="L-572"><a href="#L-572"><span class="linenos">572</span></a>        <span class="n">trigger</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="kc">None</span><span class="p">],</span>
</span><span id="L-573"><a href="#L-573"><span class="linenos">573</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-574"><a href="#L-574"><span class="linenos">574</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-575"><a href="#L-575"><span class="linenos">575</span></a><span class="sd">        This function transitions the program into the `ITI` state. It does this by resetting lick counts, setting new state time,</span>
</span><span id="L-576"><a href="#L-576"><span class="linenos">576</span></a><span class="sd">        updating the models, and setting the .after call to transition to TTC.</span>
</span><span id="L-577"><a href="#L-577"><span class="linenos">577</span></a>
</span><span id="L-578"><a href="#L-578"><span class="linenos">578</span></a><span class="sd">        Parameters</span>
</span><span id="L-579"><a href="#L-579"><span class="linenos">579</span></a><span class="sd">        ----------</span>
</span><span id="L-580"><a href="#L-580"><span class="linenos">580</span></a><span class="sd">        - **exp_data** (*ExperimentProcessData*): Reference to the `models.experiment_process_data`. Here we use it to get a reference to event_data to set trial</span>
</span><span id="L-581"><a href="#L-581"><span class="linenos">581</span></a><span class="sd">        licks to 0, get logical trial number, and get state duration time.</span>
</span><span id="L-582"><a href="#L-582"><span class="linenos">582</span></a><span class="sd">        - **main_gui** (*MainGUI*): A reference to `views.main_gui` MainGUI instance, this is used to update elements inside the GUI window(s). Here we use it to</span>
</span><span id="L-583"><a href="#L-583"><span class="linenos">583</span></a><span class="sd">        update GUI with new trial information and configure the state timer.</span>
</span><span id="L-584"><a href="#L-584"><span class="linenos">584</span></a><span class="sd">        - **state** (*str*): State is used to update GUI with current state and grab the state duration time from the program schedule df.</span>
</span><span id="L-585"><a href="#L-585"><span class="linenos">585</span></a><span class="sd">        - **trigger** (*Callback method*): This callback is passed in so the `OPENING DOOR` state can be triggered after the `ITI` time has passed.</span>
</span><span id="L-586"><a href="#L-586"><span class="linenos">586</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-587"><a href="#L-587"><span class="linenos">587</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-588"><a href="#L-588"><span class="linenos">588</span></a>            <span class="c1"># get a reference to the event_data from exp_data.</span>
</span><span id="L-589"><a href="#L-589"><span class="linenos">589</span></a>            <span class="n">event_data</span> <span class="o">=</span> <span class="n">exp_data</span><span class="o">.</span><span class="n">event_data</span>
</span><span id="L-590"><a href="#L-590"><span class="linenos">590</span></a>
</span><span id="L-591"><a href="#L-591"><span class="linenos">591</span></a>            <span class="c1"># set trial licks to 0 for both sides</span>
</span><span id="L-592"><a href="#L-592"><span class="linenos">592</span></a>            <span class="n">event_data</span><span class="o">.</span><span class="n">side_one_licks</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-593"><a href="#L-593"><span class="linenos">593</span></a>            <span class="n">event_data</span><span class="o">.</span><span class="n">side_two_licks</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-594"><a href="#L-594"><span class="linenos">594</span></a>
</span><span id="L-595"><a href="#L-595"><span class="linenos">595</span></a>            <span class="c1"># logical df rows will always be 1 behind the current trial because of zero based indexing in dataframes vs</span>
</span><span id="L-596"><a href="#L-596"><span class="linenos">596</span></a>            <span class="c1"># 1 based for trials</span>
</span><span id="L-597"><a href="#L-597"><span class="linenos">597</span></a>            <span class="n">logical_trial</span> <span class="o">=</span> <span class="n">exp_data</span><span class="o">.</span><span class="n">current_trial_number</span> <span class="o">-</span> <span class="mi">1</span>
</span><span id="L-598"><a href="#L-598"><span class="linenos">598</span></a>
</span><span id="L-599"><a href="#L-599"><span class="linenos">599</span></a>            <span class="c1"># Call gui updates needed every trial (e.g program schedule window highlighting, progress bar, trial stimuli, etc)</span>
</span><span id="L-600"><a href="#L-600"><span class="linenos">600</span></a>            <span class="c1"># make sure we convert received vals to str to avoid type errors</span>
</span><span id="L-601"><a href="#L-601"><span class="linenos">601</span></a>            <span class="n">main_gui</span><span class="o">.</span><span class="n">update_on_new_trial</span><span class="p">(</span>
</span><span id="L-602"><a href="#L-602"><span class="linenos">602</span></a>                <span class="nb">str</span><span class="p">(</span><span class="n">exp_data</span><span class="o">.</span><span class="n">program_schedule_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">logical_trial</span><span class="p">,</span> <span class="s2">&quot;Port 1&quot;</span><span class="p">]),</span>
</span><span id="L-603"><a href="#L-603"><span class="linenos">603</span></a>                <span class="nb">str</span><span class="p">(</span><span class="n">exp_data</span><span class="o">.</span><span class="n">program_schedule_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">logical_trial</span><span class="p">,</span> <span class="s2">&quot;Port 2&quot;</span><span class="p">]),</span>
</span><span id="L-604"><a href="#L-604"><span class="linenos">604</span></a>            <span class="p">)</span>
</span><span id="L-605"><a href="#L-605"><span class="linenos">605</span></a>
</span><span id="L-606"><a href="#L-606"><span class="linenos">606</span></a>            <span class="c1"># clear state timer and reset the state start time</span>
</span><span id="L-607"><a href="#L-607"><span class="linenos">607</span></a>            <span class="n">main_gui</span><span class="o">.</span><span class="n">state_timer_text</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="p">(</span><span class="n">state</span> <span class="o">+</span> <span class="s2">&quot;Time:&quot;</span><span class="p">))</span>
</span><span id="L-608"><a href="#L-608"><span class="linenos">608</span></a>            <span class="n">exp_data</span><span class="o">.</span><span class="n">state_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="L-609"><a href="#L-609"><span class="linenos">609</span></a>
</span><span id="L-610"><a href="#L-610"><span class="linenos">610</span></a>            <span class="n">initial_time_interval</span> <span class="o">=</span> <span class="n">exp_data</span><span class="o">.</span><span class="n">program_schedule_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
</span><span id="L-611"><a href="#L-611"><span class="linenos">611</span></a>                <span class="n">logical_trial</span><span class="p">,</span> <span class="n">state</span>
</span><span id="L-612"><a href="#L-612"><span class="linenos">612</span></a>            <span class="p">]</span>
</span><span id="L-613"><a href="#L-613"><span class="linenos">613</span></a>
</span><span id="L-614"><a href="#L-614"><span class="linenos">614</span></a>            <span class="n">main_gui</span><span class="o">.</span><span class="n">update_on_state_change</span><span class="p">(</span><span class="n">initial_time_interval</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="L-615"><a href="#L-615"><span class="linenos">615</span></a>
</span><span id="L-616"><a href="#L-616"><span class="linenos">616</span></a>            <span class="c1"># tell tkinter main loop that we want to trigger DOOR OPEN state after initial_time_interval milliseconds</span>
</span><span id="L-617"><a href="#L-617"><span class="linenos">617</span></a>            <span class="n">iti_ttc_transition</span> <span class="o">=</span> <span class="n">main_gui</span><span class="o">.</span><span class="n">after</span><span class="p">(</span>
</span><span id="L-618"><a href="#L-618"><span class="linenos">618</span></a>                <span class="nb">int</span><span class="p">(</span><span class="n">initial_time_interval</span><span class="p">),</span>
</span><span id="L-619"><a href="#L-619"><span class="linenos">619</span></a>                <span class="k">lambda</span><span class="p">:</span> <span class="n">trigger</span><span class="p">(</span><span class="s2">&quot;DOOR OPEN&quot;</span><span class="p">),</span>
</span><span id="L-620"><a href="#L-620"><span class="linenos">620</span></a>            <span class="p">)</span>
</span><span id="L-621"><a href="#L-621"><span class="linenos">621</span></a>
</span><span id="L-622"><a href="#L-622"><span class="linenos">622</span></a>            <span class="c1"># add the transition to scheduled tasks dict so that</span>
</span><span id="L-623"><a href="#L-623"><span class="linenos">623</span></a>            <span class="n">main_gui</span><span class="o">.</span><span class="n">scheduled_tasks</span><span class="p">[</span><span class="s2">&quot;ITI TO DOOR OPEN&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">iti_ttc_transition</span>
</span><span id="L-624"><a href="#L-624"><span class="linenos">624</span></a>
</span><span id="L-625"><a href="#L-625"><span class="linenos">625</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="L-626"><a href="#L-626"><span class="linenos">626</span></a>                <span class="sa">f</span><span class="s2">&quot;STATE CHANGE: ITI BEGINS NOW for trial -&gt; </span><span class="si">{</span><span class="n">exp_data</span><span class="o">.</span><span class="n">current_trial_number</span><span class="si">}</span><span class="s2">, completes in </span><span class="si">{</span><span class="n">initial_time_interval</span><span class="si">}</span><span class="s2">.&quot;</span>
</span><span id="L-627"><a href="#L-627"><span class="linenos">627</span></a>            <span class="p">)</span>
</span><span id="L-628"><a href="#L-628"><span class="linenos">628</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-629"><a href="#L-629"><span class="linenos">629</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in initial time interval: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-630"><a href="#L-630"><span class="linenos">630</span></a>            <span class="k">raise</span>
</span><span id="L-631"><a href="#L-631"><span class="linenos">631</span></a>
</span><span id="L-632"><a href="#L-632"><span class="linenos">632</span></a>
</span><span id="L-633"><a href="#L-633"><span class="linenos">633</span></a><span class="k">class</span><span class="w"> </span><span class="nc">OpeningDoor</span><span class="p">:</span>
</span><span id="L-634"><a href="#L-634"><span class="linenos">634</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-635"><a href="#L-635"><span class="linenos">635</span></a><span class="sd">    Intermediate state between `ITI` and `TTC`.</span>
</span><span id="L-636"><a href="#L-636"><span class="linenos">636</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-637"><a href="#L-637"><span class="linenos">637</span></a>
</span><span id="L-638"><a href="#L-638"><span class="linenos">638</span></a>    <span class="c1"># we are going to need to pass in the arduino controller as well</span>
</span><span id="L-639"><a href="#L-639"><span class="linenos">639</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="L-640"><a href="#L-640"><span class="linenos">640</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-641"><a href="#L-641"><span class="linenos">641</span></a>        <span class="n">exp_data</span><span class="p">:</span> <span class="n">ExperimentProcessData</span><span class="p">,</span>
</span><span id="L-642"><a href="#L-642"><span class="linenos">642</span></a>        <span class="n">main_gui</span><span class="p">:</span> <span class="n">MainGUI</span><span class="p">,</span>
</span><span id="L-643"><a href="#L-643"><span class="linenos">643</span></a>        <span class="n">arduino_controller</span><span class="p">:</span> <span class="n">ArduinoManager</span><span class="p">,</span>
</span><span id="L-644"><a href="#L-644"><span class="linenos">644</span></a>        <span class="n">state</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="L-645"><a href="#L-645"><span class="linenos">645</span></a>        <span class="n">trigger</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="kc">None</span><span class="p">],</span>
</span><span id="L-646"><a href="#L-646"><span class="linenos">646</span></a>    <span class="p">):</span>
</span><span id="L-647"><a href="#L-647"><span class="linenos">647</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-648"><a href="#L-648"><span class="linenos">648</span></a><span class="sd">        In the initialization steps for this state we command the door down, then wait `DOOR_MOVE_TIME` to move to the `TTC` state.</span>
</span><span id="L-649"><a href="#L-649"><span class="linenos">649</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-650"><a href="#L-650"><span class="linenos">650</span></a>        <span class="c1"># send comment to arduino to move the door down</span>
</span><span id="L-651"><a href="#L-651"><span class="linenos">651</span></a>        <span class="n">down_command</span> <span class="o">=</span> <span class="s2">&quot;DOWN</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
</span><span id="L-652"><a href="#L-652"><span class="linenos">652</span></a>        <span class="n">arduino_controller</span><span class="o">.</span><span class="n">send_command</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">down_command</span><span class="p">)</span>
</span><span id="L-653"><a href="#L-653"><span class="linenos">653</span></a>
</span><span id="L-654"><a href="#L-654"><span class="linenos">654</span></a>        <span class="c1"># after the door is down, then we will begin the ttc state logic, found in run_ttc</span>
</span><span id="L-655"><a href="#L-655"><span class="linenos">655</span></a>        <span class="n">main_gui</span><span class="o">.</span><span class="n">after</span><span class="p">(</span><span class="n">DOOR_MOVE_TIME</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">trigger</span><span class="p">(</span><span class="s2">&quot;TTC&quot;</span><span class="p">))</span>
</span><span id="L-656"><a href="#L-656"><span class="linenos">656</span></a>
</span><span id="L-657"><a href="#L-657"><span class="linenos">657</span></a>        <span class="c1"># state start time begins</span>
</span><span id="L-658"><a href="#L-658"><span class="linenos">658</span></a>        <span class="n">exp_data</span><span class="o">.</span><span class="n">state_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="L-659"><a href="#L-659"><span class="linenos">659</span></a>
</span><span id="L-660"><a href="#L-660"><span class="linenos">660</span></a>        <span class="c1"># show current_time / door close time to avoid confusion</span>
</span><span id="L-661"><a href="#L-661"><span class="linenos">661</span></a>        <span class="n">main_gui</span><span class="o">.</span><span class="n">update_on_state_change</span><span class="p">(</span><span class="n">DOOR_MOVE_TIME</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="L-662"><a href="#L-662"><span class="linenos">662</span></a>
</span><span id="L-663"><a href="#L-663"><span class="linenos">663</span></a>
</span><span id="L-664"><a href="#L-664"><span class="linenos">664</span></a><span class="k">class</span><span class="w"> </span><span class="nc">TimeToContact</span><span class="p">:</span>
</span><span id="L-665"><a href="#L-665"><span class="linenos">665</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-666"><a href="#L-666"><span class="linenos">666</span></a><span class="sd">    State class for time to contact experiment state</span>
</span><span id="L-667"><a href="#L-667"><span class="linenos">667</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-668"><a href="#L-668"><span class="linenos">668</span></a>
</span><span id="L-669"><a href="#L-669"><span class="linenos">669</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="L-670"><a href="#L-670"><span class="linenos">670</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-671"><a href="#L-671"><span class="linenos">671</span></a>        <span class="n">exp_data</span><span class="p">:</span> <span class="n">ExperimentProcessData</span><span class="p">,</span>
</span><span id="L-672"><a href="#L-672"><span class="linenos">672</span></a>        <span class="n">arduino_controller</span><span class="p">:</span> <span class="n">ArduinoManager</span><span class="p">,</span>
</span><span id="L-673"><a href="#L-673"><span class="linenos">673</span></a>        <span class="n">main_gui</span><span class="p">:</span> <span class="n">MainGUI</span><span class="p">,</span>
</span><span id="L-674"><a href="#L-674"><span class="linenos">674</span></a>        <span class="n">state</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="L-675"><a href="#L-675"><span class="linenos">675</span></a>        <span class="n">trigger</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="kc">None</span><span class="p">],</span>
</span><span id="L-676"><a href="#L-676"><span class="linenos">676</span></a>    <span class="p">):</span>
</span><span id="L-677"><a href="#L-677"><span class="linenos">677</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-678"><a href="#L-678"><span class="linenos">678</span></a><span class="sd">        This function transitions the program into the `TTC` state. We can only reach this state from `OPENING DOOR`.</span>
</span><span id="L-679"><a href="#L-679"><span class="linenos">679</span></a>
</span><span id="L-680"><a href="#L-680"><span class="linenos">680</span></a><span class="sd">        We transition into `TTC` by resetting the state timer, instructing the Arduino that the trial has started, and scheduling a transition into</span>
</span><span id="L-681"><a href="#L-681"><span class="linenos">681</span></a><span class="sd">        `TRIAL END` if the rat does not engage in this trial. This is cancelled in sample time if 3 licks or more from `TTC` are detected in the `models.arduino_data`</span>
</span><span id="L-682"><a href="#L-682"><span class="linenos">682</span></a><span class="sd">        module&#39;s `handle_licks` method.</span>
</span><span id="L-683"><a href="#L-683"><span class="linenos">683</span></a>
</span><span id="L-684"><a href="#L-684"><span class="linenos">684</span></a><span class="sd">        Parameters</span>
</span><span id="L-685"><a href="#L-685"><span class="linenos">685</span></a><span class="sd">        ----------</span>
</span><span id="L-686"><a href="#L-686"><span class="linenos">686</span></a><span class="sd">        - **exp_data** (*ExperimentProcessData*): Reference to the `models.experiment_process_data`. Here we use it to get a reference to event_data to reset state time</span>
</span><span id="L-687"><a href="#L-687"><span class="linenos">687</span></a><span class="sd">        and find `TTC` state time.</span>
</span><span id="L-688"><a href="#L-688"><span class="linenos">688</span></a><span class="sd">        - **arduino_controller** (*ArduinoManager*): A reference to the `controllers.arduino_control` instance, this is the method by which the Arduino is communicated</span>
</span><span id="L-689"><a href="#L-689"><span class="linenos">689</span></a><span class="sd">        with in the program. Used here to tell Arduino board trial has begun.</span>
</span><span id="L-690"><a href="#L-690"><span class="linenos">690</span></a><span class="sd">        - **main_gui** (*MainGUI*): A reference to `views.main_gui` MainGUI instance, this is used to update elements inside the GUI window(s). Here we use it to</span>
</span><span id="L-691"><a href="#L-691"><span class="linenos">691</span></a><span class="sd">        update GUI with new state time.</span>
</span><span id="L-692"><a href="#L-692"><span class="linenos">692</span></a><span class="sd">        - **state** (*str*): State is used to update GUI with current state and grab the state duration time from the program schedule df.</span>
</span><span id="L-693"><a href="#L-693"><span class="linenos">693</span></a><span class="sd">        - **trigger** (*Callback method*): This callback is passed in so the `TRIAL END` state can be triggered if trial is not engaged.</span>
</span><span id="L-694"><a href="#L-694"><span class="linenos">694</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-695"><a href="#L-695"><span class="linenos">695</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-696"><a href="#L-696"><span class="linenos">696</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="L-697"><a href="#L-697"><span class="linenos">697</span></a>                <span class="sa">f</span><span class="s2">&quot;STATE CHANGE: DOOR OPEN -&gt; TTC NOW for trial -&gt; </span><span class="si">{</span><span class="n">exp_data</span><span class="o">.</span><span class="n">current_trial_number</span><span class="si">}</span><span class="s2">.&quot;</span>
</span><span id="L-698"><a href="#L-698"><span class="linenos">698</span></a>            <span class="p">)</span>
</span><span id="L-699"><a href="#L-699"><span class="linenos">699</span></a>
</span><span id="L-700"><a href="#L-700"><span class="linenos">700</span></a>            <span class="n">logical_trial</span> <span class="o">=</span> <span class="n">exp_data</span><span class="o">.</span><span class="n">current_trial_number</span> <span class="o">-</span> <span class="mi">1</span>
</span><span id="L-701"><a href="#L-701"><span class="linenos">701</span></a>
</span><span id="L-702"><a href="#L-702"><span class="linenos">702</span></a>            <span class="c1"># tell the arduino that the trial begins now, becuase the rats are able to licks beginning now</span>
</span><span id="L-703"><a href="#L-703"><span class="linenos">703</span></a>            <span class="n">command</span> <span class="o">=</span> <span class="s2">&quot;TRIAL START</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
</span><span id="L-704"><a href="#L-704"><span class="linenos">704</span></a>            <span class="n">arduino_controller</span><span class="o">.</span><span class="n">send_command</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
</span><span id="L-705"><a href="#L-705"><span class="linenos">705</span></a>
</span><span id="L-706"><a href="#L-706"><span class="linenos">706</span></a>            <span class="n">main_gui</span><span class="o">.</span><span class="n">state_timer_text</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="p">(</span><span class="n">state</span> <span class="o">+</span> <span class="s2">&quot; Time:&quot;</span><span class="p">))</span>
</span><span id="L-707"><a href="#L-707"><span class="linenos">707</span></a>
</span><span id="L-708"><a href="#L-708"><span class="linenos">708</span></a>            <span class="c1"># state time starts now, as does trial because lick availabilty starts now</span>
</span><span id="L-709"><a href="#L-709"><span class="linenos">709</span></a>            <span class="n">exp_data</span><span class="o">.</span><span class="n">state_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="L-710"><a href="#L-710"><span class="linenos">710</span></a>            <span class="n">exp_data</span><span class="o">.</span><span class="n">trial_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="L-711"><a href="#L-711"><span class="linenos">711</span></a>
</span><span id="L-712"><a href="#L-712"><span class="linenos">712</span></a>            <span class="c1"># find the amount of time available for TTC for this trial</span>
</span><span id="L-713"><a href="#L-713"><span class="linenos">713</span></a>            <span class="n">time_to_contact</span> <span class="o">=</span> <span class="n">exp_data</span><span class="o">.</span><span class="n">program_schedule_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">logical_trial</span><span class="p">,</span> <span class="n">state</span><span class="p">]</span>
</span><span id="L-714"><a href="#L-714"><span class="linenos">714</span></a>
</span><span id="L-715"><a href="#L-715"><span class="linenos">715</span></a>            <span class="n">main_gui</span><span class="o">.</span><span class="n">update_on_state_change</span><span class="p">(</span><span class="n">time_to_contact</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="L-716"><a href="#L-716"><span class="linenos">716</span></a>
</span><span id="L-717"><a href="#L-717"><span class="linenos">717</span></a>            <span class="c1"># set a state change to occur after the time_to_contact time, this will be cancelled if the laser arduino</span>
</span><span id="L-718"><a href="#L-718"><span class="linenos">718</span></a>            <span class="c1"># sends 3 licks befote the TTC_time</span>
</span><span id="L-719"><a href="#L-719"><span class="linenos">719</span></a>            <span class="n">ttc_iti_transition</span> <span class="o">=</span> <span class="n">main_gui</span><span class="o">.</span><span class="n">after</span><span class="p">(</span>
</span><span id="L-720"><a href="#L-720"><span class="linenos">720</span></a>                <span class="nb">int</span><span class="p">(</span><span class="n">time_to_contact</span><span class="p">),</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">trigger</span><span class="p">(</span><span class="s2">&quot;TRIAL END&quot;</span><span class="p">)</span>
</span><span id="L-721"><a href="#L-721"><span class="linenos">721</span></a>            <span class="p">)</span>
</span><span id="L-722"><a href="#L-722"><span class="linenos">722</span></a>
</span><span id="L-723"><a href="#L-723"><span class="linenos">723</span></a>            <span class="c1"># store this task id so that it can be cancelled if the sample time transition is taken.</span>
</span><span id="L-724"><a href="#L-724"><span class="linenos">724</span></a>            <span class="n">main_gui</span><span class="o">.</span><span class="n">scheduled_tasks</span><span class="p">[</span><span class="s2">&quot;TTC TO TRIAL END&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ttc_iti_transition</span>
</span><span id="L-725"><a href="#L-725"><span class="linenos">725</span></a>
</span><span id="L-726"><a href="#L-726"><span class="linenos">726</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="L-727"><a href="#L-727"><span class="linenos">727</span></a>                <span class="sa">f</span><span class="s2">&quot;STATE CHANGE: TTC BEGINS NOW for trial -&gt; </span><span class="si">{</span><span class="n">exp_data</span><span class="o">.</span><span class="n">current_trial_number</span><span class="si">}</span><span class="s2">, completes in </span><span class="si">{</span><span class="n">time_to_contact</span><span class="si">}</span><span class="s2">.&quot;</span>
</span><span id="L-728"><a href="#L-728"><span class="linenos">728</span></a>            <span class="p">)</span>
</span><span id="L-729"><a href="#L-729"><span class="linenos">729</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-730"><a href="#L-730"><span class="linenos">730</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in TTC state start: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-731"><a href="#L-731"><span class="linenos">731</span></a>            <span class="k">raise</span>
</span><span id="L-732"><a href="#L-732"><span class="linenos">732</span></a>
</span><span id="L-733"><a href="#L-733"><span class="linenos">733</span></a>
</span><span id="L-734"><a href="#L-734"><span class="linenos">734</span></a><span class="k">class</span><span class="w"> </span><span class="nc">SampleTime</span><span class="p">:</span>
</span><span id="L-735"><a href="#L-735"><span class="linenos">735</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-736"><a href="#L-736"><span class="linenos">736</span></a><span class="sd">    Sample state class to handle setup of `Sample` state.</span>
</span><span id="L-737"><a href="#L-737"><span class="linenos">737</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-738"><a href="#L-738"><span class="linenos">738</span></a>
</span><span id="L-739"><a href="#L-739"><span class="linenos">739</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="L-740"><a href="#L-740"><span class="linenos">740</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-741"><a href="#L-741"><span class="linenos">741</span></a>        <span class="n">exp_data</span><span class="p">:</span> <span class="n">ExperimentProcessData</span><span class="p">,</span>
</span><span id="L-742"><a href="#L-742"><span class="linenos">742</span></a>        <span class="n">main_gui</span><span class="p">:</span> <span class="n">MainGUI</span><span class="p">,</span>
</span><span id="L-743"><a href="#L-743"><span class="linenos">743</span></a>        <span class="n">arduino_controller</span><span class="p">:</span> <span class="n">ArduinoManager</span><span class="p">,</span>
</span><span id="L-744"><a href="#L-744"><span class="linenos">744</span></a>        <span class="n">state</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="L-745"><a href="#L-745"><span class="linenos">745</span></a>        <span class="n">trigger</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="kc">None</span><span class="p">],</span>
</span><span id="L-746"><a href="#L-746"><span class="linenos">746</span></a>    <span class="p">):</span>
</span><span id="L-747"><a href="#L-747"><span class="linenos">747</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-748"><a href="#L-748"><span class="linenos">748</span></a><span class="sd">        This function transitions the program into the `SAMPLE` state. We can only reach this state from `TTC` if 3 licks or more are detected in `TTC`.</span>
</span><span id="L-749"><a href="#L-749"><span class="linenos">749</span></a>
</span><span id="L-750"><a href="#L-750"><span class="linenos">750</span></a><span class="sd">        We transition into `SAMPLE` by resetting licks to zero to count only sample time licks for trial, updating the actual `TTC` time taken before engaging in the</span>
</span><span id="L-751"><a href="#L-751"><span class="linenos">751</span></a><span class="sd">        trial, cancelling the scheduled `TTC` to `TRIAL END` transition, instructing Arduino to begin opening valves when licks occur, and updating state start time.</span>
</span><span id="L-752"><a href="#L-752"><span class="linenos">752</span></a>
</span><span id="L-753"><a href="#L-753"><span class="linenos">753</span></a><span class="sd">        Parameters</span>
</span><span id="L-754"><a href="#L-754"><span class="linenos">754</span></a><span class="sd">        ----------</span>
</span><span id="L-755"><a href="#L-755"><span class="linenos">755</span></a><span class="sd">        - **exp_data** (*ExperimentProcessData*): Reference to the `models.experiment_process_data`. Here we use it to get a reference to event_data to reset state time</span>
</span><span id="L-756"><a href="#L-756"><span class="linenos">756</span></a><span class="sd">        and find `SAMPLE` state time, reset trial lick data.</span>
</span><span id="L-757"><a href="#L-757"><span class="linenos">757</span></a><span class="sd">        - **main_gui** (*MainGUI*): A reference to `views.main_gui` MainGUI instance, this is used to update elements inside the GUI window(s). Here we use it to</span>
</span><span id="L-758"><a href="#L-758"><span class="linenos">758</span></a><span class="sd">        update GUI with new state info and cancel `TTC` to `TRIAL END` transition.</span>
</span><span id="L-759"><a href="#L-759"><span class="linenos">759</span></a><span class="sd">        - **arduino_controller** (*ArduinoManager*): A reference to the `controllers.arduino_control` instance, this is the method by which the Arduino is communicated</span>
</span><span id="L-760"><a href="#L-760"><span class="linenos">760</span></a><span class="sd">        with in the program. Used here to tell Arduino to begin opening valves when licks are detected.</span>
</span><span id="L-761"><a href="#L-761"><span class="linenos">761</span></a><span class="sd">        - **state** (*str*): State is used to update GUI with current state and grab the state duration time from the program schedule df.</span>
</span><span id="L-762"><a href="#L-762"><span class="linenos">762</span></a><span class="sd">        - **trigger** (*Callback method*): This callback is passed in so the `TRIAL END` state can be triggered after `SAMPLE` time.</span>
</span><span id="L-763"><a href="#L-763"><span class="linenos">763</span></a>
</span><span id="L-764"><a href="#L-764"><span class="linenos">764</span></a><span class="sd">        Methods</span>
</span><span id="L-765"><a href="#L-765"><span class="linenos">765</span></a><span class="sd">        -------</span>
</span><span id="L-766"><a href="#L-766"><span class="linenos">766</span></a><span class="sd">        - `update_ttc_time`(exp_data, logical_trial)</span>
</span><span id="L-767"><a href="#L-767"><span class="linenos">767</span></a><span class="sd">        Updates program schedule dataframe with actual time used in the `TTC` state.</span>
</span><span id="L-768"><a href="#L-768"><span class="linenos">768</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-769"><a href="#L-769"><span class="linenos">769</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-770"><a href="#L-770"><span class="linenos">770</span></a>            <span class="n">logical_trial</span> <span class="o">=</span> <span class="n">exp_data</span><span class="o">.</span><span class="n">current_trial_number</span> <span class="o">-</span> <span class="mi">1</span>
</span><span id="L-771"><a href="#L-771"><span class="linenos">771</span></a>
</span><span id="L-772"><a href="#L-772"><span class="linenos">772</span></a>            <span class="n">event_data</span> <span class="o">=</span> <span class="n">exp_data</span><span class="o">.</span><span class="n">event_data</span>
</span><span id="L-773"><a href="#L-773"><span class="linenos">773</span></a>
</span><span id="L-774"><a href="#L-774"><span class="linenos">774</span></a>            <span class="c1"># reset trial licks to count only sample licks</span>
</span><span id="L-775"><a href="#L-775"><span class="linenos">775</span></a>            <span class="n">event_data</span><span class="o">.</span><span class="n">side_one_licks</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-776"><a href="#L-776"><span class="linenos">776</span></a>            <span class="n">event_data</span><span class="o">.</span><span class="n">side_two_licks</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-777"><a href="#L-777"><span class="linenos">777</span></a>
</span><span id="L-778"><a href="#L-778"><span class="linenos">778</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">update_ttc_time</span><span class="p">(</span><span class="n">exp_data</span><span class="p">,</span> <span class="n">logical_trial</span><span class="p">)</span>
</span><span id="L-779"><a href="#L-779"><span class="linenos">779</span></a>
</span><span id="L-780"><a href="#L-780"><span class="linenos">780</span></a>            <span class="c1"># since the trial was engaged, cancel the planned transition from ttc to trial end. program has branched to new state</span>
</span><span id="L-781"><a href="#L-781"><span class="linenos">781</span></a>            <span class="n">main_gui</span><span class="o">.</span><span class="n">after_cancel</span><span class="p">(</span><span class="n">main_gui</span><span class="o">.</span><span class="n">scheduled_tasks</span><span class="p">[</span><span class="s2">&quot;TTC TO TRIAL END&quot;</span><span class="p">])</span>
</span><span id="L-782"><a href="#L-782"><span class="linenos">782</span></a>
</span><span id="L-783"><a href="#L-783"><span class="linenos">783</span></a>            <span class="c1"># Tell the laser arduino to begin accepting licks and opening valves</span>
</span><span id="L-784"><a href="#L-784"><span class="linenos">784</span></a>            <span class="c1"># resetting the lick counters for both spouts</span>
</span><span id="L-785"><a href="#L-785"><span class="linenos">785</span></a>            <span class="c1"># tell the laser to begin opening valves on licks</span>
</span><span id="L-786"><a href="#L-786"><span class="linenos">786</span></a>            <span class="n">open_command</span> <span class="o">=</span> <span class="s2">&quot;BEGIN OPEN VALVES</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
</span><span id="L-787"><a href="#L-787"><span class="linenos">787</span></a>            <span class="n">arduino_controller</span><span class="o">.</span><span class="n">send_command</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">open_command</span><span class="p">)</span>
</span><span id="L-788"><a href="#L-788"><span class="linenos">788</span></a>
</span><span id="L-789"><a href="#L-789"><span class="linenos">789</span></a>            <span class="n">exp_data</span><span class="o">.</span><span class="n">state_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="L-790"><a href="#L-790"><span class="linenos">790</span></a>
</span><span id="L-791"><a href="#L-791"><span class="linenos">791</span></a>            <span class="n">sample_interval_value</span> <span class="o">=</span> <span class="n">exp_data</span><span class="o">.</span><span class="n">program_schedule_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
</span><span id="L-792"><a href="#L-792"><span class="linenos">792</span></a>                <span class="n">logical_trial</span><span class="p">,</span> <span class="n">state</span>
</span><span id="L-793"><a href="#L-793"><span class="linenos">793</span></a>            <span class="p">]</span>
</span><span id="L-794"><a href="#L-794"><span class="linenos">794</span></a>
</span><span id="L-795"><a href="#L-795"><span class="linenos">795</span></a>            <span class="n">main_gui</span><span class="o">.</span><span class="n">update_on_state_change</span><span class="p">(</span><span class="n">sample_interval_value</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="L-796"><a href="#L-796"><span class="linenos">796</span></a>
</span><span id="L-797"><a href="#L-797"><span class="linenos">797</span></a>            <span class="n">main_gui</span><span class="o">.</span><span class="n">after</span><span class="p">(</span>
</span><span id="L-798"><a href="#L-798"><span class="linenos">798</span></a>                <span class="nb">int</span><span class="p">(</span><span class="n">sample_interval_value</span><span class="p">),</span>
</span><span id="L-799"><a href="#L-799"><span class="linenos">799</span></a>                <span class="k">lambda</span><span class="p">:</span> <span class="n">trigger</span><span class="p">(</span><span class="s2">&quot;TRIAL END&quot;</span><span class="p">),</span>
</span><span id="L-800"><a href="#L-800"><span class="linenos">800</span></a>            <span class="p">)</span>
</span><span id="L-801"><a href="#L-801"><span class="linenos">801</span></a>
</span><span id="L-802"><a href="#L-802"><span class="linenos">802</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="L-803"><a href="#L-803"><span class="linenos">803</span></a>                <span class="sa">f</span><span class="s2">&quot;STATE CHANGE: SAMPLE BEGINS NOW for trial-&gt; </span><span class="si">{</span><span class="n">exp_data</span><span class="o">.</span><span class="n">current_trial_number</span><span class="si">}</span><span class="s2">, completes in </span><span class="si">{</span><span class="n">sample_interval_value</span><span class="si">}</span><span class="s2">.&quot;</span>
</span><span id="L-804"><a href="#L-804"><span class="linenos">804</span></a>            <span class="p">)</span>
</span><span id="L-805"><a href="#L-805"><span class="linenos">805</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-806"><a href="#L-806"><span class="linenos">806</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
</span><span id="L-807"><a href="#L-807"><span class="linenos">807</span></a>                <span class="sa">f</span><span class="s2">&quot;Error in sample time trial no. </span><span class="si">{</span><span class="n">exp_data</span><span class="o">.</span><span class="n">current_trial_number</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-808"><a href="#L-808"><span class="linenos">808</span></a>            <span class="p">)</span>
</span><span id="L-809"><a href="#L-809"><span class="linenos">809</span></a>            <span class="k">raise</span>
</span><span id="L-810"><a href="#L-810"><span class="linenos">810</span></a>
</span><span id="L-811"><a href="#L-811"><span class="linenos">811</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_ttc_time</span><span class="p">(</span>
</span><span id="L-812"><a href="#L-812"><span class="linenos">812</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">exp_data</span><span class="p">:</span> <span class="n">ExperimentProcessData</span><span class="p">,</span> <span class="n">logical_trial</span><span class="p">:</span> <span class="nb">int</span>
</span><span id="L-813"><a href="#L-813"><span class="linenos">813</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-814"><a href="#L-814"><span class="linenos">814</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-815"><a href="#L-815"><span class="linenos">815</span></a><span class="sd">        If we reach this code that means the rat licked at least 3 times in `TTC` state</span>
</span><span id="L-816"><a href="#L-816"><span class="linenos">816</span></a><span class="sd">        so we didn&#39;t take all the allocated time. update program schedule window with actual time taken</span>
</span><span id="L-817"><a href="#L-817"><span class="linenos">817</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-818"><a href="#L-818"><span class="linenos">818</span></a>        <span class="n">ttc_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">exp_data</span><span class="o">.</span><span class="n">state_start_time</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
</span><span id="L-819"><a href="#L-819"><span class="linenos">819</span></a>
</span><span id="L-820"><a href="#L-820"><span class="linenos">820</span></a>        <span class="n">exp_data</span><span class="o">.</span><span class="n">program_schedule_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">logical_trial</span><span class="p">,</span> <span class="s2">&quot;TTC Actual&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span>
</span><span id="L-821"><a href="#L-821"><span class="linenos">821</span></a>            <span class="n">ttc_time</span><span class="p">,</span> <span class="mi">3</span>
</span><span id="L-822"><a href="#L-822"><span class="linenos">822</span></a>        <span class="p">)</span>
</span><span id="L-823"><a href="#L-823"><span class="linenos">823</span></a>
</span><span id="L-824"><a href="#L-824"><span class="linenos">824</span></a>
</span><span id="L-825"><a href="#L-825"><span class="linenos">825</span></a><span class="k">class</span><span class="w"> </span><span class="nc">TrialEnd</span><span class="p">:</span>
</span><span id="L-826"><a href="#L-826"><span class="linenos">826</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-827"><a href="#L-827"><span class="linenos">827</span></a><span class="sd">    Handle end of trial operations such as data storage and GUI updates with gathered trial data.</span>
</span><span id="L-828"><a href="#L-828"><span class="linenos">828</span></a>
</span><span id="L-829"><a href="#L-829"><span class="linenos">829</span></a><span class="sd">    Methods</span>
</span><span id="L-830"><a href="#L-830"><span class="linenos">830</span></a><span class="sd">    -------</span>
</span><span id="L-831"><a href="#L-831"><span class="linenos">831</span></a><span class="sd">    - `arduino_trial_end`(arduino_controller): Handle Arduino end of trial, send door up, stop accepting licks.</span>
</span><span id="L-832"><a href="#L-832"><span class="linenos">832</span></a><span class="sd">    - `end_trial`(exp_data: ExperimentProcessData): Determine if this trial is the last, if not increment trial number in `models.experiment_process_data`.</span>
</span><span id="L-833"><a href="#L-833"><span class="linenos">833</span></a><span class="sd">    - `handle_from_ttc`(logical_trial, trigger), exp_data): Call `update_ttc_actual` to update TTC time. Trigger transition to `ITI`.</span>
</span><span id="L-834"><a href="#L-834"><span class="linenos">834</span></a><span class="sd">    - `update_schedule_licks`(logical_trial, exp_data) -&gt; None: Update program schedule df with licks for this trial on each port.</span>
</span><span id="L-835"><a href="#L-835"><span class="linenos">835</span></a><span class="sd">    - `update_raster_plots`(exp_data, logical_trial, main_gui) -&gt; None: Update raster plot with licks from this trial.</span>
</span><span id="L-836"><a href="#L-836"><span class="linenos">836</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-837"><a href="#L-837"><span class="linenos">837</span></a>
</span><span id="L-838"><a href="#L-838"><span class="linenos">838</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="L-839"><a href="#L-839"><span class="linenos">839</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-840"><a href="#L-840"><span class="linenos">840</span></a>        <span class="n">exp_data</span><span class="p">:</span> <span class="n">ExperimentProcessData</span><span class="p">,</span>
</span><span id="L-841"><a href="#L-841"><span class="linenos">841</span></a>        <span class="n">main_gui</span><span class="p">:</span> <span class="n">MainGUI</span><span class="p">,</span>
</span><span id="L-842"><a href="#L-842"><span class="linenos">842</span></a>        <span class="n">arduino_controller</span><span class="p">:</span> <span class="n">ArduinoManager</span><span class="p">,</span>
</span><span id="L-843"><a href="#L-843"><span class="linenos">843</span></a>        <span class="n">prev_state</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="L-844"><a href="#L-844"><span class="linenos">844</span></a>        <span class="n">trigger</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="kc">None</span><span class="p">],</span>
</span><span id="L-845"><a href="#L-845"><span class="linenos">845</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-846"><a href="#L-846"><span class="linenos">846</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-847"><a href="#L-847"><span class="linenos">847</span></a><span class="sd">        This function transitions the program into the `SAMPLE` state. We can only reach this state from `TTC` if 3 licks or more are detected in `TTC`.</span>
</span><span id="L-848"><a href="#L-848"><span class="linenos">848</span></a>
</span><span id="L-849"><a href="#L-849"><span class="linenos">849</span></a><span class="sd">        We transition into `SAMPLE` by resetting licks to zero to count only sample time licks for trial, updating the actual `TTC` time taken before engaging in the</span>
</span><span id="L-850"><a href="#L-850"><span class="linenos">850</span></a><span class="sd">        trial, cancelling the scheduled `TTC` to `TRIAL END` transition, instructing Arduino to begin opening valves when licks occur, and updating state start time.</span>
</span><span id="L-851"><a href="#L-851"><span class="linenos">851</span></a>
</span><span id="L-852"><a href="#L-852"><span class="linenos">852</span></a><span class="sd">        Parameters</span>
</span><span id="L-853"><a href="#L-853"><span class="linenos">853</span></a><span class="sd">        ----------</span>
</span><span id="L-854"><a href="#L-854"><span class="linenos">854</span></a><span class="sd">        - **exp_data** (*ExperimentProcessData*): Reference to the `models.experiment_process_data`. Here we use it to update program df with trial licks, increment trial,</span>
</span><span id="L-855"><a href="#L-855"><span class="linenos">855</span></a><span class="sd">        check if current trial is the final trial, and other data operations.</span>
</span><span id="L-856"><a href="#L-856"><span class="linenos">856</span></a><span class="sd">        - **main_gui** (*MainGUI*): A reference to `views.main_gui` MainGUI instance, this is used to update elements inside the GUI window(s). Here we use it to</span>
</span><span id="L-857"><a href="#L-857"><span class="linenos">857</span></a><span class="sd">        update program schedule and populate raster plots with trial licks.</span>
</span><span id="L-858"><a href="#L-858"><span class="linenos">858</span></a><span class="sd">        - **arduino_controller** (*ArduinoManager*): A reference to the `controllers.arduino_control` instance, this is the method by which the Arduino is communicated</span>
</span><span id="L-859"><a href="#L-859"><span class="linenos">859</span></a><span class="sd">        with in the program. Used here to tell Arduino to stop opening valves when licks are detected.</span>
</span><span id="L-860"><a href="#L-860"><span class="linenos">860</span></a><span class="sd">        - **prev_state** (*str*): prev_state is used to decide which end of trial operations should be executed.</span>
</span><span id="L-861"><a href="#L-861"><span class="linenos">861</span></a><span class="sd">        - **trigger** (*Callback method*): This callback is passed in so the `ITI` state can be triggered after `TRIAL END` logic is complete.</span>
</span><span id="L-862"><a href="#L-862"><span class="linenos">862</span></a>
</span><span id="L-863"><a href="#L-863"><span class="linenos">863</span></a><span class="sd">        Methods</span>
</span><span id="L-864"><a href="#L-864"><span class="linenos">864</span></a><span class="sd">        -------</span>
</span><span id="L-865"><a href="#L-865"><span class="linenos">865</span></a><span class="sd">        - `update_ttc_time`(exp_data, logical_trial)</span>
</span><span id="L-866"><a href="#L-866"><span class="linenos">866</span></a><span class="sd">        Updates program schedule dataframe with actual time used in the `TTC` state.</span>
</span><span id="L-867"><a href="#L-867"><span class="linenos">867</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-868"><a href="#L-868"><span class="linenos">868</span></a>
</span><span id="L-869"><a href="#L-869"><span class="linenos">869</span></a>        <span class="c1"># use the same logical trial for all functions current_trial_number - 1</span>
</span><span id="L-870"><a href="#L-870"><span class="linenos">870</span></a>        <span class="c1"># to account for 1 indexing</span>
</span><span id="L-871"><a href="#L-871"><span class="linenos">871</span></a>        <span class="n">logical_trial</span> <span class="o">=</span> <span class="n">exp_data</span><span class="o">.</span><span class="n">current_trial_number</span> <span class="o">-</span> <span class="mi">1</span>
</span><span id="L-872"><a href="#L-872"><span class="linenos">872</span></a>
</span><span id="L-873"><a href="#L-873"><span class="linenos">873</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">arduino_trial_end</span><span class="p">(</span><span class="n">arduino_controller</span><span class="p">)</span>
</span><span id="L-874"><a href="#L-874"><span class="linenos">874</span></a>
</span><span id="L-875"><a href="#L-875"><span class="linenos">875</span></a>        <span class="c1">#######TRIAL NUMBER IS INCREMENTED INSIDE OF END_TRIAL#######</span>
</span><span id="L-876"><a href="#L-876"><span class="linenos">876</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_trial</span><span class="p">(</span><span class="n">exp_data</span><span class="p">):</span>
</span><span id="L-877"><a href="#L-877"><span class="linenos">877</span></a>            <span class="n">program_schedule</span> <span class="o">=</span> <span class="n">main_gui</span><span class="o">.</span><span class="n">windows</span><span class="p">[</span><span class="s2">&quot;Program Schedule&quot;</span><span class="p">]</span>
</span><span id="L-878"><a href="#L-878"><span class="linenos">878</span></a>            <span class="c1"># if the experiment is over update the licks for the final trial</span>
</span><span id="L-879"><a href="#L-879"><span class="linenos">879</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">update_schedule_licks</span><span class="p">(</span><span class="n">logical_trial</span><span class="p">,</span> <span class="n">exp_data</span><span class="p">)</span>
</span><span id="L-880"><a href="#L-880"><span class="linenos">880</span></a>            <span class="n">program_schedule</span><span class="o">.</span><span class="n">refresh_end_trial</span><span class="p">(</span><span class="n">logical_trial</span><span class="p">)</span>
</span><span id="L-881"><a href="#L-881"><span class="linenos">881</span></a>
</span><span id="L-882"><a href="#L-882"><span class="linenos">882</span></a>            <span class="n">trigger</span><span class="p">(</span><span class="s2">&quot;STOP&quot;</span><span class="p">)</span>
</span><span id="L-883"><a href="#L-883"><span class="linenos">883</span></a>            <span class="c1"># return from the call / kill the working thread</span>
</span><span id="L-884"><a href="#L-884"><span class="linenos">884</span></a>            <span class="k">return</span>
</span><span id="L-885"><a href="#L-885"><span class="linenos">885</span></a>
</span><span id="L-886"><a href="#L-886"><span class="linenos">886</span></a>        <span class="c1"># update licks for this trial</span>
</span><span id="L-887"><a href="#L-887"><span class="linenos">887</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">update_schedule_licks</span><span class="p">(</span><span class="n">logical_trial</span><span class="p">,</span> <span class="n">exp_data</span><span class="p">)</span>
</span><span id="L-888"><a href="#L-888"><span class="linenos">888</span></a>
</span><span id="L-889"><a href="#L-889"><span class="linenos">889</span></a>        <span class="k">match</span> <span class="n">prev_state</span><span class="p">:</span>
</span><span id="L-890"><a href="#L-890"><span class="linenos">890</span></a>            <span class="k">case</span> <span class="s2">&quot;TTC&quot;</span><span class="p">:</span>
</span><span id="L-891"><a href="#L-891"><span class="linenos">891</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">update_ttc_actual</span><span class="p">(</span><span class="n">logical_trial</span><span class="p">,</span> <span class="n">exp_data</span><span class="p">)</span>
</span><span id="L-892"><a href="#L-892"><span class="linenos">892</span></a>                <span class="n">trigger</span><span class="p">(</span><span class="s2">&quot;ITI&quot;</span><span class="p">)</span>
</span><span id="L-893"><a href="#L-893"><span class="linenos">893</span></a>            <span class="k">case</span> <span class="s2">&quot;SAMPLE&quot;</span><span class="p">:</span>
</span><span id="L-894"><a href="#L-894"><span class="linenos">894</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">update_raster_plots</span><span class="p">(</span><span class="n">exp_data</span><span class="p">,</span> <span class="n">logical_trial</span><span class="p">,</span> <span class="n">main_gui</span><span class="p">)</span>
</span><span id="L-895"><a href="#L-895"><span class="linenos">895</span></a>                <span class="n">trigger</span><span class="p">(</span><span class="s2">&quot;ITI&quot;</span><span class="p">)</span>
</span><span id="L-896"><a href="#L-896"><span class="linenos">896</span></a>            <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
</span><span id="L-897"><a href="#L-897"><span class="linenos">897</span></a>                <span class="c1"># cases not explicitly defined go here</span>
</span><span id="L-898"><a href="#L-898"><span class="linenos">898</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;UNDEFINED PREVIOUS TRANSITION IN TRIAL END STATE&quot;</span><span class="p">)</span>
</span><span id="L-899"><a href="#L-899"><span class="linenos">899</span></a>
</span><span id="L-900"><a href="#L-900"><span class="linenos">900</span></a>        <span class="n">main_gui</span><span class="o">.</span><span class="n">windows</span><span class="p">[</span><span class="s2">&quot;Program Schedule&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">refresh_end_trial</span><span class="p">(</span><span class="n">logical_trial</span><span class="p">)</span>
</span><span id="L-901"><a href="#L-901"><span class="linenos">901</span></a>
</span><span id="L-902"><a href="#L-902"><span class="linenos">902</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">arduino_trial_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arduino_controller</span><span class="p">:</span> <span class="n">ArduinoManager</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-903"><a href="#L-903"><span class="linenos">903</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-904"><a href="#L-904"><span class="linenos">904</span></a><span class="sd">        Send rig door up and tell Arduino to stop accepting licks.</span>
</span><span id="L-905"><a href="#L-905"><span class="linenos">905</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-906"><a href="#L-906"><span class="linenos">906</span></a>        <span class="n">up_command</span> <span class="o">=</span> <span class="s2">&quot;UP</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
</span><span id="L-907"><a href="#L-907"><span class="linenos">907</span></a>        <span class="n">arduino_controller</span><span class="o">.</span><span class="n">send_command</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">up_command</span><span class="p">)</span>
</span><span id="L-908"><a href="#L-908"><span class="linenos">908</span></a>
</span><span id="L-909"><a href="#L-909"><span class="linenos">909</span></a>        <span class="n">stop_command</span> <span class="o">=</span> <span class="s2">&quot;STOP OPEN VALVES</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
</span><span id="L-910"><a href="#L-910"><span class="linenos">910</span></a>        <span class="n">arduino_controller</span><span class="o">.</span><span class="n">send_command</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">stop_command</span><span class="p">)</span>
</span><span id="L-911"><a href="#L-911"><span class="linenos">911</span></a>
</span><span id="L-912"><a href="#L-912"><span class="linenos">912</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">end_trial</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exp_data</span><span class="p">:</span> <span class="n">ExperimentProcessData</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="L-913"><a href="#L-913"><span class="linenos">913</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-914"><a href="#L-914"><span class="linenos">914</span></a><span class="sd">        This method checks if current trial is the last trial. If it is, we return true to the calling code.</span>
</span><span id="L-915"><a href="#L-915"><span class="linenos">915</span></a><span class="sd">        If false, we increment current_trial_number, return false, and proceed to next trial.</span>
</span><span id="L-916"><a href="#L-916"><span class="linenos">916</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-917"><a href="#L-917"><span class="linenos">917</span></a>        <span class="n">current_trial</span> <span class="o">=</span> <span class="n">exp_data</span><span class="o">.</span><span class="n">current_trial_number</span>
</span><span id="L-918"><a href="#L-918"><span class="linenos">918</span></a>        <span class="n">max_trials</span> <span class="o">=</span> <span class="n">exp_data</span><span class="o">.</span><span class="n">exp_var_entries</span><span class="p">[</span><span class="s2">&quot;Num Trials&quot;</span><span class="p">]</span>
</span><span id="L-919"><a href="#L-919"><span class="linenos">919</span></a>
</span><span id="L-920"><a href="#L-920"><span class="linenos">920</span></a>        <span class="k">if</span> <span class="n">current_trial</span> <span class="o">&gt;=</span> <span class="n">max_trials</span><span class="p">:</span>
</span><span id="L-921"><a href="#L-921"><span class="linenos">921</span></a>            <span class="k">return</span> <span class="kc">True</span>
</span><span id="L-922"><a href="#L-922"><span class="linenos">922</span></a>
</span><span id="L-923"><a href="#L-923"><span class="linenos">923</span></a>        <span class="n">exp_data</span><span class="o">.</span><span class="n">current_trial_number</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-924"><a href="#L-924"><span class="linenos">924</span></a>        <span class="k">return</span> <span class="kc">False</span>
</span><span id="L-925"><a href="#L-925"><span class="linenos">925</span></a>
</span><span id="L-926"><a href="#L-926"><span class="linenos">926</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_ttc_actual</span><span class="p">(</span>
</span><span id="L-927"><a href="#L-927"><span class="linenos">927</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">logical_trial</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">exp_data</span><span class="p">:</span> <span class="n">ExperimentProcessData</span>
</span><span id="L-928"><a href="#L-928"><span class="linenos">928</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-929"><a href="#L-929"><span class="linenos">929</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-930"><a href="#L-930"><span class="linenos">930</span></a><span class="sd">        Update the actual ttc time take in the program schedule with the max time value,</span>
</span><span id="L-931"><a href="#L-931"><span class="linenos">931</span></a><span class="sd">        since we reached trial end we know we took the max time allowed</span>
</span><span id="L-932"><a href="#L-932"><span class="linenos">932</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-933"><a href="#L-933"><span class="linenos">933</span></a>        <span class="n">program_df</span> <span class="o">=</span> <span class="n">exp_data</span><span class="o">.</span><span class="n">program_schedule_df</span>
</span><span id="L-934"><a href="#L-934"><span class="linenos">934</span></a>
</span><span id="L-935"><a href="#L-935"><span class="linenos">935</span></a>        <span class="n">ttc_column_value</span> <span class="o">=</span> <span class="n">program_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">logical_trial</span><span class="p">,</span> <span class="s2">&quot;TTC&quot;</span><span class="p">]</span>
</span><span id="L-936"><a href="#L-936"><span class="linenos">936</span></a>        <span class="n">program_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">logical_trial</span><span class="p">,</span> <span class="s2">&quot;TTC Actual&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ttc_column_value</span>
</span><span id="L-937"><a href="#L-937"><span class="linenos">937</span></a>
</span><span id="L-938"><a href="#L-938"><span class="linenos">938</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_schedule_licks</span><span class="p">(</span>
</span><span id="L-939"><a href="#L-939"><span class="linenos">939</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">logical_trial</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">exp_data</span><span class="p">:</span> <span class="n">ExperimentProcessData</span>
</span><span id="L-940"><a href="#L-940"><span class="linenos">940</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-941"><a href="#L-941"><span class="linenos">941</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Update the licks for each side in the program schedule df for this trial&quot;&quot;&quot;</span>
</span><span id="L-942"><a href="#L-942"><span class="linenos">942</span></a>        <span class="n">program_df</span> <span class="o">=</span> <span class="n">exp_data</span><span class="o">.</span><span class="n">program_schedule_df</span>
</span><span id="L-943"><a href="#L-943"><span class="linenos">943</span></a>        <span class="n">event_data</span> <span class="o">=</span> <span class="n">exp_data</span><span class="o">.</span><span class="n">event_data</span>
</span><span id="L-944"><a href="#L-944"><span class="linenos">944</span></a>
</span><span id="L-945"><a href="#L-945"><span class="linenos">945</span></a>        <span class="n">licks_sd_one</span> <span class="o">=</span> <span class="n">event_data</span><span class="o">.</span><span class="n">side_one_licks</span>
</span><span id="L-946"><a href="#L-946"><span class="linenos">946</span></a>        <span class="n">licks_sd_two</span> <span class="o">=</span> <span class="n">event_data</span><span class="o">.</span><span class="n">side_two_licks</span>
</span><span id="L-947"><a href="#L-947"><span class="linenos">947</span></a>
</span><span id="L-948"><a href="#L-948"><span class="linenos">948</span></a>        <span class="n">program_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">logical_trial</span><span class="p">,</span> <span class="s2">&quot;Port 1 Licks&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">licks_sd_one</span>
</span><span id="L-949"><a href="#L-949"><span class="linenos">949</span></a>
</span><span id="L-950"><a href="#L-950"><span class="linenos">950</span></a>        <span class="n">program_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">logical_trial</span><span class="p">,</span> <span class="s2">&quot;Port 2 Licks&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">licks_sd_two</span>
</span><span id="L-951"><a href="#L-951"><span class="linenos">951</span></a>
</span><span id="L-952"><a href="#L-952"><span class="linenos">952</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_raster_plots</span><span class="p">(</span>
</span><span id="L-953"><a href="#L-953"><span class="linenos">953</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">exp_data</span><span class="p">:</span> <span class="n">ExperimentProcessData</span><span class="p">,</span> <span class="n">logical_trial</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">main_gui</span><span class="p">:</span> <span class="n">MainGUI</span>
</span><span id="L-954"><a href="#L-954"><span class="linenos">954</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-955"><a href="#L-955"><span class="linenos">955</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Instruct raster windows to update with new lick timestamps&quot;&quot;&quot;</span>
</span><span id="L-956"><a href="#L-956"><span class="linenos">956</span></a>        <span class="c1"># gather lick timestamp data from the event data model</span>
</span><span id="L-957"><a href="#L-957"><span class="linenos">957</span></a>        <span class="n">lick_stamps</span> <span class="o">=</span> <span class="n">exp_data</span><span class="o">.</span><span class="n">event_data</span><span class="o">.</span><span class="n">get_lick_timestamps</span><span class="p">(</span><span class="n">logical_trial</span><span class="p">)</span>
</span><span id="L-958"><a href="#L-958"><span class="linenos">958</span></a>
</span><span id="L-959"><a href="#L-959"><span class="linenos">959</span></a>        <span class="c1"># send it to raster windows</span>
</span><span id="L-960"><a href="#L-960"><span class="linenos">960</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">window</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">main_gui</span><span class="o">.</span><span class="n">windows</span><span class="p">[</span><span class="s2">&quot;Raster Plot&quot;</span><span class="p">]):</span>
</span><span id="L-961"><a href="#L-961"><span class="linenos">961</span></a>            <span class="n">window</span><span class="o">.</span><span class="n">update_plot</span><span class="p">(</span><span class="n">lick_stamps</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">logical_trial</span><span class="p">)</span>
</span></pre></div>


            </section>
                <section id="logger">
                    <div class="attr variable">
            <span class="name">logger</span>        =
<span class="default_value">&lt;RootLogger root (INFO)&gt;</span>

        
    </div>
    <a class="headerlink" href="#logger"></a>
    
            <div class="docstring"><p>Logger used to log program runtime details for debugging</p>
</div>


                </section>
                <section id="console_handler">
                    <div class="attr variable">
            <span class="name">console_handler</span>        =
<span class="default_value">&lt;StreamHandler (ERROR)&gt;</span>

        
    </div>
    <a class="headerlink" href="#console_handler"></a>
    
            <div class="docstring"><p>The console handler is used to print errors to the console</p>
</div>


                </section>
                <section id="RIG_CONFIG">
                    <div class="attr variable">
            <span class="name">RIG_CONFIG</span>        =
<span class="default_value">&#39;/home/blake/Documents/Photologic-Experiment-Rig-Files/assets/rig_config.toml&#39;</span>

        
    </div>
    <a class="headerlink" href="#RIG_CONFIG"></a>
    
            <div class="docstring"><p>This utilizes <code><a href="system_config.html">system_config</a></code> module to obtain a constant path for this machine regardless of OS to the Rig Files foler 
at the current users documents folder.</p>
</div>


                </section>
                <section id="DOOR_MOVE_TIME">
                    <div class="attr variable">
            <span class="name">DOOR_MOVE_TIME</span>        =
<span class="default_value">2338</span>

        
    </div>
    <a class="headerlink" href="#DOOR_MOVE_TIME"></a>
    
            <div class="docstring"><p>Constant value stored in the door_motor_config section of <code>RIG CONFIG</code> config</p>
</div>


                </section>
                <section id="now">
                    <div class="attr variable">
            <span class="name">now</span>        =
<span class="default_value">datetime.datetime(2025, 3, 28, 15, 42, 14, 295292)</span>

        
    </div>
    <a class="headerlink" href="#now"></a>
    
    

                </section>
                <section id="logfile_name">
                    <div class="attr variable">
            <span class="name">logfile_name</span>        =
<span class="default_value">&#39;15_42_14 - 2025-03-28 experiment log&#39;</span>

        
    </div>
    <a class="headerlink" href="#logfile_name"></a>
    
    

                </section>
                <section id="logfile_path">
                    <div class="attr variable">
            <span class="name">logfile_path</span>        =
<input id="logfile_path-view-value" class="view-value-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
            <label class="view-value-button pdoc-button" for="logfile_path-view-value"></label><span class="default_value">&#39;/home/blake/Documents/Photologic-Experiment-Rig-Files/logfiles/15_42_14 - 2025-03-28 experiment log.txt&#39;</span>

        
    </div>
    <a class="headerlink" href="#logfile_path"></a>
    
    

                </section>
                <section id="file_handler">
                    <div class="attr variable">
            <span class="name">file_handler</span>        =
<input id="file_handler-view-value" class="view-value-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
            <label class="view-value-button pdoc-button" for="file_handler-view-value"></label><span class="default_value">&lt;FileHandler /home/blake/Documents/Photologic-Experiment-Rig-Files/logfiles/15_42_14 - 2025-03-28 experiment log.txt (INFO)&gt;</span>

        
    </div>
    <a class="headerlink" href="#file_handler"></a>
    
    

                </section>
                <section id="StateMachine">
                            <input id="StateMachine-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">StateMachine</span>:

                <label class="view-source-button" for="StateMachine-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#StateMachine"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="StateMachine-71"><a href="#StateMachine-71"><span class="linenos"> 71</span></a><span class="k">class</span><span class="w"> </span><span class="nc">StateMachine</span><span class="p">:</span>
</span><span id="StateMachine-72"><a href="#StateMachine-72"><span class="linenos"> 72</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StateMachine-73"><a href="#StateMachine-73"><span class="linenos"> 73</span></a><span class="sd">    This class is the heart of the program. Defines and handles program state transitions.</span>
</span><span id="StateMachine-74"><a href="#StateMachine-74"><span class="linenos"> 74</span></a><span class="sd">    It coordinates co-operation between view (gui) and models (data). We inherit a TkinterApp class to include</span>
</span><span id="StateMachine-75"><a href="#StateMachine-75"><span class="linenos"> 75</span></a><span class="sd">    attributes of a tkinter app such as gui, arduino controller, etc.</span>
</span><span id="StateMachine-76"><a href="#StateMachine-76"><span class="linenos"> 76</span></a>
</span><span id="StateMachine-77"><a href="#StateMachine-77"><span class="linenos"> 77</span></a><span class="sd">    Attributes</span>
</span><span id="StateMachine-78"><a href="#StateMachine-78"><span class="linenos"> 78</span></a><span class="sd">    ----------</span>
</span><span id="StateMachine-79"><a href="#StateMachine-79"><span class="linenos"> 79</span></a><span class="sd">    - **exp_data** (*ExperimentProcessData*): An instance of `models.experiment_process_data` ExperimentProcessData, this attribute allows for access and</span>
</span><span id="StateMachine-80"><a href="#StateMachine-80"><span class="linenos"> 80</span></a><span class="sd">    modification of experiment variables, and access for to more specific models like `models.event_data` and `models.arduino_data`.</span>
</span><span id="StateMachine-81"><a href="#StateMachine-81"><span class="linenos"> 81</span></a><span class="sd">    - **arduino_controller** (*ArduinoManager*): An instance of `controllers.arduino_control` ArduinoManager, this allows for communication between this program and the</span>
</span><span id="StateMachine-82"><a href="#StateMachine-82"><span class="linenos"> 82</span></a><span class="sd">    Arduino board.</span>
</span><span id="StateMachine-83"><a href="#StateMachine-83"><span class="linenos"> 83</span></a><span class="sd">    - **main_gui** (*MainGUI*): An instance of `views.main_gui` MainGUI, this allows for the creation and modification of all GUI attributes in the program. All GUI windows</span>
</span><span id="StateMachine-84"><a href="#StateMachine-84"><span class="linenos"> 84</span></a><span class="sd">    are created and managed here.</span>
</span><span id="StateMachine-85"><a href="#StateMachine-85"><span class="linenos"> 85</span></a><span class="sd">    - **state** (*str*): Contains the current state the program is in.</span>
</span><span id="StateMachine-86"><a href="#StateMachine-86"><span class="linenos"> 86</span></a><span class="sd">    - **prev_state** (*str*): Contains the state the program was previously in. Useful to restore state in case of erroneous transitions.</span>
</span><span id="StateMachine-87"><a href="#StateMachine-87"><span class="linenos"> 87</span></a><span class="sd">    - **app_result** (*list*): Mutable list with one element. Is a reference to list defined in `main`.</span>
</span><span id="StateMachine-88"><a href="#StateMachine-88"><span class="linenos"> 88</span></a><span class="sd">    - **transitions**  (*dict*): Program state transition table.</span>
</span><span id="StateMachine-89"><a href="#StateMachine-89"><span class="linenos"> 89</span></a>
</span><span id="StateMachine-90"><a href="#StateMachine-90"><span class="linenos"> 90</span></a><span class="sd">    Methods</span>
</span><span id="StateMachine-91"><a href="#StateMachine-91"><span class="linenos"> 91</span></a><span class="sd">    -------</span>
</span><span id="StateMachine-92"><a href="#StateMachine-92"><span class="linenos"> 92</span></a><span class="sd">    - `trigger`(event)</span>
</span><span id="StateMachine-93"><a href="#StateMachine-93"><span class="linenos"> 93</span></a><span class="sd">        Handles state transition events. Decides if a transition is valid and warns user of destructive transitions. If valid,</span>
</span><span id="StateMachine-94"><a href="#StateMachine-94"><span class="linenos"> 94</span></a><span class="sd">        passes state to `execute_state` method.</span>
</span><span id="StateMachine-95"><a href="#StateMachine-95"><span class="linenos"> 95</span></a><span class="sd">    - `execute_state`(new_state: str)</span>
</span><span id="StateMachine-96"><a href="#StateMachine-96"><span class="linenos"> 96</span></a><span class="sd">        Takes the state passed from trigger event and decides appropriate action.</span>
</span><span id="StateMachine-97"><a href="#StateMachine-97"><span class="linenos"> 97</span></a><span class="sd">    - `process_queue`(data_queue)</span>
</span><span id="StateMachine-98"><a href="#StateMachine-98"><span class="linenos"> 98</span></a><span class="sd">        Processes incoming data from the Arduino board. Reads from queue that is added to by `controllers.arduino_control` module</span>
</span><span id="StateMachine-99"><a href="#StateMachine-99"><span class="linenos"> 99</span></a><span class="sd">        `listen_for_serial` method.</span>
</span><span id="StateMachine-100"><a href="#StateMachine-100"><span class="linenos">100</span></a><span class="sd">    - `reject_actions`(event)</span>
</span><span id="StateMachine-101"><a href="#StateMachine-101"><span class="linenos">101</span></a><span class="sd">        A static method that handles the rejection of actions that cannot be performed given a certain state transition.</span>
</span><span id="StateMachine-102"><a href="#StateMachine-102"><span class="linenos">102</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="StateMachine-103"><a href="#StateMachine-103"><span class="linenos">103</span></a>
</span><span id="StateMachine-104"><a href="#StateMachine-104"><span class="linenos">104</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result_container</span><span class="p">):</span>
</span><span id="StateMachine-105"><a href="#StateMachine-105"><span class="linenos">105</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;init method for `StateMachine`. Takes `main` module `result_container`.</span>
</span><span id="StateMachine-106"><a href="#StateMachine-106"><span class="linenos">106</span></a><span class="sd">        the &#39;super&#39; parent class which is the gui&quot;&quot;&quot;</span>
</span><span id="StateMachine-107"><a href="#StateMachine-107"><span class="linenos">107</span></a>
</span><span id="StateMachine-108"><a href="#StateMachine-108"><span class="linenos">108</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">exp_data</span> <span class="o">=</span> <span class="n">ExperimentProcessData</span><span class="p">()</span>
</span><span id="StateMachine-109"><a href="#StateMachine-109"><span class="linenos">109</span></a>
</span><span id="StateMachine-110"><a href="#StateMachine-110"><span class="linenos">110</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">arduino_controller</span> <span class="o">=</span> <span class="n">ArduinoManager</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exp_data</span><span class="p">)</span>
</span><span id="StateMachine-111"><a href="#StateMachine-111"><span class="linenos">111</span></a>
</span><span id="StateMachine-112"><a href="#StateMachine-112"><span class="linenos">112</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">main_gui</span> <span class="o">=</span> <span class="n">MainGUI</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exp_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">arduino_controller</span><span class="p">)</span>
</span><span id="StateMachine-113"><a href="#StateMachine-113"><span class="linenos">113</span></a>        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;GUI started successfully.&quot;</span><span class="p">)</span>
</span><span id="StateMachine-114"><a href="#StateMachine-114"><span class="linenos">114</span></a>
</span><span id="StateMachine-115"><a href="#StateMachine-115"><span class="linenos">115</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="s2">&quot;IDLE&quot;</span>
</span><span id="StateMachine-116"><a href="#StateMachine-116"><span class="linenos">116</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Default state for program is set at IDLE&quot;&quot;&quot;</span>
</span><span id="StateMachine-117"><a href="#StateMachine-117"><span class="linenos">117</span></a>
</span><span id="StateMachine-118"><a href="#StateMachine-118"><span class="linenos">118</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">prev_state</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="StateMachine-119"><a href="#StateMachine-119"><span class="linenos">119</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Default previous state for program is set to None. Utilized in `trigger`.&quot;&quot;&quot;</span>
</span><span id="StateMachine-120"><a href="#StateMachine-120"><span class="linenos">120</span></a>
</span><span id="StateMachine-121"><a href="#StateMachine-121"><span class="linenos">121</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">app_result</span> <span class="o">=</span> <span class="n">result_container</span>
</span><span id="StateMachine-122"><a href="#StateMachine-122"><span class="linenos">122</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StateMachine-123"><a href="#StateMachine-123"><span class="linenos">123</span></a><span class="sd">        Here we store a reference to `main` module `result_container` to store decision of whether to restart the </span>
</span><span id="StateMachine-124"><a href="#StateMachine-124"><span class="linenos">124</span></a><span class="sd">        program or just terminate the current instance.</span>
</span><span id="StateMachine-125"><a href="#StateMachine-125"><span class="linenos">125</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StateMachine-126"><a href="#StateMachine-126"><span class="linenos">126</span></a>
</span><span id="StateMachine-127"><a href="#StateMachine-127"><span class="linenos">127</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">transitions</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="StateMachine-128"><a href="#StateMachine-128"><span class="linenos">128</span></a>            <span class="p">(</span><span class="s2">&quot;IDLE&quot;</span><span class="p">,</span> <span class="s2">&quot;GENERATE SCHEDULE&quot;</span><span class="p">):</span> <span class="s2">&quot;GENERATE SCHEDULE&quot;</span><span class="p">,</span>
</span><span id="StateMachine-129"><a href="#StateMachine-129"><span class="linenos">129</span></a>            <span class="p">(</span>
</span><span id="StateMachine-130"><a href="#StateMachine-130"><span class="linenos">130</span></a>                <span class="s2">&quot;GENERATE SCHEDULE&quot;</span><span class="p">,</span>
</span><span id="StateMachine-131"><a href="#StateMachine-131"><span class="linenos">131</span></a>                <span class="s2">&quot;IDLE&quot;</span><span class="p">,</span>
</span><span id="StateMachine-132"><a href="#StateMachine-132"><span class="linenos">132</span></a>            <span class="p">):</span> <span class="s2">&quot;IDLE&quot;</span><span class="p">,</span>
</span><span id="StateMachine-133"><a href="#StateMachine-133"><span class="linenos">133</span></a>            <span class="p">(</span><span class="s2">&quot;IDLE&quot;</span><span class="p">,</span> <span class="s2">&quot;START&quot;</span><span class="p">):</span> <span class="s2">&quot;START PROGRAM&quot;</span><span class="p">,</span>
</span><span id="StateMachine-134"><a href="#StateMachine-134"><span class="linenos">134</span></a>            <span class="p">(</span><span class="s2">&quot;IDLE&quot;</span><span class="p">,</span> <span class="s2">&quot;RESET&quot;</span><span class="p">):</span> <span class="s2">&quot;RESET PROGRAM&quot;</span><span class="p">,</span>
</span><span id="StateMachine-135"><a href="#StateMachine-135"><span class="linenos">135</span></a>            <span class="p">(</span><span class="s2">&quot;STOP PROGRAM&quot;</span><span class="p">,</span> <span class="s2">&quot;RESET&quot;</span><span class="p">):</span> <span class="s2">&quot;RESET PROGRAM&quot;</span><span class="p">,</span>
</span><span id="StateMachine-136"><a href="#StateMachine-136"><span class="linenos">136</span></a>            <span class="p">(</span><span class="s2">&quot;START PROGRAM&quot;</span><span class="p">,</span> <span class="s2">&quot;ITI&quot;</span><span class="p">):</span> <span class="s2">&quot;ITI&quot;</span><span class="p">,</span>
</span><span id="StateMachine-137"><a href="#StateMachine-137"><span class="linenos">137</span></a>            <span class="p">(</span><span class="s2">&quot;ITI&quot;</span><span class="p">,</span> <span class="s2">&quot;DOOR OPEN&quot;</span><span class="p">):</span> <span class="s2">&quot;OPENING DOOR&quot;</span><span class="p">,</span>
</span><span id="StateMachine-138"><a href="#StateMachine-138"><span class="linenos">138</span></a>            <span class="p">(</span><span class="s2">&quot;OPENING DOOR&quot;</span><span class="p">,</span> <span class="s2">&quot;TTC&quot;</span><span class="p">):</span> <span class="s2">&quot;TTC&quot;</span><span class="p">,</span>
</span><span id="StateMachine-139"><a href="#StateMachine-139"><span class="linenos">139</span></a>            <span class="p">(</span><span class="s2">&quot;TTC&quot;</span><span class="p">,</span> <span class="s2">&quot;SAMPLE&quot;</span><span class="p">):</span> <span class="s2">&quot;SAMPLE&quot;</span><span class="p">,</span>  <span class="c1"># -&gt; if rat engages in trial</span>
</span><span id="StateMachine-140"><a href="#StateMachine-140"><span class="linenos">140</span></a>            <span class="p">(</span><span class="s2">&quot;TTC&quot;</span><span class="p">,</span> <span class="s2">&quot;TRIAL END&quot;</span><span class="p">):</span> <span class="s2">&quot;TRIAL END&quot;</span><span class="p">,</span>  <span class="c1"># -&gt; if rat does NOT engage</span>
</span><span id="StateMachine-141"><a href="#StateMachine-141"><span class="linenos">141</span></a>            <span class="p">(</span><span class="s2">&quot;SAMPLE&quot;</span><span class="p">,</span> <span class="s2">&quot;TRIAL END&quot;</span><span class="p">):</span> <span class="s2">&quot;TRIAL END&quot;</span><span class="p">,</span>
</span><span id="StateMachine-142"><a href="#StateMachine-142"><span class="linenos">142</span></a>            <span class="p">(</span><span class="s2">&quot;TRIAL END&quot;</span><span class="p">,</span> <span class="s2">&quot;ITI&quot;</span><span class="p">):</span> <span class="s2">&quot;ITI&quot;</span><span class="p">,</span>  <span class="c1"># -&gt; save trial data, update gui, door up</span>
</span><span id="StateMachine-143"><a href="#StateMachine-143"><span class="linenos">143</span></a>            <span class="p">(</span><span class="s2">&quot;ITI&quot;</span><span class="p">,</span> <span class="s2">&quot;STOP&quot;</span><span class="p">):</span> <span class="s2">&quot;STOP PROGRAM&quot;</span><span class="p">,</span>  <span class="c1"># can move to &#39;stop&#39; state in all states</span>
</span><span id="StateMachine-144"><a href="#StateMachine-144"><span class="linenos">144</span></a>            <span class="p">(</span><span class="s2">&quot;OPENING DOOR&quot;</span><span class="p">,</span> <span class="s2">&quot;STOP&quot;</span><span class="p">):</span> <span class="s2">&quot;STOP PROGRAM&quot;</span><span class="p">,</span>
</span><span id="StateMachine-145"><a href="#StateMachine-145"><span class="linenos">145</span></a>            <span class="p">(</span><span class="s2">&quot;TTC&quot;</span><span class="p">,</span> <span class="s2">&quot;STOP&quot;</span><span class="p">):</span> <span class="s2">&quot;STOP PROGRAM&quot;</span><span class="p">,</span>
</span><span id="StateMachine-146"><a href="#StateMachine-146"><span class="linenos">146</span></a>            <span class="p">(</span><span class="s2">&quot;SAMPLE&quot;</span><span class="p">,</span> <span class="s2">&quot;STOP&quot;</span><span class="p">):</span> <span class="s2">&quot;STOP PROGRAM&quot;</span><span class="p">,</span>
</span><span id="StateMachine-147"><a href="#StateMachine-147"><span class="linenos">147</span></a>            <span class="p">(</span><span class="s2">&quot;TRIAL END&quot;</span><span class="p">,</span> <span class="s2">&quot;STOP&quot;</span><span class="p">):</span> <span class="s2">&quot;STOP PROGRAM&quot;</span><span class="p">,</span>
</span><span id="StateMachine-148"><a href="#StateMachine-148"><span class="linenos">148</span></a>        <span class="p">}</span>
</span><span id="StateMachine-149"><a href="#StateMachine-149"><span class="linenos">149</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;State transition table defines all transitions that the program can possibly take&quot;&quot;&quot;</span>
</span><span id="StateMachine-150"><a href="#StateMachine-150"><span class="linenos">150</span></a>
</span><span id="StateMachine-151"><a href="#StateMachine-151"><span class="linenos">151</span></a>        <span class="c1"># don&#39;t start the mainloop until AFTER the gui is setup so that the app_result property</span>
</span><span id="StateMachine-152"><a href="#StateMachine-152"><span class="linenos">152</span></a>        <span class="c1"># is available if reset is desired</span>
</span><span id="StateMachine-153"><a href="#StateMachine-153"><span class="linenos">153</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">main_gui</span><span class="o">.</span><span class="n">mainloop</span><span class="p">()</span>
</span><span id="StateMachine-154"><a href="#StateMachine-154"><span class="linenos">154</span></a>
</span><span id="StateMachine-155"><a href="#StateMachine-155"><span class="linenos">155</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">trigger</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
</span><span id="StateMachine-156"><a href="#StateMachine-156"><span class="linenos">156</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StateMachine-157"><a href="#StateMachine-157"><span class="linenos">157</span></a><span class="sd">        This function takes a requested state and decides if the transition from this state is allowed.</span>
</span><span id="StateMachine-158"><a href="#StateMachine-158"><span class="linenos">158</span></a>
</span><span id="StateMachine-159"><a href="#StateMachine-159"><span class="linenos">159</span></a><span class="sd">        Parameters</span>
</span><span id="StateMachine-160"><a href="#StateMachine-160"><span class="linenos">160</span></a><span class="sd">        ----------</span>
</span><span id="StateMachine-161"><a href="#StateMachine-161"><span class="linenos">161</span></a><span class="sd">        - **event** (*str*): Contains the desired state to move to.</span>
</span><span id="StateMachine-162"><a href="#StateMachine-162"><span class="linenos">162</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StateMachine-163"><a href="#StateMachine-163"><span class="linenos">163</span></a>
</span><span id="StateMachine-164"><a href="#StateMachine-164"><span class="linenos">164</span></a>        <span class="n">transition</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="n">event</span><span class="p">)</span>
</span><span id="StateMachine-165"><a href="#StateMachine-165"><span class="linenos">165</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">prev_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span>
</span><span id="StateMachine-166"><a href="#StateMachine-166"><span class="linenos">166</span></a>        <span class="n">new_state</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="StateMachine-167"><a href="#StateMachine-167"><span class="linenos">167</span></a>
</span><span id="StateMachine-168"><a href="#StateMachine-168"><span class="linenos">168</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;state transition -&gt; </span><span class="si">{</span><span class="n">transition</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="StateMachine-169"><a href="#StateMachine-169"><span class="linenos">169</span></a>
</span><span id="StateMachine-170"><a href="#StateMachine-170"><span class="linenos">170</span></a>        <span class="c1"># checking if the attemped transition is valid according to the table</span>
</span><span id="StateMachine-171"><a href="#StateMachine-171"><span class="linenos">171</span></a>        <span class="k">if</span> <span class="n">transition</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">transitions</span><span class="p">:</span>
</span><span id="StateMachine-172"><a href="#StateMachine-172"><span class="linenos">172</span></a>            <span class="n">new_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transitions</span><span class="p">[</span><span class="n">transition</span><span class="p">]</span>
</span><span id="StateMachine-173"><a href="#StateMachine-173"><span class="linenos">173</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="StateMachine-174"><a href="#StateMachine-174"><span class="linenos">174</span></a>            <span class="c1"># if the key is not in the transition table, handle rejection based on desired state</span>
</span><span id="StateMachine-175"><a href="#StateMachine-175"><span class="linenos">175</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">reject_actions</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
</span><span id="StateMachine-176"><a href="#StateMachine-176"><span class="linenos">176</span></a>
</span><span id="StateMachine-177"><a href="#StateMachine-177"><span class="linenos">177</span></a>        <span class="c1"># if the key was in the transition table, and the new state wants to reset the program, that means this is a valid action at this time. MAKE SURE the</span>
</span><span id="StateMachine-178"><a href="#StateMachine-178"><span class="linenos">178</span></a>        <span class="c1"># user REALLY wants to do that</span>
</span><span id="StateMachine-179"><a href="#StateMachine-179"><span class="linenos">179</span></a>        <span class="k">if</span> <span class="n">new_state</span> <span class="o">==</span> <span class="s2">&quot;RESET PROGRAM&quot;</span><span class="p">:</span>
</span><span id="StateMachine-180"><a href="#StateMachine-180"><span class="linenos">180</span></a>            <span class="n">response</span> <span class="o">=</span> <span class="n">GUIUtils</span><span class="o">.</span><span class="n">askyesno</span><span class="p">(</span>
</span><span id="StateMachine-181"><a href="#StateMachine-181"><span class="linenos">181</span></a>                <span class="s2">&quot;============WARNING============&quot;</span><span class="p">,</span>
</span><span id="StateMachine-182"><a href="#StateMachine-182"><span class="linenos">182</span></a>                <span class="s2">&quot;THIS ACTION WILL ERASE ALL DATA CURRENTLY STORED FOR THIS EXPERIMENT... ARE YOU SURE YOU WANT TO CONTINUE?&quot;</span><span class="p">,</span>
</span><span id="StateMachine-183"><a href="#StateMachine-183"><span class="linenos">183</span></a>            <span class="p">)</span>
</span><span id="StateMachine-184"><a href="#StateMachine-184"><span class="linenos">184</span></a>            <span class="c1"># if true, go ahead with the reset, if false return to prev_state</span>
</span><span id="StateMachine-185"><a href="#StateMachine-185"><span class="linenos">185</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="p">:</span>
</span><span id="StateMachine-186"><a href="#StateMachine-186"><span class="linenos">186</span></a>                <span class="n">new_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_state</span>
</span><span id="StateMachine-187"><a href="#StateMachine-187"><span class="linenos">187</span></a>
</span><span id="StateMachine-188"><a href="#StateMachine-188"><span class="linenos">188</span></a>        <span class="c1"># if attempt to start program with no experiment schedule, tell user to do that</span>
</span><span id="StateMachine-189"><a href="#StateMachine-189"><span class="linenos">189</span></a>        <span class="k">if</span> <span class="n">new_state</span> <span class="o">==</span> <span class="s2">&quot;START PROGRAM&quot;</span><span class="p">:</span>
</span><span id="StateMachine-190"><a href="#StateMachine-190"><span class="linenos">190</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_data</span><span class="o">.</span><span class="n">program_schedule_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
</span><span id="StateMachine-191"><a href="#StateMachine-191"><span class="linenos">191</span></a>                <span class="n">GUIUtils</span><span class="o">.</span><span class="n">display_error</span><span class="p">(</span>
</span><span id="StateMachine-192"><a href="#StateMachine-192"><span class="linenos">192</span></a>                    <span class="s2">&quot;Experiement Schedule Not Yet Generated!!!&quot;</span><span class="p">,</span>
</span><span id="StateMachine-193"><a href="#StateMachine-193"><span class="linenos">193</span></a>                    <span class="s2">&quot;Please generate the program schedule before attempting to start the experiment. You can do this by clicking the &#39;Valve / Stimuli&#39; button in the main screen.&quot;</span><span class="p">,</span>
</span><span id="StateMachine-194"><a href="#StateMachine-194"><span class="linenos">194</span></a>                <span class="p">)</span>
</span><span id="StateMachine-195"><a href="#StateMachine-195"><span class="linenos">195</span></a>                <span class="n">new_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_state</span>
</span><span id="StateMachine-196"><a href="#StateMachine-196"><span class="linenos">196</span></a>
</span><span id="StateMachine-197"><a href="#StateMachine-197"><span class="linenos">197</span></a>        <span class="c1"># if we have a new state, perform the associated action for that state</span>
</span><span id="StateMachine-198"><a href="#StateMachine-198"><span class="linenos">198</span></a>        <span class="k">if</span> <span class="n">new_state</span><span class="p">:</span>
</span><span id="StateMachine-199"><a href="#StateMachine-199"><span class="linenos">199</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;new state -&gt; </span><span class="si">{</span><span class="n">new_state</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="StateMachine-200"><a href="#StateMachine-200"><span class="linenos">200</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">execute_state</span><span class="p">(</span><span class="n">new_state</span><span class="p">)</span>
</span><span id="StateMachine-201"><a href="#StateMachine-201"><span class="linenos">201</span></a>
</span><span id="StateMachine-202"><a href="#StateMachine-202"><span class="linenos">202</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">execute_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_state</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="StateMachine-203"><a href="#StateMachine-203"><span class="linenos">203</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StateMachine-204"><a href="#StateMachine-204"><span class="linenos">204</span></a><span class="sd">        Executes the action corresponding to new_state. if the action is defined under state_target,</span>
</span><span id="StateMachine-205"><a href="#StateMachine-205"><span class="linenos">205</span></a><span class="sd">        that action will be taken in a new thread to avoid overloading the main tkinter thread. otherwise</span>
</span><span id="StateMachine-206"><a href="#StateMachine-206"><span class="linenos">206</span></a><span class="sd">        it is executed immediately in the main thread.</span>
</span><span id="StateMachine-207"><a href="#StateMachine-207"><span class="linenos">207</span></a>
</span><span id="StateMachine-208"><a href="#StateMachine-208"><span class="linenos">208</span></a><span class="sd">        Parameters</span>
</span><span id="StateMachine-209"><a href="#StateMachine-209"><span class="linenos">209</span></a><span class="sd">        ----------</span>
</span><span id="StateMachine-210"><a href="#StateMachine-210"><span class="linenos">210</span></a><span class="sd">        - **new_state** (*str*): Contains the desired state to move to. Used to locate the desired action.</span>
</span><span id="StateMachine-211"><a href="#StateMachine-211"><span class="linenos">211</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StateMachine-212"><a href="#StateMachine-212"><span class="linenos">212</span></a>
</span><span id="StateMachine-213"><a href="#StateMachine-213"><span class="linenos">213</span></a>        <span class="n">thread_target</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="StateMachine-214"><a href="#StateMachine-214"><span class="linenos">214</span></a>
</span><span id="StateMachine-215"><a href="#StateMachine-215"><span class="linenos">215</span></a>        <span class="k">match</span> <span class="n">new_state</span><span class="p">:</span>
</span><span id="StateMachine-216"><a href="#StateMachine-216"><span class="linenos">216</span></a>            <span class="k">case</span> <span class="s2">&quot;START PROGRAM&quot;</span><span class="p">:</span>
</span><span id="StateMachine-217"><a href="#StateMachine-217"><span class="linenos">217</span></a>
</span><span id="StateMachine-218"><a href="#StateMachine-218"><span class="linenos">218</span></a>                <span class="k">def</span><span class="w"> </span><span class="nf">thread_target</span><span class="p">():</span>
</span><span id="StateMachine-219"><a href="#StateMachine-219"><span class="linenos">219</span></a>                    <span class="n">StartProgram</span><span class="p">(</span>
</span><span id="StateMachine-220"><a href="#StateMachine-220"><span class="linenos">220</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">exp_data</span><span class="p">,</span>
</span><span id="StateMachine-221"><a href="#StateMachine-221"><span class="linenos">221</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">main_gui</span><span class="p">,</span>
</span><span id="StateMachine-222"><a href="#StateMachine-222"><span class="linenos">222</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">arduino_controller</span><span class="p">,</span>
</span><span id="StateMachine-223"><a href="#StateMachine-223"><span class="linenos">223</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">,</span>
</span><span id="StateMachine-224"><a href="#StateMachine-224"><span class="linenos">224</span></a>                    <span class="p">)</span>
</span><span id="StateMachine-225"><a href="#StateMachine-225"><span class="linenos">225</span></a>            <span class="k">case</span> <span class="s2">&quot;RESET PROGRAM&quot;</span><span class="p">:</span>
</span><span id="StateMachine-226"><a href="#StateMachine-226"><span class="linenos">226</span></a>                <span class="n">ResetProgram</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">main_gui</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">app_result</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">arduino_controller</span><span class="p">)</span>
</span><span id="StateMachine-227"><a href="#StateMachine-227"><span class="linenos">227</span></a>            <span class="k">case</span> <span class="s2">&quot;STOP PROGRAM&quot;</span><span class="p">:</span>
</span><span id="StateMachine-228"><a href="#StateMachine-228"><span class="linenos">228</span></a>                <span class="n">StopProgram</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">main_gui</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">arduino_controller</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">)</span>
</span><span id="StateMachine-229"><a href="#StateMachine-229"><span class="linenos">229</span></a>            <span class="k">case</span> <span class="s2">&quot;GENERATE SCHEDULE&quot;</span><span class="p">:</span>
</span><span id="StateMachine-230"><a href="#StateMachine-230"><span class="linenos">230</span></a>                <span class="c1"># because this will run in main thread, we need to return early to avoid self.state</span>
</span><span id="StateMachine-231"><a href="#StateMachine-231"><span class="linenos">231</span></a>                <span class="c1"># assignment confusion</span>
</span><span id="StateMachine-232"><a href="#StateMachine-232"><span class="linenos">232</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">new_state</span>
</span><span id="StateMachine-233"><a href="#StateMachine-233"><span class="linenos">233</span></a>                <span class="n">GenerateSchedule</span><span class="p">(</span>
</span><span id="StateMachine-234"><a href="#StateMachine-234"><span class="linenos">234</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">main_gui</span><span class="p">,</span>
</span><span id="StateMachine-235"><a href="#StateMachine-235"><span class="linenos">235</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">arduino_controller</span><span class="p">,</span>
</span><span id="StateMachine-236"><a href="#StateMachine-236"><span class="linenos">236</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">process_queue</span><span class="p">,</span>
</span><span id="StateMachine-237"><a href="#StateMachine-237"><span class="linenos">237</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">,</span>
</span><span id="StateMachine-238"><a href="#StateMachine-238"><span class="linenos">238</span></a>                <span class="p">)</span>
</span><span id="StateMachine-239"><a href="#StateMachine-239"><span class="linenos">239</span></a>                <span class="k">return</span>
</span><span id="StateMachine-240"><a href="#StateMachine-240"><span class="linenos">240</span></a>            <span class="k">case</span> <span class="s2">&quot;ITI&quot;</span><span class="p">:</span>
</span><span id="StateMachine-241"><a href="#StateMachine-241"><span class="linenos">241</span></a>
</span><span id="StateMachine-242"><a href="#StateMachine-242"><span class="linenos">242</span></a>                <span class="k">def</span><span class="w"> </span><span class="nf">thread_target</span><span class="p">():</span>
</span><span id="StateMachine-243"><a href="#StateMachine-243"><span class="linenos">243</span></a>                    <span class="n">InitialTimeInterval</span><span class="p">(</span>
</span><span id="StateMachine-244"><a href="#StateMachine-244"><span class="linenos">244</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">exp_data</span><span class="p">,</span>
</span><span id="StateMachine-245"><a href="#StateMachine-245"><span class="linenos">245</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">main_gui</span><span class="p">,</span>
</span><span id="StateMachine-246"><a href="#StateMachine-246"><span class="linenos">246</span></a>                        <span class="n">new_state</span><span class="p">,</span>
</span><span id="StateMachine-247"><a href="#StateMachine-247"><span class="linenos">247</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">,</span>
</span><span id="StateMachine-248"><a href="#StateMachine-248"><span class="linenos">248</span></a>                    <span class="p">)</span>
</span><span id="StateMachine-249"><a href="#StateMachine-249"><span class="linenos">249</span></a>            <span class="k">case</span> <span class="s2">&quot;OPENING DOOR&quot;</span><span class="p">:</span>
</span><span id="StateMachine-250"><a href="#StateMachine-250"><span class="linenos">250</span></a>
</span><span id="StateMachine-251"><a href="#StateMachine-251"><span class="linenos">251</span></a>                <span class="k">def</span><span class="w"> </span><span class="nf">thread_target</span><span class="p">():</span>
</span><span id="StateMachine-252"><a href="#StateMachine-252"><span class="linenos">252</span></a>                    <span class="n">OpeningDoor</span><span class="p">(</span>
</span><span id="StateMachine-253"><a href="#StateMachine-253"><span class="linenos">253</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">exp_data</span><span class="p">,</span>
</span><span id="StateMachine-254"><a href="#StateMachine-254"><span class="linenos">254</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">main_gui</span><span class="p">,</span>
</span><span id="StateMachine-255"><a href="#StateMachine-255"><span class="linenos">255</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">arduino_controller</span><span class="p">,</span>
</span><span id="StateMachine-256"><a href="#StateMachine-256"><span class="linenos">256</span></a>                        <span class="n">new_state</span><span class="p">,</span>
</span><span id="StateMachine-257"><a href="#StateMachine-257"><span class="linenos">257</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">,</span>
</span><span id="StateMachine-258"><a href="#StateMachine-258"><span class="linenos">258</span></a>                    <span class="p">)</span>
</span><span id="StateMachine-259"><a href="#StateMachine-259"><span class="linenos">259</span></a>            <span class="k">case</span> <span class="s2">&quot;TTC&quot;</span><span class="p">:</span>
</span><span id="StateMachine-260"><a href="#StateMachine-260"><span class="linenos">260</span></a>
</span><span id="StateMachine-261"><a href="#StateMachine-261"><span class="linenos">261</span></a>                <span class="k">def</span><span class="w"> </span><span class="nf">thread_target</span><span class="p">():</span>
</span><span id="StateMachine-262"><a href="#StateMachine-262"><span class="linenos">262</span></a>                    <span class="n">TimeToContact</span><span class="p">(</span>
</span><span id="StateMachine-263"><a href="#StateMachine-263"><span class="linenos">263</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">exp_data</span><span class="p">,</span>
</span><span id="StateMachine-264"><a href="#StateMachine-264"><span class="linenos">264</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">arduino_controller</span><span class="p">,</span>
</span><span id="StateMachine-265"><a href="#StateMachine-265"><span class="linenos">265</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">main_gui</span><span class="p">,</span>
</span><span id="StateMachine-266"><a href="#StateMachine-266"><span class="linenos">266</span></a>                        <span class="n">new_state</span><span class="p">,</span>
</span><span id="StateMachine-267"><a href="#StateMachine-267"><span class="linenos">267</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">,</span>
</span><span id="StateMachine-268"><a href="#StateMachine-268"><span class="linenos">268</span></a>                    <span class="p">)</span>
</span><span id="StateMachine-269"><a href="#StateMachine-269"><span class="linenos">269</span></a>            <span class="k">case</span> <span class="s2">&quot;SAMPLE&quot;</span><span class="p">:</span>
</span><span id="StateMachine-270"><a href="#StateMachine-270"><span class="linenos">270</span></a>
</span><span id="StateMachine-271"><a href="#StateMachine-271"><span class="linenos">271</span></a>                <span class="k">def</span><span class="w"> </span><span class="nf">thread_target</span><span class="p">():</span>
</span><span id="StateMachine-272"><a href="#StateMachine-272"><span class="linenos">272</span></a>                    <span class="n">SampleTime</span><span class="p">(</span>
</span><span id="StateMachine-273"><a href="#StateMachine-273"><span class="linenos">273</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">exp_data</span><span class="p">,</span>
</span><span id="StateMachine-274"><a href="#StateMachine-274"><span class="linenos">274</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">main_gui</span><span class="p">,</span>
</span><span id="StateMachine-275"><a href="#StateMachine-275"><span class="linenos">275</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">arduino_controller</span><span class="p">,</span>
</span><span id="StateMachine-276"><a href="#StateMachine-276"><span class="linenos">276</span></a>                        <span class="n">new_state</span><span class="p">,</span>
</span><span id="StateMachine-277"><a href="#StateMachine-277"><span class="linenos">277</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">,</span>
</span><span id="StateMachine-278"><a href="#StateMachine-278"><span class="linenos">278</span></a>                    <span class="p">)</span>
</span><span id="StateMachine-279"><a href="#StateMachine-279"><span class="linenos">279</span></a>            <span class="k">case</span> <span class="s2">&quot;TRIAL END&quot;</span><span class="p">:</span>
</span><span id="StateMachine-280"><a href="#StateMachine-280"><span class="linenos">280</span></a>
</span><span id="StateMachine-281"><a href="#StateMachine-281"><span class="linenos">281</span></a>                <span class="k">def</span><span class="w"> </span><span class="nf">thread_target</span><span class="p">():</span>
</span><span id="StateMachine-282"><a href="#StateMachine-282"><span class="linenos">282</span></a>                    <span class="n">TrialEnd</span><span class="p">(</span>
</span><span id="StateMachine-283"><a href="#StateMachine-283"><span class="linenos">283</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">exp_data</span><span class="p">,</span>
</span><span id="StateMachine-284"><a href="#StateMachine-284"><span class="linenos">284</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">main_gui</span><span class="p">,</span>
</span><span id="StateMachine-285"><a href="#StateMachine-285"><span class="linenos">285</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">arduino_controller</span><span class="p">,</span>
</span><span id="StateMachine-286"><a href="#StateMachine-286"><span class="linenos">286</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">prev_state</span><span class="p">,</span>
</span><span id="StateMachine-287"><a href="#StateMachine-287"><span class="linenos">287</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">,</span>
</span><span id="StateMachine-288"><a href="#StateMachine-288"><span class="linenos">288</span></a>                    <span class="p">)</span>
</span><span id="StateMachine-289"><a href="#StateMachine-289"><span class="linenos">289</span></a>
</span><span id="StateMachine-290"><a href="#StateMachine-290"><span class="linenos">290</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">prev_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span>
</span><span id="StateMachine-291"><a href="#StateMachine-291"><span class="linenos">291</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">new_state</span>
</span><span id="StateMachine-292"><a href="#StateMachine-292"><span class="linenos">292</span></a>
</span><span id="StateMachine-293"><a href="#StateMachine-293"><span class="linenos">293</span></a>        <span class="k">if</span> <span class="n">thread_target</span><span class="p">:</span>
</span><span id="StateMachine-294"><a href="#StateMachine-294"><span class="linenos">294</span></a>            <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">thread_target</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span><span id="StateMachine-295"><a href="#StateMachine-295"><span class="linenos">295</span></a>
</span><span id="StateMachine-296"><a href="#StateMachine-296"><span class="linenos">296</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">process_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_queue</span><span class="p">:</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="StateMachine-297"><a href="#StateMachine-297"><span class="linenos">297</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StateMachine-298"><a href="#StateMachine-298"><span class="linenos">298</span></a><span class="sd">        Process the data queue. Pulls in data from the thread that is reading data from the arduinos constantly. if there is anything</span>
</span><span id="StateMachine-299"><a href="#StateMachine-299"><span class="linenos">299</span></a><span class="sd">        in the queue at time of function call, we will stay here until its all been dealt with.</span>
</span><span id="StateMachine-300"><a href="#StateMachine-300"><span class="linenos">300</span></a>
</span><span id="StateMachine-301"><a href="#StateMachine-301"><span class="linenos">301</span></a><span class="sd">        Parameters</span>
</span><span id="StateMachine-302"><a href="#StateMachine-302"><span class="linenos">302</span></a><span class="sd">        ----------</span>
</span><span id="StateMachine-303"><a href="#StateMachine-303"><span class="linenos">303</span></a><span class="sd">        - **data_queue** (*tuple[str, str]*): This is a shared queue between a thread initiated in the `controllers.arduino_control` module&#39;s</span>
</span><span id="StateMachine-304"><a href="#StateMachine-304"><span class="linenos">304</span></a><span class="sd">        `listen_for_serial` method. That thread constantly reads info from Arduino so it is not missed, and the main thread calls this process method</span>
</span><span id="StateMachine-305"><a href="#StateMachine-305"><span class="linenos">305</span></a><span class="sd">        to process accumulated data to avoid overloading the thread.</span>
</span><span id="StateMachine-306"><a href="#StateMachine-306"><span class="linenos">306</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StateMachine-307"><a href="#StateMachine-307"><span class="linenos">307</span></a>
</span><span id="StateMachine-308"><a href="#StateMachine-308"><span class="linenos">308</span></a>        <span class="n">arduino_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_data</span><span class="o">.</span><span class="n">arduino_data</span>
</span><span id="StateMachine-309"><a href="#StateMachine-309"><span class="linenos">309</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="StateMachine-310"><a href="#StateMachine-310"><span class="linenos">310</span></a>            <span class="k">while</span> <span class="ow">not</span> <span class="n">data_queue</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
</span><span id="StateMachine-311"><a href="#StateMachine-311"><span class="linenos">311</span></a>                <span class="n">source</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">data_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
</span><span id="StateMachine-312"><a href="#StateMachine-312"><span class="linenos">312</span></a>                <span class="n">arduino_data</span><span class="o">.</span><span class="n">process_data</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">)</span>
</span><span id="StateMachine-313"><a href="#StateMachine-313"><span class="linenos">313</span></a>
</span><span id="StateMachine-314"><a href="#StateMachine-314"><span class="linenos">314</span></a>            <span class="c1"># run this command every 250ms</span>
</span><span id="StateMachine-315"><a href="#StateMachine-315"><span class="linenos">315</span></a>            <span class="n">queue_ps_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">main_gui</span><span class="o">.</span><span class="n">after</span><span class="p">(</span>
</span><span id="StateMachine-316"><a href="#StateMachine-316"><span class="linenos">316</span></a>                <span class="mi">250</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_queue</span><span class="p">(</span><span class="n">data_queue</span><span class="p">)</span>
</span><span id="StateMachine-317"><a href="#StateMachine-317"><span class="linenos">317</span></a>            <span class="p">)</span>
</span><span id="StateMachine-318"><a href="#StateMachine-318"><span class="linenos">318</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">main_gui</span><span class="o">.</span><span class="n">scheduled_tasks</span><span class="p">[</span><span class="s2">&quot;PROCESS QUEUE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">queue_ps_id</span>
</span><span id="StateMachine-319"><a href="#StateMachine-319"><span class="linenos">319</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="StateMachine-320"><a href="#StateMachine-320"><span class="linenos">320</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing data queue: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="StateMachine-321"><a href="#StateMachine-321"><span class="linenos">321</span></a>            <span class="k">raise</span>
</span><span id="StateMachine-322"><a href="#StateMachine-322"><span class="linenos">322</span></a>
</span><span id="StateMachine-323"><a href="#StateMachine-323"><span class="linenos">323</span></a>    <span class="nd">@staticmethod</span>
</span><span id="StateMachine-324"><a href="#StateMachine-324"><span class="linenos">324</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">reject_actions</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
</span><span id="StateMachine-325"><a href="#StateMachine-325"><span class="linenos">325</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StateMachine-326"><a href="#StateMachine-326"><span class="linenos">326</span></a><span class="sd">        This method handles the rejection of the &#39;START&#39; and &#39;RESET&#39; actions. These are rejected when there is no state transition for their current state.</span>
</span><span id="StateMachine-327"><a href="#StateMachine-327"><span class="linenos">327</span></a><span class="sd">        This is usually during program runtime for reset or before schedule generation for start.</span>
</span><span id="StateMachine-328"><a href="#StateMachine-328"><span class="linenos">328</span></a>
</span><span id="StateMachine-329"><a href="#StateMachine-329"><span class="linenos">329</span></a><span class="sd">        Parameters</span>
</span><span id="StateMachine-330"><a href="#StateMachine-330"><span class="linenos">330</span></a><span class="sd">        ----------</span>
</span><span id="StateMachine-331"><a href="#StateMachine-331"><span class="linenos">331</span></a><span class="sd">        - **event** (*str*): This is the desired state being rejected here.</span>
</span><span id="StateMachine-332"><a href="#StateMachine-332"><span class="linenos">332</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StateMachine-333"><a href="#StateMachine-333"><span class="linenos">333</span></a>        <span class="k">match</span> <span class="n">event</span><span class="p">:</span>
</span><span id="StateMachine-334"><a href="#StateMachine-334"><span class="linenos">334</span></a>            <span class="k">case</span> <span class="s2">&quot;RESET&quot;</span><span class="p">:</span>
</span><span id="StateMachine-335"><a href="#StateMachine-335"><span class="linenos">335</span></a>                <span class="n">GUIUtils</span><span class="o">.</span><span class="n">display_error</span><span class="p">(</span>
</span><span id="StateMachine-336"><a href="#StateMachine-336"><span class="linenos">336</span></a>                    <span class="s2">&quot;CANNOT PERFORM THIS ACTION&quot;</span><span class="p">,</span>
</span><span id="StateMachine-337"><a href="#StateMachine-337"><span class="linenos">337</span></a>                    <span class="s2">&quot;RESET cannot be performed during runtime. Stop the program to reset.&quot;</span><span class="p">,</span>
</span><span id="StateMachine-338"><a href="#StateMachine-338"><span class="linenos">338</span></a>                <span class="p">)</span>
</span><span id="StateMachine-339"><a href="#StateMachine-339"><span class="linenos">339</span></a>            <span class="c1"># if key is not in table but we try to start (for example, STOP PROGRAM -&gt; START) we do NOT want to allow this until a full reset has been completed</span>
</span><span id="StateMachine-340"><a href="#StateMachine-340"><span class="linenos">340</span></a>            <span class="k">case</span> <span class="s2">&quot;START&quot;</span><span class="p">:</span>
</span><span id="StateMachine-341"><a href="#StateMachine-341"><span class="linenos">341</span></a>                <span class="n">GUIUtils</span><span class="o">.</span><span class="n">display_error</span><span class="p">(</span>
</span><span id="StateMachine-342"><a href="#StateMachine-342"><span class="linenos">342</span></a>                    <span class="s2">&quot;CANNOT PERFORM THIS ACTION&quot;</span><span class="p">,</span>
</span><span id="StateMachine-343"><a href="#StateMachine-343"><span class="linenos">343</span></a>                    <span class="s2">&quot;Experiement has already been executed. Before running another, you need to RESET the application to ensure all data is reset to defaults&quot;</span><span class="p">,</span>
</span><span id="StateMachine-344"><a href="#StateMachine-344"><span class="linenos">344</span></a>                <span class="p">)</span>
</span><span id="StateMachine-345"><a href="#StateMachine-345"><span class="linenos">345</span></a>            <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
</span><span id="StateMachine-346"><a href="#StateMachine-346"><span class="linenos">346</span></a>                <span class="k">return</span>
</span></pre></div>


            <div class="docstring"><p>This class is the heart of the program. Defines and handles program state transitions.
It coordinates co-operation between view (gui) and models (data). We inherit a TkinterApp class to include
attributes of a tkinter app such as gui, arduino controller, etc.</p>

<h2 id="attributes">Attributes</h2>

<ul>
<li><strong>exp_data</strong> (<em>ExperimentProcessData</em>): An instance of <code>models.experiment_process_data</code> ExperimentProcessData, this attribute allows for access and
modification of experiment variables, and access for to more specific models like <code>models.event_data</code> and <code>models.arduino_data</code>.</li>
<li><strong>arduino_controller</strong> (<em>ArduinoManager</em>): An instance of <code>controllers.arduino_control</code> ArduinoManager, this allows for communication between this program and the
Arduino board.</li>
<li><strong>main_gui</strong> (<em>MainGUI</em>): An instance of <code>views.main_gui</code> MainGUI, this allows for the creation and modification of all GUI attributes in the program. All GUI windows
are created and managed here.</li>
<li><strong>state</strong> (<em>str</em>): Contains the current state the program is in.</li>
<li><strong>prev_state</strong> (<em>str</em>): Contains the state the program was previously in. Useful to restore state in case of erroneous transitions.</li>
<li><strong>app_result</strong> (<em>list</em>): Mutable list with one element. Is a reference to list defined in <code><a href="main.html">main</a></code>.</li>
<li><strong>transitions</strong>  (<em>dict</em>): Program state transition table.</li>
</ul>

<h2 id="methods">Methods</h2>

<ul>
<li><code><a href="#StateMachine.trigger">trigger</a></code>(event)
Handles state transition events. Decides if a transition is valid and warns user of destructive transitions. If valid,
passes state to <code><a href="#StateMachine.execute_state">execute_state</a></code> method.</li>
<li><code><a href="#StateMachine.execute_state">execute_state</a></code>(new_state: str)
Takes the state passed from trigger event and decides appropriate action.</li>
<li><code><a href="#StateMachine.process_queue">process_queue</a></code>(data_queue)
Processes incoming data from the Arduino board. Reads from queue that is added to by <code>controllers.arduino_control</code> module
<code>listen_for_serial</code> method.</li>
<li><code><a href="#StateMachine.reject_actions">reject_actions</a></code>(event)
A static method that handles the rejection of actions that cannot be performed given a certain state transition.</li>
</ul>
</div>


                            <div id="StateMachine.__init__" class="classattr">
                                        <input id="StateMachine.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">StateMachine</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">result_container</span></span>)</span>

                <label class="view-source-button" for="StateMachine.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#StateMachine.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="StateMachine.__init__-104"><a href="#StateMachine.__init__-104"><span class="linenos">104</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result_container</span><span class="p">):</span>
</span><span id="StateMachine.__init__-105"><a href="#StateMachine.__init__-105"><span class="linenos">105</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;init method for `StateMachine`. Takes `main` module `result_container`.</span>
</span><span id="StateMachine.__init__-106"><a href="#StateMachine.__init__-106"><span class="linenos">106</span></a><span class="sd">        the &#39;super&#39; parent class which is the gui&quot;&quot;&quot;</span>
</span><span id="StateMachine.__init__-107"><a href="#StateMachine.__init__-107"><span class="linenos">107</span></a>
</span><span id="StateMachine.__init__-108"><a href="#StateMachine.__init__-108"><span class="linenos">108</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">exp_data</span> <span class="o">=</span> <span class="n">ExperimentProcessData</span><span class="p">()</span>
</span><span id="StateMachine.__init__-109"><a href="#StateMachine.__init__-109"><span class="linenos">109</span></a>
</span><span id="StateMachine.__init__-110"><a href="#StateMachine.__init__-110"><span class="linenos">110</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">arduino_controller</span> <span class="o">=</span> <span class="n">ArduinoManager</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exp_data</span><span class="p">)</span>
</span><span id="StateMachine.__init__-111"><a href="#StateMachine.__init__-111"><span class="linenos">111</span></a>
</span><span id="StateMachine.__init__-112"><a href="#StateMachine.__init__-112"><span class="linenos">112</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">main_gui</span> <span class="o">=</span> <span class="n">MainGUI</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exp_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">arduino_controller</span><span class="p">)</span>
</span><span id="StateMachine.__init__-113"><a href="#StateMachine.__init__-113"><span class="linenos">113</span></a>        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;GUI started successfully.&quot;</span><span class="p">)</span>
</span><span id="StateMachine.__init__-114"><a href="#StateMachine.__init__-114"><span class="linenos">114</span></a>
</span><span id="StateMachine.__init__-115"><a href="#StateMachine.__init__-115"><span class="linenos">115</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="s2">&quot;IDLE&quot;</span>
</span><span id="StateMachine.__init__-116"><a href="#StateMachine.__init__-116"><span class="linenos">116</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Default state for program is set at IDLE&quot;&quot;&quot;</span>
</span><span id="StateMachine.__init__-117"><a href="#StateMachine.__init__-117"><span class="linenos">117</span></a>
</span><span id="StateMachine.__init__-118"><a href="#StateMachine.__init__-118"><span class="linenos">118</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">prev_state</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="StateMachine.__init__-119"><a href="#StateMachine.__init__-119"><span class="linenos">119</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Default previous state for program is set to None. Utilized in `trigger`.&quot;&quot;&quot;</span>
</span><span id="StateMachine.__init__-120"><a href="#StateMachine.__init__-120"><span class="linenos">120</span></a>
</span><span id="StateMachine.__init__-121"><a href="#StateMachine.__init__-121"><span class="linenos">121</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">app_result</span> <span class="o">=</span> <span class="n">result_container</span>
</span><span id="StateMachine.__init__-122"><a href="#StateMachine.__init__-122"><span class="linenos">122</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StateMachine.__init__-123"><a href="#StateMachine.__init__-123"><span class="linenos">123</span></a><span class="sd">        Here we store a reference to `main` module `result_container` to store decision of whether to restart the </span>
</span><span id="StateMachine.__init__-124"><a href="#StateMachine.__init__-124"><span class="linenos">124</span></a><span class="sd">        program or just terminate the current instance.</span>
</span><span id="StateMachine.__init__-125"><a href="#StateMachine.__init__-125"><span class="linenos">125</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StateMachine.__init__-126"><a href="#StateMachine.__init__-126"><span class="linenos">126</span></a>
</span><span id="StateMachine.__init__-127"><a href="#StateMachine.__init__-127"><span class="linenos">127</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">transitions</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="StateMachine.__init__-128"><a href="#StateMachine.__init__-128"><span class="linenos">128</span></a>            <span class="p">(</span><span class="s2">&quot;IDLE&quot;</span><span class="p">,</span> <span class="s2">&quot;GENERATE SCHEDULE&quot;</span><span class="p">):</span> <span class="s2">&quot;GENERATE SCHEDULE&quot;</span><span class="p">,</span>
</span><span id="StateMachine.__init__-129"><a href="#StateMachine.__init__-129"><span class="linenos">129</span></a>            <span class="p">(</span>
</span><span id="StateMachine.__init__-130"><a href="#StateMachine.__init__-130"><span class="linenos">130</span></a>                <span class="s2">&quot;GENERATE SCHEDULE&quot;</span><span class="p">,</span>
</span><span id="StateMachine.__init__-131"><a href="#StateMachine.__init__-131"><span class="linenos">131</span></a>                <span class="s2">&quot;IDLE&quot;</span><span class="p">,</span>
</span><span id="StateMachine.__init__-132"><a href="#StateMachine.__init__-132"><span class="linenos">132</span></a>            <span class="p">):</span> <span class="s2">&quot;IDLE&quot;</span><span class="p">,</span>
</span><span id="StateMachine.__init__-133"><a href="#StateMachine.__init__-133"><span class="linenos">133</span></a>            <span class="p">(</span><span class="s2">&quot;IDLE&quot;</span><span class="p">,</span> <span class="s2">&quot;START&quot;</span><span class="p">):</span> <span class="s2">&quot;START PROGRAM&quot;</span><span class="p">,</span>
</span><span id="StateMachine.__init__-134"><a href="#StateMachine.__init__-134"><span class="linenos">134</span></a>            <span class="p">(</span><span class="s2">&quot;IDLE&quot;</span><span class="p">,</span> <span class="s2">&quot;RESET&quot;</span><span class="p">):</span> <span class="s2">&quot;RESET PROGRAM&quot;</span><span class="p">,</span>
</span><span id="StateMachine.__init__-135"><a href="#StateMachine.__init__-135"><span class="linenos">135</span></a>            <span class="p">(</span><span class="s2">&quot;STOP PROGRAM&quot;</span><span class="p">,</span> <span class="s2">&quot;RESET&quot;</span><span class="p">):</span> <span class="s2">&quot;RESET PROGRAM&quot;</span><span class="p">,</span>
</span><span id="StateMachine.__init__-136"><a href="#StateMachine.__init__-136"><span class="linenos">136</span></a>            <span class="p">(</span><span class="s2">&quot;START PROGRAM&quot;</span><span class="p">,</span> <span class="s2">&quot;ITI&quot;</span><span class="p">):</span> <span class="s2">&quot;ITI&quot;</span><span class="p">,</span>
</span><span id="StateMachine.__init__-137"><a href="#StateMachine.__init__-137"><span class="linenos">137</span></a>            <span class="p">(</span><span class="s2">&quot;ITI&quot;</span><span class="p">,</span> <span class="s2">&quot;DOOR OPEN&quot;</span><span class="p">):</span> <span class="s2">&quot;OPENING DOOR&quot;</span><span class="p">,</span>
</span><span id="StateMachine.__init__-138"><a href="#StateMachine.__init__-138"><span class="linenos">138</span></a>            <span class="p">(</span><span class="s2">&quot;OPENING DOOR&quot;</span><span class="p">,</span> <span class="s2">&quot;TTC&quot;</span><span class="p">):</span> <span class="s2">&quot;TTC&quot;</span><span class="p">,</span>
</span><span id="StateMachine.__init__-139"><a href="#StateMachine.__init__-139"><span class="linenos">139</span></a>            <span class="p">(</span><span class="s2">&quot;TTC&quot;</span><span class="p">,</span> <span class="s2">&quot;SAMPLE&quot;</span><span class="p">):</span> <span class="s2">&quot;SAMPLE&quot;</span><span class="p">,</span>  <span class="c1"># -&gt; if rat engages in trial</span>
</span><span id="StateMachine.__init__-140"><a href="#StateMachine.__init__-140"><span class="linenos">140</span></a>            <span class="p">(</span><span class="s2">&quot;TTC&quot;</span><span class="p">,</span> <span class="s2">&quot;TRIAL END&quot;</span><span class="p">):</span> <span class="s2">&quot;TRIAL END&quot;</span><span class="p">,</span>  <span class="c1"># -&gt; if rat does NOT engage</span>
</span><span id="StateMachine.__init__-141"><a href="#StateMachine.__init__-141"><span class="linenos">141</span></a>            <span class="p">(</span><span class="s2">&quot;SAMPLE&quot;</span><span class="p">,</span> <span class="s2">&quot;TRIAL END&quot;</span><span class="p">):</span> <span class="s2">&quot;TRIAL END&quot;</span><span class="p">,</span>
</span><span id="StateMachine.__init__-142"><a href="#StateMachine.__init__-142"><span class="linenos">142</span></a>            <span class="p">(</span><span class="s2">&quot;TRIAL END&quot;</span><span class="p">,</span> <span class="s2">&quot;ITI&quot;</span><span class="p">):</span> <span class="s2">&quot;ITI&quot;</span><span class="p">,</span>  <span class="c1"># -&gt; save trial data, update gui, door up</span>
</span><span id="StateMachine.__init__-143"><a href="#StateMachine.__init__-143"><span class="linenos">143</span></a>            <span class="p">(</span><span class="s2">&quot;ITI&quot;</span><span class="p">,</span> <span class="s2">&quot;STOP&quot;</span><span class="p">):</span> <span class="s2">&quot;STOP PROGRAM&quot;</span><span class="p">,</span>  <span class="c1"># can move to &#39;stop&#39; state in all states</span>
</span><span id="StateMachine.__init__-144"><a href="#StateMachine.__init__-144"><span class="linenos">144</span></a>            <span class="p">(</span><span class="s2">&quot;OPENING DOOR&quot;</span><span class="p">,</span> <span class="s2">&quot;STOP&quot;</span><span class="p">):</span> <span class="s2">&quot;STOP PROGRAM&quot;</span><span class="p">,</span>
</span><span id="StateMachine.__init__-145"><a href="#StateMachine.__init__-145"><span class="linenos">145</span></a>            <span class="p">(</span><span class="s2">&quot;TTC&quot;</span><span class="p">,</span> <span class="s2">&quot;STOP&quot;</span><span class="p">):</span> <span class="s2">&quot;STOP PROGRAM&quot;</span><span class="p">,</span>
</span><span id="StateMachine.__init__-146"><a href="#StateMachine.__init__-146"><span class="linenos">146</span></a>            <span class="p">(</span><span class="s2">&quot;SAMPLE&quot;</span><span class="p">,</span> <span class="s2">&quot;STOP&quot;</span><span class="p">):</span> <span class="s2">&quot;STOP PROGRAM&quot;</span><span class="p">,</span>
</span><span id="StateMachine.__init__-147"><a href="#StateMachine.__init__-147"><span class="linenos">147</span></a>            <span class="p">(</span><span class="s2">&quot;TRIAL END&quot;</span><span class="p">,</span> <span class="s2">&quot;STOP&quot;</span><span class="p">):</span> <span class="s2">&quot;STOP PROGRAM&quot;</span><span class="p">,</span>
</span><span id="StateMachine.__init__-148"><a href="#StateMachine.__init__-148"><span class="linenos">148</span></a>        <span class="p">}</span>
</span><span id="StateMachine.__init__-149"><a href="#StateMachine.__init__-149"><span class="linenos">149</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;State transition table defines all transitions that the program can possibly take&quot;&quot;&quot;</span>
</span><span id="StateMachine.__init__-150"><a href="#StateMachine.__init__-150"><span class="linenos">150</span></a>
</span><span id="StateMachine.__init__-151"><a href="#StateMachine.__init__-151"><span class="linenos">151</span></a>        <span class="c1"># don&#39;t start the mainloop until AFTER the gui is setup so that the app_result property</span>
</span><span id="StateMachine.__init__-152"><a href="#StateMachine.__init__-152"><span class="linenos">152</span></a>        <span class="c1"># is available if reset is desired</span>
</span><span id="StateMachine.__init__-153"><a href="#StateMachine.__init__-153"><span class="linenos">153</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">main_gui</span><span class="o">.</span><span class="n">mainloop</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>init method for <code><a href="#StateMachine">StateMachine</a></code>. Takes <code><a href="main.html">main</a></code> module <code>result_container</code>.
the 'super' parent class which is the gui</p>
</div>


                            </div>
                            <div id="StateMachine.exp_data" class="classattr">
                                <div class="attr variable">
            <span class="name">exp_data</span>

        
    </div>
    <a class="headerlink" href="#StateMachine.exp_data"></a>
    
    

                            </div>
                            <div id="StateMachine.arduino_controller" class="classattr">
                                <div class="attr variable">
            <span class="name">arduino_controller</span>

        
    </div>
    <a class="headerlink" href="#StateMachine.arduino_controller"></a>
    
    

                            </div>
                            <div id="StateMachine.main_gui" class="classattr">
                                <div class="attr variable">
            <span class="name">main_gui</span>

        
    </div>
    <a class="headerlink" href="#StateMachine.main_gui"></a>
    
    

                            </div>
                            <div id="StateMachine.state" class="classattr">
                                <div class="attr variable">
            <span class="name">state</span>

        
    </div>
    <a class="headerlink" href="#StateMachine.state"></a>
    
            <div class="docstring"><p>Default state for program is set at IDLE</p>
</div>


                            </div>
                            <div id="StateMachine.prev_state" class="classattr">
                                <div class="attr variable">
            <span class="name">prev_state</span>

        
    </div>
    <a class="headerlink" href="#StateMachine.prev_state"></a>
    
            <div class="docstring"><p>Default previous state for program is set to None. Utilized in <code><a href="#StateMachine.trigger">trigger</a></code>.</p>
</div>


                            </div>
                            <div id="StateMachine.app_result" class="classattr">
                                <div class="attr variable">
            <span class="name">app_result</span>

        
    </div>
    <a class="headerlink" href="#StateMachine.app_result"></a>
    
            <div class="docstring"><p>Here we store a reference to <code><a href="main.html">main</a></code> module <code>result_container</code> to store decision of whether to restart the 
program or just terminate the current instance.</p>
</div>


                            </div>
                            <div id="StateMachine.transitions" class="classattr">
                                <div class="attr variable">
            <span class="name">transitions</span>

        
    </div>
    <a class="headerlink" href="#StateMachine.transitions"></a>
    
            <div class="docstring"><p>State transition table defines all transitions that the program can possibly take</p>
</div>


                            </div>
                            <div id="StateMachine.trigger" class="classattr">
                                        <input id="StateMachine.trigger-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">trigger</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">event</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="StateMachine.trigger-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#StateMachine.trigger"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="StateMachine.trigger-155"><a href="#StateMachine.trigger-155"><span class="linenos">155</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">trigger</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
</span><span id="StateMachine.trigger-156"><a href="#StateMachine.trigger-156"><span class="linenos">156</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StateMachine.trigger-157"><a href="#StateMachine.trigger-157"><span class="linenos">157</span></a><span class="sd">        This function takes a requested state and decides if the transition from this state is allowed.</span>
</span><span id="StateMachine.trigger-158"><a href="#StateMachine.trigger-158"><span class="linenos">158</span></a>
</span><span id="StateMachine.trigger-159"><a href="#StateMachine.trigger-159"><span class="linenos">159</span></a><span class="sd">        Parameters</span>
</span><span id="StateMachine.trigger-160"><a href="#StateMachine.trigger-160"><span class="linenos">160</span></a><span class="sd">        ----------</span>
</span><span id="StateMachine.trigger-161"><a href="#StateMachine.trigger-161"><span class="linenos">161</span></a><span class="sd">        - **event** (*str*): Contains the desired state to move to.</span>
</span><span id="StateMachine.trigger-162"><a href="#StateMachine.trigger-162"><span class="linenos">162</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StateMachine.trigger-163"><a href="#StateMachine.trigger-163"><span class="linenos">163</span></a>
</span><span id="StateMachine.trigger-164"><a href="#StateMachine.trigger-164"><span class="linenos">164</span></a>        <span class="n">transition</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="n">event</span><span class="p">)</span>
</span><span id="StateMachine.trigger-165"><a href="#StateMachine.trigger-165"><span class="linenos">165</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">prev_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span>
</span><span id="StateMachine.trigger-166"><a href="#StateMachine.trigger-166"><span class="linenos">166</span></a>        <span class="n">new_state</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="StateMachine.trigger-167"><a href="#StateMachine.trigger-167"><span class="linenos">167</span></a>
</span><span id="StateMachine.trigger-168"><a href="#StateMachine.trigger-168"><span class="linenos">168</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;state transition -&gt; </span><span class="si">{</span><span class="n">transition</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="StateMachine.trigger-169"><a href="#StateMachine.trigger-169"><span class="linenos">169</span></a>
</span><span id="StateMachine.trigger-170"><a href="#StateMachine.trigger-170"><span class="linenos">170</span></a>        <span class="c1"># checking if the attemped transition is valid according to the table</span>
</span><span id="StateMachine.trigger-171"><a href="#StateMachine.trigger-171"><span class="linenos">171</span></a>        <span class="k">if</span> <span class="n">transition</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">transitions</span><span class="p">:</span>
</span><span id="StateMachine.trigger-172"><a href="#StateMachine.trigger-172"><span class="linenos">172</span></a>            <span class="n">new_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transitions</span><span class="p">[</span><span class="n">transition</span><span class="p">]</span>
</span><span id="StateMachine.trigger-173"><a href="#StateMachine.trigger-173"><span class="linenos">173</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="StateMachine.trigger-174"><a href="#StateMachine.trigger-174"><span class="linenos">174</span></a>            <span class="c1"># if the key is not in the transition table, handle rejection based on desired state</span>
</span><span id="StateMachine.trigger-175"><a href="#StateMachine.trigger-175"><span class="linenos">175</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">reject_actions</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
</span><span id="StateMachine.trigger-176"><a href="#StateMachine.trigger-176"><span class="linenos">176</span></a>
</span><span id="StateMachine.trigger-177"><a href="#StateMachine.trigger-177"><span class="linenos">177</span></a>        <span class="c1"># if the key was in the transition table, and the new state wants to reset the program, that means this is a valid action at this time. MAKE SURE the</span>
</span><span id="StateMachine.trigger-178"><a href="#StateMachine.trigger-178"><span class="linenos">178</span></a>        <span class="c1"># user REALLY wants to do that</span>
</span><span id="StateMachine.trigger-179"><a href="#StateMachine.trigger-179"><span class="linenos">179</span></a>        <span class="k">if</span> <span class="n">new_state</span> <span class="o">==</span> <span class="s2">&quot;RESET PROGRAM&quot;</span><span class="p">:</span>
</span><span id="StateMachine.trigger-180"><a href="#StateMachine.trigger-180"><span class="linenos">180</span></a>            <span class="n">response</span> <span class="o">=</span> <span class="n">GUIUtils</span><span class="o">.</span><span class="n">askyesno</span><span class="p">(</span>
</span><span id="StateMachine.trigger-181"><a href="#StateMachine.trigger-181"><span class="linenos">181</span></a>                <span class="s2">&quot;============WARNING============&quot;</span><span class="p">,</span>
</span><span id="StateMachine.trigger-182"><a href="#StateMachine.trigger-182"><span class="linenos">182</span></a>                <span class="s2">&quot;THIS ACTION WILL ERASE ALL DATA CURRENTLY STORED FOR THIS EXPERIMENT... ARE YOU SURE YOU WANT TO CONTINUE?&quot;</span><span class="p">,</span>
</span><span id="StateMachine.trigger-183"><a href="#StateMachine.trigger-183"><span class="linenos">183</span></a>            <span class="p">)</span>
</span><span id="StateMachine.trigger-184"><a href="#StateMachine.trigger-184"><span class="linenos">184</span></a>            <span class="c1"># if true, go ahead with the reset, if false return to prev_state</span>
</span><span id="StateMachine.trigger-185"><a href="#StateMachine.trigger-185"><span class="linenos">185</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="p">:</span>
</span><span id="StateMachine.trigger-186"><a href="#StateMachine.trigger-186"><span class="linenos">186</span></a>                <span class="n">new_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_state</span>
</span><span id="StateMachine.trigger-187"><a href="#StateMachine.trigger-187"><span class="linenos">187</span></a>
</span><span id="StateMachine.trigger-188"><a href="#StateMachine.trigger-188"><span class="linenos">188</span></a>        <span class="c1"># if attempt to start program with no experiment schedule, tell user to do that</span>
</span><span id="StateMachine.trigger-189"><a href="#StateMachine.trigger-189"><span class="linenos">189</span></a>        <span class="k">if</span> <span class="n">new_state</span> <span class="o">==</span> <span class="s2">&quot;START PROGRAM&quot;</span><span class="p">:</span>
</span><span id="StateMachine.trigger-190"><a href="#StateMachine.trigger-190"><span class="linenos">190</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_data</span><span class="o">.</span><span class="n">program_schedule_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
</span><span id="StateMachine.trigger-191"><a href="#StateMachine.trigger-191"><span class="linenos">191</span></a>                <span class="n">GUIUtils</span><span class="o">.</span><span class="n">display_error</span><span class="p">(</span>
</span><span id="StateMachine.trigger-192"><a href="#StateMachine.trigger-192"><span class="linenos">192</span></a>                    <span class="s2">&quot;Experiement Schedule Not Yet Generated!!!&quot;</span><span class="p">,</span>
</span><span id="StateMachine.trigger-193"><a href="#StateMachine.trigger-193"><span class="linenos">193</span></a>                    <span class="s2">&quot;Please generate the program schedule before attempting to start the experiment. You can do this by clicking the &#39;Valve / Stimuli&#39; button in the main screen.&quot;</span><span class="p">,</span>
</span><span id="StateMachine.trigger-194"><a href="#StateMachine.trigger-194"><span class="linenos">194</span></a>                <span class="p">)</span>
</span><span id="StateMachine.trigger-195"><a href="#StateMachine.trigger-195"><span class="linenos">195</span></a>                <span class="n">new_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_state</span>
</span><span id="StateMachine.trigger-196"><a href="#StateMachine.trigger-196"><span class="linenos">196</span></a>
</span><span id="StateMachine.trigger-197"><a href="#StateMachine.trigger-197"><span class="linenos">197</span></a>        <span class="c1"># if we have a new state, perform the associated action for that state</span>
</span><span id="StateMachine.trigger-198"><a href="#StateMachine.trigger-198"><span class="linenos">198</span></a>        <span class="k">if</span> <span class="n">new_state</span><span class="p">:</span>
</span><span id="StateMachine.trigger-199"><a href="#StateMachine.trigger-199"><span class="linenos">199</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;new state -&gt; </span><span class="si">{</span><span class="n">new_state</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="StateMachine.trigger-200"><a href="#StateMachine.trigger-200"><span class="linenos">200</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">execute_state</span><span class="p">(</span><span class="n">new_state</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>This function takes a requested state and decides if the transition from this state is allowed.</p>

<h2 id="parameters">Parameters</h2>

<ul>
<li><strong>event</strong> (<em>str</em>): Contains the desired state to move to.</li>
</ul>
</div>


                            </div>
                            <div id="StateMachine.execute_state" class="classattr">
                                        <input id="StateMachine.execute_state-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">execute_state</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">new_state</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="StateMachine.execute_state-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#StateMachine.execute_state"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="StateMachine.execute_state-202"><a href="#StateMachine.execute_state-202"><span class="linenos">202</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">execute_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_state</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="StateMachine.execute_state-203"><a href="#StateMachine.execute_state-203"><span class="linenos">203</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StateMachine.execute_state-204"><a href="#StateMachine.execute_state-204"><span class="linenos">204</span></a><span class="sd">        Executes the action corresponding to new_state. if the action is defined under state_target,</span>
</span><span id="StateMachine.execute_state-205"><a href="#StateMachine.execute_state-205"><span class="linenos">205</span></a><span class="sd">        that action will be taken in a new thread to avoid overloading the main tkinter thread. otherwise</span>
</span><span id="StateMachine.execute_state-206"><a href="#StateMachine.execute_state-206"><span class="linenos">206</span></a><span class="sd">        it is executed immediately in the main thread.</span>
</span><span id="StateMachine.execute_state-207"><a href="#StateMachine.execute_state-207"><span class="linenos">207</span></a>
</span><span id="StateMachine.execute_state-208"><a href="#StateMachine.execute_state-208"><span class="linenos">208</span></a><span class="sd">        Parameters</span>
</span><span id="StateMachine.execute_state-209"><a href="#StateMachine.execute_state-209"><span class="linenos">209</span></a><span class="sd">        ----------</span>
</span><span id="StateMachine.execute_state-210"><a href="#StateMachine.execute_state-210"><span class="linenos">210</span></a><span class="sd">        - **new_state** (*str*): Contains the desired state to move to. Used to locate the desired action.</span>
</span><span id="StateMachine.execute_state-211"><a href="#StateMachine.execute_state-211"><span class="linenos">211</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StateMachine.execute_state-212"><a href="#StateMachine.execute_state-212"><span class="linenos">212</span></a>
</span><span id="StateMachine.execute_state-213"><a href="#StateMachine.execute_state-213"><span class="linenos">213</span></a>        <span class="n">thread_target</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="StateMachine.execute_state-214"><a href="#StateMachine.execute_state-214"><span class="linenos">214</span></a>
</span><span id="StateMachine.execute_state-215"><a href="#StateMachine.execute_state-215"><span class="linenos">215</span></a>        <span class="k">match</span> <span class="n">new_state</span><span class="p">:</span>
</span><span id="StateMachine.execute_state-216"><a href="#StateMachine.execute_state-216"><span class="linenos">216</span></a>            <span class="k">case</span> <span class="s2">&quot;START PROGRAM&quot;</span><span class="p">:</span>
</span><span id="StateMachine.execute_state-217"><a href="#StateMachine.execute_state-217"><span class="linenos">217</span></a>
</span><span id="StateMachine.execute_state-218"><a href="#StateMachine.execute_state-218"><span class="linenos">218</span></a>                <span class="k">def</span><span class="w"> </span><span class="nf">thread_target</span><span class="p">():</span>
</span><span id="StateMachine.execute_state-219"><a href="#StateMachine.execute_state-219"><span class="linenos">219</span></a>                    <span class="n">StartProgram</span><span class="p">(</span>
</span><span id="StateMachine.execute_state-220"><a href="#StateMachine.execute_state-220"><span class="linenos">220</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">exp_data</span><span class="p">,</span>
</span><span id="StateMachine.execute_state-221"><a href="#StateMachine.execute_state-221"><span class="linenos">221</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">main_gui</span><span class="p">,</span>
</span><span id="StateMachine.execute_state-222"><a href="#StateMachine.execute_state-222"><span class="linenos">222</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">arduino_controller</span><span class="p">,</span>
</span><span id="StateMachine.execute_state-223"><a href="#StateMachine.execute_state-223"><span class="linenos">223</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">,</span>
</span><span id="StateMachine.execute_state-224"><a href="#StateMachine.execute_state-224"><span class="linenos">224</span></a>                    <span class="p">)</span>
</span><span id="StateMachine.execute_state-225"><a href="#StateMachine.execute_state-225"><span class="linenos">225</span></a>            <span class="k">case</span> <span class="s2">&quot;RESET PROGRAM&quot;</span><span class="p">:</span>
</span><span id="StateMachine.execute_state-226"><a href="#StateMachine.execute_state-226"><span class="linenos">226</span></a>                <span class="n">ResetProgram</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">main_gui</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">app_result</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">arduino_controller</span><span class="p">)</span>
</span><span id="StateMachine.execute_state-227"><a href="#StateMachine.execute_state-227"><span class="linenos">227</span></a>            <span class="k">case</span> <span class="s2">&quot;STOP PROGRAM&quot;</span><span class="p">:</span>
</span><span id="StateMachine.execute_state-228"><a href="#StateMachine.execute_state-228"><span class="linenos">228</span></a>                <span class="n">StopProgram</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">main_gui</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">arduino_controller</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">)</span>
</span><span id="StateMachine.execute_state-229"><a href="#StateMachine.execute_state-229"><span class="linenos">229</span></a>            <span class="k">case</span> <span class="s2">&quot;GENERATE SCHEDULE&quot;</span><span class="p">:</span>
</span><span id="StateMachine.execute_state-230"><a href="#StateMachine.execute_state-230"><span class="linenos">230</span></a>                <span class="c1"># because this will run in main thread, we need to return early to avoid self.state</span>
</span><span id="StateMachine.execute_state-231"><a href="#StateMachine.execute_state-231"><span class="linenos">231</span></a>                <span class="c1"># assignment confusion</span>
</span><span id="StateMachine.execute_state-232"><a href="#StateMachine.execute_state-232"><span class="linenos">232</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">new_state</span>
</span><span id="StateMachine.execute_state-233"><a href="#StateMachine.execute_state-233"><span class="linenos">233</span></a>                <span class="n">GenerateSchedule</span><span class="p">(</span>
</span><span id="StateMachine.execute_state-234"><a href="#StateMachine.execute_state-234"><span class="linenos">234</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">main_gui</span><span class="p">,</span>
</span><span id="StateMachine.execute_state-235"><a href="#StateMachine.execute_state-235"><span class="linenos">235</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">arduino_controller</span><span class="p">,</span>
</span><span id="StateMachine.execute_state-236"><a href="#StateMachine.execute_state-236"><span class="linenos">236</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">process_queue</span><span class="p">,</span>
</span><span id="StateMachine.execute_state-237"><a href="#StateMachine.execute_state-237"><span class="linenos">237</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">,</span>
</span><span id="StateMachine.execute_state-238"><a href="#StateMachine.execute_state-238"><span class="linenos">238</span></a>                <span class="p">)</span>
</span><span id="StateMachine.execute_state-239"><a href="#StateMachine.execute_state-239"><span class="linenos">239</span></a>                <span class="k">return</span>
</span><span id="StateMachine.execute_state-240"><a href="#StateMachine.execute_state-240"><span class="linenos">240</span></a>            <span class="k">case</span> <span class="s2">&quot;ITI&quot;</span><span class="p">:</span>
</span><span id="StateMachine.execute_state-241"><a href="#StateMachine.execute_state-241"><span class="linenos">241</span></a>
</span><span id="StateMachine.execute_state-242"><a href="#StateMachine.execute_state-242"><span class="linenos">242</span></a>                <span class="k">def</span><span class="w"> </span><span class="nf">thread_target</span><span class="p">():</span>
</span><span id="StateMachine.execute_state-243"><a href="#StateMachine.execute_state-243"><span class="linenos">243</span></a>                    <span class="n">InitialTimeInterval</span><span class="p">(</span>
</span><span id="StateMachine.execute_state-244"><a href="#StateMachine.execute_state-244"><span class="linenos">244</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">exp_data</span><span class="p">,</span>
</span><span id="StateMachine.execute_state-245"><a href="#StateMachine.execute_state-245"><span class="linenos">245</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">main_gui</span><span class="p">,</span>
</span><span id="StateMachine.execute_state-246"><a href="#StateMachine.execute_state-246"><span class="linenos">246</span></a>                        <span class="n">new_state</span><span class="p">,</span>
</span><span id="StateMachine.execute_state-247"><a href="#StateMachine.execute_state-247"><span class="linenos">247</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">,</span>
</span><span id="StateMachine.execute_state-248"><a href="#StateMachine.execute_state-248"><span class="linenos">248</span></a>                    <span class="p">)</span>
</span><span id="StateMachine.execute_state-249"><a href="#StateMachine.execute_state-249"><span class="linenos">249</span></a>            <span class="k">case</span> <span class="s2">&quot;OPENING DOOR&quot;</span><span class="p">:</span>
</span><span id="StateMachine.execute_state-250"><a href="#StateMachine.execute_state-250"><span class="linenos">250</span></a>
</span><span id="StateMachine.execute_state-251"><a href="#StateMachine.execute_state-251"><span class="linenos">251</span></a>                <span class="k">def</span><span class="w"> </span><span class="nf">thread_target</span><span class="p">():</span>
</span><span id="StateMachine.execute_state-252"><a href="#StateMachine.execute_state-252"><span class="linenos">252</span></a>                    <span class="n">OpeningDoor</span><span class="p">(</span>
</span><span id="StateMachine.execute_state-253"><a href="#StateMachine.execute_state-253"><span class="linenos">253</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">exp_data</span><span class="p">,</span>
</span><span id="StateMachine.execute_state-254"><a href="#StateMachine.execute_state-254"><span class="linenos">254</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">main_gui</span><span class="p">,</span>
</span><span id="StateMachine.execute_state-255"><a href="#StateMachine.execute_state-255"><span class="linenos">255</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">arduino_controller</span><span class="p">,</span>
</span><span id="StateMachine.execute_state-256"><a href="#StateMachine.execute_state-256"><span class="linenos">256</span></a>                        <span class="n">new_state</span><span class="p">,</span>
</span><span id="StateMachine.execute_state-257"><a href="#StateMachine.execute_state-257"><span class="linenos">257</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">,</span>
</span><span id="StateMachine.execute_state-258"><a href="#StateMachine.execute_state-258"><span class="linenos">258</span></a>                    <span class="p">)</span>
</span><span id="StateMachine.execute_state-259"><a href="#StateMachine.execute_state-259"><span class="linenos">259</span></a>            <span class="k">case</span> <span class="s2">&quot;TTC&quot;</span><span class="p">:</span>
</span><span id="StateMachine.execute_state-260"><a href="#StateMachine.execute_state-260"><span class="linenos">260</span></a>
</span><span id="StateMachine.execute_state-261"><a href="#StateMachine.execute_state-261"><span class="linenos">261</span></a>                <span class="k">def</span><span class="w"> </span><span class="nf">thread_target</span><span class="p">():</span>
</span><span id="StateMachine.execute_state-262"><a href="#StateMachine.execute_state-262"><span class="linenos">262</span></a>                    <span class="n">TimeToContact</span><span class="p">(</span>
</span><span id="StateMachine.execute_state-263"><a href="#StateMachine.execute_state-263"><span class="linenos">263</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">exp_data</span><span class="p">,</span>
</span><span id="StateMachine.execute_state-264"><a href="#StateMachine.execute_state-264"><span class="linenos">264</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">arduino_controller</span><span class="p">,</span>
</span><span id="StateMachine.execute_state-265"><a href="#StateMachine.execute_state-265"><span class="linenos">265</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">main_gui</span><span class="p">,</span>
</span><span id="StateMachine.execute_state-266"><a href="#StateMachine.execute_state-266"><span class="linenos">266</span></a>                        <span class="n">new_state</span><span class="p">,</span>
</span><span id="StateMachine.execute_state-267"><a href="#StateMachine.execute_state-267"><span class="linenos">267</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">,</span>
</span><span id="StateMachine.execute_state-268"><a href="#StateMachine.execute_state-268"><span class="linenos">268</span></a>                    <span class="p">)</span>
</span><span id="StateMachine.execute_state-269"><a href="#StateMachine.execute_state-269"><span class="linenos">269</span></a>            <span class="k">case</span> <span class="s2">&quot;SAMPLE&quot;</span><span class="p">:</span>
</span><span id="StateMachine.execute_state-270"><a href="#StateMachine.execute_state-270"><span class="linenos">270</span></a>
</span><span id="StateMachine.execute_state-271"><a href="#StateMachine.execute_state-271"><span class="linenos">271</span></a>                <span class="k">def</span><span class="w"> </span><span class="nf">thread_target</span><span class="p">():</span>
</span><span id="StateMachine.execute_state-272"><a href="#StateMachine.execute_state-272"><span class="linenos">272</span></a>                    <span class="n">SampleTime</span><span class="p">(</span>
</span><span id="StateMachine.execute_state-273"><a href="#StateMachine.execute_state-273"><span class="linenos">273</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">exp_data</span><span class="p">,</span>
</span><span id="StateMachine.execute_state-274"><a href="#StateMachine.execute_state-274"><span class="linenos">274</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">main_gui</span><span class="p">,</span>
</span><span id="StateMachine.execute_state-275"><a href="#StateMachine.execute_state-275"><span class="linenos">275</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">arduino_controller</span><span class="p">,</span>
</span><span id="StateMachine.execute_state-276"><a href="#StateMachine.execute_state-276"><span class="linenos">276</span></a>                        <span class="n">new_state</span><span class="p">,</span>
</span><span id="StateMachine.execute_state-277"><a href="#StateMachine.execute_state-277"><span class="linenos">277</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">,</span>
</span><span id="StateMachine.execute_state-278"><a href="#StateMachine.execute_state-278"><span class="linenos">278</span></a>                    <span class="p">)</span>
</span><span id="StateMachine.execute_state-279"><a href="#StateMachine.execute_state-279"><span class="linenos">279</span></a>            <span class="k">case</span> <span class="s2">&quot;TRIAL END&quot;</span><span class="p">:</span>
</span><span id="StateMachine.execute_state-280"><a href="#StateMachine.execute_state-280"><span class="linenos">280</span></a>
</span><span id="StateMachine.execute_state-281"><a href="#StateMachine.execute_state-281"><span class="linenos">281</span></a>                <span class="k">def</span><span class="w"> </span><span class="nf">thread_target</span><span class="p">():</span>
</span><span id="StateMachine.execute_state-282"><a href="#StateMachine.execute_state-282"><span class="linenos">282</span></a>                    <span class="n">TrialEnd</span><span class="p">(</span>
</span><span id="StateMachine.execute_state-283"><a href="#StateMachine.execute_state-283"><span class="linenos">283</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">exp_data</span><span class="p">,</span>
</span><span id="StateMachine.execute_state-284"><a href="#StateMachine.execute_state-284"><span class="linenos">284</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">main_gui</span><span class="p">,</span>
</span><span id="StateMachine.execute_state-285"><a href="#StateMachine.execute_state-285"><span class="linenos">285</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">arduino_controller</span><span class="p">,</span>
</span><span id="StateMachine.execute_state-286"><a href="#StateMachine.execute_state-286"><span class="linenos">286</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">prev_state</span><span class="p">,</span>
</span><span id="StateMachine.execute_state-287"><a href="#StateMachine.execute_state-287"><span class="linenos">287</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">,</span>
</span><span id="StateMachine.execute_state-288"><a href="#StateMachine.execute_state-288"><span class="linenos">288</span></a>                    <span class="p">)</span>
</span><span id="StateMachine.execute_state-289"><a href="#StateMachine.execute_state-289"><span class="linenos">289</span></a>
</span><span id="StateMachine.execute_state-290"><a href="#StateMachine.execute_state-290"><span class="linenos">290</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">prev_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span>
</span><span id="StateMachine.execute_state-291"><a href="#StateMachine.execute_state-291"><span class="linenos">291</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">new_state</span>
</span><span id="StateMachine.execute_state-292"><a href="#StateMachine.execute_state-292"><span class="linenos">292</span></a>
</span><span id="StateMachine.execute_state-293"><a href="#StateMachine.execute_state-293"><span class="linenos">293</span></a>        <span class="k">if</span> <span class="n">thread_target</span><span class="p">:</span>
</span><span id="StateMachine.execute_state-294"><a href="#StateMachine.execute_state-294"><span class="linenos">294</span></a>            <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">thread_target</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Executes the action corresponding to new_state. if the action is defined under state_target,
that action will be taken in a new thread to avoid overloading the main tkinter thread. otherwise
it is executed immediately in the main thread.</p>

<h2 id="parameters">Parameters</h2>

<ul>
<li><strong>new_state</strong> (<em>str</em>): Contains the desired state to move to. Used to locate the desired action.</li>
</ul>
</div>


                            </div>
                            <div id="StateMachine.process_queue" class="classattr">
                                        <input id="StateMachine.process_queue-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">process_queue</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">data_queue</span><span class="p">:</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="StateMachine.process_queue-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#StateMachine.process_queue"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="StateMachine.process_queue-296"><a href="#StateMachine.process_queue-296"><span class="linenos">296</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">process_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_queue</span><span class="p">:</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="StateMachine.process_queue-297"><a href="#StateMachine.process_queue-297"><span class="linenos">297</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StateMachine.process_queue-298"><a href="#StateMachine.process_queue-298"><span class="linenos">298</span></a><span class="sd">        Process the data queue. Pulls in data from the thread that is reading data from the arduinos constantly. if there is anything</span>
</span><span id="StateMachine.process_queue-299"><a href="#StateMachine.process_queue-299"><span class="linenos">299</span></a><span class="sd">        in the queue at time of function call, we will stay here until its all been dealt with.</span>
</span><span id="StateMachine.process_queue-300"><a href="#StateMachine.process_queue-300"><span class="linenos">300</span></a>
</span><span id="StateMachine.process_queue-301"><a href="#StateMachine.process_queue-301"><span class="linenos">301</span></a><span class="sd">        Parameters</span>
</span><span id="StateMachine.process_queue-302"><a href="#StateMachine.process_queue-302"><span class="linenos">302</span></a><span class="sd">        ----------</span>
</span><span id="StateMachine.process_queue-303"><a href="#StateMachine.process_queue-303"><span class="linenos">303</span></a><span class="sd">        - **data_queue** (*tuple[str, str]*): This is a shared queue between a thread initiated in the `controllers.arduino_control` module&#39;s</span>
</span><span id="StateMachine.process_queue-304"><a href="#StateMachine.process_queue-304"><span class="linenos">304</span></a><span class="sd">        `listen_for_serial` method. That thread constantly reads info from Arduino so it is not missed, and the main thread calls this process method</span>
</span><span id="StateMachine.process_queue-305"><a href="#StateMachine.process_queue-305"><span class="linenos">305</span></a><span class="sd">        to process accumulated data to avoid overloading the thread.</span>
</span><span id="StateMachine.process_queue-306"><a href="#StateMachine.process_queue-306"><span class="linenos">306</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StateMachine.process_queue-307"><a href="#StateMachine.process_queue-307"><span class="linenos">307</span></a>
</span><span id="StateMachine.process_queue-308"><a href="#StateMachine.process_queue-308"><span class="linenos">308</span></a>        <span class="n">arduino_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_data</span><span class="o">.</span><span class="n">arduino_data</span>
</span><span id="StateMachine.process_queue-309"><a href="#StateMachine.process_queue-309"><span class="linenos">309</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="StateMachine.process_queue-310"><a href="#StateMachine.process_queue-310"><span class="linenos">310</span></a>            <span class="k">while</span> <span class="ow">not</span> <span class="n">data_queue</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
</span><span id="StateMachine.process_queue-311"><a href="#StateMachine.process_queue-311"><span class="linenos">311</span></a>                <span class="n">source</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">data_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
</span><span id="StateMachine.process_queue-312"><a href="#StateMachine.process_queue-312"><span class="linenos">312</span></a>                <span class="n">arduino_data</span><span class="o">.</span><span class="n">process_data</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">)</span>
</span><span id="StateMachine.process_queue-313"><a href="#StateMachine.process_queue-313"><span class="linenos">313</span></a>
</span><span id="StateMachine.process_queue-314"><a href="#StateMachine.process_queue-314"><span class="linenos">314</span></a>            <span class="c1"># run this command every 250ms</span>
</span><span id="StateMachine.process_queue-315"><a href="#StateMachine.process_queue-315"><span class="linenos">315</span></a>            <span class="n">queue_ps_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">main_gui</span><span class="o">.</span><span class="n">after</span><span class="p">(</span>
</span><span id="StateMachine.process_queue-316"><a href="#StateMachine.process_queue-316"><span class="linenos">316</span></a>                <span class="mi">250</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_queue</span><span class="p">(</span><span class="n">data_queue</span><span class="p">)</span>
</span><span id="StateMachine.process_queue-317"><a href="#StateMachine.process_queue-317"><span class="linenos">317</span></a>            <span class="p">)</span>
</span><span id="StateMachine.process_queue-318"><a href="#StateMachine.process_queue-318"><span class="linenos">318</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">main_gui</span><span class="o">.</span><span class="n">scheduled_tasks</span><span class="p">[</span><span class="s2">&quot;PROCESS QUEUE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">queue_ps_id</span>
</span><span id="StateMachine.process_queue-319"><a href="#StateMachine.process_queue-319"><span class="linenos">319</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="StateMachine.process_queue-320"><a href="#StateMachine.process_queue-320"><span class="linenos">320</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing data queue: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="StateMachine.process_queue-321"><a href="#StateMachine.process_queue-321"><span class="linenos">321</span></a>            <span class="k">raise</span>
</span></pre></div>


            <div class="docstring"><p>Process the data queue. Pulls in data from the thread that is reading data from the arduinos constantly. if there is anything
in the queue at time of function call, we will stay here until its all been dealt with.</p>

<h2 id="parameters">Parameters</h2>

<ul>
<li><strong>data_queue</strong> (<em>tuple[str, str]</em>): This is a shared queue between a thread initiated in the <code>controllers.arduino_control</code> module's
<code>listen_for_serial</code> method. That thread constantly reads info from Arduino so it is not missed, and the main thread calls this process method
to process accumulated data to avoid overloading the thread.</li>
</ul>
</div>


                            </div>
                            <div id="StateMachine.reject_actions" class="classattr">
                                        <input id="StateMachine.reject_actions-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-staticmethod">@staticmethod</div>

        <span class="def">def</span>
        <span class="name">reject_actions</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">event</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="StateMachine.reject_actions-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#StateMachine.reject_actions"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="StateMachine.reject_actions-323"><a href="#StateMachine.reject_actions-323"><span class="linenos">323</span></a>    <span class="nd">@staticmethod</span>
</span><span id="StateMachine.reject_actions-324"><a href="#StateMachine.reject_actions-324"><span class="linenos">324</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">reject_actions</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
</span><span id="StateMachine.reject_actions-325"><a href="#StateMachine.reject_actions-325"><span class="linenos">325</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StateMachine.reject_actions-326"><a href="#StateMachine.reject_actions-326"><span class="linenos">326</span></a><span class="sd">        This method handles the rejection of the &#39;START&#39; and &#39;RESET&#39; actions. These are rejected when there is no state transition for their current state.</span>
</span><span id="StateMachine.reject_actions-327"><a href="#StateMachine.reject_actions-327"><span class="linenos">327</span></a><span class="sd">        This is usually during program runtime for reset or before schedule generation for start.</span>
</span><span id="StateMachine.reject_actions-328"><a href="#StateMachine.reject_actions-328"><span class="linenos">328</span></a>
</span><span id="StateMachine.reject_actions-329"><a href="#StateMachine.reject_actions-329"><span class="linenos">329</span></a><span class="sd">        Parameters</span>
</span><span id="StateMachine.reject_actions-330"><a href="#StateMachine.reject_actions-330"><span class="linenos">330</span></a><span class="sd">        ----------</span>
</span><span id="StateMachine.reject_actions-331"><a href="#StateMachine.reject_actions-331"><span class="linenos">331</span></a><span class="sd">        - **event** (*str*): This is the desired state being rejected here.</span>
</span><span id="StateMachine.reject_actions-332"><a href="#StateMachine.reject_actions-332"><span class="linenos">332</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StateMachine.reject_actions-333"><a href="#StateMachine.reject_actions-333"><span class="linenos">333</span></a>        <span class="k">match</span> <span class="n">event</span><span class="p">:</span>
</span><span id="StateMachine.reject_actions-334"><a href="#StateMachine.reject_actions-334"><span class="linenos">334</span></a>            <span class="k">case</span> <span class="s2">&quot;RESET&quot;</span><span class="p">:</span>
</span><span id="StateMachine.reject_actions-335"><a href="#StateMachine.reject_actions-335"><span class="linenos">335</span></a>                <span class="n">GUIUtils</span><span class="o">.</span><span class="n">display_error</span><span class="p">(</span>
</span><span id="StateMachine.reject_actions-336"><a href="#StateMachine.reject_actions-336"><span class="linenos">336</span></a>                    <span class="s2">&quot;CANNOT PERFORM THIS ACTION&quot;</span><span class="p">,</span>
</span><span id="StateMachine.reject_actions-337"><a href="#StateMachine.reject_actions-337"><span class="linenos">337</span></a>                    <span class="s2">&quot;RESET cannot be performed during runtime. Stop the program to reset.&quot;</span><span class="p">,</span>
</span><span id="StateMachine.reject_actions-338"><a href="#StateMachine.reject_actions-338"><span class="linenos">338</span></a>                <span class="p">)</span>
</span><span id="StateMachine.reject_actions-339"><a href="#StateMachine.reject_actions-339"><span class="linenos">339</span></a>            <span class="c1"># if key is not in table but we try to start (for example, STOP PROGRAM -&gt; START) we do NOT want to allow this until a full reset has been completed</span>
</span><span id="StateMachine.reject_actions-340"><a href="#StateMachine.reject_actions-340"><span class="linenos">340</span></a>            <span class="k">case</span> <span class="s2">&quot;START&quot;</span><span class="p">:</span>
</span><span id="StateMachine.reject_actions-341"><a href="#StateMachine.reject_actions-341"><span class="linenos">341</span></a>                <span class="n">GUIUtils</span><span class="o">.</span><span class="n">display_error</span><span class="p">(</span>
</span><span id="StateMachine.reject_actions-342"><a href="#StateMachine.reject_actions-342"><span class="linenos">342</span></a>                    <span class="s2">&quot;CANNOT PERFORM THIS ACTION&quot;</span><span class="p">,</span>
</span><span id="StateMachine.reject_actions-343"><a href="#StateMachine.reject_actions-343"><span class="linenos">343</span></a>                    <span class="s2">&quot;Experiement has already been executed. Before running another, you need to RESET the application to ensure all data is reset to defaults&quot;</span><span class="p">,</span>
</span><span id="StateMachine.reject_actions-344"><a href="#StateMachine.reject_actions-344"><span class="linenos">344</span></a>                <span class="p">)</span>
</span><span id="StateMachine.reject_actions-345"><a href="#StateMachine.reject_actions-345"><span class="linenos">345</span></a>            <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
</span><span id="StateMachine.reject_actions-346"><a href="#StateMachine.reject_actions-346"><span class="linenos">346</span></a>                <span class="k">return</span>
</span></pre></div>


            <div class="docstring"><p>This method handles the rejection of the 'START' and 'RESET' actions. These are rejected when there is no state transition for their current state.
This is usually during program runtime for reset or before schedule generation for start.</p>

<h2 id="parameters">Parameters</h2>

<ul>
<li><strong>event</strong> (<em>str</em>): This is the desired state being rejected here.</li>
</ul>
</div>


                            </div>
                </section>
                <section id="GenerateSchedule">
                            <input id="GenerateSchedule-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">GenerateSchedule</span>:

                <label class="view-source-button" for="GenerateSchedule-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#GenerateSchedule"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="GenerateSchedule-349"><a href="#GenerateSchedule-349"><span class="linenos">349</span></a><span class="k">class</span><span class="w"> </span><span class="nc">GenerateSchedule</span><span class="p">:</span>
</span><span id="GenerateSchedule-350"><a href="#GenerateSchedule-350"><span class="linenos">350</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="GenerateSchedule-351"><a href="#GenerateSchedule-351"><span class="linenos">351</span></a><span class="sd">    This class handles the schedule generation state. It is called once the user has input the amount of simuli for this experiment, the</span>
</span><span id="GenerateSchedule-352"><a href="#GenerateSchedule-352"><span class="linenos">352</span></a><span class="sd">    number of trial blocks, changed the names of the stimuli in each cylinder/valve in the &#39;Valve / Stimuli&#39; window, and pressed generate schedule.</span>
</span><span id="GenerateSchedule-353"><a href="#GenerateSchedule-353"><span class="linenos">353</span></a>
</span><span id="GenerateSchedule-354"><a href="#GenerateSchedule-354"><span class="linenos">354</span></a><span class="sd">    The main things handled here are the updating of gui objects that needed the previously discussed info to be created (e.g raster plots need</span>
</span><span id="GenerateSchedule-355"><a href="#GenerateSchedule-355"><span class="linenos">355</span></a><span class="sd">    total trials, program schedule window needed the experiment data, etc.)</span>
</span><span id="GenerateSchedule-356"><a href="#GenerateSchedule-356"><span class="linenos">356</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="GenerateSchedule-357"><a href="#GenerateSchedule-357"><span class="linenos">357</span></a>
</span><span id="GenerateSchedule-358"><a href="#GenerateSchedule-358"><span class="linenos">358</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="GenerateSchedule-359"><a href="#GenerateSchedule-359"><span class="linenos">359</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="GenerateSchedule-360"><a href="#GenerateSchedule-360"><span class="linenos">360</span></a>        <span class="n">main_gui</span><span class="p">:</span> <span class="n">MainGUI</span><span class="p">,</span>
</span><span id="GenerateSchedule-361"><a href="#GenerateSchedule-361"><span class="linenos">361</span></a>        <span class="n">arduino_controller</span><span class="p">:</span> <span class="n">ArduinoManager</span><span class="p">,</span>
</span><span id="GenerateSchedule-362"><a href="#GenerateSchedule-362"><span class="linenos">362</span></a>        <span class="n">process_queue</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]],</span> <span class="kc">None</span><span class="p">],</span>
</span><span id="GenerateSchedule-363"><a href="#GenerateSchedule-363"><span class="linenos">363</span></a>        <span class="n">trigger</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="kc">None</span><span class="p">],</span>
</span><span id="GenerateSchedule-364"><a href="#GenerateSchedule-364"><span class="linenos">364</span></a>    <span class="p">):</span>
</span><span id="GenerateSchedule-365"><a href="#GenerateSchedule-365"><span class="linenos">365</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="GenerateSchedule-366"><a href="#GenerateSchedule-366"><span class="linenos">366</span></a><span class="sd">        Initialize and handle the GenerateSchedule class state.</span>
</span><span id="GenerateSchedule-367"><a href="#GenerateSchedule-367"><span class="linenos">367</span></a>
</span><span id="GenerateSchedule-368"><a href="#GenerateSchedule-368"><span class="linenos">368</span></a><span class="sd">        Parameters</span>
</span><span id="GenerateSchedule-369"><a href="#GenerateSchedule-369"><span class="linenos">369</span></a><span class="sd">        ----------</span>
</span><span id="GenerateSchedule-370"><a href="#GenerateSchedule-370"><span class="linenos">370</span></a><span class="sd">        - **main_gui** (*MainGUI*): A reference to the `views.main_gui` MainGUI instance, this is used to update elements inside the GUI window(s). Here we use it to</span>
</span><span id="GenerateSchedule-371"><a href="#GenerateSchedule-371"><span class="linenos">371</span></a><span class="sd">        update show the program schedule and create raster plots.</span>
</span><span id="GenerateSchedule-372"><a href="#GenerateSchedule-372"><span class="linenos">372</span></a><span class="sd">        - **arduino_controller** (*ArduinoManager*): A reference to the `controllers.arduino_control` Arduino controller instance, this is the method by which the Arduino is communicated</span>
</span><span id="GenerateSchedule-373"><a href="#GenerateSchedule-373"><span class="linenos">373</span></a><span class="sd">        with in the program. Used to send schedules, variables, and valve durations here.</span>
</span><span id="GenerateSchedule-374"><a href="#GenerateSchedule-374"><span class="linenos">374</span></a><span class="sd">        - **process_queue** (*Callback method*): This callback method is passed here so that the Arduino listener process thread can be started once the listener thread</span>
</span><span id="GenerateSchedule-375"><a href="#GenerateSchedule-375"><span class="linenos">375</span></a><span class="sd">        is running. It does NOT run prior to this so that sending individual bytes (send schedule, etc.) is performed without having data stolen away by the constantly running</span>
</span><span id="GenerateSchedule-376"><a href="#GenerateSchedule-376"><span class="linenos">376</span></a><span class="sd">        listener thread.</span>
</span><span id="GenerateSchedule-377"><a href="#GenerateSchedule-377"><span class="linenos">377</span></a><span class="sd">        - **trigger** (*Callback method*): This callback is passed in so that this state can trigger a transition back to `IDLE` when it is finished with its work.</span>
</span><span id="GenerateSchedule-378"><a href="#GenerateSchedule-378"><span class="linenos">378</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="GenerateSchedule-379"><a href="#GenerateSchedule-379"><span class="linenos">379</span></a>
</span><span id="GenerateSchedule-380"><a href="#GenerateSchedule-380"><span class="linenos">380</span></a>        <span class="c1"># show the program sched window via the callback passed into the class at initialization</span>
</span><span id="GenerateSchedule-381"><a href="#GenerateSchedule-381"><span class="linenos">381</span></a>        <span class="n">main_gui</span><span class="o">.</span><span class="n">show_secondary_window</span><span class="p">(</span><span class="s2">&quot;Program Schedule&quot;</span><span class="p">)</span>
</span><span id="GenerateSchedule-382"><a href="#GenerateSchedule-382"><span class="linenos">382</span></a>
</span><span id="GenerateSchedule-383"><a href="#GenerateSchedule-383"><span class="linenos">383</span></a>        <span class="c1"># create plots using generated number of trials as max Y values</span>
</span><span id="GenerateSchedule-384"><a href="#GenerateSchedule-384"><span class="linenos">384</span></a>        <span class="k">for</span> <span class="n">window</span> <span class="ow">in</span> <span class="n">main_gui</span><span class="o">.</span><span class="n">windows</span><span class="p">[</span><span class="s2">&quot;Raster Plot&quot;</span><span class="p">]:</span>
</span><span id="GenerateSchedule-385"><a href="#GenerateSchedule-385"><span class="linenos">385</span></a>            <span class="n">window</span><span class="o">.</span><span class="n">create_plot</span><span class="p">()</span>
</span><span id="GenerateSchedule-386"><a href="#GenerateSchedule-386"><span class="linenos">386</span></a>
</span><span id="GenerateSchedule-387"><a href="#GenerateSchedule-387"><span class="linenos">387</span></a>        <span class="c1"># send exp variables, schedule, and valve open durations stored in arduino_data.toml to the arduino</span>
</span><span id="GenerateSchedule-388"><a href="#GenerateSchedule-388"><span class="linenos">388</span></a>        <span class="n">arduino_controller</span><span class="o">.</span><span class="n">send_experiment_variables</span><span class="p">()</span>
</span><span id="GenerateSchedule-389"><a href="#GenerateSchedule-389"><span class="linenos">389</span></a>        <span class="n">arduino_controller</span><span class="o">.</span><span class="n">send_schedule_data</span><span class="p">()</span>
</span><span id="GenerateSchedule-390"><a href="#GenerateSchedule-390"><span class="linenos">390</span></a>        <span class="n">arduino_controller</span><span class="o">.</span><span class="n">send_valve_durations</span><span class="p">()</span>
</span><span id="GenerateSchedule-391"><a href="#GenerateSchedule-391"><span class="linenos">391</span></a>
</span><span id="GenerateSchedule-392"><a href="#GenerateSchedule-392"><span class="linenos">392</span></a>        <span class="c1"># start Arduino process queue and listener thread so we know when Arduino tries to tell us something</span>
</span><span id="GenerateSchedule-393"><a href="#GenerateSchedule-393"><span class="linenos">393</span></a>        <span class="n">process_queue</span><span class="p">(</span><span class="n">arduino_controller</span><span class="o">.</span><span class="n">data_queue</span><span class="p">)</span>
</span><span id="GenerateSchedule-394"><a href="#GenerateSchedule-394"><span class="linenos">394</span></a>
</span><span id="GenerateSchedule-395"><a href="#GenerateSchedule-395"><span class="linenos">395</span></a>        <span class="n">arduino_controller</span><span class="o">.</span><span class="n">listener_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span>
</span><span id="GenerateSchedule-396"><a href="#GenerateSchedule-396"><span class="linenos">396</span></a>            <span class="n">target</span><span class="o">=</span><span class="n">arduino_controller</span><span class="o">.</span><span class="n">listen_for_serial</span>
</span><span id="GenerateSchedule-397"><a href="#GenerateSchedule-397"><span class="linenos">397</span></a>        <span class="p">)</span>
</span><span id="GenerateSchedule-398"><a href="#GenerateSchedule-398"><span class="linenos">398</span></a>
</span><span id="GenerateSchedule-399"><a href="#GenerateSchedule-399"><span class="linenos">399</span></a>        <span class="n">arduino_controller</span><span class="o">.</span><span class="n">listener_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span><span id="GenerateSchedule-400"><a href="#GenerateSchedule-400"><span class="linenos">400</span></a>
</span><span id="GenerateSchedule-401"><a href="#GenerateSchedule-401"><span class="linenos">401</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Started listening thread for Arduino serial input.&quot;</span><span class="p">)</span>
</span><span id="GenerateSchedule-402"><a href="#GenerateSchedule-402"><span class="linenos">402</span></a>
</span><span id="GenerateSchedule-403"><a href="#GenerateSchedule-403"><span class="linenos">403</span></a>        <span class="c1"># transition back to idle</span>
</span><span id="GenerateSchedule-404"><a href="#GenerateSchedule-404"><span class="linenos">404</span></a>        <span class="n">trigger</span><span class="p">(</span><span class="s2">&quot;IDLE&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>This class handles the schedule generation state. It is called once the user has input the amount of simuli for this experiment, the
number of trial blocks, changed the names of the stimuli in each cylinder/valve in the 'Valve / Stimuli' window, and pressed generate schedule.</p>

<p>The main things handled here are the updating of gui objects that needed the previously discussed info to be created (e.g raster plots need
total trials, program schedule window needed the experiment data, etc.)</p>
</div>


                            <div id="GenerateSchedule.__init__" class="classattr">
                                        <input id="GenerateSchedule.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">GenerateSchedule</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">main_gui</span><span class="p">:</span> <span class="n">views</span><span class="o">.</span><span class="n">main_gui</span><span class="o">.</span><span class="n">MainGUI</span>,</span><span class="param">	<span class="n">arduino_controller</span><span class="p">:</span> <span class="n">controllers</span><span class="o">.</span><span class="n">arduino_control</span><span class="o">.</span><span class="n">ArduinoManager</span>,</span><span class="param">	<span class="n">process_queue</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]],</span> <span class="n">NoneType</span><span class="p">]</span>,</span><span class="param">	<span class="n">trigger</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="n">NoneType</span><span class="p">]</span></span>)</span>

                <label class="view-source-button" for="GenerateSchedule.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#GenerateSchedule.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="GenerateSchedule.__init__-358"><a href="#GenerateSchedule.__init__-358"><span class="linenos">358</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="GenerateSchedule.__init__-359"><a href="#GenerateSchedule.__init__-359"><span class="linenos">359</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="GenerateSchedule.__init__-360"><a href="#GenerateSchedule.__init__-360"><span class="linenos">360</span></a>        <span class="n">main_gui</span><span class="p">:</span> <span class="n">MainGUI</span><span class="p">,</span>
</span><span id="GenerateSchedule.__init__-361"><a href="#GenerateSchedule.__init__-361"><span class="linenos">361</span></a>        <span class="n">arduino_controller</span><span class="p">:</span> <span class="n">ArduinoManager</span><span class="p">,</span>
</span><span id="GenerateSchedule.__init__-362"><a href="#GenerateSchedule.__init__-362"><span class="linenos">362</span></a>        <span class="n">process_queue</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]],</span> <span class="kc">None</span><span class="p">],</span>
</span><span id="GenerateSchedule.__init__-363"><a href="#GenerateSchedule.__init__-363"><span class="linenos">363</span></a>        <span class="n">trigger</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="kc">None</span><span class="p">],</span>
</span><span id="GenerateSchedule.__init__-364"><a href="#GenerateSchedule.__init__-364"><span class="linenos">364</span></a>    <span class="p">):</span>
</span><span id="GenerateSchedule.__init__-365"><a href="#GenerateSchedule.__init__-365"><span class="linenos">365</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="GenerateSchedule.__init__-366"><a href="#GenerateSchedule.__init__-366"><span class="linenos">366</span></a><span class="sd">        Initialize and handle the GenerateSchedule class state.</span>
</span><span id="GenerateSchedule.__init__-367"><a href="#GenerateSchedule.__init__-367"><span class="linenos">367</span></a>
</span><span id="GenerateSchedule.__init__-368"><a href="#GenerateSchedule.__init__-368"><span class="linenos">368</span></a><span class="sd">        Parameters</span>
</span><span id="GenerateSchedule.__init__-369"><a href="#GenerateSchedule.__init__-369"><span class="linenos">369</span></a><span class="sd">        ----------</span>
</span><span id="GenerateSchedule.__init__-370"><a href="#GenerateSchedule.__init__-370"><span class="linenos">370</span></a><span class="sd">        - **main_gui** (*MainGUI*): A reference to the `views.main_gui` MainGUI instance, this is used to update elements inside the GUI window(s). Here we use it to</span>
</span><span id="GenerateSchedule.__init__-371"><a href="#GenerateSchedule.__init__-371"><span class="linenos">371</span></a><span class="sd">        update show the program schedule and create raster plots.</span>
</span><span id="GenerateSchedule.__init__-372"><a href="#GenerateSchedule.__init__-372"><span class="linenos">372</span></a><span class="sd">        - **arduino_controller** (*ArduinoManager*): A reference to the `controllers.arduino_control` Arduino controller instance, this is the method by which the Arduino is communicated</span>
</span><span id="GenerateSchedule.__init__-373"><a href="#GenerateSchedule.__init__-373"><span class="linenos">373</span></a><span class="sd">        with in the program. Used to send schedules, variables, and valve durations here.</span>
</span><span id="GenerateSchedule.__init__-374"><a href="#GenerateSchedule.__init__-374"><span class="linenos">374</span></a><span class="sd">        - **process_queue** (*Callback method*): This callback method is passed here so that the Arduino listener process thread can be started once the listener thread</span>
</span><span id="GenerateSchedule.__init__-375"><a href="#GenerateSchedule.__init__-375"><span class="linenos">375</span></a><span class="sd">        is running. It does NOT run prior to this so that sending individual bytes (send schedule, etc.) is performed without having data stolen away by the constantly running</span>
</span><span id="GenerateSchedule.__init__-376"><a href="#GenerateSchedule.__init__-376"><span class="linenos">376</span></a><span class="sd">        listener thread.</span>
</span><span id="GenerateSchedule.__init__-377"><a href="#GenerateSchedule.__init__-377"><span class="linenos">377</span></a><span class="sd">        - **trigger** (*Callback method*): This callback is passed in so that this state can trigger a transition back to `IDLE` when it is finished with its work.</span>
</span><span id="GenerateSchedule.__init__-378"><a href="#GenerateSchedule.__init__-378"><span class="linenos">378</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="GenerateSchedule.__init__-379"><a href="#GenerateSchedule.__init__-379"><span class="linenos">379</span></a>
</span><span id="GenerateSchedule.__init__-380"><a href="#GenerateSchedule.__init__-380"><span class="linenos">380</span></a>        <span class="c1"># show the program sched window via the callback passed into the class at initialization</span>
</span><span id="GenerateSchedule.__init__-381"><a href="#GenerateSchedule.__init__-381"><span class="linenos">381</span></a>        <span class="n">main_gui</span><span class="o">.</span><span class="n">show_secondary_window</span><span class="p">(</span><span class="s2">&quot;Program Schedule&quot;</span><span class="p">)</span>
</span><span id="GenerateSchedule.__init__-382"><a href="#GenerateSchedule.__init__-382"><span class="linenos">382</span></a>
</span><span id="GenerateSchedule.__init__-383"><a href="#GenerateSchedule.__init__-383"><span class="linenos">383</span></a>        <span class="c1"># create plots using generated number of trials as max Y values</span>
</span><span id="GenerateSchedule.__init__-384"><a href="#GenerateSchedule.__init__-384"><span class="linenos">384</span></a>        <span class="k">for</span> <span class="n">window</span> <span class="ow">in</span> <span class="n">main_gui</span><span class="o">.</span><span class="n">windows</span><span class="p">[</span><span class="s2">&quot;Raster Plot&quot;</span><span class="p">]:</span>
</span><span id="GenerateSchedule.__init__-385"><a href="#GenerateSchedule.__init__-385"><span class="linenos">385</span></a>            <span class="n">window</span><span class="o">.</span><span class="n">create_plot</span><span class="p">()</span>
</span><span id="GenerateSchedule.__init__-386"><a href="#GenerateSchedule.__init__-386"><span class="linenos">386</span></a>
</span><span id="GenerateSchedule.__init__-387"><a href="#GenerateSchedule.__init__-387"><span class="linenos">387</span></a>        <span class="c1"># send exp variables, schedule, and valve open durations stored in arduino_data.toml to the arduino</span>
</span><span id="GenerateSchedule.__init__-388"><a href="#GenerateSchedule.__init__-388"><span class="linenos">388</span></a>        <span class="n">arduino_controller</span><span class="o">.</span><span class="n">send_experiment_variables</span><span class="p">()</span>
</span><span id="GenerateSchedule.__init__-389"><a href="#GenerateSchedule.__init__-389"><span class="linenos">389</span></a>        <span class="n">arduino_controller</span><span class="o">.</span><span class="n">send_schedule_data</span><span class="p">()</span>
</span><span id="GenerateSchedule.__init__-390"><a href="#GenerateSchedule.__init__-390"><span class="linenos">390</span></a>        <span class="n">arduino_controller</span><span class="o">.</span><span class="n">send_valve_durations</span><span class="p">()</span>
</span><span id="GenerateSchedule.__init__-391"><a href="#GenerateSchedule.__init__-391"><span class="linenos">391</span></a>
</span><span id="GenerateSchedule.__init__-392"><a href="#GenerateSchedule.__init__-392"><span class="linenos">392</span></a>        <span class="c1"># start Arduino process queue and listener thread so we know when Arduino tries to tell us something</span>
</span><span id="GenerateSchedule.__init__-393"><a href="#GenerateSchedule.__init__-393"><span class="linenos">393</span></a>        <span class="n">process_queue</span><span class="p">(</span><span class="n">arduino_controller</span><span class="o">.</span><span class="n">data_queue</span><span class="p">)</span>
</span><span id="GenerateSchedule.__init__-394"><a href="#GenerateSchedule.__init__-394"><span class="linenos">394</span></a>
</span><span id="GenerateSchedule.__init__-395"><a href="#GenerateSchedule.__init__-395"><span class="linenos">395</span></a>        <span class="n">arduino_controller</span><span class="o">.</span><span class="n">listener_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span>
</span><span id="GenerateSchedule.__init__-396"><a href="#GenerateSchedule.__init__-396"><span class="linenos">396</span></a>            <span class="n">target</span><span class="o">=</span><span class="n">arduino_controller</span><span class="o">.</span><span class="n">listen_for_serial</span>
</span><span id="GenerateSchedule.__init__-397"><a href="#GenerateSchedule.__init__-397"><span class="linenos">397</span></a>        <span class="p">)</span>
</span><span id="GenerateSchedule.__init__-398"><a href="#GenerateSchedule.__init__-398"><span class="linenos">398</span></a>
</span><span id="GenerateSchedule.__init__-399"><a href="#GenerateSchedule.__init__-399"><span class="linenos">399</span></a>        <span class="n">arduino_controller</span><span class="o">.</span><span class="n">listener_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span><span id="GenerateSchedule.__init__-400"><a href="#GenerateSchedule.__init__-400"><span class="linenos">400</span></a>
</span><span id="GenerateSchedule.__init__-401"><a href="#GenerateSchedule.__init__-401"><span class="linenos">401</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Started listening thread for Arduino serial input.&quot;</span><span class="p">)</span>
</span><span id="GenerateSchedule.__init__-402"><a href="#GenerateSchedule.__init__-402"><span class="linenos">402</span></a>
</span><span id="GenerateSchedule.__init__-403"><a href="#GenerateSchedule.__init__-403"><span class="linenos">403</span></a>        <span class="c1"># transition back to idle</span>
</span><span id="GenerateSchedule.__init__-404"><a href="#GenerateSchedule.__init__-404"><span class="linenos">404</span></a>        <span class="n">trigger</span><span class="p">(</span><span class="s2">&quot;IDLE&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Initialize and handle the GenerateSchedule class state.</p>

<h2 id="parameters">Parameters</h2>

<ul>
<li><strong>main_gui</strong> (<em>MainGUI</em>): A reference to the <code>views.main_gui</code> MainGUI instance, this is used to update elements inside the GUI window(s). Here we use it to
update show the program schedule and create raster plots.</li>
<li><strong>arduino_controller</strong> (<em>ArduinoManager</em>): A reference to the <code>controllers.arduino_control</code> Arduino controller instance, this is the method by which the Arduino is communicated
with in the program. Used to send schedules, variables, and valve durations here.</li>
<li><strong>process_queue</strong> (<em>Callback method</em>): This callback method is passed here so that the Arduino listener process thread can be started once the listener thread
is running. It does NOT run prior to this so that sending individual bytes (send schedule, etc.) is performed without having data stolen away by the constantly running
listener thread.</li>
<li><strong>trigger</strong> (<em>Callback method</em>): This callback is passed in so that this state can trigger a transition back to <code>IDLE</code> when it is finished with its work.</li>
</ul>
</div>


                            </div>
                </section>
                <section id="StartProgram">
                            <input id="StartProgram-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">StartProgram</span>:

                <label class="view-source-button" for="StartProgram-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#StartProgram"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="StartProgram-407"><a href="#StartProgram-407"><span class="linenos">407</span></a><span class="k">class</span><span class="w"> </span><span class="nc">StartProgram</span><span class="p">:</span>
</span><span id="StartProgram-408"><a href="#StartProgram-408"><span class="linenos">408</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StartProgram-409"><a href="#StartProgram-409"><span class="linenos">409</span></a><span class="sd">    This class handles the remaining set-up steps to prepare for experiment runtime. It then triggers the experiment.</span>
</span><span id="StartProgram-410"><a href="#StartProgram-410"><span class="linenos">410</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="StartProgram-411"><a href="#StartProgram-411"><span class="linenos">411</span></a>
</span><span id="StartProgram-412"><a href="#StartProgram-412"><span class="linenos">412</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="StartProgram-413"><a href="#StartProgram-413"><span class="linenos">413</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="StartProgram-414"><a href="#StartProgram-414"><span class="linenos">414</span></a>        <span class="n">exp_data</span><span class="p">:</span> <span class="n">ExperimentProcessData</span><span class="p">,</span>
</span><span id="StartProgram-415"><a href="#StartProgram-415"><span class="linenos">415</span></a>        <span class="n">main_gui</span><span class="p">:</span> <span class="n">MainGUI</span><span class="p">,</span>
</span><span id="StartProgram-416"><a href="#StartProgram-416"><span class="linenos">416</span></a>        <span class="n">arduino_controller</span><span class="p">:</span> <span class="n">ArduinoManager</span><span class="p">,</span>
</span><span id="StartProgram-417"><a href="#StartProgram-417"><span class="linenos">417</span></a>        <span class="n">trigger</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="kc">None</span><span class="p">],</span>
</span><span id="StartProgram-418"><a href="#StartProgram-418"><span class="linenos">418</span></a>    <span class="p">):</span>
</span><span id="StartProgram-419"><a href="#StartProgram-419"><span class="linenos">419</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StartProgram-420"><a href="#StartProgram-420"><span class="linenos">420</span></a><span class="sd">        Parameters</span>
</span><span id="StartProgram-421"><a href="#StartProgram-421"><span class="linenos">421</span></a><span class="sd">        ----------</span>
</span><span id="StartProgram-422"><a href="#StartProgram-422"><span class="linenos">422</span></a><span class="sd">        - **exp_data** (*ExperimentProcessData*): Reference to the `models.experiment_process_data`. Here we use it to mark experiment and state start times.</span>
</span><span id="StartProgram-423"><a href="#StartProgram-423"><span class="linenos">423</span></a><span class="sd">        - **main_gui** (*MainGUI*): A reference to `views.main_gui` MainGUI instance, this is used to update elements inside the GUI window(s). Here we use it to</span>
</span><span id="StartProgram-424"><a href="#StartProgram-424"><span class="linenos">424</span></a><span class="sd">        update clock labels and max program runtime.</span>
</span><span id="StartProgram-425"><a href="#StartProgram-425"><span class="linenos">425</span></a><span class="sd">        - **arduino_controller** (*ArduinoManager*): A reference to the `controllers.arduino_control` instance, this is the method by which the Arduino is communicated</span>
</span><span id="StartProgram-426"><a href="#StartProgram-426"><span class="linenos">426</span></a><span class="sd">        with in the program. Used to tell Arduino that program begins now.</span>
</span><span id="StartProgram-427"><a href="#StartProgram-427"><span class="linenos">427</span></a><span class="sd">        - **trigger** (*Callback method*): This callback is passed in so that this state can trigger a transition to `ITI` when it is finished with its work.</span>
</span><span id="StartProgram-428"><a href="#StartProgram-428"><span class="linenos">428</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StartProgram-429"><a href="#StartProgram-429"><span class="linenos">429</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="StartProgram-430"><a href="#StartProgram-430"><span class="linenos">430</span></a>            <span class="c1"># update experiment data model program start time and state start time variables with current time</span>
</span><span id="StartProgram-431"><a href="#StartProgram-431"><span class="linenos">431</span></a>            <span class="n">exp_data</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="StartProgram-432"><a href="#StartProgram-432"><span class="linenos">432</span></a>            <span class="n">exp_data</span><span class="o">.</span><span class="n">state_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="StartProgram-433"><a href="#StartProgram-433"><span class="linenos">433</span></a>
</span><span id="StartProgram-434"><a href="#StartProgram-434"><span class="linenos">434</span></a>            <span class="c1"># tell Arduino that experiment starts now so it knows how to calculate timestamps</span>
</span><span id="StartProgram-435"><a href="#StartProgram-435"><span class="linenos">435</span></a>            <span class="n">start_command</span> <span class="o">=</span> <span class="s2">&quot;T=0</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
</span><span id="StartProgram-436"><a href="#StartProgram-436"><span class="linenos">436</span></a>            <span class="n">arduino_controller</span><span class="o">.</span><span class="n">send_command</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">start_command</span><span class="p">)</span>
</span><span id="StartProgram-437"><a href="#StartProgram-437"><span class="linenos">437</span></a>
</span><span id="StartProgram-438"><a href="#StartProgram-438"><span class="linenos">438</span></a>            <span class="n">main_gui</span><span class="o">.</span><span class="n">update_clock_label</span><span class="p">()</span>
</span><span id="StartProgram-439"><a href="#StartProgram-439"><span class="linenos">439</span></a>            <span class="n">main_gui</span><span class="o">.</span><span class="n">update_max_time</span><span class="p">()</span>
</span><span id="StartProgram-440"><a href="#StartProgram-440"><span class="linenos">440</span></a>
</span><span id="StartProgram-441"><a href="#StartProgram-441"><span class="linenos">441</span></a>            <span class="c1"># change the green start button into a red stop button, update the associated command</span>
</span><span id="StartProgram-442"><a href="#StartProgram-442"><span class="linenos">442</span></a>            <span class="n">main_gui</span><span class="o">.</span><span class="n">start_button</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span>
</span><span id="StartProgram-443"><a href="#StartProgram-443"><span class="linenos">443</span></a>                <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Stop&quot;</span><span class="p">,</span> <span class="n">bg</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">trigger</span><span class="p">(</span><span class="s2">&quot;STOP&quot;</span><span class="p">)</span>
</span><span id="StartProgram-444"><a href="#StartProgram-444"><span class="linenos">444</span></a>            <span class="p">)</span>
</span><span id="StartProgram-445"><a href="#StartProgram-445"><span class="linenos">445</span></a>
</span><span id="StartProgram-446"><a href="#StartProgram-446"><span class="linenos">446</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;==========EXPERIMENT BEGINS NOW==========&quot;</span><span class="p">)</span>
</span><span id="StartProgram-447"><a href="#StartProgram-447"><span class="linenos">447</span></a>
</span><span id="StartProgram-448"><a href="#StartProgram-448"><span class="linenos">448</span></a>            <span class="n">trigger</span><span class="p">(</span><span class="s2">&quot;ITI&quot;</span><span class="p">)</span>
</span><span id="StartProgram-449"><a href="#StartProgram-449"><span class="linenos">449</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="StartProgram-450"><a href="#StartProgram-450"><span class="linenos">450</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error starting program: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="StartProgram-451"><a href="#StartProgram-451"><span class="linenos">451</span></a>            <span class="k">raise</span>
</span></pre></div>


            <div class="docstring"><p>This class handles the remaining set-up steps to prepare for experiment runtime. It then triggers the experiment.</p>
</div>


                            <div id="StartProgram.__init__" class="classattr">
                                        <input id="StartProgram.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">StartProgram</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">exp_data</span><span class="p">:</span> <span class="n">models</span><span class="o">.</span><span class="n">experiment_process_data</span><span class="o">.</span><span class="n">ExperimentProcessData</span>,</span><span class="param">	<span class="n">main_gui</span><span class="p">:</span> <span class="n">views</span><span class="o">.</span><span class="n">main_gui</span><span class="o">.</span><span class="n">MainGUI</span>,</span><span class="param">	<span class="n">arduino_controller</span><span class="p">:</span> <span class="n">controllers</span><span class="o">.</span><span class="n">arduino_control</span><span class="o">.</span><span class="n">ArduinoManager</span>,</span><span class="param">	<span class="n">trigger</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="n">NoneType</span><span class="p">]</span></span>)</span>

                <label class="view-source-button" for="StartProgram.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#StartProgram.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="StartProgram.__init__-412"><a href="#StartProgram.__init__-412"><span class="linenos">412</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="StartProgram.__init__-413"><a href="#StartProgram.__init__-413"><span class="linenos">413</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="StartProgram.__init__-414"><a href="#StartProgram.__init__-414"><span class="linenos">414</span></a>        <span class="n">exp_data</span><span class="p">:</span> <span class="n">ExperimentProcessData</span><span class="p">,</span>
</span><span id="StartProgram.__init__-415"><a href="#StartProgram.__init__-415"><span class="linenos">415</span></a>        <span class="n">main_gui</span><span class="p">:</span> <span class="n">MainGUI</span><span class="p">,</span>
</span><span id="StartProgram.__init__-416"><a href="#StartProgram.__init__-416"><span class="linenos">416</span></a>        <span class="n">arduino_controller</span><span class="p">:</span> <span class="n">ArduinoManager</span><span class="p">,</span>
</span><span id="StartProgram.__init__-417"><a href="#StartProgram.__init__-417"><span class="linenos">417</span></a>        <span class="n">trigger</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="kc">None</span><span class="p">],</span>
</span><span id="StartProgram.__init__-418"><a href="#StartProgram.__init__-418"><span class="linenos">418</span></a>    <span class="p">):</span>
</span><span id="StartProgram.__init__-419"><a href="#StartProgram.__init__-419"><span class="linenos">419</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StartProgram.__init__-420"><a href="#StartProgram.__init__-420"><span class="linenos">420</span></a><span class="sd">        Parameters</span>
</span><span id="StartProgram.__init__-421"><a href="#StartProgram.__init__-421"><span class="linenos">421</span></a><span class="sd">        ----------</span>
</span><span id="StartProgram.__init__-422"><a href="#StartProgram.__init__-422"><span class="linenos">422</span></a><span class="sd">        - **exp_data** (*ExperimentProcessData*): Reference to the `models.experiment_process_data`. Here we use it to mark experiment and state start times.</span>
</span><span id="StartProgram.__init__-423"><a href="#StartProgram.__init__-423"><span class="linenos">423</span></a><span class="sd">        - **main_gui** (*MainGUI*): A reference to `views.main_gui` MainGUI instance, this is used to update elements inside the GUI window(s). Here we use it to</span>
</span><span id="StartProgram.__init__-424"><a href="#StartProgram.__init__-424"><span class="linenos">424</span></a><span class="sd">        update clock labels and max program runtime.</span>
</span><span id="StartProgram.__init__-425"><a href="#StartProgram.__init__-425"><span class="linenos">425</span></a><span class="sd">        - **arduino_controller** (*ArduinoManager*): A reference to the `controllers.arduino_control` instance, this is the method by which the Arduino is communicated</span>
</span><span id="StartProgram.__init__-426"><a href="#StartProgram.__init__-426"><span class="linenos">426</span></a><span class="sd">        with in the program. Used to tell Arduino that program begins now.</span>
</span><span id="StartProgram.__init__-427"><a href="#StartProgram.__init__-427"><span class="linenos">427</span></a><span class="sd">        - **trigger** (*Callback method*): This callback is passed in so that this state can trigger a transition to `ITI` when it is finished with its work.</span>
</span><span id="StartProgram.__init__-428"><a href="#StartProgram.__init__-428"><span class="linenos">428</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StartProgram.__init__-429"><a href="#StartProgram.__init__-429"><span class="linenos">429</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="StartProgram.__init__-430"><a href="#StartProgram.__init__-430"><span class="linenos">430</span></a>            <span class="c1"># update experiment data model program start time and state start time variables with current time</span>
</span><span id="StartProgram.__init__-431"><a href="#StartProgram.__init__-431"><span class="linenos">431</span></a>            <span class="n">exp_data</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="StartProgram.__init__-432"><a href="#StartProgram.__init__-432"><span class="linenos">432</span></a>            <span class="n">exp_data</span><span class="o">.</span><span class="n">state_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="StartProgram.__init__-433"><a href="#StartProgram.__init__-433"><span class="linenos">433</span></a>
</span><span id="StartProgram.__init__-434"><a href="#StartProgram.__init__-434"><span class="linenos">434</span></a>            <span class="c1"># tell Arduino that experiment starts now so it knows how to calculate timestamps</span>
</span><span id="StartProgram.__init__-435"><a href="#StartProgram.__init__-435"><span class="linenos">435</span></a>            <span class="n">start_command</span> <span class="o">=</span> <span class="s2">&quot;T=0</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
</span><span id="StartProgram.__init__-436"><a href="#StartProgram.__init__-436"><span class="linenos">436</span></a>            <span class="n">arduino_controller</span><span class="o">.</span><span class="n">send_command</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">start_command</span><span class="p">)</span>
</span><span id="StartProgram.__init__-437"><a href="#StartProgram.__init__-437"><span class="linenos">437</span></a>
</span><span id="StartProgram.__init__-438"><a href="#StartProgram.__init__-438"><span class="linenos">438</span></a>            <span class="n">main_gui</span><span class="o">.</span><span class="n">update_clock_label</span><span class="p">()</span>
</span><span id="StartProgram.__init__-439"><a href="#StartProgram.__init__-439"><span class="linenos">439</span></a>            <span class="n">main_gui</span><span class="o">.</span><span class="n">update_max_time</span><span class="p">()</span>
</span><span id="StartProgram.__init__-440"><a href="#StartProgram.__init__-440"><span class="linenos">440</span></a>
</span><span id="StartProgram.__init__-441"><a href="#StartProgram.__init__-441"><span class="linenos">441</span></a>            <span class="c1"># change the green start button into a red stop button, update the associated command</span>
</span><span id="StartProgram.__init__-442"><a href="#StartProgram.__init__-442"><span class="linenos">442</span></a>            <span class="n">main_gui</span><span class="o">.</span><span class="n">start_button</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span>
</span><span id="StartProgram.__init__-443"><a href="#StartProgram.__init__-443"><span class="linenos">443</span></a>                <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Stop&quot;</span><span class="p">,</span> <span class="n">bg</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">trigger</span><span class="p">(</span><span class="s2">&quot;STOP&quot;</span><span class="p">)</span>
</span><span id="StartProgram.__init__-444"><a href="#StartProgram.__init__-444"><span class="linenos">444</span></a>            <span class="p">)</span>
</span><span id="StartProgram.__init__-445"><a href="#StartProgram.__init__-445"><span class="linenos">445</span></a>
</span><span id="StartProgram.__init__-446"><a href="#StartProgram.__init__-446"><span class="linenos">446</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;==========EXPERIMENT BEGINS NOW==========&quot;</span><span class="p">)</span>
</span><span id="StartProgram.__init__-447"><a href="#StartProgram.__init__-447"><span class="linenos">447</span></a>
</span><span id="StartProgram.__init__-448"><a href="#StartProgram.__init__-448"><span class="linenos">448</span></a>            <span class="n">trigger</span><span class="p">(</span><span class="s2">&quot;ITI&quot;</span><span class="p">)</span>
</span><span id="StartProgram.__init__-449"><a href="#StartProgram.__init__-449"><span class="linenos">449</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="StartProgram.__init__-450"><a href="#StartProgram.__init__-450"><span class="linenos">450</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error starting program: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="StartProgram.__init__-451"><a href="#StartProgram.__init__-451"><span class="linenos">451</span></a>            <span class="k">raise</span>
</span></pre></div>


            <div class="docstring"><h2 id="parameters">Parameters</h2>

<ul>
<li><strong>exp_data</strong> (<em>ExperimentProcessData</em>): Reference to the <code>models.experiment_process_data</code>. Here we use it to mark experiment and state start times.</li>
<li><strong>main_gui</strong> (<em>MainGUI</em>): A reference to <code>views.main_gui</code> MainGUI instance, this is used to update elements inside the GUI window(s). Here we use it to
update clock labels and max program runtime.</li>
<li><strong>arduino_controller</strong> (<em>ArduinoManager</em>): A reference to the <code>controllers.arduino_control</code> instance, this is the method by which the Arduino is communicated
with in the program. Used to tell Arduino that program begins now.</li>
<li><strong>trigger</strong> (<em>Callback method</em>): This callback is passed in so that this state can trigger a transition to <code>ITI</code> when it is finished with its work.</li>
</ul>
</div>


                            </div>
                </section>
                <section id="StopProgram">
                            <input id="StopProgram-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">StopProgram</span>:

                <label class="view-source-button" for="StopProgram-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#StopProgram"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="StopProgram-454"><a href="#StopProgram-454"><span class="linenos">454</span></a><span class="k">class</span><span class="w"> </span><span class="nc">StopProgram</span><span class="p">:</span>
</span><span id="StopProgram-455"><a href="#StopProgram-455"><span class="linenos">455</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StopProgram-456"><a href="#StopProgram-456"><span class="linenos">456</span></a><span class="sd">    Stops and updates program to reflect `IDLE` state.</span>
</span><span id="StopProgram-457"><a href="#StopProgram-457"><span class="linenos">457</span></a>
</span><span id="StopProgram-458"><a href="#StopProgram-458"><span class="linenos">458</span></a><span class="sd">    Methods</span>
</span><span id="StopProgram-459"><a href="#StopProgram-459"><span class="linenos">459</span></a><span class="sd">    -------</span>
</span><span id="StopProgram-460"><a href="#StopProgram-460"><span class="linenos">460</span></a><span class="sd">    - `finalize_program`(main_gui, arduino_controller)</span>
</span><span id="StopProgram-461"><a href="#StopProgram-461"><span class="linenos">461</span></a><span class="sd">        This method waits until the door closes for the last time, then cancels the last scheduled task, stops the listener thread, closes Arduino connections, and</span>
</span><span id="StopProgram-462"><a href="#StopProgram-462"><span class="linenos">462</span></a><span class="sd">        instructs the user to save their data.</span>
</span><span id="StopProgram-463"><a href="#StopProgram-463"><span class="linenos">463</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="StopProgram-464"><a href="#StopProgram-464"><span class="linenos">464</span></a>
</span><span id="StopProgram-465"><a href="#StopProgram-465"><span class="linenos">465</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="StopProgram-466"><a href="#StopProgram-466"><span class="linenos">466</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="StopProgram-467"><a href="#StopProgram-467"><span class="linenos">467</span></a>        <span class="n">main_gui</span><span class="p">:</span> <span class="n">MainGUI</span><span class="p">,</span>
</span><span id="StopProgram-468"><a href="#StopProgram-468"><span class="linenos">468</span></a>        <span class="n">arduino_controller</span><span class="p">:</span> <span class="n">ArduinoManager</span><span class="p">,</span>
</span><span id="StopProgram-469"><a href="#StopProgram-469"><span class="linenos">469</span></a>        <span class="n">trigger</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="kc">None</span><span class="p">],</span>
</span><span id="StopProgram-470"><a href="#StopProgram-470"><span class="linenos">470</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="StopProgram-471"><a href="#StopProgram-471"><span class="linenos">471</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StopProgram-472"><a href="#StopProgram-472"><span class="linenos">472</span></a><span class="sd">        Parameters</span>
</span><span id="StopProgram-473"><a href="#StopProgram-473"><span class="linenos">473</span></a><span class="sd">        ----------</span>
</span><span id="StopProgram-474"><a href="#StopProgram-474"><span class="linenos">474</span></a><span class="sd">        - **main_gui** (*MainGUI*): A reference to `views.main_gui` MainGUI instance, this is used to update elements inside the GUI window(s). Here we use it to</span>
</span><span id="StopProgram-475"><a href="#StopProgram-475"><span class="linenos">475</span></a><span class="sd">        call update_on_stop, configure the start/stop button back to start, and cancel tkinter scheduled tasks.</span>
</span><span id="StopProgram-476"><a href="#StopProgram-476"><span class="linenos">476</span></a><span class="sd">        - **arduino_controller** (*ArduinoManager*): A reference to the `controllers.arduino_control` instance, this is the method by which the Arduino is communicated</span>
</span><span id="StopProgram-477"><a href="#StopProgram-477"><span class="linenos">477</span></a><span class="sd">        with in the program. Used to reset Arduino and clear all left-over experiment data.</span>
</span><span id="StopProgram-478"><a href="#StopProgram-478"><span class="linenos">478</span></a><span class="sd">        - **trigger** (*Callback method*): This callback is passed in so the start button can be configured to command a `START` state.</span>
</span><span id="StopProgram-479"><a href="#StopProgram-479"><span class="linenos">479</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StopProgram-480"><a href="#StopProgram-480"><span class="linenos">480</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="StopProgram-481"><a href="#StopProgram-481"><span class="linenos">481</span></a>            <span class="n">main_gui</span><span class="o">.</span><span class="n">update_on_stop</span><span class="p">()</span>
</span><span id="StopProgram-482"><a href="#StopProgram-482"><span class="linenos">482</span></a>            <span class="c1"># change the command back to start for the start button. (STOP PROGRAM, START) is not a defined transition, so the</span>
</span><span id="StopProgram-483"><a href="#StopProgram-483"><span class="linenos">483</span></a>            <span class="c1"># trigger function will call reject_actions to let the user know the program has already ran and they need to reset the app.</span>
</span><span id="StopProgram-484"><a href="#StopProgram-484"><span class="linenos">484</span></a>            <span class="n">main_gui</span><span class="o">.</span><span class="n">start_button</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span>
</span><span id="StopProgram-485"><a href="#StopProgram-485"><span class="linenos">485</span></a>                <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Start&quot;</span><span class="p">,</span> <span class="n">bg</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">trigger</span><span class="p">(</span><span class="s2">&quot;START&quot;</span><span class="p">)</span>
</span><span id="StopProgram-486"><a href="#StopProgram-486"><span class="linenos">486</span></a>            <span class="p">)</span>
</span><span id="StopProgram-487"><a href="#StopProgram-487"><span class="linenos">487</span></a>
</span><span id="StopProgram-488"><a href="#StopProgram-488"><span class="linenos">488</span></a>            <span class="c1"># stop all scheduled tasks EXCEPT for the process queue, we are still waiting for the last door close timestamp</span>
</span><span id="StopProgram-489"><a href="#StopProgram-489"><span class="linenos">489</span></a>            <span class="k">for</span> <span class="n">desc</span><span class="p">,</span> <span class="n">sched_task</span> <span class="ow">in</span> <span class="n">main_gui</span><span class="o">.</span><span class="n">scheduled_tasks</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="StopProgram-490"><a href="#StopProgram-490"><span class="linenos">490</span></a>                <span class="k">if</span> <span class="n">desc</span> <span class="o">!=</span> <span class="s2">&quot;PROCESS QUEUE&quot;</span><span class="p">:</span>
</span><span id="StopProgram-491"><a href="#StopProgram-491"><span class="linenos">491</span></a>                    <span class="n">main_gui</span><span class="o">.</span><span class="n">after_cancel</span><span class="p">(</span><span class="n">sched_task</span><span class="p">)</span>
</span><span id="StopProgram-492"><a href="#StopProgram-492"><span class="linenos">492</span></a>
</span><span id="StopProgram-493"><a href="#StopProgram-493"><span class="linenos">493</span></a>            <span class="c1"># schedule finalization after door will be down</span>
</span><span id="StopProgram-494"><a href="#StopProgram-494"><span class="linenos">494</span></a>            <span class="n">main_gui</span><span class="o">.</span><span class="n">scheduled_tasks</span><span class="p">[</span><span class="s2">&quot;FINALIZE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">main_gui</span><span class="o">.</span><span class="n">after</span><span class="p">(</span>
</span><span id="StopProgram-495"><a href="#StopProgram-495"><span class="linenos">495</span></a>                <span class="mi">5000</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">finalize_program</span><span class="p">(</span><span class="n">main_gui</span><span class="p">,</span> <span class="n">arduino_controller</span><span class="p">)</span>
</span><span id="StopProgram-496"><a href="#StopProgram-496"><span class="linenos">496</span></a>            <span class="p">)</span>
</span><span id="StopProgram-497"><a href="#StopProgram-497"><span class="linenos">497</span></a>
</span><span id="StopProgram-498"><a href="#StopProgram-498"><span class="linenos">498</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Program stopped... waiting to finalize...&quot;</span><span class="p">)</span>
</span><span id="StopProgram-499"><a href="#StopProgram-499"><span class="linenos">499</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="StopProgram-500"><a href="#StopProgram-500"><span class="linenos">500</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error stopping program: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="StopProgram-501"><a href="#StopProgram-501"><span class="linenos">501</span></a>            <span class="k">raise</span>
</span><span id="StopProgram-502"><a href="#StopProgram-502"><span class="linenos">502</span></a>
</span><span id="StopProgram-503"><a href="#StopProgram-503"><span class="linenos">503</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">finalize_program</span><span class="p">(</span>
</span><span id="StopProgram-504"><a href="#StopProgram-504"><span class="linenos">504</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">main_gui</span><span class="p">:</span> <span class="n">MainGUI</span><span class="p">,</span> <span class="n">arduino_controller</span><span class="p">:</span> <span class="n">ArduinoManager</span>
</span><span id="StopProgram-505"><a href="#StopProgram-505"><span class="linenos">505</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="StopProgram-506"><a href="#StopProgram-506"><span class="linenos">506</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StopProgram-507"><a href="#StopProgram-507"><span class="linenos">507</span></a><span class="sd">        Finalize the program by resetting the Arduino board, offer to save the data frames into xlsx files.</span>
</span><span id="StopProgram-508"><a href="#StopProgram-508"><span class="linenos">508</span></a>
</span><span id="StopProgram-509"><a href="#StopProgram-509"><span class="linenos">509</span></a><span class="sd">        Parameters</span>
</span><span id="StopProgram-510"><a href="#StopProgram-510"><span class="linenos">510</span></a><span class="sd">        ----------</span>
</span><span id="StopProgram-511"><a href="#StopProgram-511"><span class="linenos">511</span></a><span class="sd">        - **main_gui** (*MainGUI*): A reference to `views.main_gui` MainGUI instance, this is used to update elements inside the GUI window(s). Here we use it to</span>
</span><span id="StopProgram-512"><a href="#StopProgram-512"><span class="linenos">512</span></a><span class="sd">        cancel the last tkinter.after call.</span>
</span><span id="StopProgram-513"><a href="#StopProgram-513"><span class="linenos">513</span></a><span class="sd">        - **arduino_controller** (*ArduinoManager*): A reference to the `controllers.arduino_control` instance, this is the method by which the Arduino is communicated</span>
</span><span id="StopProgram-514"><a href="#StopProgram-514"><span class="linenos">514</span></a><span class="sd">        with in the program. Used to reset Arduino board and close the connection to it.</span>
</span><span id="StopProgram-515"><a href="#StopProgram-515"><span class="linenos">515</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StopProgram-516"><a href="#StopProgram-516"><span class="linenos">516</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="StopProgram-517"><a href="#StopProgram-517"><span class="linenos">517</span></a>            <span class="c1"># stop the arduino listener so that the program can shut down</span>
</span><span id="StopProgram-518"><a href="#StopProgram-518"><span class="linenos">518</span></a>            <span class="c1"># and not be blocked</span>
</span><span id="StopProgram-519"><a href="#StopProgram-519"><span class="linenos">519</span></a>            <span class="n">arduino_controller</span><span class="o">.</span><span class="n">stop_listener_thread</span><span class="p">()</span>
</span><span id="StopProgram-520"><a href="#StopProgram-520"><span class="linenos">520</span></a>
</span><span id="StopProgram-521"><a href="#StopProgram-521"><span class="linenos">521</span></a>            <span class="n">queue_id</span> <span class="o">=</span> <span class="n">main_gui</span><span class="o">.</span><span class="n">scheduled_tasks</span><span class="p">[</span><span class="s2">&quot;PROCESS QUEUE&quot;</span><span class="p">]</span>
</span><span id="StopProgram-522"><a href="#StopProgram-522"><span class="linenos">522</span></a>            <span class="n">main_gui</span><span class="o">.</span><span class="n">after_cancel</span><span class="p">(</span><span class="n">queue_id</span><span class="p">)</span>
</span><span id="StopProgram-523"><a href="#StopProgram-523"><span class="linenos">523</span></a>
</span><span id="StopProgram-524"><a href="#StopProgram-524"><span class="linenos">524</span></a>            <span class="n">arduino_controller</span><span class="o">.</span><span class="n">close_connection</span><span class="p">()</span>
</span><span id="StopProgram-525"><a href="#StopProgram-525"><span class="linenos">525</span></a>
</span><span id="StopProgram-526"><a href="#StopProgram-526"><span class="linenos">526</span></a>            <span class="n">main_gui</span><span class="o">.</span><span class="n">save_button_handler</span><span class="p">()</span>
</span><span id="StopProgram-527"><a href="#StopProgram-527"><span class="linenos">527</span></a>
</span><span id="StopProgram-528"><a href="#StopProgram-528"><span class="linenos">528</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Program finalized, arduino boards reset.&quot;</span><span class="p">)</span>
</span><span id="StopProgram-529"><a href="#StopProgram-529"><span class="linenos">529</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="StopProgram-530"><a href="#StopProgram-530"><span class="linenos">530</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error completing program: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="StopProgram-531"><a href="#StopProgram-531"><span class="linenos">531</span></a>            <span class="k">raise</span>
</span></pre></div>


            <div class="docstring"><p>Stops and updates program to reflect <code>IDLE</code> state.</p>

<h2 id="methods">Methods</h2>

<ul>
<li><code><a href="#StopProgram.finalize_program">finalize_program</a></code>(main_gui, arduino_controller)
This method waits until the door closes for the last time, then cancels the last scheduled task, stops the listener thread, closes Arduino connections, and
instructs the user to save their data.</li>
</ul>
</div>


                            <div id="StopProgram.__init__" class="classattr">
                                        <input id="StopProgram.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">StopProgram</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">main_gui</span><span class="p">:</span> <span class="n">views</span><span class="o">.</span><span class="n">main_gui</span><span class="o">.</span><span class="n">MainGUI</span>,</span><span class="param">	<span class="n">arduino_controller</span><span class="p">:</span> <span class="n">controllers</span><span class="o">.</span><span class="n">arduino_control</span><span class="o">.</span><span class="n">ArduinoManager</span>,</span><span class="param">	<span class="n">trigger</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="n">NoneType</span><span class="p">]</span></span>)</span>

                <label class="view-source-button" for="StopProgram.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#StopProgram.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="StopProgram.__init__-465"><a href="#StopProgram.__init__-465"><span class="linenos">465</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="StopProgram.__init__-466"><a href="#StopProgram.__init__-466"><span class="linenos">466</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="StopProgram.__init__-467"><a href="#StopProgram.__init__-467"><span class="linenos">467</span></a>        <span class="n">main_gui</span><span class="p">:</span> <span class="n">MainGUI</span><span class="p">,</span>
</span><span id="StopProgram.__init__-468"><a href="#StopProgram.__init__-468"><span class="linenos">468</span></a>        <span class="n">arduino_controller</span><span class="p">:</span> <span class="n">ArduinoManager</span><span class="p">,</span>
</span><span id="StopProgram.__init__-469"><a href="#StopProgram.__init__-469"><span class="linenos">469</span></a>        <span class="n">trigger</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="kc">None</span><span class="p">],</span>
</span><span id="StopProgram.__init__-470"><a href="#StopProgram.__init__-470"><span class="linenos">470</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="StopProgram.__init__-471"><a href="#StopProgram.__init__-471"><span class="linenos">471</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StopProgram.__init__-472"><a href="#StopProgram.__init__-472"><span class="linenos">472</span></a><span class="sd">        Parameters</span>
</span><span id="StopProgram.__init__-473"><a href="#StopProgram.__init__-473"><span class="linenos">473</span></a><span class="sd">        ----------</span>
</span><span id="StopProgram.__init__-474"><a href="#StopProgram.__init__-474"><span class="linenos">474</span></a><span class="sd">        - **main_gui** (*MainGUI*): A reference to `views.main_gui` MainGUI instance, this is used to update elements inside the GUI window(s). Here we use it to</span>
</span><span id="StopProgram.__init__-475"><a href="#StopProgram.__init__-475"><span class="linenos">475</span></a><span class="sd">        call update_on_stop, configure the start/stop button back to start, and cancel tkinter scheduled tasks.</span>
</span><span id="StopProgram.__init__-476"><a href="#StopProgram.__init__-476"><span class="linenos">476</span></a><span class="sd">        - **arduino_controller** (*ArduinoManager*): A reference to the `controllers.arduino_control` instance, this is the method by which the Arduino is communicated</span>
</span><span id="StopProgram.__init__-477"><a href="#StopProgram.__init__-477"><span class="linenos">477</span></a><span class="sd">        with in the program. Used to reset Arduino and clear all left-over experiment data.</span>
</span><span id="StopProgram.__init__-478"><a href="#StopProgram.__init__-478"><span class="linenos">478</span></a><span class="sd">        - **trigger** (*Callback method*): This callback is passed in so the start button can be configured to command a `START` state.</span>
</span><span id="StopProgram.__init__-479"><a href="#StopProgram.__init__-479"><span class="linenos">479</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StopProgram.__init__-480"><a href="#StopProgram.__init__-480"><span class="linenos">480</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="StopProgram.__init__-481"><a href="#StopProgram.__init__-481"><span class="linenos">481</span></a>            <span class="n">main_gui</span><span class="o">.</span><span class="n">update_on_stop</span><span class="p">()</span>
</span><span id="StopProgram.__init__-482"><a href="#StopProgram.__init__-482"><span class="linenos">482</span></a>            <span class="c1"># change the command back to start for the start button. (STOP PROGRAM, START) is not a defined transition, so the</span>
</span><span id="StopProgram.__init__-483"><a href="#StopProgram.__init__-483"><span class="linenos">483</span></a>            <span class="c1"># trigger function will call reject_actions to let the user know the program has already ran and they need to reset the app.</span>
</span><span id="StopProgram.__init__-484"><a href="#StopProgram.__init__-484"><span class="linenos">484</span></a>            <span class="n">main_gui</span><span class="o">.</span><span class="n">start_button</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span>
</span><span id="StopProgram.__init__-485"><a href="#StopProgram.__init__-485"><span class="linenos">485</span></a>                <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Start&quot;</span><span class="p">,</span> <span class="n">bg</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">trigger</span><span class="p">(</span><span class="s2">&quot;START&quot;</span><span class="p">)</span>
</span><span id="StopProgram.__init__-486"><a href="#StopProgram.__init__-486"><span class="linenos">486</span></a>            <span class="p">)</span>
</span><span id="StopProgram.__init__-487"><a href="#StopProgram.__init__-487"><span class="linenos">487</span></a>
</span><span id="StopProgram.__init__-488"><a href="#StopProgram.__init__-488"><span class="linenos">488</span></a>            <span class="c1"># stop all scheduled tasks EXCEPT for the process queue, we are still waiting for the last door close timestamp</span>
</span><span id="StopProgram.__init__-489"><a href="#StopProgram.__init__-489"><span class="linenos">489</span></a>            <span class="k">for</span> <span class="n">desc</span><span class="p">,</span> <span class="n">sched_task</span> <span class="ow">in</span> <span class="n">main_gui</span><span class="o">.</span><span class="n">scheduled_tasks</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="StopProgram.__init__-490"><a href="#StopProgram.__init__-490"><span class="linenos">490</span></a>                <span class="k">if</span> <span class="n">desc</span> <span class="o">!=</span> <span class="s2">&quot;PROCESS QUEUE&quot;</span><span class="p">:</span>
</span><span id="StopProgram.__init__-491"><a href="#StopProgram.__init__-491"><span class="linenos">491</span></a>                    <span class="n">main_gui</span><span class="o">.</span><span class="n">after_cancel</span><span class="p">(</span><span class="n">sched_task</span><span class="p">)</span>
</span><span id="StopProgram.__init__-492"><a href="#StopProgram.__init__-492"><span class="linenos">492</span></a>
</span><span id="StopProgram.__init__-493"><a href="#StopProgram.__init__-493"><span class="linenos">493</span></a>            <span class="c1"># schedule finalization after door will be down</span>
</span><span id="StopProgram.__init__-494"><a href="#StopProgram.__init__-494"><span class="linenos">494</span></a>            <span class="n">main_gui</span><span class="o">.</span><span class="n">scheduled_tasks</span><span class="p">[</span><span class="s2">&quot;FINALIZE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">main_gui</span><span class="o">.</span><span class="n">after</span><span class="p">(</span>
</span><span id="StopProgram.__init__-495"><a href="#StopProgram.__init__-495"><span class="linenos">495</span></a>                <span class="mi">5000</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">finalize_program</span><span class="p">(</span><span class="n">main_gui</span><span class="p">,</span> <span class="n">arduino_controller</span><span class="p">)</span>
</span><span id="StopProgram.__init__-496"><a href="#StopProgram.__init__-496"><span class="linenos">496</span></a>            <span class="p">)</span>
</span><span id="StopProgram.__init__-497"><a href="#StopProgram.__init__-497"><span class="linenos">497</span></a>
</span><span id="StopProgram.__init__-498"><a href="#StopProgram.__init__-498"><span class="linenos">498</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Program stopped... waiting to finalize...&quot;</span><span class="p">)</span>
</span><span id="StopProgram.__init__-499"><a href="#StopProgram.__init__-499"><span class="linenos">499</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="StopProgram.__init__-500"><a href="#StopProgram.__init__-500"><span class="linenos">500</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error stopping program: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="StopProgram.__init__-501"><a href="#StopProgram.__init__-501"><span class="linenos">501</span></a>            <span class="k">raise</span>
</span></pre></div>


            <div class="docstring"><h2 id="parameters">Parameters</h2>

<ul>
<li><strong>main_gui</strong> (<em>MainGUI</em>): A reference to <code>views.main_gui</code> MainGUI instance, this is used to update elements inside the GUI window(s). Here we use it to
call update_on_stop, configure the start/stop button back to start, and cancel tkinter scheduled tasks.</li>
<li><strong>arduino_controller</strong> (<em>ArduinoManager</em>): A reference to the <code>controllers.arduino_control</code> instance, this is the method by which the Arduino is communicated
with in the program. Used to reset Arduino and clear all left-over experiment data.</li>
<li><strong>trigger</strong> (<em>Callback method</em>): This callback is passed in so the start button can be configured to command a <code>START</code> state.</li>
</ul>
</div>


                            </div>
                            <div id="StopProgram.finalize_program" class="classattr">
                                        <input id="StopProgram.finalize_program-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">finalize_program</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">main_gui</span><span class="p">:</span> <span class="n">views</span><span class="o">.</span><span class="n">main_gui</span><span class="o">.</span><span class="n">MainGUI</span>,</span><span class="param">	<span class="n">arduino_controller</span><span class="p">:</span> <span class="n">controllers</span><span class="o">.</span><span class="n">arduino_control</span><span class="o">.</span><span class="n">ArduinoManager</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="StopProgram.finalize_program-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#StopProgram.finalize_program"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="StopProgram.finalize_program-503"><a href="#StopProgram.finalize_program-503"><span class="linenos">503</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">finalize_program</span><span class="p">(</span>
</span><span id="StopProgram.finalize_program-504"><a href="#StopProgram.finalize_program-504"><span class="linenos">504</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">main_gui</span><span class="p">:</span> <span class="n">MainGUI</span><span class="p">,</span> <span class="n">arduino_controller</span><span class="p">:</span> <span class="n">ArduinoManager</span>
</span><span id="StopProgram.finalize_program-505"><a href="#StopProgram.finalize_program-505"><span class="linenos">505</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="StopProgram.finalize_program-506"><a href="#StopProgram.finalize_program-506"><span class="linenos">506</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StopProgram.finalize_program-507"><a href="#StopProgram.finalize_program-507"><span class="linenos">507</span></a><span class="sd">        Finalize the program by resetting the Arduino board, offer to save the data frames into xlsx files.</span>
</span><span id="StopProgram.finalize_program-508"><a href="#StopProgram.finalize_program-508"><span class="linenos">508</span></a>
</span><span id="StopProgram.finalize_program-509"><a href="#StopProgram.finalize_program-509"><span class="linenos">509</span></a><span class="sd">        Parameters</span>
</span><span id="StopProgram.finalize_program-510"><a href="#StopProgram.finalize_program-510"><span class="linenos">510</span></a><span class="sd">        ----------</span>
</span><span id="StopProgram.finalize_program-511"><a href="#StopProgram.finalize_program-511"><span class="linenos">511</span></a><span class="sd">        - **main_gui** (*MainGUI*): A reference to `views.main_gui` MainGUI instance, this is used to update elements inside the GUI window(s). Here we use it to</span>
</span><span id="StopProgram.finalize_program-512"><a href="#StopProgram.finalize_program-512"><span class="linenos">512</span></a><span class="sd">        cancel the last tkinter.after call.</span>
</span><span id="StopProgram.finalize_program-513"><a href="#StopProgram.finalize_program-513"><span class="linenos">513</span></a><span class="sd">        - **arduino_controller** (*ArduinoManager*): A reference to the `controllers.arduino_control` instance, this is the method by which the Arduino is communicated</span>
</span><span id="StopProgram.finalize_program-514"><a href="#StopProgram.finalize_program-514"><span class="linenos">514</span></a><span class="sd">        with in the program. Used to reset Arduino board and close the connection to it.</span>
</span><span id="StopProgram.finalize_program-515"><a href="#StopProgram.finalize_program-515"><span class="linenos">515</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StopProgram.finalize_program-516"><a href="#StopProgram.finalize_program-516"><span class="linenos">516</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="StopProgram.finalize_program-517"><a href="#StopProgram.finalize_program-517"><span class="linenos">517</span></a>            <span class="c1"># stop the arduino listener so that the program can shut down</span>
</span><span id="StopProgram.finalize_program-518"><a href="#StopProgram.finalize_program-518"><span class="linenos">518</span></a>            <span class="c1"># and not be blocked</span>
</span><span id="StopProgram.finalize_program-519"><a href="#StopProgram.finalize_program-519"><span class="linenos">519</span></a>            <span class="n">arduino_controller</span><span class="o">.</span><span class="n">stop_listener_thread</span><span class="p">()</span>
</span><span id="StopProgram.finalize_program-520"><a href="#StopProgram.finalize_program-520"><span class="linenos">520</span></a>
</span><span id="StopProgram.finalize_program-521"><a href="#StopProgram.finalize_program-521"><span class="linenos">521</span></a>            <span class="n">queue_id</span> <span class="o">=</span> <span class="n">main_gui</span><span class="o">.</span><span class="n">scheduled_tasks</span><span class="p">[</span><span class="s2">&quot;PROCESS QUEUE&quot;</span><span class="p">]</span>
</span><span id="StopProgram.finalize_program-522"><a href="#StopProgram.finalize_program-522"><span class="linenos">522</span></a>            <span class="n">main_gui</span><span class="o">.</span><span class="n">after_cancel</span><span class="p">(</span><span class="n">queue_id</span><span class="p">)</span>
</span><span id="StopProgram.finalize_program-523"><a href="#StopProgram.finalize_program-523"><span class="linenos">523</span></a>
</span><span id="StopProgram.finalize_program-524"><a href="#StopProgram.finalize_program-524"><span class="linenos">524</span></a>            <span class="n">arduino_controller</span><span class="o">.</span><span class="n">close_connection</span><span class="p">()</span>
</span><span id="StopProgram.finalize_program-525"><a href="#StopProgram.finalize_program-525"><span class="linenos">525</span></a>
</span><span id="StopProgram.finalize_program-526"><a href="#StopProgram.finalize_program-526"><span class="linenos">526</span></a>            <span class="n">main_gui</span><span class="o">.</span><span class="n">save_button_handler</span><span class="p">()</span>
</span><span id="StopProgram.finalize_program-527"><a href="#StopProgram.finalize_program-527"><span class="linenos">527</span></a>
</span><span id="StopProgram.finalize_program-528"><a href="#StopProgram.finalize_program-528"><span class="linenos">528</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Program finalized, arduino boards reset.&quot;</span><span class="p">)</span>
</span><span id="StopProgram.finalize_program-529"><a href="#StopProgram.finalize_program-529"><span class="linenos">529</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="StopProgram.finalize_program-530"><a href="#StopProgram.finalize_program-530"><span class="linenos">530</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error completing program: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="StopProgram.finalize_program-531"><a href="#StopProgram.finalize_program-531"><span class="linenos">531</span></a>            <span class="k">raise</span>
</span></pre></div>


            <div class="docstring"><p>Finalize the program by resetting the Arduino board, offer to save the data frames into xlsx files.</p>

<h2 id="parameters">Parameters</h2>

<ul>
<li><strong>main_gui</strong> (<em>MainGUI</em>): A reference to <code>views.main_gui</code> MainGUI instance, this is used to update elements inside the GUI window(s). Here we use it to
cancel the last tkinter.after call.</li>
<li><strong>arduino_controller</strong> (<em>ArduinoManager</em>): A reference to the <code>controllers.arduino_control</code> instance, this is the method by which the Arduino is communicated
with in the program. Used to reset Arduino board and close the connection to it.</li>
</ul>
</div>


                            </div>
                </section>
                <section id="ResetProgram">
                            <input id="ResetProgram-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">ResetProgram</span>:

                <label class="view-source-button" for="ResetProgram-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ResetProgram"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ResetProgram-534"><a href="#ResetProgram-534"><span class="linenos">534</span></a><span class="k">class</span><span class="w"> </span><span class="nc">ResetProgram</span><span class="p">:</span>
</span><span id="ResetProgram-535"><a href="#ResetProgram-535"><span class="linenos">535</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ResetProgram-536"><a href="#ResetProgram-536"><span class="linenos">536</span></a><span class="sd">    Handle resetting the program on click of the reset button. This class has no instance variable or methods.</span>
</span><span id="ResetProgram-537"><a href="#ResetProgram-537"><span class="linenos">537</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="ResetProgram-538"><a href="#ResetProgram-538"><span class="linenos">538</span></a>
</span><span id="ResetProgram-539"><a href="#ResetProgram-539"><span class="linenos">539</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="ResetProgram-540"><a href="#ResetProgram-540"><span class="linenos">540</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">main_gui</span><span class="p">:</span> <span class="n">MainGUI</span><span class="p">,</span> <span class="n">app_result</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">arduino_controller</span><span class="p">:</span> <span class="n">ArduinoManager</span>
</span><span id="ResetProgram-541"><a href="#ResetProgram-541"><span class="linenos">541</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ResetProgram-542"><a href="#ResetProgram-542"><span class="linenos">542</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="ResetProgram-543"><a href="#ResetProgram-543"><span class="linenos">543</span></a>            <span class="c1"># these two calls will stop the gui, halting the programs mainloop.</span>
</span><span id="ResetProgram-544"><a href="#ResetProgram-544"><span class="linenos">544</span></a>            <span class="n">main_gui</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>
</span><span id="ResetProgram-545"><a href="#ResetProgram-545"><span class="linenos">545</span></a>            <span class="n">main_gui</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>
</span><span id="ResetProgram-546"><a href="#ResetProgram-546"><span class="linenos">546</span></a>
</span><span id="ResetProgram-547"><a href="#ResetProgram-547"><span class="linenos">547</span></a>            <span class="c1"># cancel all scheduled tasks</span>
</span><span id="ResetProgram-548"><a href="#ResetProgram-548"><span class="linenos">548</span></a>            <span class="k">for</span> <span class="n">sched_task</span> <span class="ow">in</span> <span class="n">main_gui</span><span class="o">.</span><span class="n">scheduled_tasks</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
</span><span id="ResetProgram-549"><a href="#ResetProgram-549"><span class="linenos">549</span></a>                <span class="n">main_gui</span><span class="o">.</span><span class="n">after_cancel</span><span class="p">(</span><span class="n">sched_task</span><span class="p">)</span>
</span><span id="ResetProgram-550"><a href="#ResetProgram-550"><span class="linenos">550</span></a>            <span class="c1"># if we have an listener thread and arduino connected, stop the thread and close the connection.</span>
</span><span id="ResetProgram-551"><a href="#ResetProgram-551"><span class="linenos">551</span></a>            <span class="k">if</span> <span class="n">arduino_controller</span><span class="o">.</span><span class="n">listener_thread</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ResetProgram-552"><a href="#ResetProgram-552"><span class="linenos">552</span></a>                <span class="n">arduino_controller</span><span class="o">.</span><span class="n">stop_listener_thread</span><span class="p">()</span>
</span><span id="ResetProgram-553"><a href="#ResetProgram-553"><span class="linenos">553</span></a>            <span class="k">if</span> <span class="n">arduino_controller</span><span class="o">.</span><span class="n">arduino</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ResetProgram-554"><a href="#ResetProgram-554"><span class="linenos">554</span></a>                <span class="n">arduino_controller</span><span class="o">.</span><span class="n">close_connection</span><span class="p">()</span>
</span><span id="ResetProgram-555"><a href="#ResetProgram-555"><span class="linenos">555</span></a>
</span><span id="ResetProgram-556"><a href="#ResetProgram-556"><span class="linenos">556</span></a>            <span class="c1"># set first bit in app_result list to 1 to instruct main to restart.</span>
</span><span id="ResetProgram-557"><a href="#ResetProgram-557"><span class="linenos">557</span></a>            <span class="n">app_result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="ResetProgram-558"><a href="#ResetProgram-558"><span class="linenos">558</span></a>
</span><span id="ResetProgram-559"><a href="#ResetProgram-559"><span class="linenos">559</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="ResetProgram-560"><a href="#ResetProgram-560"><span class="linenos">560</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error resetting the program: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Handle resetting the program on click of the reset button. This class has no instance variable or methods.</p>
</div>


                            <div id="ResetProgram.__init__" class="classattr">
                                        <input id="ResetProgram.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">ResetProgram</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">main_gui</span><span class="p">:</span> <span class="n">views</span><span class="o">.</span><span class="n">main_gui</span><span class="o">.</span><span class="n">MainGUI</span>,</span><span class="param">	<span class="n">app_result</span><span class="p">:</span> <span class="nb">list</span>,</span><span class="param">	<span class="n">arduino_controller</span><span class="p">:</span> <span class="n">controllers</span><span class="o">.</span><span class="n">arduino_control</span><span class="o">.</span><span class="n">ArduinoManager</span></span>)</span>

                <label class="view-source-button" for="ResetProgram.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ResetProgram.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ResetProgram.__init__-539"><a href="#ResetProgram.__init__-539"><span class="linenos">539</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="ResetProgram.__init__-540"><a href="#ResetProgram.__init__-540"><span class="linenos">540</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">main_gui</span><span class="p">:</span> <span class="n">MainGUI</span><span class="p">,</span> <span class="n">app_result</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">arduino_controller</span><span class="p">:</span> <span class="n">ArduinoManager</span>
</span><span id="ResetProgram.__init__-541"><a href="#ResetProgram.__init__-541"><span class="linenos">541</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ResetProgram.__init__-542"><a href="#ResetProgram.__init__-542"><span class="linenos">542</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="ResetProgram.__init__-543"><a href="#ResetProgram.__init__-543"><span class="linenos">543</span></a>            <span class="c1"># these two calls will stop the gui, halting the programs mainloop.</span>
</span><span id="ResetProgram.__init__-544"><a href="#ResetProgram.__init__-544"><span class="linenos">544</span></a>            <span class="n">main_gui</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>
</span><span id="ResetProgram.__init__-545"><a href="#ResetProgram.__init__-545"><span class="linenos">545</span></a>            <span class="n">main_gui</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>
</span><span id="ResetProgram.__init__-546"><a href="#ResetProgram.__init__-546"><span class="linenos">546</span></a>
</span><span id="ResetProgram.__init__-547"><a href="#ResetProgram.__init__-547"><span class="linenos">547</span></a>            <span class="c1"># cancel all scheduled tasks</span>
</span><span id="ResetProgram.__init__-548"><a href="#ResetProgram.__init__-548"><span class="linenos">548</span></a>            <span class="k">for</span> <span class="n">sched_task</span> <span class="ow">in</span> <span class="n">main_gui</span><span class="o">.</span><span class="n">scheduled_tasks</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
</span><span id="ResetProgram.__init__-549"><a href="#ResetProgram.__init__-549"><span class="linenos">549</span></a>                <span class="n">main_gui</span><span class="o">.</span><span class="n">after_cancel</span><span class="p">(</span><span class="n">sched_task</span><span class="p">)</span>
</span><span id="ResetProgram.__init__-550"><a href="#ResetProgram.__init__-550"><span class="linenos">550</span></a>            <span class="c1"># if we have an listener thread and arduino connected, stop the thread and close the connection.</span>
</span><span id="ResetProgram.__init__-551"><a href="#ResetProgram.__init__-551"><span class="linenos">551</span></a>            <span class="k">if</span> <span class="n">arduino_controller</span><span class="o">.</span><span class="n">listener_thread</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ResetProgram.__init__-552"><a href="#ResetProgram.__init__-552"><span class="linenos">552</span></a>                <span class="n">arduino_controller</span><span class="o">.</span><span class="n">stop_listener_thread</span><span class="p">()</span>
</span><span id="ResetProgram.__init__-553"><a href="#ResetProgram.__init__-553"><span class="linenos">553</span></a>            <span class="k">if</span> <span class="n">arduino_controller</span><span class="o">.</span><span class="n">arduino</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ResetProgram.__init__-554"><a href="#ResetProgram.__init__-554"><span class="linenos">554</span></a>                <span class="n">arduino_controller</span><span class="o">.</span><span class="n">close_connection</span><span class="p">()</span>
</span><span id="ResetProgram.__init__-555"><a href="#ResetProgram.__init__-555"><span class="linenos">555</span></a>
</span><span id="ResetProgram.__init__-556"><a href="#ResetProgram.__init__-556"><span class="linenos">556</span></a>            <span class="c1"># set first bit in app_result list to 1 to instruct main to restart.</span>
</span><span id="ResetProgram.__init__-557"><a href="#ResetProgram.__init__-557"><span class="linenos">557</span></a>            <span class="n">app_result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="ResetProgram.__init__-558"><a href="#ResetProgram.__init__-558"><span class="linenos">558</span></a>
</span><span id="ResetProgram.__init__-559"><a href="#ResetProgram.__init__-559"><span class="linenos">559</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="ResetProgram.__init__-560"><a href="#ResetProgram.__init__-560"><span class="linenos">560</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error resetting the program: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                </section>
                <section id="InitialTimeInterval">
                            <input id="InitialTimeInterval-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">InitialTimeInterval</span>:

                <label class="view-source-button" for="InitialTimeInterval-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#InitialTimeInterval"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="InitialTimeInterval-563"><a href="#InitialTimeInterval-563"><span class="linenos">563</span></a><span class="k">class</span><span class="w"> </span><span class="nc">InitialTimeInterval</span><span class="p">:</span>
</span><span id="InitialTimeInterval-564"><a href="#InitialTimeInterval-564"><span class="linenos">564</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="InitialTimeInterval-565"><a href="#InitialTimeInterval-565"><span class="linenos">565</span></a><span class="sd">    State class for initial time interval experiment state.</span>
</span><span id="InitialTimeInterval-566"><a href="#InitialTimeInterval-566"><span class="linenos">566</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="InitialTimeInterval-567"><a href="#InitialTimeInterval-567"><span class="linenos">567</span></a>
</span><span id="InitialTimeInterval-568"><a href="#InitialTimeInterval-568"><span class="linenos">568</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="InitialTimeInterval-569"><a href="#InitialTimeInterval-569"><span class="linenos">569</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="InitialTimeInterval-570"><a href="#InitialTimeInterval-570"><span class="linenos">570</span></a>        <span class="n">exp_data</span><span class="p">:</span> <span class="n">ExperimentProcessData</span><span class="p">,</span>
</span><span id="InitialTimeInterval-571"><a href="#InitialTimeInterval-571"><span class="linenos">571</span></a>        <span class="n">main_gui</span><span class="p">:</span> <span class="n">MainGUI</span><span class="p">,</span>
</span><span id="InitialTimeInterval-572"><a href="#InitialTimeInterval-572"><span class="linenos">572</span></a>        <span class="n">state</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="InitialTimeInterval-573"><a href="#InitialTimeInterval-573"><span class="linenos">573</span></a>        <span class="n">trigger</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="kc">None</span><span class="p">],</span>
</span><span id="InitialTimeInterval-574"><a href="#InitialTimeInterval-574"><span class="linenos">574</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="InitialTimeInterval-575"><a href="#InitialTimeInterval-575"><span class="linenos">575</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="InitialTimeInterval-576"><a href="#InitialTimeInterval-576"><span class="linenos">576</span></a><span class="sd">        This function transitions the program into the `ITI` state. It does this by resetting lick counts, setting new state time,</span>
</span><span id="InitialTimeInterval-577"><a href="#InitialTimeInterval-577"><span class="linenos">577</span></a><span class="sd">        updating the models, and setting the .after call to transition to TTC.</span>
</span><span id="InitialTimeInterval-578"><a href="#InitialTimeInterval-578"><span class="linenos">578</span></a>
</span><span id="InitialTimeInterval-579"><a href="#InitialTimeInterval-579"><span class="linenos">579</span></a><span class="sd">        Parameters</span>
</span><span id="InitialTimeInterval-580"><a href="#InitialTimeInterval-580"><span class="linenos">580</span></a><span class="sd">        ----------</span>
</span><span id="InitialTimeInterval-581"><a href="#InitialTimeInterval-581"><span class="linenos">581</span></a><span class="sd">        - **exp_data** (*ExperimentProcessData*): Reference to the `models.experiment_process_data`. Here we use it to get a reference to event_data to set trial</span>
</span><span id="InitialTimeInterval-582"><a href="#InitialTimeInterval-582"><span class="linenos">582</span></a><span class="sd">        licks to 0, get logical trial number, and get state duration time.</span>
</span><span id="InitialTimeInterval-583"><a href="#InitialTimeInterval-583"><span class="linenos">583</span></a><span class="sd">        - **main_gui** (*MainGUI*): A reference to `views.main_gui` MainGUI instance, this is used to update elements inside the GUI window(s). Here we use it to</span>
</span><span id="InitialTimeInterval-584"><a href="#InitialTimeInterval-584"><span class="linenos">584</span></a><span class="sd">        update GUI with new trial information and configure the state timer.</span>
</span><span id="InitialTimeInterval-585"><a href="#InitialTimeInterval-585"><span class="linenos">585</span></a><span class="sd">        - **state** (*str*): State is used to update GUI with current state and grab the state duration time from the program schedule df.</span>
</span><span id="InitialTimeInterval-586"><a href="#InitialTimeInterval-586"><span class="linenos">586</span></a><span class="sd">        - **trigger** (*Callback method*): This callback is passed in so the `OPENING DOOR` state can be triggered after the `ITI` time has passed.</span>
</span><span id="InitialTimeInterval-587"><a href="#InitialTimeInterval-587"><span class="linenos">587</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="InitialTimeInterval-588"><a href="#InitialTimeInterval-588"><span class="linenos">588</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="InitialTimeInterval-589"><a href="#InitialTimeInterval-589"><span class="linenos">589</span></a>            <span class="c1"># get a reference to the event_data from exp_data.</span>
</span><span id="InitialTimeInterval-590"><a href="#InitialTimeInterval-590"><span class="linenos">590</span></a>            <span class="n">event_data</span> <span class="o">=</span> <span class="n">exp_data</span><span class="o">.</span><span class="n">event_data</span>
</span><span id="InitialTimeInterval-591"><a href="#InitialTimeInterval-591"><span class="linenos">591</span></a>
</span><span id="InitialTimeInterval-592"><a href="#InitialTimeInterval-592"><span class="linenos">592</span></a>            <span class="c1"># set trial licks to 0 for both sides</span>
</span><span id="InitialTimeInterval-593"><a href="#InitialTimeInterval-593"><span class="linenos">593</span></a>            <span class="n">event_data</span><span class="o">.</span><span class="n">side_one_licks</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="InitialTimeInterval-594"><a href="#InitialTimeInterval-594"><span class="linenos">594</span></a>            <span class="n">event_data</span><span class="o">.</span><span class="n">side_two_licks</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="InitialTimeInterval-595"><a href="#InitialTimeInterval-595"><span class="linenos">595</span></a>
</span><span id="InitialTimeInterval-596"><a href="#InitialTimeInterval-596"><span class="linenos">596</span></a>            <span class="c1"># logical df rows will always be 1 behind the current trial because of zero based indexing in dataframes vs</span>
</span><span id="InitialTimeInterval-597"><a href="#InitialTimeInterval-597"><span class="linenos">597</span></a>            <span class="c1"># 1 based for trials</span>
</span><span id="InitialTimeInterval-598"><a href="#InitialTimeInterval-598"><span class="linenos">598</span></a>            <span class="n">logical_trial</span> <span class="o">=</span> <span class="n">exp_data</span><span class="o">.</span><span class="n">current_trial_number</span> <span class="o">-</span> <span class="mi">1</span>
</span><span id="InitialTimeInterval-599"><a href="#InitialTimeInterval-599"><span class="linenos">599</span></a>
</span><span id="InitialTimeInterval-600"><a href="#InitialTimeInterval-600"><span class="linenos">600</span></a>            <span class="c1"># Call gui updates needed every trial (e.g program schedule window highlighting, progress bar, trial stimuli, etc)</span>
</span><span id="InitialTimeInterval-601"><a href="#InitialTimeInterval-601"><span class="linenos">601</span></a>            <span class="c1"># make sure we convert received vals to str to avoid type errors</span>
</span><span id="InitialTimeInterval-602"><a href="#InitialTimeInterval-602"><span class="linenos">602</span></a>            <span class="n">main_gui</span><span class="o">.</span><span class="n">update_on_new_trial</span><span class="p">(</span>
</span><span id="InitialTimeInterval-603"><a href="#InitialTimeInterval-603"><span class="linenos">603</span></a>                <span class="nb">str</span><span class="p">(</span><span class="n">exp_data</span><span class="o">.</span><span class="n">program_schedule_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">logical_trial</span><span class="p">,</span> <span class="s2">&quot;Port 1&quot;</span><span class="p">]),</span>
</span><span id="InitialTimeInterval-604"><a href="#InitialTimeInterval-604"><span class="linenos">604</span></a>                <span class="nb">str</span><span class="p">(</span><span class="n">exp_data</span><span class="o">.</span><span class="n">program_schedule_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">logical_trial</span><span class="p">,</span> <span class="s2">&quot;Port 2&quot;</span><span class="p">]),</span>
</span><span id="InitialTimeInterval-605"><a href="#InitialTimeInterval-605"><span class="linenos">605</span></a>            <span class="p">)</span>
</span><span id="InitialTimeInterval-606"><a href="#InitialTimeInterval-606"><span class="linenos">606</span></a>
</span><span id="InitialTimeInterval-607"><a href="#InitialTimeInterval-607"><span class="linenos">607</span></a>            <span class="c1"># clear state timer and reset the state start time</span>
</span><span id="InitialTimeInterval-608"><a href="#InitialTimeInterval-608"><span class="linenos">608</span></a>            <span class="n">main_gui</span><span class="o">.</span><span class="n">state_timer_text</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="p">(</span><span class="n">state</span> <span class="o">+</span> <span class="s2">&quot;Time:&quot;</span><span class="p">))</span>
</span><span id="InitialTimeInterval-609"><a href="#InitialTimeInterval-609"><span class="linenos">609</span></a>            <span class="n">exp_data</span><span class="o">.</span><span class="n">state_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="InitialTimeInterval-610"><a href="#InitialTimeInterval-610"><span class="linenos">610</span></a>
</span><span id="InitialTimeInterval-611"><a href="#InitialTimeInterval-611"><span class="linenos">611</span></a>            <span class="n">initial_time_interval</span> <span class="o">=</span> <span class="n">exp_data</span><span class="o">.</span><span class="n">program_schedule_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
</span><span id="InitialTimeInterval-612"><a href="#InitialTimeInterval-612"><span class="linenos">612</span></a>                <span class="n">logical_trial</span><span class="p">,</span> <span class="n">state</span>
</span><span id="InitialTimeInterval-613"><a href="#InitialTimeInterval-613"><span class="linenos">613</span></a>            <span class="p">]</span>
</span><span id="InitialTimeInterval-614"><a href="#InitialTimeInterval-614"><span class="linenos">614</span></a>
</span><span id="InitialTimeInterval-615"><a href="#InitialTimeInterval-615"><span class="linenos">615</span></a>            <span class="n">main_gui</span><span class="o">.</span><span class="n">update_on_state_change</span><span class="p">(</span><span class="n">initial_time_interval</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="InitialTimeInterval-616"><a href="#InitialTimeInterval-616"><span class="linenos">616</span></a>
</span><span id="InitialTimeInterval-617"><a href="#InitialTimeInterval-617"><span class="linenos">617</span></a>            <span class="c1"># tell tkinter main loop that we want to trigger DOOR OPEN state after initial_time_interval milliseconds</span>
</span><span id="InitialTimeInterval-618"><a href="#InitialTimeInterval-618"><span class="linenos">618</span></a>            <span class="n">iti_ttc_transition</span> <span class="o">=</span> <span class="n">main_gui</span><span class="o">.</span><span class="n">after</span><span class="p">(</span>
</span><span id="InitialTimeInterval-619"><a href="#InitialTimeInterval-619"><span class="linenos">619</span></a>                <span class="nb">int</span><span class="p">(</span><span class="n">initial_time_interval</span><span class="p">),</span>
</span><span id="InitialTimeInterval-620"><a href="#InitialTimeInterval-620"><span class="linenos">620</span></a>                <span class="k">lambda</span><span class="p">:</span> <span class="n">trigger</span><span class="p">(</span><span class="s2">&quot;DOOR OPEN&quot;</span><span class="p">),</span>
</span><span id="InitialTimeInterval-621"><a href="#InitialTimeInterval-621"><span class="linenos">621</span></a>            <span class="p">)</span>
</span><span id="InitialTimeInterval-622"><a href="#InitialTimeInterval-622"><span class="linenos">622</span></a>
</span><span id="InitialTimeInterval-623"><a href="#InitialTimeInterval-623"><span class="linenos">623</span></a>            <span class="c1"># add the transition to scheduled tasks dict so that</span>
</span><span id="InitialTimeInterval-624"><a href="#InitialTimeInterval-624"><span class="linenos">624</span></a>            <span class="n">main_gui</span><span class="o">.</span><span class="n">scheduled_tasks</span><span class="p">[</span><span class="s2">&quot;ITI TO DOOR OPEN&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">iti_ttc_transition</span>
</span><span id="InitialTimeInterval-625"><a href="#InitialTimeInterval-625"><span class="linenos">625</span></a>
</span><span id="InitialTimeInterval-626"><a href="#InitialTimeInterval-626"><span class="linenos">626</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="InitialTimeInterval-627"><a href="#InitialTimeInterval-627"><span class="linenos">627</span></a>                <span class="sa">f</span><span class="s2">&quot;STATE CHANGE: ITI BEGINS NOW for trial -&gt; </span><span class="si">{</span><span class="n">exp_data</span><span class="o">.</span><span class="n">current_trial_number</span><span class="si">}</span><span class="s2">, completes in </span><span class="si">{</span><span class="n">initial_time_interval</span><span class="si">}</span><span class="s2">.&quot;</span>
</span><span id="InitialTimeInterval-628"><a href="#InitialTimeInterval-628"><span class="linenos">628</span></a>            <span class="p">)</span>
</span><span id="InitialTimeInterval-629"><a href="#InitialTimeInterval-629"><span class="linenos">629</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="InitialTimeInterval-630"><a href="#InitialTimeInterval-630"><span class="linenos">630</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in initial time interval: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="InitialTimeInterval-631"><a href="#InitialTimeInterval-631"><span class="linenos">631</span></a>            <span class="k">raise</span>
</span></pre></div>


            <div class="docstring"><p>State class for initial time interval experiment state.</p>
</div>


                            <div id="InitialTimeInterval.__init__" class="classattr">
                                        <input id="InitialTimeInterval.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">InitialTimeInterval</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">exp_data</span><span class="p">:</span> <span class="n">models</span><span class="o">.</span><span class="n">experiment_process_data</span><span class="o">.</span><span class="n">ExperimentProcessData</span>,</span><span class="param">	<span class="n">main_gui</span><span class="p">:</span> <span class="n">views</span><span class="o">.</span><span class="n">main_gui</span><span class="o">.</span><span class="n">MainGUI</span>,</span><span class="param">	<span class="n">state</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">trigger</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="n">NoneType</span><span class="p">]</span></span>)</span>

                <label class="view-source-button" for="InitialTimeInterval.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#InitialTimeInterval.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="InitialTimeInterval.__init__-568"><a href="#InitialTimeInterval.__init__-568"><span class="linenos">568</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="InitialTimeInterval.__init__-569"><a href="#InitialTimeInterval.__init__-569"><span class="linenos">569</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="InitialTimeInterval.__init__-570"><a href="#InitialTimeInterval.__init__-570"><span class="linenos">570</span></a>        <span class="n">exp_data</span><span class="p">:</span> <span class="n">ExperimentProcessData</span><span class="p">,</span>
</span><span id="InitialTimeInterval.__init__-571"><a href="#InitialTimeInterval.__init__-571"><span class="linenos">571</span></a>        <span class="n">main_gui</span><span class="p">:</span> <span class="n">MainGUI</span><span class="p">,</span>
</span><span id="InitialTimeInterval.__init__-572"><a href="#InitialTimeInterval.__init__-572"><span class="linenos">572</span></a>        <span class="n">state</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="InitialTimeInterval.__init__-573"><a href="#InitialTimeInterval.__init__-573"><span class="linenos">573</span></a>        <span class="n">trigger</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="kc">None</span><span class="p">],</span>
</span><span id="InitialTimeInterval.__init__-574"><a href="#InitialTimeInterval.__init__-574"><span class="linenos">574</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="InitialTimeInterval.__init__-575"><a href="#InitialTimeInterval.__init__-575"><span class="linenos">575</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="InitialTimeInterval.__init__-576"><a href="#InitialTimeInterval.__init__-576"><span class="linenos">576</span></a><span class="sd">        This function transitions the program into the `ITI` state. It does this by resetting lick counts, setting new state time,</span>
</span><span id="InitialTimeInterval.__init__-577"><a href="#InitialTimeInterval.__init__-577"><span class="linenos">577</span></a><span class="sd">        updating the models, and setting the .after call to transition to TTC.</span>
</span><span id="InitialTimeInterval.__init__-578"><a href="#InitialTimeInterval.__init__-578"><span class="linenos">578</span></a>
</span><span id="InitialTimeInterval.__init__-579"><a href="#InitialTimeInterval.__init__-579"><span class="linenos">579</span></a><span class="sd">        Parameters</span>
</span><span id="InitialTimeInterval.__init__-580"><a href="#InitialTimeInterval.__init__-580"><span class="linenos">580</span></a><span class="sd">        ----------</span>
</span><span id="InitialTimeInterval.__init__-581"><a href="#InitialTimeInterval.__init__-581"><span class="linenos">581</span></a><span class="sd">        - **exp_data** (*ExperimentProcessData*): Reference to the `models.experiment_process_data`. Here we use it to get a reference to event_data to set trial</span>
</span><span id="InitialTimeInterval.__init__-582"><a href="#InitialTimeInterval.__init__-582"><span class="linenos">582</span></a><span class="sd">        licks to 0, get logical trial number, and get state duration time.</span>
</span><span id="InitialTimeInterval.__init__-583"><a href="#InitialTimeInterval.__init__-583"><span class="linenos">583</span></a><span class="sd">        - **main_gui** (*MainGUI*): A reference to `views.main_gui` MainGUI instance, this is used to update elements inside the GUI window(s). Here we use it to</span>
</span><span id="InitialTimeInterval.__init__-584"><a href="#InitialTimeInterval.__init__-584"><span class="linenos">584</span></a><span class="sd">        update GUI with new trial information and configure the state timer.</span>
</span><span id="InitialTimeInterval.__init__-585"><a href="#InitialTimeInterval.__init__-585"><span class="linenos">585</span></a><span class="sd">        - **state** (*str*): State is used to update GUI with current state and grab the state duration time from the program schedule df.</span>
</span><span id="InitialTimeInterval.__init__-586"><a href="#InitialTimeInterval.__init__-586"><span class="linenos">586</span></a><span class="sd">        - **trigger** (*Callback method*): This callback is passed in so the `OPENING DOOR` state can be triggered after the `ITI` time has passed.</span>
</span><span id="InitialTimeInterval.__init__-587"><a href="#InitialTimeInterval.__init__-587"><span class="linenos">587</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="InitialTimeInterval.__init__-588"><a href="#InitialTimeInterval.__init__-588"><span class="linenos">588</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="InitialTimeInterval.__init__-589"><a href="#InitialTimeInterval.__init__-589"><span class="linenos">589</span></a>            <span class="c1"># get a reference to the event_data from exp_data.</span>
</span><span id="InitialTimeInterval.__init__-590"><a href="#InitialTimeInterval.__init__-590"><span class="linenos">590</span></a>            <span class="n">event_data</span> <span class="o">=</span> <span class="n">exp_data</span><span class="o">.</span><span class="n">event_data</span>
</span><span id="InitialTimeInterval.__init__-591"><a href="#InitialTimeInterval.__init__-591"><span class="linenos">591</span></a>
</span><span id="InitialTimeInterval.__init__-592"><a href="#InitialTimeInterval.__init__-592"><span class="linenos">592</span></a>            <span class="c1"># set trial licks to 0 for both sides</span>
</span><span id="InitialTimeInterval.__init__-593"><a href="#InitialTimeInterval.__init__-593"><span class="linenos">593</span></a>            <span class="n">event_data</span><span class="o">.</span><span class="n">side_one_licks</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="InitialTimeInterval.__init__-594"><a href="#InitialTimeInterval.__init__-594"><span class="linenos">594</span></a>            <span class="n">event_data</span><span class="o">.</span><span class="n">side_two_licks</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="InitialTimeInterval.__init__-595"><a href="#InitialTimeInterval.__init__-595"><span class="linenos">595</span></a>
</span><span id="InitialTimeInterval.__init__-596"><a href="#InitialTimeInterval.__init__-596"><span class="linenos">596</span></a>            <span class="c1"># logical df rows will always be 1 behind the current trial because of zero based indexing in dataframes vs</span>
</span><span id="InitialTimeInterval.__init__-597"><a href="#InitialTimeInterval.__init__-597"><span class="linenos">597</span></a>            <span class="c1"># 1 based for trials</span>
</span><span id="InitialTimeInterval.__init__-598"><a href="#InitialTimeInterval.__init__-598"><span class="linenos">598</span></a>            <span class="n">logical_trial</span> <span class="o">=</span> <span class="n">exp_data</span><span class="o">.</span><span class="n">current_trial_number</span> <span class="o">-</span> <span class="mi">1</span>
</span><span id="InitialTimeInterval.__init__-599"><a href="#InitialTimeInterval.__init__-599"><span class="linenos">599</span></a>
</span><span id="InitialTimeInterval.__init__-600"><a href="#InitialTimeInterval.__init__-600"><span class="linenos">600</span></a>            <span class="c1"># Call gui updates needed every trial (e.g program schedule window highlighting, progress bar, trial stimuli, etc)</span>
</span><span id="InitialTimeInterval.__init__-601"><a href="#InitialTimeInterval.__init__-601"><span class="linenos">601</span></a>            <span class="c1"># make sure we convert received vals to str to avoid type errors</span>
</span><span id="InitialTimeInterval.__init__-602"><a href="#InitialTimeInterval.__init__-602"><span class="linenos">602</span></a>            <span class="n">main_gui</span><span class="o">.</span><span class="n">update_on_new_trial</span><span class="p">(</span>
</span><span id="InitialTimeInterval.__init__-603"><a href="#InitialTimeInterval.__init__-603"><span class="linenos">603</span></a>                <span class="nb">str</span><span class="p">(</span><span class="n">exp_data</span><span class="o">.</span><span class="n">program_schedule_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">logical_trial</span><span class="p">,</span> <span class="s2">&quot;Port 1&quot;</span><span class="p">]),</span>
</span><span id="InitialTimeInterval.__init__-604"><a href="#InitialTimeInterval.__init__-604"><span class="linenos">604</span></a>                <span class="nb">str</span><span class="p">(</span><span class="n">exp_data</span><span class="o">.</span><span class="n">program_schedule_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">logical_trial</span><span class="p">,</span> <span class="s2">&quot;Port 2&quot;</span><span class="p">]),</span>
</span><span id="InitialTimeInterval.__init__-605"><a href="#InitialTimeInterval.__init__-605"><span class="linenos">605</span></a>            <span class="p">)</span>
</span><span id="InitialTimeInterval.__init__-606"><a href="#InitialTimeInterval.__init__-606"><span class="linenos">606</span></a>
</span><span id="InitialTimeInterval.__init__-607"><a href="#InitialTimeInterval.__init__-607"><span class="linenos">607</span></a>            <span class="c1"># clear state timer and reset the state start time</span>
</span><span id="InitialTimeInterval.__init__-608"><a href="#InitialTimeInterval.__init__-608"><span class="linenos">608</span></a>            <span class="n">main_gui</span><span class="o">.</span><span class="n">state_timer_text</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="p">(</span><span class="n">state</span> <span class="o">+</span> <span class="s2">&quot;Time:&quot;</span><span class="p">))</span>
</span><span id="InitialTimeInterval.__init__-609"><a href="#InitialTimeInterval.__init__-609"><span class="linenos">609</span></a>            <span class="n">exp_data</span><span class="o">.</span><span class="n">state_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="InitialTimeInterval.__init__-610"><a href="#InitialTimeInterval.__init__-610"><span class="linenos">610</span></a>
</span><span id="InitialTimeInterval.__init__-611"><a href="#InitialTimeInterval.__init__-611"><span class="linenos">611</span></a>            <span class="n">initial_time_interval</span> <span class="o">=</span> <span class="n">exp_data</span><span class="o">.</span><span class="n">program_schedule_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
</span><span id="InitialTimeInterval.__init__-612"><a href="#InitialTimeInterval.__init__-612"><span class="linenos">612</span></a>                <span class="n">logical_trial</span><span class="p">,</span> <span class="n">state</span>
</span><span id="InitialTimeInterval.__init__-613"><a href="#InitialTimeInterval.__init__-613"><span class="linenos">613</span></a>            <span class="p">]</span>
</span><span id="InitialTimeInterval.__init__-614"><a href="#InitialTimeInterval.__init__-614"><span class="linenos">614</span></a>
</span><span id="InitialTimeInterval.__init__-615"><a href="#InitialTimeInterval.__init__-615"><span class="linenos">615</span></a>            <span class="n">main_gui</span><span class="o">.</span><span class="n">update_on_state_change</span><span class="p">(</span><span class="n">initial_time_interval</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="InitialTimeInterval.__init__-616"><a href="#InitialTimeInterval.__init__-616"><span class="linenos">616</span></a>
</span><span id="InitialTimeInterval.__init__-617"><a href="#InitialTimeInterval.__init__-617"><span class="linenos">617</span></a>            <span class="c1"># tell tkinter main loop that we want to trigger DOOR OPEN state after initial_time_interval milliseconds</span>
</span><span id="InitialTimeInterval.__init__-618"><a href="#InitialTimeInterval.__init__-618"><span class="linenos">618</span></a>            <span class="n">iti_ttc_transition</span> <span class="o">=</span> <span class="n">main_gui</span><span class="o">.</span><span class="n">after</span><span class="p">(</span>
</span><span id="InitialTimeInterval.__init__-619"><a href="#InitialTimeInterval.__init__-619"><span class="linenos">619</span></a>                <span class="nb">int</span><span class="p">(</span><span class="n">initial_time_interval</span><span class="p">),</span>
</span><span id="InitialTimeInterval.__init__-620"><a href="#InitialTimeInterval.__init__-620"><span class="linenos">620</span></a>                <span class="k">lambda</span><span class="p">:</span> <span class="n">trigger</span><span class="p">(</span><span class="s2">&quot;DOOR OPEN&quot;</span><span class="p">),</span>
</span><span id="InitialTimeInterval.__init__-621"><a href="#InitialTimeInterval.__init__-621"><span class="linenos">621</span></a>            <span class="p">)</span>
</span><span id="InitialTimeInterval.__init__-622"><a href="#InitialTimeInterval.__init__-622"><span class="linenos">622</span></a>
</span><span id="InitialTimeInterval.__init__-623"><a href="#InitialTimeInterval.__init__-623"><span class="linenos">623</span></a>            <span class="c1"># add the transition to scheduled tasks dict so that</span>
</span><span id="InitialTimeInterval.__init__-624"><a href="#InitialTimeInterval.__init__-624"><span class="linenos">624</span></a>            <span class="n">main_gui</span><span class="o">.</span><span class="n">scheduled_tasks</span><span class="p">[</span><span class="s2">&quot;ITI TO DOOR OPEN&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">iti_ttc_transition</span>
</span><span id="InitialTimeInterval.__init__-625"><a href="#InitialTimeInterval.__init__-625"><span class="linenos">625</span></a>
</span><span id="InitialTimeInterval.__init__-626"><a href="#InitialTimeInterval.__init__-626"><span class="linenos">626</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="InitialTimeInterval.__init__-627"><a href="#InitialTimeInterval.__init__-627"><span class="linenos">627</span></a>                <span class="sa">f</span><span class="s2">&quot;STATE CHANGE: ITI BEGINS NOW for trial -&gt; </span><span class="si">{</span><span class="n">exp_data</span><span class="o">.</span><span class="n">current_trial_number</span><span class="si">}</span><span class="s2">, completes in </span><span class="si">{</span><span class="n">initial_time_interval</span><span class="si">}</span><span class="s2">.&quot;</span>
</span><span id="InitialTimeInterval.__init__-628"><a href="#InitialTimeInterval.__init__-628"><span class="linenos">628</span></a>            <span class="p">)</span>
</span><span id="InitialTimeInterval.__init__-629"><a href="#InitialTimeInterval.__init__-629"><span class="linenos">629</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="InitialTimeInterval.__init__-630"><a href="#InitialTimeInterval.__init__-630"><span class="linenos">630</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in initial time interval: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="InitialTimeInterval.__init__-631"><a href="#InitialTimeInterval.__init__-631"><span class="linenos">631</span></a>            <span class="k">raise</span>
</span></pre></div>


            <div class="docstring"><p>This function transitions the program into the <code>ITI</code> state. It does this by resetting lick counts, setting new state time,
updating the models, and setting the .after call to transition to TTC.</p>

<h2 id="parameters">Parameters</h2>

<ul>
<li><strong>exp_data</strong> (<em>ExperimentProcessData</em>): Reference to the <code>models.experiment_process_data</code>. Here we use it to get a reference to event_data to set trial
licks to 0, get logical trial number, and get state duration time.</li>
<li><strong>main_gui</strong> (<em>MainGUI</em>): A reference to <code>views.main_gui</code> MainGUI instance, this is used to update elements inside the GUI window(s). Here we use it to
update GUI with new trial information and configure the state timer.</li>
<li><strong>state</strong> (<em>str</em>): State is used to update GUI with current state and grab the state duration time from the program schedule df.</li>
<li><strong>trigger</strong> (<em>Callback method</em>): This callback is passed in so the <code>OPENING DOOR</code> state can be triggered after the <code>ITI</code> time has passed.</li>
</ul>
</div>


                            </div>
                </section>
                <section id="OpeningDoor">
                            <input id="OpeningDoor-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">OpeningDoor</span>:

                <label class="view-source-button" for="OpeningDoor-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#OpeningDoor"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="OpeningDoor-634"><a href="#OpeningDoor-634"><span class="linenos">634</span></a><span class="k">class</span><span class="w"> </span><span class="nc">OpeningDoor</span><span class="p">:</span>
</span><span id="OpeningDoor-635"><a href="#OpeningDoor-635"><span class="linenos">635</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="OpeningDoor-636"><a href="#OpeningDoor-636"><span class="linenos">636</span></a><span class="sd">    Intermediate state between `ITI` and `TTC`.</span>
</span><span id="OpeningDoor-637"><a href="#OpeningDoor-637"><span class="linenos">637</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="OpeningDoor-638"><a href="#OpeningDoor-638"><span class="linenos">638</span></a>
</span><span id="OpeningDoor-639"><a href="#OpeningDoor-639"><span class="linenos">639</span></a>    <span class="c1"># we are going to need to pass in the arduino controller as well</span>
</span><span id="OpeningDoor-640"><a href="#OpeningDoor-640"><span class="linenos">640</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="OpeningDoor-641"><a href="#OpeningDoor-641"><span class="linenos">641</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="OpeningDoor-642"><a href="#OpeningDoor-642"><span class="linenos">642</span></a>        <span class="n">exp_data</span><span class="p">:</span> <span class="n">ExperimentProcessData</span><span class="p">,</span>
</span><span id="OpeningDoor-643"><a href="#OpeningDoor-643"><span class="linenos">643</span></a>        <span class="n">main_gui</span><span class="p">:</span> <span class="n">MainGUI</span><span class="p">,</span>
</span><span id="OpeningDoor-644"><a href="#OpeningDoor-644"><span class="linenos">644</span></a>        <span class="n">arduino_controller</span><span class="p">:</span> <span class="n">ArduinoManager</span><span class="p">,</span>
</span><span id="OpeningDoor-645"><a href="#OpeningDoor-645"><span class="linenos">645</span></a>        <span class="n">state</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="OpeningDoor-646"><a href="#OpeningDoor-646"><span class="linenos">646</span></a>        <span class="n">trigger</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="kc">None</span><span class="p">],</span>
</span><span id="OpeningDoor-647"><a href="#OpeningDoor-647"><span class="linenos">647</span></a>    <span class="p">):</span>
</span><span id="OpeningDoor-648"><a href="#OpeningDoor-648"><span class="linenos">648</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="OpeningDoor-649"><a href="#OpeningDoor-649"><span class="linenos">649</span></a><span class="sd">        In the initialization steps for this state we command the door down, then wait `DOOR_MOVE_TIME` to move to the `TTC` state.</span>
</span><span id="OpeningDoor-650"><a href="#OpeningDoor-650"><span class="linenos">650</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="OpeningDoor-651"><a href="#OpeningDoor-651"><span class="linenos">651</span></a>        <span class="c1"># send comment to arduino to move the door down</span>
</span><span id="OpeningDoor-652"><a href="#OpeningDoor-652"><span class="linenos">652</span></a>        <span class="n">down_command</span> <span class="o">=</span> <span class="s2">&quot;DOWN</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
</span><span id="OpeningDoor-653"><a href="#OpeningDoor-653"><span class="linenos">653</span></a>        <span class="n">arduino_controller</span><span class="o">.</span><span class="n">send_command</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">down_command</span><span class="p">)</span>
</span><span id="OpeningDoor-654"><a href="#OpeningDoor-654"><span class="linenos">654</span></a>
</span><span id="OpeningDoor-655"><a href="#OpeningDoor-655"><span class="linenos">655</span></a>        <span class="c1"># after the door is down, then we will begin the ttc state logic, found in run_ttc</span>
</span><span id="OpeningDoor-656"><a href="#OpeningDoor-656"><span class="linenos">656</span></a>        <span class="n">main_gui</span><span class="o">.</span><span class="n">after</span><span class="p">(</span><span class="n">DOOR_MOVE_TIME</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">trigger</span><span class="p">(</span><span class="s2">&quot;TTC&quot;</span><span class="p">))</span>
</span><span id="OpeningDoor-657"><a href="#OpeningDoor-657"><span class="linenos">657</span></a>
</span><span id="OpeningDoor-658"><a href="#OpeningDoor-658"><span class="linenos">658</span></a>        <span class="c1"># state start time begins</span>
</span><span id="OpeningDoor-659"><a href="#OpeningDoor-659"><span class="linenos">659</span></a>        <span class="n">exp_data</span><span class="o">.</span><span class="n">state_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="OpeningDoor-660"><a href="#OpeningDoor-660"><span class="linenos">660</span></a>
</span><span id="OpeningDoor-661"><a href="#OpeningDoor-661"><span class="linenos">661</span></a>        <span class="c1"># show current_time / door close time to avoid confusion</span>
</span><span id="OpeningDoor-662"><a href="#OpeningDoor-662"><span class="linenos">662</span></a>        <span class="n">main_gui</span><span class="o">.</span><span class="n">update_on_state_change</span><span class="p">(</span><span class="n">DOOR_MOVE_TIME</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Intermediate state between <code>ITI</code> and <code>TTC</code>.</p>
</div>


                            <div id="OpeningDoor.__init__" class="classattr">
                                        <input id="OpeningDoor.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">OpeningDoor</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">exp_data</span><span class="p">:</span> <span class="n">models</span><span class="o">.</span><span class="n">experiment_process_data</span><span class="o">.</span><span class="n">ExperimentProcessData</span>,</span><span class="param">	<span class="n">main_gui</span><span class="p">:</span> <span class="n">views</span><span class="o">.</span><span class="n">main_gui</span><span class="o">.</span><span class="n">MainGUI</span>,</span><span class="param">	<span class="n">arduino_controller</span><span class="p">:</span> <span class="n">controllers</span><span class="o">.</span><span class="n">arduino_control</span><span class="o">.</span><span class="n">ArduinoManager</span>,</span><span class="param">	<span class="n">state</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">trigger</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="n">NoneType</span><span class="p">]</span></span>)</span>

                <label class="view-source-button" for="OpeningDoor.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#OpeningDoor.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="OpeningDoor.__init__-640"><a href="#OpeningDoor.__init__-640"><span class="linenos">640</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="OpeningDoor.__init__-641"><a href="#OpeningDoor.__init__-641"><span class="linenos">641</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="OpeningDoor.__init__-642"><a href="#OpeningDoor.__init__-642"><span class="linenos">642</span></a>        <span class="n">exp_data</span><span class="p">:</span> <span class="n">ExperimentProcessData</span><span class="p">,</span>
</span><span id="OpeningDoor.__init__-643"><a href="#OpeningDoor.__init__-643"><span class="linenos">643</span></a>        <span class="n">main_gui</span><span class="p">:</span> <span class="n">MainGUI</span><span class="p">,</span>
</span><span id="OpeningDoor.__init__-644"><a href="#OpeningDoor.__init__-644"><span class="linenos">644</span></a>        <span class="n">arduino_controller</span><span class="p">:</span> <span class="n">ArduinoManager</span><span class="p">,</span>
</span><span id="OpeningDoor.__init__-645"><a href="#OpeningDoor.__init__-645"><span class="linenos">645</span></a>        <span class="n">state</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="OpeningDoor.__init__-646"><a href="#OpeningDoor.__init__-646"><span class="linenos">646</span></a>        <span class="n">trigger</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="kc">None</span><span class="p">],</span>
</span><span id="OpeningDoor.__init__-647"><a href="#OpeningDoor.__init__-647"><span class="linenos">647</span></a>    <span class="p">):</span>
</span><span id="OpeningDoor.__init__-648"><a href="#OpeningDoor.__init__-648"><span class="linenos">648</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="OpeningDoor.__init__-649"><a href="#OpeningDoor.__init__-649"><span class="linenos">649</span></a><span class="sd">        In the initialization steps for this state we command the door down, then wait `DOOR_MOVE_TIME` to move to the `TTC` state.</span>
</span><span id="OpeningDoor.__init__-650"><a href="#OpeningDoor.__init__-650"><span class="linenos">650</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="OpeningDoor.__init__-651"><a href="#OpeningDoor.__init__-651"><span class="linenos">651</span></a>        <span class="c1"># send comment to arduino to move the door down</span>
</span><span id="OpeningDoor.__init__-652"><a href="#OpeningDoor.__init__-652"><span class="linenos">652</span></a>        <span class="n">down_command</span> <span class="o">=</span> <span class="s2">&quot;DOWN</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
</span><span id="OpeningDoor.__init__-653"><a href="#OpeningDoor.__init__-653"><span class="linenos">653</span></a>        <span class="n">arduino_controller</span><span class="o">.</span><span class="n">send_command</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">down_command</span><span class="p">)</span>
</span><span id="OpeningDoor.__init__-654"><a href="#OpeningDoor.__init__-654"><span class="linenos">654</span></a>
</span><span id="OpeningDoor.__init__-655"><a href="#OpeningDoor.__init__-655"><span class="linenos">655</span></a>        <span class="c1"># after the door is down, then we will begin the ttc state logic, found in run_ttc</span>
</span><span id="OpeningDoor.__init__-656"><a href="#OpeningDoor.__init__-656"><span class="linenos">656</span></a>        <span class="n">main_gui</span><span class="o">.</span><span class="n">after</span><span class="p">(</span><span class="n">DOOR_MOVE_TIME</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">trigger</span><span class="p">(</span><span class="s2">&quot;TTC&quot;</span><span class="p">))</span>
</span><span id="OpeningDoor.__init__-657"><a href="#OpeningDoor.__init__-657"><span class="linenos">657</span></a>
</span><span id="OpeningDoor.__init__-658"><a href="#OpeningDoor.__init__-658"><span class="linenos">658</span></a>        <span class="c1"># state start time begins</span>
</span><span id="OpeningDoor.__init__-659"><a href="#OpeningDoor.__init__-659"><span class="linenos">659</span></a>        <span class="n">exp_data</span><span class="o">.</span><span class="n">state_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="OpeningDoor.__init__-660"><a href="#OpeningDoor.__init__-660"><span class="linenos">660</span></a>
</span><span id="OpeningDoor.__init__-661"><a href="#OpeningDoor.__init__-661"><span class="linenos">661</span></a>        <span class="c1"># show current_time / door close time to avoid confusion</span>
</span><span id="OpeningDoor.__init__-662"><a href="#OpeningDoor.__init__-662"><span class="linenos">662</span></a>        <span class="n">main_gui</span><span class="o">.</span><span class="n">update_on_state_change</span><span class="p">(</span><span class="n">DOOR_MOVE_TIME</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>In the initialization steps for this state we command the door down, then wait <code><a href="#DOOR_MOVE_TIME">DOOR_MOVE_TIME</a></code> to move to the <code>TTC</code> state.</p>
</div>


                            </div>
                </section>
                <section id="TimeToContact">
                            <input id="TimeToContact-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">TimeToContact</span>:

                <label class="view-source-button" for="TimeToContact-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TimeToContact"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TimeToContact-665"><a href="#TimeToContact-665"><span class="linenos">665</span></a><span class="k">class</span><span class="w"> </span><span class="nc">TimeToContact</span><span class="p">:</span>
</span><span id="TimeToContact-666"><a href="#TimeToContact-666"><span class="linenos">666</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="TimeToContact-667"><a href="#TimeToContact-667"><span class="linenos">667</span></a><span class="sd">    State class for time to contact experiment state</span>
</span><span id="TimeToContact-668"><a href="#TimeToContact-668"><span class="linenos">668</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="TimeToContact-669"><a href="#TimeToContact-669"><span class="linenos">669</span></a>
</span><span id="TimeToContact-670"><a href="#TimeToContact-670"><span class="linenos">670</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="TimeToContact-671"><a href="#TimeToContact-671"><span class="linenos">671</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="TimeToContact-672"><a href="#TimeToContact-672"><span class="linenos">672</span></a>        <span class="n">exp_data</span><span class="p">:</span> <span class="n">ExperimentProcessData</span><span class="p">,</span>
</span><span id="TimeToContact-673"><a href="#TimeToContact-673"><span class="linenos">673</span></a>        <span class="n">arduino_controller</span><span class="p">:</span> <span class="n">ArduinoManager</span><span class="p">,</span>
</span><span id="TimeToContact-674"><a href="#TimeToContact-674"><span class="linenos">674</span></a>        <span class="n">main_gui</span><span class="p">:</span> <span class="n">MainGUI</span><span class="p">,</span>
</span><span id="TimeToContact-675"><a href="#TimeToContact-675"><span class="linenos">675</span></a>        <span class="n">state</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="TimeToContact-676"><a href="#TimeToContact-676"><span class="linenos">676</span></a>        <span class="n">trigger</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="kc">None</span><span class="p">],</span>
</span><span id="TimeToContact-677"><a href="#TimeToContact-677"><span class="linenos">677</span></a>    <span class="p">):</span>
</span><span id="TimeToContact-678"><a href="#TimeToContact-678"><span class="linenos">678</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="TimeToContact-679"><a href="#TimeToContact-679"><span class="linenos">679</span></a><span class="sd">        This function transitions the program into the `TTC` state. We can only reach this state from `OPENING DOOR`.</span>
</span><span id="TimeToContact-680"><a href="#TimeToContact-680"><span class="linenos">680</span></a>
</span><span id="TimeToContact-681"><a href="#TimeToContact-681"><span class="linenos">681</span></a><span class="sd">        We transition into `TTC` by resetting the state timer, instructing the Arduino that the trial has started, and scheduling a transition into</span>
</span><span id="TimeToContact-682"><a href="#TimeToContact-682"><span class="linenos">682</span></a><span class="sd">        `TRIAL END` if the rat does not engage in this trial. This is cancelled in sample time if 3 licks or more from `TTC` are detected in the `models.arduino_data`</span>
</span><span id="TimeToContact-683"><a href="#TimeToContact-683"><span class="linenos">683</span></a><span class="sd">        module&#39;s `handle_licks` method.</span>
</span><span id="TimeToContact-684"><a href="#TimeToContact-684"><span class="linenos">684</span></a>
</span><span id="TimeToContact-685"><a href="#TimeToContact-685"><span class="linenos">685</span></a><span class="sd">        Parameters</span>
</span><span id="TimeToContact-686"><a href="#TimeToContact-686"><span class="linenos">686</span></a><span class="sd">        ----------</span>
</span><span id="TimeToContact-687"><a href="#TimeToContact-687"><span class="linenos">687</span></a><span class="sd">        - **exp_data** (*ExperimentProcessData*): Reference to the `models.experiment_process_data`. Here we use it to get a reference to event_data to reset state time</span>
</span><span id="TimeToContact-688"><a href="#TimeToContact-688"><span class="linenos">688</span></a><span class="sd">        and find `TTC` state time.</span>
</span><span id="TimeToContact-689"><a href="#TimeToContact-689"><span class="linenos">689</span></a><span class="sd">        - **arduino_controller** (*ArduinoManager*): A reference to the `controllers.arduino_control` instance, this is the method by which the Arduino is communicated</span>
</span><span id="TimeToContact-690"><a href="#TimeToContact-690"><span class="linenos">690</span></a><span class="sd">        with in the program. Used here to tell Arduino board trial has begun.</span>
</span><span id="TimeToContact-691"><a href="#TimeToContact-691"><span class="linenos">691</span></a><span class="sd">        - **main_gui** (*MainGUI*): A reference to `views.main_gui` MainGUI instance, this is used to update elements inside the GUI window(s). Here we use it to</span>
</span><span id="TimeToContact-692"><a href="#TimeToContact-692"><span class="linenos">692</span></a><span class="sd">        update GUI with new state time.</span>
</span><span id="TimeToContact-693"><a href="#TimeToContact-693"><span class="linenos">693</span></a><span class="sd">        - **state** (*str*): State is used to update GUI with current state and grab the state duration time from the program schedule df.</span>
</span><span id="TimeToContact-694"><a href="#TimeToContact-694"><span class="linenos">694</span></a><span class="sd">        - **trigger** (*Callback method*): This callback is passed in so the `TRIAL END` state can be triggered if trial is not engaged.</span>
</span><span id="TimeToContact-695"><a href="#TimeToContact-695"><span class="linenos">695</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TimeToContact-696"><a href="#TimeToContact-696"><span class="linenos">696</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="TimeToContact-697"><a href="#TimeToContact-697"><span class="linenos">697</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="TimeToContact-698"><a href="#TimeToContact-698"><span class="linenos">698</span></a>                <span class="sa">f</span><span class="s2">&quot;STATE CHANGE: DOOR OPEN -&gt; TTC NOW for trial -&gt; </span><span class="si">{</span><span class="n">exp_data</span><span class="o">.</span><span class="n">current_trial_number</span><span class="si">}</span><span class="s2">.&quot;</span>
</span><span id="TimeToContact-699"><a href="#TimeToContact-699"><span class="linenos">699</span></a>            <span class="p">)</span>
</span><span id="TimeToContact-700"><a href="#TimeToContact-700"><span class="linenos">700</span></a>
</span><span id="TimeToContact-701"><a href="#TimeToContact-701"><span class="linenos">701</span></a>            <span class="n">logical_trial</span> <span class="o">=</span> <span class="n">exp_data</span><span class="o">.</span><span class="n">current_trial_number</span> <span class="o">-</span> <span class="mi">1</span>
</span><span id="TimeToContact-702"><a href="#TimeToContact-702"><span class="linenos">702</span></a>
</span><span id="TimeToContact-703"><a href="#TimeToContact-703"><span class="linenos">703</span></a>            <span class="c1"># tell the arduino that the trial begins now, becuase the rats are able to licks beginning now</span>
</span><span id="TimeToContact-704"><a href="#TimeToContact-704"><span class="linenos">704</span></a>            <span class="n">command</span> <span class="o">=</span> <span class="s2">&quot;TRIAL START</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
</span><span id="TimeToContact-705"><a href="#TimeToContact-705"><span class="linenos">705</span></a>            <span class="n">arduino_controller</span><span class="o">.</span><span class="n">send_command</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
</span><span id="TimeToContact-706"><a href="#TimeToContact-706"><span class="linenos">706</span></a>
</span><span id="TimeToContact-707"><a href="#TimeToContact-707"><span class="linenos">707</span></a>            <span class="n">main_gui</span><span class="o">.</span><span class="n">state_timer_text</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="p">(</span><span class="n">state</span> <span class="o">+</span> <span class="s2">&quot; Time:&quot;</span><span class="p">))</span>
</span><span id="TimeToContact-708"><a href="#TimeToContact-708"><span class="linenos">708</span></a>
</span><span id="TimeToContact-709"><a href="#TimeToContact-709"><span class="linenos">709</span></a>            <span class="c1"># state time starts now, as does trial because lick availabilty starts now</span>
</span><span id="TimeToContact-710"><a href="#TimeToContact-710"><span class="linenos">710</span></a>            <span class="n">exp_data</span><span class="o">.</span><span class="n">state_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="TimeToContact-711"><a href="#TimeToContact-711"><span class="linenos">711</span></a>            <span class="n">exp_data</span><span class="o">.</span><span class="n">trial_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="TimeToContact-712"><a href="#TimeToContact-712"><span class="linenos">712</span></a>
</span><span id="TimeToContact-713"><a href="#TimeToContact-713"><span class="linenos">713</span></a>            <span class="c1"># find the amount of time available for TTC for this trial</span>
</span><span id="TimeToContact-714"><a href="#TimeToContact-714"><span class="linenos">714</span></a>            <span class="n">time_to_contact</span> <span class="o">=</span> <span class="n">exp_data</span><span class="o">.</span><span class="n">program_schedule_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">logical_trial</span><span class="p">,</span> <span class="n">state</span><span class="p">]</span>
</span><span id="TimeToContact-715"><a href="#TimeToContact-715"><span class="linenos">715</span></a>
</span><span id="TimeToContact-716"><a href="#TimeToContact-716"><span class="linenos">716</span></a>            <span class="n">main_gui</span><span class="o">.</span><span class="n">update_on_state_change</span><span class="p">(</span><span class="n">time_to_contact</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="TimeToContact-717"><a href="#TimeToContact-717"><span class="linenos">717</span></a>
</span><span id="TimeToContact-718"><a href="#TimeToContact-718"><span class="linenos">718</span></a>            <span class="c1"># set a state change to occur after the time_to_contact time, this will be cancelled if the laser arduino</span>
</span><span id="TimeToContact-719"><a href="#TimeToContact-719"><span class="linenos">719</span></a>            <span class="c1"># sends 3 licks befote the TTC_time</span>
</span><span id="TimeToContact-720"><a href="#TimeToContact-720"><span class="linenos">720</span></a>            <span class="n">ttc_iti_transition</span> <span class="o">=</span> <span class="n">main_gui</span><span class="o">.</span><span class="n">after</span><span class="p">(</span>
</span><span id="TimeToContact-721"><a href="#TimeToContact-721"><span class="linenos">721</span></a>                <span class="nb">int</span><span class="p">(</span><span class="n">time_to_contact</span><span class="p">),</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">trigger</span><span class="p">(</span><span class="s2">&quot;TRIAL END&quot;</span><span class="p">)</span>
</span><span id="TimeToContact-722"><a href="#TimeToContact-722"><span class="linenos">722</span></a>            <span class="p">)</span>
</span><span id="TimeToContact-723"><a href="#TimeToContact-723"><span class="linenos">723</span></a>
</span><span id="TimeToContact-724"><a href="#TimeToContact-724"><span class="linenos">724</span></a>            <span class="c1"># store this task id so that it can be cancelled if the sample time transition is taken.</span>
</span><span id="TimeToContact-725"><a href="#TimeToContact-725"><span class="linenos">725</span></a>            <span class="n">main_gui</span><span class="o">.</span><span class="n">scheduled_tasks</span><span class="p">[</span><span class="s2">&quot;TTC TO TRIAL END&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ttc_iti_transition</span>
</span><span id="TimeToContact-726"><a href="#TimeToContact-726"><span class="linenos">726</span></a>
</span><span id="TimeToContact-727"><a href="#TimeToContact-727"><span class="linenos">727</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="TimeToContact-728"><a href="#TimeToContact-728"><span class="linenos">728</span></a>                <span class="sa">f</span><span class="s2">&quot;STATE CHANGE: TTC BEGINS NOW for trial -&gt; </span><span class="si">{</span><span class="n">exp_data</span><span class="o">.</span><span class="n">current_trial_number</span><span class="si">}</span><span class="s2">, completes in </span><span class="si">{</span><span class="n">time_to_contact</span><span class="si">}</span><span class="s2">.&quot;</span>
</span><span id="TimeToContact-729"><a href="#TimeToContact-729"><span class="linenos">729</span></a>            <span class="p">)</span>
</span><span id="TimeToContact-730"><a href="#TimeToContact-730"><span class="linenos">730</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="TimeToContact-731"><a href="#TimeToContact-731"><span class="linenos">731</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in TTC state start: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="TimeToContact-732"><a href="#TimeToContact-732"><span class="linenos">732</span></a>            <span class="k">raise</span>
</span></pre></div>


            <div class="docstring"><p>State class for time to contact experiment state</p>
</div>


                            <div id="TimeToContact.__init__" class="classattr">
                                        <input id="TimeToContact.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">TimeToContact</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">exp_data</span><span class="p">:</span> <span class="n">models</span><span class="o">.</span><span class="n">experiment_process_data</span><span class="o">.</span><span class="n">ExperimentProcessData</span>,</span><span class="param">	<span class="n">arduino_controller</span><span class="p">:</span> <span class="n">controllers</span><span class="o">.</span><span class="n">arduino_control</span><span class="o">.</span><span class="n">ArduinoManager</span>,</span><span class="param">	<span class="n">main_gui</span><span class="p">:</span> <span class="n">views</span><span class="o">.</span><span class="n">main_gui</span><span class="o">.</span><span class="n">MainGUI</span>,</span><span class="param">	<span class="n">state</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">trigger</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="n">NoneType</span><span class="p">]</span></span>)</span>

                <label class="view-source-button" for="TimeToContact.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TimeToContact.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TimeToContact.__init__-670"><a href="#TimeToContact.__init__-670"><span class="linenos">670</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="TimeToContact.__init__-671"><a href="#TimeToContact.__init__-671"><span class="linenos">671</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="TimeToContact.__init__-672"><a href="#TimeToContact.__init__-672"><span class="linenos">672</span></a>        <span class="n">exp_data</span><span class="p">:</span> <span class="n">ExperimentProcessData</span><span class="p">,</span>
</span><span id="TimeToContact.__init__-673"><a href="#TimeToContact.__init__-673"><span class="linenos">673</span></a>        <span class="n">arduino_controller</span><span class="p">:</span> <span class="n">ArduinoManager</span><span class="p">,</span>
</span><span id="TimeToContact.__init__-674"><a href="#TimeToContact.__init__-674"><span class="linenos">674</span></a>        <span class="n">main_gui</span><span class="p">:</span> <span class="n">MainGUI</span><span class="p">,</span>
</span><span id="TimeToContact.__init__-675"><a href="#TimeToContact.__init__-675"><span class="linenos">675</span></a>        <span class="n">state</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="TimeToContact.__init__-676"><a href="#TimeToContact.__init__-676"><span class="linenos">676</span></a>        <span class="n">trigger</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="kc">None</span><span class="p">],</span>
</span><span id="TimeToContact.__init__-677"><a href="#TimeToContact.__init__-677"><span class="linenos">677</span></a>    <span class="p">):</span>
</span><span id="TimeToContact.__init__-678"><a href="#TimeToContact.__init__-678"><span class="linenos">678</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="TimeToContact.__init__-679"><a href="#TimeToContact.__init__-679"><span class="linenos">679</span></a><span class="sd">        This function transitions the program into the `TTC` state. We can only reach this state from `OPENING DOOR`.</span>
</span><span id="TimeToContact.__init__-680"><a href="#TimeToContact.__init__-680"><span class="linenos">680</span></a>
</span><span id="TimeToContact.__init__-681"><a href="#TimeToContact.__init__-681"><span class="linenos">681</span></a><span class="sd">        We transition into `TTC` by resetting the state timer, instructing the Arduino that the trial has started, and scheduling a transition into</span>
</span><span id="TimeToContact.__init__-682"><a href="#TimeToContact.__init__-682"><span class="linenos">682</span></a><span class="sd">        `TRIAL END` if the rat does not engage in this trial. This is cancelled in sample time if 3 licks or more from `TTC` are detected in the `models.arduino_data`</span>
</span><span id="TimeToContact.__init__-683"><a href="#TimeToContact.__init__-683"><span class="linenos">683</span></a><span class="sd">        module&#39;s `handle_licks` method.</span>
</span><span id="TimeToContact.__init__-684"><a href="#TimeToContact.__init__-684"><span class="linenos">684</span></a>
</span><span id="TimeToContact.__init__-685"><a href="#TimeToContact.__init__-685"><span class="linenos">685</span></a><span class="sd">        Parameters</span>
</span><span id="TimeToContact.__init__-686"><a href="#TimeToContact.__init__-686"><span class="linenos">686</span></a><span class="sd">        ----------</span>
</span><span id="TimeToContact.__init__-687"><a href="#TimeToContact.__init__-687"><span class="linenos">687</span></a><span class="sd">        - **exp_data** (*ExperimentProcessData*): Reference to the `models.experiment_process_data`. Here we use it to get a reference to event_data to reset state time</span>
</span><span id="TimeToContact.__init__-688"><a href="#TimeToContact.__init__-688"><span class="linenos">688</span></a><span class="sd">        and find `TTC` state time.</span>
</span><span id="TimeToContact.__init__-689"><a href="#TimeToContact.__init__-689"><span class="linenos">689</span></a><span class="sd">        - **arduino_controller** (*ArduinoManager*): A reference to the `controllers.arduino_control` instance, this is the method by which the Arduino is communicated</span>
</span><span id="TimeToContact.__init__-690"><a href="#TimeToContact.__init__-690"><span class="linenos">690</span></a><span class="sd">        with in the program. Used here to tell Arduino board trial has begun.</span>
</span><span id="TimeToContact.__init__-691"><a href="#TimeToContact.__init__-691"><span class="linenos">691</span></a><span class="sd">        - **main_gui** (*MainGUI*): A reference to `views.main_gui` MainGUI instance, this is used to update elements inside the GUI window(s). Here we use it to</span>
</span><span id="TimeToContact.__init__-692"><a href="#TimeToContact.__init__-692"><span class="linenos">692</span></a><span class="sd">        update GUI with new state time.</span>
</span><span id="TimeToContact.__init__-693"><a href="#TimeToContact.__init__-693"><span class="linenos">693</span></a><span class="sd">        - **state** (*str*): State is used to update GUI with current state and grab the state duration time from the program schedule df.</span>
</span><span id="TimeToContact.__init__-694"><a href="#TimeToContact.__init__-694"><span class="linenos">694</span></a><span class="sd">        - **trigger** (*Callback method*): This callback is passed in so the `TRIAL END` state can be triggered if trial is not engaged.</span>
</span><span id="TimeToContact.__init__-695"><a href="#TimeToContact.__init__-695"><span class="linenos">695</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TimeToContact.__init__-696"><a href="#TimeToContact.__init__-696"><span class="linenos">696</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="TimeToContact.__init__-697"><a href="#TimeToContact.__init__-697"><span class="linenos">697</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="TimeToContact.__init__-698"><a href="#TimeToContact.__init__-698"><span class="linenos">698</span></a>                <span class="sa">f</span><span class="s2">&quot;STATE CHANGE: DOOR OPEN -&gt; TTC NOW for trial -&gt; </span><span class="si">{</span><span class="n">exp_data</span><span class="o">.</span><span class="n">current_trial_number</span><span class="si">}</span><span class="s2">.&quot;</span>
</span><span id="TimeToContact.__init__-699"><a href="#TimeToContact.__init__-699"><span class="linenos">699</span></a>            <span class="p">)</span>
</span><span id="TimeToContact.__init__-700"><a href="#TimeToContact.__init__-700"><span class="linenos">700</span></a>
</span><span id="TimeToContact.__init__-701"><a href="#TimeToContact.__init__-701"><span class="linenos">701</span></a>            <span class="n">logical_trial</span> <span class="o">=</span> <span class="n">exp_data</span><span class="o">.</span><span class="n">current_trial_number</span> <span class="o">-</span> <span class="mi">1</span>
</span><span id="TimeToContact.__init__-702"><a href="#TimeToContact.__init__-702"><span class="linenos">702</span></a>
</span><span id="TimeToContact.__init__-703"><a href="#TimeToContact.__init__-703"><span class="linenos">703</span></a>            <span class="c1"># tell the arduino that the trial begins now, becuase the rats are able to licks beginning now</span>
</span><span id="TimeToContact.__init__-704"><a href="#TimeToContact.__init__-704"><span class="linenos">704</span></a>            <span class="n">command</span> <span class="o">=</span> <span class="s2">&quot;TRIAL START</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
</span><span id="TimeToContact.__init__-705"><a href="#TimeToContact.__init__-705"><span class="linenos">705</span></a>            <span class="n">arduino_controller</span><span class="o">.</span><span class="n">send_command</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
</span><span id="TimeToContact.__init__-706"><a href="#TimeToContact.__init__-706"><span class="linenos">706</span></a>
</span><span id="TimeToContact.__init__-707"><a href="#TimeToContact.__init__-707"><span class="linenos">707</span></a>            <span class="n">main_gui</span><span class="o">.</span><span class="n">state_timer_text</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="p">(</span><span class="n">state</span> <span class="o">+</span> <span class="s2">&quot; Time:&quot;</span><span class="p">))</span>
</span><span id="TimeToContact.__init__-708"><a href="#TimeToContact.__init__-708"><span class="linenos">708</span></a>
</span><span id="TimeToContact.__init__-709"><a href="#TimeToContact.__init__-709"><span class="linenos">709</span></a>            <span class="c1"># state time starts now, as does trial because lick availabilty starts now</span>
</span><span id="TimeToContact.__init__-710"><a href="#TimeToContact.__init__-710"><span class="linenos">710</span></a>            <span class="n">exp_data</span><span class="o">.</span><span class="n">state_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="TimeToContact.__init__-711"><a href="#TimeToContact.__init__-711"><span class="linenos">711</span></a>            <span class="n">exp_data</span><span class="o">.</span><span class="n">trial_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="TimeToContact.__init__-712"><a href="#TimeToContact.__init__-712"><span class="linenos">712</span></a>
</span><span id="TimeToContact.__init__-713"><a href="#TimeToContact.__init__-713"><span class="linenos">713</span></a>            <span class="c1"># find the amount of time available for TTC for this trial</span>
</span><span id="TimeToContact.__init__-714"><a href="#TimeToContact.__init__-714"><span class="linenos">714</span></a>            <span class="n">time_to_contact</span> <span class="o">=</span> <span class="n">exp_data</span><span class="o">.</span><span class="n">program_schedule_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">logical_trial</span><span class="p">,</span> <span class="n">state</span><span class="p">]</span>
</span><span id="TimeToContact.__init__-715"><a href="#TimeToContact.__init__-715"><span class="linenos">715</span></a>
</span><span id="TimeToContact.__init__-716"><a href="#TimeToContact.__init__-716"><span class="linenos">716</span></a>            <span class="n">main_gui</span><span class="o">.</span><span class="n">update_on_state_change</span><span class="p">(</span><span class="n">time_to_contact</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="TimeToContact.__init__-717"><a href="#TimeToContact.__init__-717"><span class="linenos">717</span></a>
</span><span id="TimeToContact.__init__-718"><a href="#TimeToContact.__init__-718"><span class="linenos">718</span></a>            <span class="c1"># set a state change to occur after the time_to_contact time, this will be cancelled if the laser arduino</span>
</span><span id="TimeToContact.__init__-719"><a href="#TimeToContact.__init__-719"><span class="linenos">719</span></a>            <span class="c1"># sends 3 licks befote the TTC_time</span>
</span><span id="TimeToContact.__init__-720"><a href="#TimeToContact.__init__-720"><span class="linenos">720</span></a>            <span class="n">ttc_iti_transition</span> <span class="o">=</span> <span class="n">main_gui</span><span class="o">.</span><span class="n">after</span><span class="p">(</span>
</span><span id="TimeToContact.__init__-721"><a href="#TimeToContact.__init__-721"><span class="linenos">721</span></a>                <span class="nb">int</span><span class="p">(</span><span class="n">time_to_contact</span><span class="p">),</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">trigger</span><span class="p">(</span><span class="s2">&quot;TRIAL END&quot;</span><span class="p">)</span>
</span><span id="TimeToContact.__init__-722"><a href="#TimeToContact.__init__-722"><span class="linenos">722</span></a>            <span class="p">)</span>
</span><span id="TimeToContact.__init__-723"><a href="#TimeToContact.__init__-723"><span class="linenos">723</span></a>
</span><span id="TimeToContact.__init__-724"><a href="#TimeToContact.__init__-724"><span class="linenos">724</span></a>            <span class="c1"># store this task id so that it can be cancelled if the sample time transition is taken.</span>
</span><span id="TimeToContact.__init__-725"><a href="#TimeToContact.__init__-725"><span class="linenos">725</span></a>            <span class="n">main_gui</span><span class="o">.</span><span class="n">scheduled_tasks</span><span class="p">[</span><span class="s2">&quot;TTC TO TRIAL END&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ttc_iti_transition</span>
</span><span id="TimeToContact.__init__-726"><a href="#TimeToContact.__init__-726"><span class="linenos">726</span></a>
</span><span id="TimeToContact.__init__-727"><a href="#TimeToContact.__init__-727"><span class="linenos">727</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="TimeToContact.__init__-728"><a href="#TimeToContact.__init__-728"><span class="linenos">728</span></a>                <span class="sa">f</span><span class="s2">&quot;STATE CHANGE: TTC BEGINS NOW for trial -&gt; </span><span class="si">{</span><span class="n">exp_data</span><span class="o">.</span><span class="n">current_trial_number</span><span class="si">}</span><span class="s2">, completes in </span><span class="si">{</span><span class="n">time_to_contact</span><span class="si">}</span><span class="s2">.&quot;</span>
</span><span id="TimeToContact.__init__-729"><a href="#TimeToContact.__init__-729"><span class="linenos">729</span></a>            <span class="p">)</span>
</span><span id="TimeToContact.__init__-730"><a href="#TimeToContact.__init__-730"><span class="linenos">730</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="TimeToContact.__init__-731"><a href="#TimeToContact.__init__-731"><span class="linenos">731</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in TTC state start: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="TimeToContact.__init__-732"><a href="#TimeToContact.__init__-732"><span class="linenos">732</span></a>            <span class="k">raise</span>
</span></pre></div>


            <div class="docstring"><p>This function transitions the program into the <code>TTC</code> state. We can only reach this state from <code>OPENING DOOR</code>.</p>

<p>We transition into <code>TTC</code> by resetting the state timer, instructing the Arduino that the trial has started, and scheduling a transition into
<code>TRIAL END</code> if the rat does not engage in this trial. This is cancelled in sample time if 3 licks or more from <code>TTC</code> are detected in the <code>models.arduino_data</code>
module's <code>handle_licks</code> method.</p>

<h2 id="parameters">Parameters</h2>

<ul>
<li><strong>exp_data</strong> (<em>ExperimentProcessData</em>): Reference to the <code>models.experiment_process_data</code>. Here we use it to get a reference to event_data to reset state time
and find <code>TTC</code> state time.</li>
<li><strong>arduino_controller</strong> (<em>ArduinoManager</em>): A reference to the <code>controllers.arduino_control</code> instance, this is the method by which the Arduino is communicated
with in the program. Used here to tell Arduino board trial has begun.</li>
<li><strong>main_gui</strong> (<em>MainGUI</em>): A reference to <code>views.main_gui</code> MainGUI instance, this is used to update elements inside the GUI window(s). Here we use it to
update GUI with new state time.</li>
<li><strong>state</strong> (<em>str</em>): State is used to update GUI with current state and grab the state duration time from the program schedule df.</li>
<li><strong>trigger</strong> (<em>Callback method</em>): This callback is passed in so the <code>TRIAL END</code> state can be triggered if trial is not engaged.</li>
</ul>
</div>


                            </div>
                </section>
                <section id="SampleTime">
                            <input id="SampleTime-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">SampleTime</span>:

                <label class="view-source-button" for="SampleTime-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SampleTime"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SampleTime-735"><a href="#SampleTime-735"><span class="linenos">735</span></a><span class="k">class</span><span class="w"> </span><span class="nc">SampleTime</span><span class="p">:</span>
</span><span id="SampleTime-736"><a href="#SampleTime-736"><span class="linenos">736</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SampleTime-737"><a href="#SampleTime-737"><span class="linenos">737</span></a><span class="sd">    Sample state class to handle setup of `Sample` state.</span>
</span><span id="SampleTime-738"><a href="#SampleTime-738"><span class="linenos">738</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="SampleTime-739"><a href="#SampleTime-739"><span class="linenos">739</span></a>
</span><span id="SampleTime-740"><a href="#SampleTime-740"><span class="linenos">740</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="SampleTime-741"><a href="#SampleTime-741"><span class="linenos">741</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="SampleTime-742"><a href="#SampleTime-742"><span class="linenos">742</span></a>        <span class="n">exp_data</span><span class="p">:</span> <span class="n">ExperimentProcessData</span><span class="p">,</span>
</span><span id="SampleTime-743"><a href="#SampleTime-743"><span class="linenos">743</span></a>        <span class="n">main_gui</span><span class="p">:</span> <span class="n">MainGUI</span><span class="p">,</span>
</span><span id="SampleTime-744"><a href="#SampleTime-744"><span class="linenos">744</span></a>        <span class="n">arduino_controller</span><span class="p">:</span> <span class="n">ArduinoManager</span><span class="p">,</span>
</span><span id="SampleTime-745"><a href="#SampleTime-745"><span class="linenos">745</span></a>        <span class="n">state</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="SampleTime-746"><a href="#SampleTime-746"><span class="linenos">746</span></a>        <span class="n">trigger</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="kc">None</span><span class="p">],</span>
</span><span id="SampleTime-747"><a href="#SampleTime-747"><span class="linenos">747</span></a>    <span class="p">):</span>
</span><span id="SampleTime-748"><a href="#SampleTime-748"><span class="linenos">748</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SampleTime-749"><a href="#SampleTime-749"><span class="linenos">749</span></a><span class="sd">        This function transitions the program into the `SAMPLE` state. We can only reach this state from `TTC` if 3 licks or more are detected in `TTC`.</span>
</span><span id="SampleTime-750"><a href="#SampleTime-750"><span class="linenos">750</span></a>
</span><span id="SampleTime-751"><a href="#SampleTime-751"><span class="linenos">751</span></a><span class="sd">        We transition into `SAMPLE` by resetting licks to zero to count only sample time licks for trial, updating the actual `TTC` time taken before engaging in the</span>
</span><span id="SampleTime-752"><a href="#SampleTime-752"><span class="linenos">752</span></a><span class="sd">        trial, cancelling the scheduled `TTC` to `TRIAL END` transition, instructing Arduino to begin opening valves when licks occur, and updating state start time.</span>
</span><span id="SampleTime-753"><a href="#SampleTime-753"><span class="linenos">753</span></a>
</span><span id="SampleTime-754"><a href="#SampleTime-754"><span class="linenos">754</span></a><span class="sd">        Parameters</span>
</span><span id="SampleTime-755"><a href="#SampleTime-755"><span class="linenos">755</span></a><span class="sd">        ----------</span>
</span><span id="SampleTime-756"><a href="#SampleTime-756"><span class="linenos">756</span></a><span class="sd">        - **exp_data** (*ExperimentProcessData*): Reference to the `models.experiment_process_data`. Here we use it to get a reference to event_data to reset state time</span>
</span><span id="SampleTime-757"><a href="#SampleTime-757"><span class="linenos">757</span></a><span class="sd">        and find `SAMPLE` state time, reset trial lick data.</span>
</span><span id="SampleTime-758"><a href="#SampleTime-758"><span class="linenos">758</span></a><span class="sd">        - **main_gui** (*MainGUI*): A reference to `views.main_gui` MainGUI instance, this is used to update elements inside the GUI window(s). Here we use it to</span>
</span><span id="SampleTime-759"><a href="#SampleTime-759"><span class="linenos">759</span></a><span class="sd">        update GUI with new state info and cancel `TTC` to `TRIAL END` transition.</span>
</span><span id="SampleTime-760"><a href="#SampleTime-760"><span class="linenos">760</span></a><span class="sd">        - **arduino_controller** (*ArduinoManager*): A reference to the `controllers.arduino_control` instance, this is the method by which the Arduino is communicated</span>
</span><span id="SampleTime-761"><a href="#SampleTime-761"><span class="linenos">761</span></a><span class="sd">        with in the program. Used here to tell Arduino to begin opening valves when licks are detected.</span>
</span><span id="SampleTime-762"><a href="#SampleTime-762"><span class="linenos">762</span></a><span class="sd">        - **state** (*str*): State is used to update GUI with current state and grab the state duration time from the program schedule df.</span>
</span><span id="SampleTime-763"><a href="#SampleTime-763"><span class="linenos">763</span></a><span class="sd">        - **trigger** (*Callback method*): This callback is passed in so the `TRIAL END` state can be triggered after `SAMPLE` time.</span>
</span><span id="SampleTime-764"><a href="#SampleTime-764"><span class="linenos">764</span></a>
</span><span id="SampleTime-765"><a href="#SampleTime-765"><span class="linenos">765</span></a><span class="sd">        Methods</span>
</span><span id="SampleTime-766"><a href="#SampleTime-766"><span class="linenos">766</span></a><span class="sd">        -------</span>
</span><span id="SampleTime-767"><a href="#SampleTime-767"><span class="linenos">767</span></a><span class="sd">        - `update_ttc_time`(exp_data, logical_trial)</span>
</span><span id="SampleTime-768"><a href="#SampleTime-768"><span class="linenos">768</span></a><span class="sd">        Updates program schedule dataframe with actual time used in the `TTC` state.</span>
</span><span id="SampleTime-769"><a href="#SampleTime-769"><span class="linenos">769</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SampleTime-770"><a href="#SampleTime-770"><span class="linenos">770</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="SampleTime-771"><a href="#SampleTime-771"><span class="linenos">771</span></a>            <span class="n">logical_trial</span> <span class="o">=</span> <span class="n">exp_data</span><span class="o">.</span><span class="n">current_trial_number</span> <span class="o">-</span> <span class="mi">1</span>
</span><span id="SampleTime-772"><a href="#SampleTime-772"><span class="linenos">772</span></a>
</span><span id="SampleTime-773"><a href="#SampleTime-773"><span class="linenos">773</span></a>            <span class="n">event_data</span> <span class="o">=</span> <span class="n">exp_data</span><span class="o">.</span><span class="n">event_data</span>
</span><span id="SampleTime-774"><a href="#SampleTime-774"><span class="linenos">774</span></a>
</span><span id="SampleTime-775"><a href="#SampleTime-775"><span class="linenos">775</span></a>            <span class="c1"># reset trial licks to count only sample licks</span>
</span><span id="SampleTime-776"><a href="#SampleTime-776"><span class="linenos">776</span></a>            <span class="n">event_data</span><span class="o">.</span><span class="n">side_one_licks</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="SampleTime-777"><a href="#SampleTime-777"><span class="linenos">777</span></a>            <span class="n">event_data</span><span class="o">.</span><span class="n">side_two_licks</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="SampleTime-778"><a href="#SampleTime-778"><span class="linenos">778</span></a>
</span><span id="SampleTime-779"><a href="#SampleTime-779"><span class="linenos">779</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">update_ttc_time</span><span class="p">(</span><span class="n">exp_data</span><span class="p">,</span> <span class="n">logical_trial</span><span class="p">)</span>
</span><span id="SampleTime-780"><a href="#SampleTime-780"><span class="linenos">780</span></a>
</span><span id="SampleTime-781"><a href="#SampleTime-781"><span class="linenos">781</span></a>            <span class="c1"># since the trial was engaged, cancel the planned transition from ttc to trial end. program has branched to new state</span>
</span><span id="SampleTime-782"><a href="#SampleTime-782"><span class="linenos">782</span></a>            <span class="n">main_gui</span><span class="o">.</span><span class="n">after_cancel</span><span class="p">(</span><span class="n">main_gui</span><span class="o">.</span><span class="n">scheduled_tasks</span><span class="p">[</span><span class="s2">&quot;TTC TO TRIAL END&quot;</span><span class="p">])</span>
</span><span id="SampleTime-783"><a href="#SampleTime-783"><span class="linenos">783</span></a>
</span><span id="SampleTime-784"><a href="#SampleTime-784"><span class="linenos">784</span></a>            <span class="c1"># Tell the laser arduino to begin accepting licks and opening valves</span>
</span><span id="SampleTime-785"><a href="#SampleTime-785"><span class="linenos">785</span></a>            <span class="c1"># resetting the lick counters for both spouts</span>
</span><span id="SampleTime-786"><a href="#SampleTime-786"><span class="linenos">786</span></a>            <span class="c1"># tell the laser to begin opening valves on licks</span>
</span><span id="SampleTime-787"><a href="#SampleTime-787"><span class="linenos">787</span></a>            <span class="n">open_command</span> <span class="o">=</span> <span class="s2">&quot;BEGIN OPEN VALVES</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
</span><span id="SampleTime-788"><a href="#SampleTime-788"><span class="linenos">788</span></a>            <span class="n">arduino_controller</span><span class="o">.</span><span class="n">send_command</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">open_command</span><span class="p">)</span>
</span><span id="SampleTime-789"><a href="#SampleTime-789"><span class="linenos">789</span></a>
</span><span id="SampleTime-790"><a href="#SampleTime-790"><span class="linenos">790</span></a>            <span class="n">exp_data</span><span class="o">.</span><span class="n">state_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="SampleTime-791"><a href="#SampleTime-791"><span class="linenos">791</span></a>
</span><span id="SampleTime-792"><a href="#SampleTime-792"><span class="linenos">792</span></a>            <span class="n">sample_interval_value</span> <span class="o">=</span> <span class="n">exp_data</span><span class="o">.</span><span class="n">program_schedule_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
</span><span id="SampleTime-793"><a href="#SampleTime-793"><span class="linenos">793</span></a>                <span class="n">logical_trial</span><span class="p">,</span> <span class="n">state</span>
</span><span id="SampleTime-794"><a href="#SampleTime-794"><span class="linenos">794</span></a>            <span class="p">]</span>
</span><span id="SampleTime-795"><a href="#SampleTime-795"><span class="linenos">795</span></a>
</span><span id="SampleTime-796"><a href="#SampleTime-796"><span class="linenos">796</span></a>            <span class="n">main_gui</span><span class="o">.</span><span class="n">update_on_state_change</span><span class="p">(</span><span class="n">sample_interval_value</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="SampleTime-797"><a href="#SampleTime-797"><span class="linenos">797</span></a>
</span><span id="SampleTime-798"><a href="#SampleTime-798"><span class="linenos">798</span></a>            <span class="n">main_gui</span><span class="o">.</span><span class="n">after</span><span class="p">(</span>
</span><span id="SampleTime-799"><a href="#SampleTime-799"><span class="linenos">799</span></a>                <span class="nb">int</span><span class="p">(</span><span class="n">sample_interval_value</span><span class="p">),</span>
</span><span id="SampleTime-800"><a href="#SampleTime-800"><span class="linenos">800</span></a>                <span class="k">lambda</span><span class="p">:</span> <span class="n">trigger</span><span class="p">(</span><span class="s2">&quot;TRIAL END&quot;</span><span class="p">),</span>
</span><span id="SampleTime-801"><a href="#SampleTime-801"><span class="linenos">801</span></a>            <span class="p">)</span>
</span><span id="SampleTime-802"><a href="#SampleTime-802"><span class="linenos">802</span></a>
</span><span id="SampleTime-803"><a href="#SampleTime-803"><span class="linenos">803</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="SampleTime-804"><a href="#SampleTime-804"><span class="linenos">804</span></a>                <span class="sa">f</span><span class="s2">&quot;STATE CHANGE: SAMPLE BEGINS NOW for trial-&gt; </span><span class="si">{</span><span class="n">exp_data</span><span class="o">.</span><span class="n">current_trial_number</span><span class="si">}</span><span class="s2">, completes in </span><span class="si">{</span><span class="n">sample_interval_value</span><span class="si">}</span><span class="s2">.&quot;</span>
</span><span id="SampleTime-805"><a href="#SampleTime-805"><span class="linenos">805</span></a>            <span class="p">)</span>
</span><span id="SampleTime-806"><a href="#SampleTime-806"><span class="linenos">806</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="SampleTime-807"><a href="#SampleTime-807"><span class="linenos">807</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
</span><span id="SampleTime-808"><a href="#SampleTime-808"><span class="linenos">808</span></a>                <span class="sa">f</span><span class="s2">&quot;Error in sample time trial no. </span><span class="si">{</span><span class="n">exp_data</span><span class="o">.</span><span class="n">current_trial_number</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="SampleTime-809"><a href="#SampleTime-809"><span class="linenos">809</span></a>            <span class="p">)</span>
</span><span id="SampleTime-810"><a href="#SampleTime-810"><span class="linenos">810</span></a>            <span class="k">raise</span>
</span><span id="SampleTime-811"><a href="#SampleTime-811"><span class="linenos">811</span></a>
</span><span id="SampleTime-812"><a href="#SampleTime-812"><span class="linenos">812</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_ttc_time</span><span class="p">(</span>
</span><span id="SampleTime-813"><a href="#SampleTime-813"><span class="linenos">813</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">exp_data</span><span class="p">:</span> <span class="n">ExperimentProcessData</span><span class="p">,</span> <span class="n">logical_trial</span><span class="p">:</span> <span class="nb">int</span>
</span><span id="SampleTime-814"><a href="#SampleTime-814"><span class="linenos">814</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SampleTime-815"><a href="#SampleTime-815"><span class="linenos">815</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SampleTime-816"><a href="#SampleTime-816"><span class="linenos">816</span></a><span class="sd">        If we reach this code that means the rat licked at least 3 times in `TTC` state</span>
</span><span id="SampleTime-817"><a href="#SampleTime-817"><span class="linenos">817</span></a><span class="sd">        so we didn&#39;t take all the allocated time. update program schedule window with actual time taken</span>
</span><span id="SampleTime-818"><a href="#SampleTime-818"><span class="linenos">818</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SampleTime-819"><a href="#SampleTime-819"><span class="linenos">819</span></a>        <span class="n">ttc_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">exp_data</span><span class="o">.</span><span class="n">state_start_time</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
</span><span id="SampleTime-820"><a href="#SampleTime-820"><span class="linenos">820</span></a>
</span><span id="SampleTime-821"><a href="#SampleTime-821"><span class="linenos">821</span></a>        <span class="n">exp_data</span><span class="o">.</span><span class="n">program_schedule_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">logical_trial</span><span class="p">,</span> <span class="s2">&quot;TTC Actual&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span>
</span><span id="SampleTime-822"><a href="#SampleTime-822"><span class="linenos">822</span></a>            <span class="n">ttc_time</span><span class="p">,</span> <span class="mi">3</span>
</span><span id="SampleTime-823"><a href="#SampleTime-823"><span class="linenos">823</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Sample state class to handle setup of <code>Sample</code> state.</p>
</div>


                            <div id="SampleTime.__init__" class="classattr">
                                        <input id="SampleTime.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">SampleTime</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">exp_data</span><span class="p">:</span> <span class="n">models</span><span class="o">.</span><span class="n">experiment_process_data</span><span class="o">.</span><span class="n">ExperimentProcessData</span>,</span><span class="param">	<span class="n">main_gui</span><span class="p">:</span> <span class="n">views</span><span class="o">.</span><span class="n">main_gui</span><span class="o">.</span><span class="n">MainGUI</span>,</span><span class="param">	<span class="n">arduino_controller</span><span class="p">:</span> <span class="n">controllers</span><span class="o">.</span><span class="n">arduino_control</span><span class="o">.</span><span class="n">ArduinoManager</span>,</span><span class="param">	<span class="n">state</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">trigger</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="n">NoneType</span><span class="p">]</span></span>)</span>

                <label class="view-source-button" for="SampleTime.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SampleTime.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SampleTime.__init__-740"><a href="#SampleTime.__init__-740"><span class="linenos">740</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="SampleTime.__init__-741"><a href="#SampleTime.__init__-741"><span class="linenos">741</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="SampleTime.__init__-742"><a href="#SampleTime.__init__-742"><span class="linenos">742</span></a>        <span class="n">exp_data</span><span class="p">:</span> <span class="n">ExperimentProcessData</span><span class="p">,</span>
</span><span id="SampleTime.__init__-743"><a href="#SampleTime.__init__-743"><span class="linenos">743</span></a>        <span class="n">main_gui</span><span class="p">:</span> <span class="n">MainGUI</span><span class="p">,</span>
</span><span id="SampleTime.__init__-744"><a href="#SampleTime.__init__-744"><span class="linenos">744</span></a>        <span class="n">arduino_controller</span><span class="p">:</span> <span class="n">ArduinoManager</span><span class="p">,</span>
</span><span id="SampleTime.__init__-745"><a href="#SampleTime.__init__-745"><span class="linenos">745</span></a>        <span class="n">state</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="SampleTime.__init__-746"><a href="#SampleTime.__init__-746"><span class="linenos">746</span></a>        <span class="n">trigger</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="kc">None</span><span class="p">],</span>
</span><span id="SampleTime.__init__-747"><a href="#SampleTime.__init__-747"><span class="linenos">747</span></a>    <span class="p">):</span>
</span><span id="SampleTime.__init__-748"><a href="#SampleTime.__init__-748"><span class="linenos">748</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SampleTime.__init__-749"><a href="#SampleTime.__init__-749"><span class="linenos">749</span></a><span class="sd">        This function transitions the program into the `SAMPLE` state. We can only reach this state from `TTC` if 3 licks or more are detected in `TTC`.</span>
</span><span id="SampleTime.__init__-750"><a href="#SampleTime.__init__-750"><span class="linenos">750</span></a>
</span><span id="SampleTime.__init__-751"><a href="#SampleTime.__init__-751"><span class="linenos">751</span></a><span class="sd">        We transition into `SAMPLE` by resetting licks to zero to count only sample time licks for trial, updating the actual `TTC` time taken before engaging in the</span>
</span><span id="SampleTime.__init__-752"><a href="#SampleTime.__init__-752"><span class="linenos">752</span></a><span class="sd">        trial, cancelling the scheduled `TTC` to `TRIAL END` transition, instructing Arduino to begin opening valves when licks occur, and updating state start time.</span>
</span><span id="SampleTime.__init__-753"><a href="#SampleTime.__init__-753"><span class="linenos">753</span></a>
</span><span id="SampleTime.__init__-754"><a href="#SampleTime.__init__-754"><span class="linenos">754</span></a><span class="sd">        Parameters</span>
</span><span id="SampleTime.__init__-755"><a href="#SampleTime.__init__-755"><span class="linenos">755</span></a><span class="sd">        ----------</span>
</span><span id="SampleTime.__init__-756"><a href="#SampleTime.__init__-756"><span class="linenos">756</span></a><span class="sd">        - **exp_data** (*ExperimentProcessData*): Reference to the `models.experiment_process_data`. Here we use it to get a reference to event_data to reset state time</span>
</span><span id="SampleTime.__init__-757"><a href="#SampleTime.__init__-757"><span class="linenos">757</span></a><span class="sd">        and find `SAMPLE` state time, reset trial lick data.</span>
</span><span id="SampleTime.__init__-758"><a href="#SampleTime.__init__-758"><span class="linenos">758</span></a><span class="sd">        - **main_gui** (*MainGUI*): A reference to `views.main_gui` MainGUI instance, this is used to update elements inside the GUI window(s). Here we use it to</span>
</span><span id="SampleTime.__init__-759"><a href="#SampleTime.__init__-759"><span class="linenos">759</span></a><span class="sd">        update GUI with new state info and cancel `TTC` to `TRIAL END` transition.</span>
</span><span id="SampleTime.__init__-760"><a href="#SampleTime.__init__-760"><span class="linenos">760</span></a><span class="sd">        - **arduino_controller** (*ArduinoManager*): A reference to the `controllers.arduino_control` instance, this is the method by which the Arduino is communicated</span>
</span><span id="SampleTime.__init__-761"><a href="#SampleTime.__init__-761"><span class="linenos">761</span></a><span class="sd">        with in the program. Used here to tell Arduino to begin opening valves when licks are detected.</span>
</span><span id="SampleTime.__init__-762"><a href="#SampleTime.__init__-762"><span class="linenos">762</span></a><span class="sd">        - **state** (*str*): State is used to update GUI with current state and grab the state duration time from the program schedule df.</span>
</span><span id="SampleTime.__init__-763"><a href="#SampleTime.__init__-763"><span class="linenos">763</span></a><span class="sd">        - **trigger** (*Callback method*): This callback is passed in so the `TRIAL END` state can be triggered after `SAMPLE` time.</span>
</span><span id="SampleTime.__init__-764"><a href="#SampleTime.__init__-764"><span class="linenos">764</span></a>
</span><span id="SampleTime.__init__-765"><a href="#SampleTime.__init__-765"><span class="linenos">765</span></a><span class="sd">        Methods</span>
</span><span id="SampleTime.__init__-766"><a href="#SampleTime.__init__-766"><span class="linenos">766</span></a><span class="sd">        -------</span>
</span><span id="SampleTime.__init__-767"><a href="#SampleTime.__init__-767"><span class="linenos">767</span></a><span class="sd">        - `update_ttc_time`(exp_data, logical_trial)</span>
</span><span id="SampleTime.__init__-768"><a href="#SampleTime.__init__-768"><span class="linenos">768</span></a><span class="sd">        Updates program schedule dataframe with actual time used in the `TTC` state.</span>
</span><span id="SampleTime.__init__-769"><a href="#SampleTime.__init__-769"><span class="linenos">769</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SampleTime.__init__-770"><a href="#SampleTime.__init__-770"><span class="linenos">770</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="SampleTime.__init__-771"><a href="#SampleTime.__init__-771"><span class="linenos">771</span></a>            <span class="n">logical_trial</span> <span class="o">=</span> <span class="n">exp_data</span><span class="o">.</span><span class="n">current_trial_number</span> <span class="o">-</span> <span class="mi">1</span>
</span><span id="SampleTime.__init__-772"><a href="#SampleTime.__init__-772"><span class="linenos">772</span></a>
</span><span id="SampleTime.__init__-773"><a href="#SampleTime.__init__-773"><span class="linenos">773</span></a>            <span class="n">event_data</span> <span class="o">=</span> <span class="n">exp_data</span><span class="o">.</span><span class="n">event_data</span>
</span><span id="SampleTime.__init__-774"><a href="#SampleTime.__init__-774"><span class="linenos">774</span></a>
</span><span id="SampleTime.__init__-775"><a href="#SampleTime.__init__-775"><span class="linenos">775</span></a>            <span class="c1"># reset trial licks to count only sample licks</span>
</span><span id="SampleTime.__init__-776"><a href="#SampleTime.__init__-776"><span class="linenos">776</span></a>            <span class="n">event_data</span><span class="o">.</span><span class="n">side_one_licks</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="SampleTime.__init__-777"><a href="#SampleTime.__init__-777"><span class="linenos">777</span></a>            <span class="n">event_data</span><span class="o">.</span><span class="n">side_two_licks</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="SampleTime.__init__-778"><a href="#SampleTime.__init__-778"><span class="linenos">778</span></a>
</span><span id="SampleTime.__init__-779"><a href="#SampleTime.__init__-779"><span class="linenos">779</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">update_ttc_time</span><span class="p">(</span><span class="n">exp_data</span><span class="p">,</span> <span class="n">logical_trial</span><span class="p">)</span>
</span><span id="SampleTime.__init__-780"><a href="#SampleTime.__init__-780"><span class="linenos">780</span></a>
</span><span id="SampleTime.__init__-781"><a href="#SampleTime.__init__-781"><span class="linenos">781</span></a>            <span class="c1"># since the trial was engaged, cancel the planned transition from ttc to trial end. program has branched to new state</span>
</span><span id="SampleTime.__init__-782"><a href="#SampleTime.__init__-782"><span class="linenos">782</span></a>            <span class="n">main_gui</span><span class="o">.</span><span class="n">after_cancel</span><span class="p">(</span><span class="n">main_gui</span><span class="o">.</span><span class="n">scheduled_tasks</span><span class="p">[</span><span class="s2">&quot;TTC TO TRIAL END&quot;</span><span class="p">])</span>
</span><span id="SampleTime.__init__-783"><a href="#SampleTime.__init__-783"><span class="linenos">783</span></a>
</span><span id="SampleTime.__init__-784"><a href="#SampleTime.__init__-784"><span class="linenos">784</span></a>            <span class="c1"># Tell the laser arduino to begin accepting licks and opening valves</span>
</span><span id="SampleTime.__init__-785"><a href="#SampleTime.__init__-785"><span class="linenos">785</span></a>            <span class="c1"># resetting the lick counters for both spouts</span>
</span><span id="SampleTime.__init__-786"><a href="#SampleTime.__init__-786"><span class="linenos">786</span></a>            <span class="c1"># tell the laser to begin opening valves on licks</span>
</span><span id="SampleTime.__init__-787"><a href="#SampleTime.__init__-787"><span class="linenos">787</span></a>            <span class="n">open_command</span> <span class="o">=</span> <span class="s2">&quot;BEGIN OPEN VALVES</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
</span><span id="SampleTime.__init__-788"><a href="#SampleTime.__init__-788"><span class="linenos">788</span></a>            <span class="n">arduino_controller</span><span class="o">.</span><span class="n">send_command</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">open_command</span><span class="p">)</span>
</span><span id="SampleTime.__init__-789"><a href="#SampleTime.__init__-789"><span class="linenos">789</span></a>
</span><span id="SampleTime.__init__-790"><a href="#SampleTime.__init__-790"><span class="linenos">790</span></a>            <span class="n">exp_data</span><span class="o">.</span><span class="n">state_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="SampleTime.__init__-791"><a href="#SampleTime.__init__-791"><span class="linenos">791</span></a>
</span><span id="SampleTime.__init__-792"><a href="#SampleTime.__init__-792"><span class="linenos">792</span></a>            <span class="n">sample_interval_value</span> <span class="o">=</span> <span class="n">exp_data</span><span class="o">.</span><span class="n">program_schedule_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
</span><span id="SampleTime.__init__-793"><a href="#SampleTime.__init__-793"><span class="linenos">793</span></a>                <span class="n">logical_trial</span><span class="p">,</span> <span class="n">state</span>
</span><span id="SampleTime.__init__-794"><a href="#SampleTime.__init__-794"><span class="linenos">794</span></a>            <span class="p">]</span>
</span><span id="SampleTime.__init__-795"><a href="#SampleTime.__init__-795"><span class="linenos">795</span></a>
</span><span id="SampleTime.__init__-796"><a href="#SampleTime.__init__-796"><span class="linenos">796</span></a>            <span class="n">main_gui</span><span class="o">.</span><span class="n">update_on_state_change</span><span class="p">(</span><span class="n">sample_interval_value</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="SampleTime.__init__-797"><a href="#SampleTime.__init__-797"><span class="linenos">797</span></a>
</span><span id="SampleTime.__init__-798"><a href="#SampleTime.__init__-798"><span class="linenos">798</span></a>            <span class="n">main_gui</span><span class="o">.</span><span class="n">after</span><span class="p">(</span>
</span><span id="SampleTime.__init__-799"><a href="#SampleTime.__init__-799"><span class="linenos">799</span></a>                <span class="nb">int</span><span class="p">(</span><span class="n">sample_interval_value</span><span class="p">),</span>
</span><span id="SampleTime.__init__-800"><a href="#SampleTime.__init__-800"><span class="linenos">800</span></a>                <span class="k">lambda</span><span class="p">:</span> <span class="n">trigger</span><span class="p">(</span><span class="s2">&quot;TRIAL END&quot;</span><span class="p">),</span>
</span><span id="SampleTime.__init__-801"><a href="#SampleTime.__init__-801"><span class="linenos">801</span></a>            <span class="p">)</span>
</span><span id="SampleTime.__init__-802"><a href="#SampleTime.__init__-802"><span class="linenos">802</span></a>
</span><span id="SampleTime.__init__-803"><a href="#SampleTime.__init__-803"><span class="linenos">803</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="SampleTime.__init__-804"><a href="#SampleTime.__init__-804"><span class="linenos">804</span></a>                <span class="sa">f</span><span class="s2">&quot;STATE CHANGE: SAMPLE BEGINS NOW for trial-&gt; </span><span class="si">{</span><span class="n">exp_data</span><span class="o">.</span><span class="n">current_trial_number</span><span class="si">}</span><span class="s2">, completes in </span><span class="si">{</span><span class="n">sample_interval_value</span><span class="si">}</span><span class="s2">.&quot;</span>
</span><span id="SampleTime.__init__-805"><a href="#SampleTime.__init__-805"><span class="linenos">805</span></a>            <span class="p">)</span>
</span><span id="SampleTime.__init__-806"><a href="#SampleTime.__init__-806"><span class="linenos">806</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="SampleTime.__init__-807"><a href="#SampleTime.__init__-807"><span class="linenos">807</span></a>            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
</span><span id="SampleTime.__init__-808"><a href="#SampleTime.__init__-808"><span class="linenos">808</span></a>                <span class="sa">f</span><span class="s2">&quot;Error in sample time trial no. </span><span class="si">{</span><span class="n">exp_data</span><span class="o">.</span><span class="n">current_trial_number</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="SampleTime.__init__-809"><a href="#SampleTime.__init__-809"><span class="linenos">809</span></a>            <span class="p">)</span>
</span><span id="SampleTime.__init__-810"><a href="#SampleTime.__init__-810"><span class="linenos">810</span></a>            <span class="k">raise</span>
</span></pre></div>


            <div class="docstring"><p>This function transitions the program into the <code>SAMPLE</code> state. We can only reach this state from <code>TTC</code> if 3 licks or more are detected in <code>TTC</code>.</p>

<p>We transition into <code>SAMPLE</code> by resetting licks to zero to count only sample time licks for trial, updating the actual <code>TTC</code> time taken before engaging in the
trial, cancelling the scheduled <code>TTC</code> to <code>TRIAL END</code> transition, instructing Arduino to begin opening valves when licks occur, and updating state start time.</p>

<h2 id="parameters">Parameters</h2>

<ul>
<li><strong>exp_data</strong> (<em>ExperimentProcessData</em>): Reference to the <code>models.experiment_process_data</code>. Here we use it to get a reference to event_data to reset state time
and find <code>SAMPLE</code> state time, reset trial lick data.</li>
<li><strong>main_gui</strong> (<em>MainGUI</em>): A reference to <code>views.main_gui</code> MainGUI instance, this is used to update elements inside the GUI window(s). Here we use it to
update GUI with new state info and cancel <code>TTC</code> to <code>TRIAL END</code> transition.</li>
<li><strong>arduino_controller</strong> (<em>ArduinoManager</em>): A reference to the <code>controllers.arduino_control</code> instance, this is the method by which the Arduino is communicated
with in the program. Used here to tell Arduino to begin opening valves when licks are detected.</li>
<li><strong>state</strong> (<em>str</em>): State is used to update GUI with current state and grab the state duration time from the program schedule df.</li>
<li><strong>trigger</strong> (<em>Callback method</em>): This callback is passed in so the <code>TRIAL END</code> state can be triggered after <code>SAMPLE</code> time.</li>
</ul>

<h2 id="methods">Methods</h2>

<ul>
<li><code><a href="#SampleTime.update_ttc_time">update_ttc_time</a></code>(exp_data, logical_trial)
Updates program schedule dataframe with actual time used in the <code>TTC</code> state.</li>
</ul>
</div>


                            </div>
                            <div id="SampleTime.update_ttc_time" class="classattr">
                                        <input id="SampleTime.update_ttc_time-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">update_ttc_time</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">exp_data</span><span class="p">:</span> <span class="n">models</span><span class="o">.</span><span class="n">experiment_process_data</span><span class="o">.</span><span class="n">ExperimentProcessData</span>,</span><span class="param">	<span class="n">logical_trial</span><span class="p">:</span> <span class="nb">int</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="SampleTime.update_ttc_time-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SampleTime.update_ttc_time"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SampleTime.update_ttc_time-812"><a href="#SampleTime.update_ttc_time-812"><span class="linenos">812</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_ttc_time</span><span class="p">(</span>
</span><span id="SampleTime.update_ttc_time-813"><a href="#SampleTime.update_ttc_time-813"><span class="linenos">813</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">exp_data</span><span class="p">:</span> <span class="n">ExperimentProcessData</span><span class="p">,</span> <span class="n">logical_trial</span><span class="p">:</span> <span class="nb">int</span>
</span><span id="SampleTime.update_ttc_time-814"><a href="#SampleTime.update_ttc_time-814"><span class="linenos">814</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SampleTime.update_ttc_time-815"><a href="#SampleTime.update_ttc_time-815"><span class="linenos">815</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SampleTime.update_ttc_time-816"><a href="#SampleTime.update_ttc_time-816"><span class="linenos">816</span></a><span class="sd">        If we reach this code that means the rat licked at least 3 times in `TTC` state</span>
</span><span id="SampleTime.update_ttc_time-817"><a href="#SampleTime.update_ttc_time-817"><span class="linenos">817</span></a><span class="sd">        so we didn&#39;t take all the allocated time. update program schedule window with actual time taken</span>
</span><span id="SampleTime.update_ttc_time-818"><a href="#SampleTime.update_ttc_time-818"><span class="linenos">818</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SampleTime.update_ttc_time-819"><a href="#SampleTime.update_ttc_time-819"><span class="linenos">819</span></a>        <span class="n">ttc_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">exp_data</span><span class="o">.</span><span class="n">state_start_time</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
</span><span id="SampleTime.update_ttc_time-820"><a href="#SampleTime.update_ttc_time-820"><span class="linenos">820</span></a>
</span><span id="SampleTime.update_ttc_time-821"><a href="#SampleTime.update_ttc_time-821"><span class="linenos">821</span></a>        <span class="n">exp_data</span><span class="o">.</span><span class="n">program_schedule_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">logical_trial</span><span class="p">,</span> <span class="s2">&quot;TTC Actual&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span>
</span><span id="SampleTime.update_ttc_time-822"><a href="#SampleTime.update_ttc_time-822"><span class="linenos">822</span></a>            <span class="n">ttc_time</span><span class="p">,</span> <span class="mi">3</span>
</span><span id="SampleTime.update_ttc_time-823"><a href="#SampleTime.update_ttc_time-823"><span class="linenos">823</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>If we reach this code that means the rat licked at least 3 times in <code>TTC</code> state
so we didn't take all the allocated time. update program schedule window with actual time taken</p>
</div>


                            </div>
                </section>
                <section id="TrialEnd">
                            <input id="TrialEnd-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">TrialEnd</span>:

                <label class="view-source-button" for="TrialEnd-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TrialEnd"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TrialEnd-826"><a href="#TrialEnd-826"><span class="linenos">826</span></a><span class="k">class</span><span class="w"> </span><span class="nc">TrialEnd</span><span class="p">:</span>
</span><span id="TrialEnd-827"><a href="#TrialEnd-827"><span class="linenos">827</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="TrialEnd-828"><a href="#TrialEnd-828"><span class="linenos">828</span></a><span class="sd">    Handle end of trial operations such as data storage and GUI updates with gathered trial data.</span>
</span><span id="TrialEnd-829"><a href="#TrialEnd-829"><span class="linenos">829</span></a>
</span><span id="TrialEnd-830"><a href="#TrialEnd-830"><span class="linenos">830</span></a><span class="sd">    Methods</span>
</span><span id="TrialEnd-831"><a href="#TrialEnd-831"><span class="linenos">831</span></a><span class="sd">    -------</span>
</span><span id="TrialEnd-832"><a href="#TrialEnd-832"><span class="linenos">832</span></a><span class="sd">    - `arduino_trial_end`(arduino_controller): Handle Arduino end of trial, send door up, stop accepting licks.</span>
</span><span id="TrialEnd-833"><a href="#TrialEnd-833"><span class="linenos">833</span></a><span class="sd">    - `end_trial`(exp_data: ExperimentProcessData): Determine if this trial is the last, if not increment trial number in `models.experiment_process_data`.</span>
</span><span id="TrialEnd-834"><a href="#TrialEnd-834"><span class="linenos">834</span></a><span class="sd">    - `handle_from_ttc`(logical_trial, trigger), exp_data): Call `update_ttc_actual` to update TTC time. Trigger transition to `ITI`.</span>
</span><span id="TrialEnd-835"><a href="#TrialEnd-835"><span class="linenos">835</span></a><span class="sd">    - `update_schedule_licks`(logical_trial, exp_data) -&gt; None: Update program schedule df with licks for this trial on each port.</span>
</span><span id="TrialEnd-836"><a href="#TrialEnd-836"><span class="linenos">836</span></a><span class="sd">    - `update_raster_plots`(exp_data, logical_trial, main_gui) -&gt; None: Update raster plot with licks from this trial.</span>
</span><span id="TrialEnd-837"><a href="#TrialEnd-837"><span class="linenos">837</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="TrialEnd-838"><a href="#TrialEnd-838"><span class="linenos">838</span></a>
</span><span id="TrialEnd-839"><a href="#TrialEnd-839"><span class="linenos">839</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="TrialEnd-840"><a href="#TrialEnd-840"><span class="linenos">840</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="TrialEnd-841"><a href="#TrialEnd-841"><span class="linenos">841</span></a>        <span class="n">exp_data</span><span class="p">:</span> <span class="n">ExperimentProcessData</span><span class="p">,</span>
</span><span id="TrialEnd-842"><a href="#TrialEnd-842"><span class="linenos">842</span></a>        <span class="n">main_gui</span><span class="p">:</span> <span class="n">MainGUI</span><span class="p">,</span>
</span><span id="TrialEnd-843"><a href="#TrialEnd-843"><span class="linenos">843</span></a>        <span class="n">arduino_controller</span><span class="p">:</span> <span class="n">ArduinoManager</span><span class="p">,</span>
</span><span id="TrialEnd-844"><a href="#TrialEnd-844"><span class="linenos">844</span></a>        <span class="n">prev_state</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="TrialEnd-845"><a href="#TrialEnd-845"><span class="linenos">845</span></a>        <span class="n">trigger</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="kc">None</span><span class="p">],</span>
</span><span id="TrialEnd-846"><a href="#TrialEnd-846"><span class="linenos">846</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="TrialEnd-847"><a href="#TrialEnd-847"><span class="linenos">847</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="TrialEnd-848"><a href="#TrialEnd-848"><span class="linenos">848</span></a><span class="sd">        This function transitions the program into the `SAMPLE` state. We can only reach this state from `TTC` if 3 licks or more are detected in `TTC`.</span>
</span><span id="TrialEnd-849"><a href="#TrialEnd-849"><span class="linenos">849</span></a>
</span><span id="TrialEnd-850"><a href="#TrialEnd-850"><span class="linenos">850</span></a><span class="sd">        We transition into `SAMPLE` by resetting licks to zero to count only sample time licks for trial, updating the actual `TTC` time taken before engaging in the</span>
</span><span id="TrialEnd-851"><a href="#TrialEnd-851"><span class="linenos">851</span></a><span class="sd">        trial, cancelling the scheduled `TTC` to `TRIAL END` transition, instructing Arduino to begin opening valves when licks occur, and updating state start time.</span>
</span><span id="TrialEnd-852"><a href="#TrialEnd-852"><span class="linenos">852</span></a>
</span><span id="TrialEnd-853"><a href="#TrialEnd-853"><span class="linenos">853</span></a><span class="sd">        Parameters</span>
</span><span id="TrialEnd-854"><a href="#TrialEnd-854"><span class="linenos">854</span></a><span class="sd">        ----------</span>
</span><span id="TrialEnd-855"><a href="#TrialEnd-855"><span class="linenos">855</span></a><span class="sd">        - **exp_data** (*ExperimentProcessData*): Reference to the `models.experiment_process_data`. Here we use it to update program df with trial licks, increment trial,</span>
</span><span id="TrialEnd-856"><a href="#TrialEnd-856"><span class="linenos">856</span></a><span class="sd">        check if current trial is the final trial, and other data operations.</span>
</span><span id="TrialEnd-857"><a href="#TrialEnd-857"><span class="linenos">857</span></a><span class="sd">        - **main_gui** (*MainGUI*): A reference to `views.main_gui` MainGUI instance, this is used to update elements inside the GUI window(s). Here we use it to</span>
</span><span id="TrialEnd-858"><a href="#TrialEnd-858"><span class="linenos">858</span></a><span class="sd">        update program schedule and populate raster plots with trial licks.</span>
</span><span id="TrialEnd-859"><a href="#TrialEnd-859"><span class="linenos">859</span></a><span class="sd">        - **arduino_controller** (*ArduinoManager*): A reference to the `controllers.arduino_control` instance, this is the method by which the Arduino is communicated</span>
</span><span id="TrialEnd-860"><a href="#TrialEnd-860"><span class="linenos">860</span></a><span class="sd">        with in the program. Used here to tell Arduino to stop opening valves when licks are detected.</span>
</span><span id="TrialEnd-861"><a href="#TrialEnd-861"><span class="linenos">861</span></a><span class="sd">        - **prev_state** (*str*): prev_state is used to decide which end of trial operations should be executed.</span>
</span><span id="TrialEnd-862"><a href="#TrialEnd-862"><span class="linenos">862</span></a><span class="sd">        - **trigger** (*Callback method*): This callback is passed in so the `ITI` state can be triggered after `TRIAL END` logic is complete.</span>
</span><span id="TrialEnd-863"><a href="#TrialEnd-863"><span class="linenos">863</span></a>
</span><span id="TrialEnd-864"><a href="#TrialEnd-864"><span class="linenos">864</span></a><span class="sd">        Methods</span>
</span><span id="TrialEnd-865"><a href="#TrialEnd-865"><span class="linenos">865</span></a><span class="sd">        -------</span>
</span><span id="TrialEnd-866"><a href="#TrialEnd-866"><span class="linenos">866</span></a><span class="sd">        - `update_ttc_time`(exp_data, logical_trial)</span>
</span><span id="TrialEnd-867"><a href="#TrialEnd-867"><span class="linenos">867</span></a><span class="sd">        Updates program schedule dataframe with actual time used in the `TTC` state.</span>
</span><span id="TrialEnd-868"><a href="#TrialEnd-868"><span class="linenos">868</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TrialEnd-869"><a href="#TrialEnd-869"><span class="linenos">869</span></a>
</span><span id="TrialEnd-870"><a href="#TrialEnd-870"><span class="linenos">870</span></a>        <span class="c1"># use the same logical trial for all functions current_trial_number - 1</span>
</span><span id="TrialEnd-871"><a href="#TrialEnd-871"><span class="linenos">871</span></a>        <span class="c1"># to account for 1 indexing</span>
</span><span id="TrialEnd-872"><a href="#TrialEnd-872"><span class="linenos">872</span></a>        <span class="n">logical_trial</span> <span class="o">=</span> <span class="n">exp_data</span><span class="o">.</span><span class="n">current_trial_number</span> <span class="o">-</span> <span class="mi">1</span>
</span><span id="TrialEnd-873"><a href="#TrialEnd-873"><span class="linenos">873</span></a>
</span><span id="TrialEnd-874"><a href="#TrialEnd-874"><span class="linenos">874</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">arduino_trial_end</span><span class="p">(</span><span class="n">arduino_controller</span><span class="p">)</span>
</span><span id="TrialEnd-875"><a href="#TrialEnd-875"><span class="linenos">875</span></a>
</span><span id="TrialEnd-876"><a href="#TrialEnd-876"><span class="linenos">876</span></a>        <span class="c1">#######TRIAL NUMBER IS INCREMENTED INSIDE OF END_TRIAL#######</span>
</span><span id="TrialEnd-877"><a href="#TrialEnd-877"><span class="linenos">877</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_trial</span><span class="p">(</span><span class="n">exp_data</span><span class="p">):</span>
</span><span id="TrialEnd-878"><a href="#TrialEnd-878"><span class="linenos">878</span></a>            <span class="n">program_schedule</span> <span class="o">=</span> <span class="n">main_gui</span><span class="o">.</span><span class="n">windows</span><span class="p">[</span><span class="s2">&quot;Program Schedule&quot;</span><span class="p">]</span>
</span><span id="TrialEnd-879"><a href="#TrialEnd-879"><span class="linenos">879</span></a>            <span class="c1"># if the experiment is over update the licks for the final trial</span>
</span><span id="TrialEnd-880"><a href="#TrialEnd-880"><span class="linenos">880</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">update_schedule_licks</span><span class="p">(</span><span class="n">logical_trial</span><span class="p">,</span> <span class="n">exp_data</span><span class="p">)</span>
</span><span id="TrialEnd-881"><a href="#TrialEnd-881"><span class="linenos">881</span></a>            <span class="n">program_schedule</span><span class="o">.</span><span class="n">refresh_end_trial</span><span class="p">(</span><span class="n">logical_trial</span><span class="p">)</span>
</span><span id="TrialEnd-882"><a href="#TrialEnd-882"><span class="linenos">882</span></a>
</span><span id="TrialEnd-883"><a href="#TrialEnd-883"><span class="linenos">883</span></a>            <span class="n">trigger</span><span class="p">(</span><span class="s2">&quot;STOP&quot;</span><span class="p">)</span>
</span><span id="TrialEnd-884"><a href="#TrialEnd-884"><span class="linenos">884</span></a>            <span class="c1"># return from the call / kill the working thread</span>
</span><span id="TrialEnd-885"><a href="#TrialEnd-885"><span class="linenos">885</span></a>            <span class="k">return</span>
</span><span id="TrialEnd-886"><a href="#TrialEnd-886"><span class="linenos">886</span></a>
</span><span id="TrialEnd-887"><a href="#TrialEnd-887"><span class="linenos">887</span></a>        <span class="c1"># update licks for this trial</span>
</span><span id="TrialEnd-888"><a href="#TrialEnd-888"><span class="linenos">888</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">update_schedule_licks</span><span class="p">(</span><span class="n">logical_trial</span><span class="p">,</span> <span class="n">exp_data</span><span class="p">)</span>
</span><span id="TrialEnd-889"><a href="#TrialEnd-889"><span class="linenos">889</span></a>
</span><span id="TrialEnd-890"><a href="#TrialEnd-890"><span class="linenos">890</span></a>        <span class="k">match</span> <span class="n">prev_state</span><span class="p">:</span>
</span><span id="TrialEnd-891"><a href="#TrialEnd-891"><span class="linenos">891</span></a>            <span class="k">case</span> <span class="s2">&quot;TTC&quot;</span><span class="p">:</span>
</span><span id="TrialEnd-892"><a href="#TrialEnd-892"><span class="linenos">892</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">update_ttc_actual</span><span class="p">(</span><span class="n">logical_trial</span><span class="p">,</span> <span class="n">exp_data</span><span class="p">)</span>
</span><span id="TrialEnd-893"><a href="#TrialEnd-893"><span class="linenos">893</span></a>                <span class="n">trigger</span><span class="p">(</span><span class="s2">&quot;ITI&quot;</span><span class="p">)</span>
</span><span id="TrialEnd-894"><a href="#TrialEnd-894"><span class="linenos">894</span></a>            <span class="k">case</span> <span class="s2">&quot;SAMPLE&quot;</span><span class="p">:</span>
</span><span id="TrialEnd-895"><a href="#TrialEnd-895"><span class="linenos">895</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">update_raster_plots</span><span class="p">(</span><span class="n">exp_data</span><span class="p">,</span> <span class="n">logical_trial</span><span class="p">,</span> <span class="n">main_gui</span><span class="p">)</span>
</span><span id="TrialEnd-896"><a href="#TrialEnd-896"><span class="linenos">896</span></a>                <span class="n">trigger</span><span class="p">(</span><span class="s2">&quot;ITI&quot;</span><span class="p">)</span>
</span><span id="TrialEnd-897"><a href="#TrialEnd-897"><span class="linenos">897</span></a>            <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
</span><span id="TrialEnd-898"><a href="#TrialEnd-898"><span class="linenos">898</span></a>                <span class="c1"># cases not explicitly defined go here</span>
</span><span id="TrialEnd-899"><a href="#TrialEnd-899"><span class="linenos">899</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;UNDEFINED PREVIOUS TRANSITION IN TRIAL END STATE&quot;</span><span class="p">)</span>
</span><span id="TrialEnd-900"><a href="#TrialEnd-900"><span class="linenos">900</span></a>
</span><span id="TrialEnd-901"><a href="#TrialEnd-901"><span class="linenos">901</span></a>        <span class="n">main_gui</span><span class="o">.</span><span class="n">windows</span><span class="p">[</span><span class="s2">&quot;Program Schedule&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">refresh_end_trial</span><span class="p">(</span><span class="n">logical_trial</span><span class="p">)</span>
</span><span id="TrialEnd-902"><a href="#TrialEnd-902"><span class="linenos">902</span></a>
</span><span id="TrialEnd-903"><a href="#TrialEnd-903"><span class="linenos">903</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">arduino_trial_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arduino_controller</span><span class="p">:</span> <span class="n">ArduinoManager</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="TrialEnd-904"><a href="#TrialEnd-904"><span class="linenos">904</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="TrialEnd-905"><a href="#TrialEnd-905"><span class="linenos">905</span></a><span class="sd">        Send rig door up and tell Arduino to stop accepting licks.</span>
</span><span id="TrialEnd-906"><a href="#TrialEnd-906"><span class="linenos">906</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TrialEnd-907"><a href="#TrialEnd-907"><span class="linenos">907</span></a>        <span class="n">up_command</span> <span class="o">=</span> <span class="s2">&quot;UP</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
</span><span id="TrialEnd-908"><a href="#TrialEnd-908"><span class="linenos">908</span></a>        <span class="n">arduino_controller</span><span class="o">.</span><span class="n">send_command</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">up_command</span><span class="p">)</span>
</span><span id="TrialEnd-909"><a href="#TrialEnd-909"><span class="linenos">909</span></a>
</span><span id="TrialEnd-910"><a href="#TrialEnd-910"><span class="linenos">910</span></a>        <span class="n">stop_command</span> <span class="o">=</span> <span class="s2">&quot;STOP OPEN VALVES</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
</span><span id="TrialEnd-911"><a href="#TrialEnd-911"><span class="linenos">911</span></a>        <span class="n">arduino_controller</span><span class="o">.</span><span class="n">send_command</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">stop_command</span><span class="p">)</span>
</span><span id="TrialEnd-912"><a href="#TrialEnd-912"><span class="linenos">912</span></a>
</span><span id="TrialEnd-913"><a href="#TrialEnd-913"><span class="linenos">913</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">end_trial</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exp_data</span><span class="p">:</span> <span class="n">ExperimentProcessData</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="TrialEnd-914"><a href="#TrialEnd-914"><span class="linenos">914</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="TrialEnd-915"><a href="#TrialEnd-915"><span class="linenos">915</span></a><span class="sd">        This method checks if current trial is the last trial. If it is, we return true to the calling code.</span>
</span><span id="TrialEnd-916"><a href="#TrialEnd-916"><span class="linenos">916</span></a><span class="sd">        If false, we increment current_trial_number, return false, and proceed to next trial.</span>
</span><span id="TrialEnd-917"><a href="#TrialEnd-917"><span class="linenos">917</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TrialEnd-918"><a href="#TrialEnd-918"><span class="linenos">918</span></a>        <span class="n">current_trial</span> <span class="o">=</span> <span class="n">exp_data</span><span class="o">.</span><span class="n">current_trial_number</span>
</span><span id="TrialEnd-919"><a href="#TrialEnd-919"><span class="linenos">919</span></a>        <span class="n">max_trials</span> <span class="o">=</span> <span class="n">exp_data</span><span class="o">.</span><span class="n">exp_var_entries</span><span class="p">[</span><span class="s2">&quot;Num Trials&quot;</span><span class="p">]</span>
</span><span id="TrialEnd-920"><a href="#TrialEnd-920"><span class="linenos">920</span></a>
</span><span id="TrialEnd-921"><a href="#TrialEnd-921"><span class="linenos">921</span></a>        <span class="k">if</span> <span class="n">current_trial</span> <span class="o">&gt;=</span> <span class="n">max_trials</span><span class="p">:</span>
</span><span id="TrialEnd-922"><a href="#TrialEnd-922"><span class="linenos">922</span></a>            <span class="k">return</span> <span class="kc">True</span>
</span><span id="TrialEnd-923"><a href="#TrialEnd-923"><span class="linenos">923</span></a>
</span><span id="TrialEnd-924"><a href="#TrialEnd-924"><span class="linenos">924</span></a>        <span class="n">exp_data</span><span class="o">.</span><span class="n">current_trial_number</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="TrialEnd-925"><a href="#TrialEnd-925"><span class="linenos">925</span></a>        <span class="k">return</span> <span class="kc">False</span>
</span><span id="TrialEnd-926"><a href="#TrialEnd-926"><span class="linenos">926</span></a>
</span><span id="TrialEnd-927"><a href="#TrialEnd-927"><span class="linenos">927</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_ttc_actual</span><span class="p">(</span>
</span><span id="TrialEnd-928"><a href="#TrialEnd-928"><span class="linenos">928</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">logical_trial</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">exp_data</span><span class="p">:</span> <span class="n">ExperimentProcessData</span>
</span><span id="TrialEnd-929"><a href="#TrialEnd-929"><span class="linenos">929</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="TrialEnd-930"><a href="#TrialEnd-930"><span class="linenos">930</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="TrialEnd-931"><a href="#TrialEnd-931"><span class="linenos">931</span></a><span class="sd">        Update the actual ttc time take in the program schedule with the max time value,</span>
</span><span id="TrialEnd-932"><a href="#TrialEnd-932"><span class="linenos">932</span></a><span class="sd">        since we reached trial end we know we took the max time allowed</span>
</span><span id="TrialEnd-933"><a href="#TrialEnd-933"><span class="linenos">933</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TrialEnd-934"><a href="#TrialEnd-934"><span class="linenos">934</span></a>        <span class="n">program_df</span> <span class="o">=</span> <span class="n">exp_data</span><span class="o">.</span><span class="n">program_schedule_df</span>
</span><span id="TrialEnd-935"><a href="#TrialEnd-935"><span class="linenos">935</span></a>
</span><span id="TrialEnd-936"><a href="#TrialEnd-936"><span class="linenos">936</span></a>        <span class="n">ttc_column_value</span> <span class="o">=</span> <span class="n">program_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">logical_trial</span><span class="p">,</span> <span class="s2">&quot;TTC&quot;</span><span class="p">]</span>
</span><span id="TrialEnd-937"><a href="#TrialEnd-937"><span class="linenos">937</span></a>        <span class="n">program_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">logical_trial</span><span class="p">,</span> <span class="s2">&quot;TTC Actual&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ttc_column_value</span>
</span><span id="TrialEnd-938"><a href="#TrialEnd-938"><span class="linenos">938</span></a>
</span><span id="TrialEnd-939"><a href="#TrialEnd-939"><span class="linenos">939</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_schedule_licks</span><span class="p">(</span>
</span><span id="TrialEnd-940"><a href="#TrialEnd-940"><span class="linenos">940</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">logical_trial</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">exp_data</span><span class="p">:</span> <span class="n">ExperimentProcessData</span>
</span><span id="TrialEnd-941"><a href="#TrialEnd-941"><span class="linenos">941</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="TrialEnd-942"><a href="#TrialEnd-942"><span class="linenos">942</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Update the licks for each side in the program schedule df for this trial&quot;&quot;&quot;</span>
</span><span id="TrialEnd-943"><a href="#TrialEnd-943"><span class="linenos">943</span></a>        <span class="n">program_df</span> <span class="o">=</span> <span class="n">exp_data</span><span class="o">.</span><span class="n">program_schedule_df</span>
</span><span id="TrialEnd-944"><a href="#TrialEnd-944"><span class="linenos">944</span></a>        <span class="n">event_data</span> <span class="o">=</span> <span class="n">exp_data</span><span class="o">.</span><span class="n">event_data</span>
</span><span id="TrialEnd-945"><a href="#TrialEnd-945"><span class="linenos">945</span></a>
</span><span id="TrialEnd-946"><a href="#TrialEnd-946"><span class="linenos">946</span></a>        <span class="n">licks_sd_one</span> <span class="o">=</span> <span class="n">event_data</span><span class="o">.</span><span class="n">side_one_licks</span>
</span><span id="TrialEnd-947"><a href="#TrialEnd-947"><span class="linenos">947</span></a>        <span class="n">licks_sd_two</span> <span class="o">=</span> <span class="n">event_data</span><span class="o">.</span><span class="n">side_two_licks</span>
</span><span id="TrialEnd-948"><a href="#TrialEnd-948"><span class="linenos">948</span></a>
</span><span id="TrialEnd-949"><a href="#TrialEnd-949"><span class="linenos">949</span></a>        <span class="n">program_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">logical_trial</span><span class="p">,</span> <span class="s2">&quot;Port 1 Licks&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">licks_sd_one</span>
</span><span id="TrialEnd-950"><a href="#TrialEnd-950"><span class="linenos">950</span></a>
</span><span id="TrialEnd-951"><a href="#TrialEnd-951"><span class="linenos">951</span></a>        <span class="n">program_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">logical_trial</span><span class="p">,</span> <span class="s2">&quot;Port 2 Licks&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">licks_sd_two</span>
</span><span id="TrialEnd-952"><a href="#TrialEnd-952"><span class="linenos">952</span></a>
</span><span id="TrialEnd-953"><a href="#TrialEnd-953"><span class="linenos">953</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_raster_plots</span><span class="p">(</span>
</span><span id="TrialEnd-954"><a href="#TrialEnd-954"><span class="linenos">954</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">exp_data</span><span class="p">:</span> <span class="n">ExperimentProcessData</span><span class="p">,</span> <span class="n">logical_trial</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">main_gui</span><span class="p">:</span> <span class="n">MainGUI</span>
</span><span id="TrialEnd-955"><a href="#TrialEnd-955"><span class="linenos">955</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="TrialEnd-956"><a href="#TrialEnd-956"><span class="linenos">956</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Instruct raster windows to update with new lick timestamps&quot;&quot;&quot;</span>
</span><span id="TrialEnd-957"><a href="#TrialEnd-957"><span class="linenos">957</span></a>        <span class="c1"># gather lick timestamp data from the event data model</span>
</span><span id="TrialEnd-958"><a href="#TrialEnd-958"><span class="linenos">958</span></a>        <span class="n">lick_stamps</span> <span class="o">=</span> <span class="n">exp_data</span><span class="o">.</span><span class="n">event_data</span><span class="o">.</span><span class="n">get_lick_timestamps</span><span class="p">(</span><span class="n">logical_trial</span><span class="p">)</span>
</span><span id="TrialEnd-959"><a href="#TrialEnd-959"><span class="linenos">959</span></a>
</span><span id="TrialEnd-960"><a href="#TrialEnd-960"><span class="linenos">960</span></a>        <span class="c1"># send it to raster windows</span>
</span><span id="TrialEnd-961"><a href="#TrialEnd-961"><span class="linenos">961</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">window</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">main_gui</span><span class="o">.</span><span class="n">windows</span><span class="p">[</span><span class="s2">&quot;Raster Plot&quot;</span><span class="p">]):</span>
</span><span id="TrialEnd-962"><a href="#TrialEnd-962"><span class="linenos">962</span></a>            <span class="n">window</span><span class="o">.</span><span class="n">update_plot</span><span class="p">(</span><span class="n">lick_stamps</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">logical_trial</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Handle end of trial operations such as data storage and GUI updates with gathered trial data.</p>

<h2 id="methods">Methods</h2>

<ul>
<li><code><a href="#TrialEnd.arduino_trial_end">arduino_trial_end</a></code>(arduino_controller): Handle Arduino end of trial, send door up, stop accepting licks.</li>
<li><code><a href="#TrialEnd.end_trial">end_trial</a></code>(exp_data: ExperimentProcessData): Determine if this trial is the last, if not increment trial number in <code>models.experiment_process_data</code>.</li>
<li><code>handle_from_ttc</code>(logical_trial, trigger), exp_data): Call <code><a href="#TrialEnd.update_ttc_actual">update_ttc_actual</a></code> to update TTC time. Trigger transition to <code>ITI</code>.</li>
<li><code><a href="#TrialEnd.update_schedule_licks">update_schedule_licks</a></code>(logical_trial, exp_data) -> None: Update program schedule df with licks for this trial on each port.</li>
<li><code><a href="#TrialEnd.update_raster_plots">update_raster_plots</a></code>(exp_data, logical_trial, main_gui) -> None: Update raster plot with licks from this trial.</li>
</ul>
</div>


                            <div id="TrialEnd.__init__" class="classattr">
                                        <input id="TrialEnd.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">TrialEnd</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">exp_data</span><span class="p">:</span> <span class="n">models</span><span class="o">.</span><span class="n">experiment_process_data</span><span class="o">.</span><span class="n">ExperimentProcessData</span>,</span><span class="param">	<span class="n">main_gui</span><span class="p">:</span> <span class="n">views</span><span class="o">.</span><span class="n">main_gui</span><span class="o">.</span><span class="n">MainGUI</span>,</span><span class="param">	<span class="n">arduino_controller</span><span class="p">:</span> <span class="n">controllers</span><span class="o">.</span><span class="n">arduino_control</span><span class="o">.</span><span class="n">ArduinoManager</span>,</span><span class="param">	<span class="n">prev_state</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">trigger</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="n">NoneType</span><span class="p">]</span></span>)</span>

                <label class="view-source-button" for="TrialEnd.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TrialEnd.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TrialEnd.__init__-839"><a href="#TrialEnd.__init__-839"><span class="linenos">839</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="TrialEnd.__init__-840"><a href="#TrialEnd.__init__-840"><span class="linenos">840</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="TrialEnd.__init__-841"><a href="#TrialEnd.__init__-841"><span class="linenos">841</span></a>        <span class="n">exp_data</span><span class="p">:</span> <span class="n">ExperimentProcessData</span><span class="p">,</span>
</span><span id="TrialEnd.__init__-842"><a href="#TrialEnd.__init__-842"><span class="linenos">842</span></a>        <span class="n">main_gui</span><span class="p">:</span> <span class="n">MainGUI</span><span class="p">,</span>
</span><span id="TrialEnd.__init__-843"><a href="#TrialEnd.__init__-843"><span class="linenos">843</span></a>        <span class="n">arduino_controller</span><span class="p">:</span> <span class="n">ArduinoManager</span><span class="p">,</span>
</span><span id="TrialEnd.__init__-844"><a href="#TrialEnd.__init__-844"><span class="linenos">844</span></a>        <span class="n">prev_state</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="TrialEnd.__init__-845"><a href="#TrialEnd.__init__-845"><span class="linenos">845</span></a>        <span class="n">trigger</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="kc">None</span><span class="p">],</span>
</span><span id="TrialEnd.__init__-846"><a href="#TrialEnd.__init__-846"><span class="linenos">846</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="TrialEnd.__init__-847"><a href="#TrialEnd.__init__-847"><span class="linenos">847</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="TrialEnd.__init__-848"><a href="#TrialEnd.__init__-848"><span class="linenos">848</span></a><span class="sd">        This function transitions the program into the `SAMPLE` state. We can only reach this state from `TTC` if 3 licks or more are detected in `TTC`.</span>
</span><span id="TrialEnd.__init__-849"><a href="#TrialEnd.__init__-849"><span class="linenos">849</span></a>
</span><span id="TrialEnd.__init__-850"><a href="#TrialEnd.__init__-850"><span class="linenos">850</span></a><span class="sd">        We transition into `SAMPLE` by resetting licks to zero to count only sample time licks for trial, updating the actual `TTC` time taken before engaging in the</span>
</span><span id="TrialEnd.__init__-851"><a href="#TrialEnd.__init__-851"><span class="linenos">851</span></a><span class="sd">        trial, cancelling the scheduled `TTC` to `TRIAL END` transition, instructing Arduino to begin opening valves when licks occur, and updating state start time.</span>
</span><span id="TrialEnd.__init__-852"><a href="#TrialEnd.__init__-852"><span class="linenos">852</span></a>
</span><span id="TrialEnd.__init__-853"><a href="#TrialEnd.__init__-853"><span class="linenos">853</span></a><span class="sd">        Parameters</span>
</span><span id="TrialEnd.__init__-854"><a href="#TrialEnd.__init__-854"><span class="linenos">854</span></a><span class="sd">        ----------</span>
</span><span id="TrialEnd.__init__-855"><a href="#TrialEnd.__init__-855"><span class="linenos">855</span></a><span class="sd">        - **exp_data** (*ExperimentProcessData*): Reference to the `models.experiment_process_data`. Here we use it to update program df with trial licks, increment trial,</span>
</span><span id="TrialEnd.__init__-856"><a href="#TrialEnd.__init__-856"><span class="linenos">856</span></a><span class="sd">        check if current trial is the final trial, and other data operations.</span>
</span><span id="TrialEnd.__init__-857"><a href="#TrialEnd.__init__-857"><span class="linenos">857</span></a><span class="sd">        - **main_gui** (*MainGUI*): A reference to `views.main_gui` MainGUI instance, this is used to update elements inside the GUI window(s). Here we use it to</span>
</span><span id="TrialEnd.__init__-858"><a href="#TrialEnd.__init__-858"><span class="linenos">858</span></a><span class="sd">        update program schedule and populate raster plots with trial licks.</span>
</span><span id="TrialEnd.__init__-859"><a href="#TrialEnd.__init__-859"><span class="linenos">859</span></a><span class="sd">        - **arduino_controller** (*ArduinoManager*): A reference to the `controllers.arduino_control` instance, this is the method by which the Arduino is communicated</span>
</span><span id="TrialEnd.__init__-860"><a href="#TrialEnd.__init__-860"><span class="linenos">860</span></a><span class="sd">        with in the program. Used here to tell Arduino to stop opening valves when licks are detected.</span>
</span><span id="TrialEnd.__init__-861"><a href="#TrialEnd.__init__-861"><span class="linenos">861</span></a><span class="sd">        - **prev_state** (*str*): prev_state is used to decide which end of trial operations should be executed.</span>
</span><span id="TrialEnd.__init__-862"><a href="#TrialEnd.__init__-862"><span class="linenos">862</span></a><span class="sd">        - **trigger** (*Callback method*): This callback is passed in so the `ITI` state can be triggered after `TRIAL END` logic is complete.</span>
</span><span id="TrialEnd.__init__-863"><a href="#TrialEnd.__init__-863"><span class="linenos">863</span></a>
</span><span id="TrialEnd.__init__-864"><a href="#TrialEnd.__init__-864"><span class="linenos">864</span></a><span class="sd">        Methods</span>
</span><span id="TrialEnd.__init__-865"><a href="#TrialEnd.__init__-865"><span class="linenos">865</span></a><span class="sd">        -------</span>
</span><span id="TrialEnd.__init__-866"><a href="#TrialEnd.__init__-866"><span class="linenos">866</span></a><span class="sd">        - `update_ttc_time`(exp_data, logical_trial)</span>
</span><span id="TrialEnd.__init__-867"><a href="#TrialEnd.__init__-867"><span class="linenos">867</span></a><span class="sd">        Updates program schedule dataframe with actual time used in the `TTC` state.</span>
</span><span id="TrialEnd.__init__-868"><a href="#TrialEnd.__init__-868"><span class="linenos">868</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TrialEnd.__init__-869"><a href="#TrialEnd.__init__-869"><span class="linenos">869</span></a>
</span><span id="TrialEnd.__init__-870"><a href="#TrialEnd.__init__-870"><span class="linenos">870</span></a>        <span class="c1"># use the same logical trial for all functions current_trial_number - 1</span>
</span><span id="TrialEnd.__init__-871"><a href="#TrialEnd.__init__-871"><span class="linenos">871</span></a>        <span class="c1"># to account for 1 indexing</span>
</span><span id="TrialEnd.__init__-872"><a href="#TrialEnd.__init__-872"><span class="linenos">872</span></a>        <span class="n">logical_trial</span> <span class="o">=</span> <span class="n">exp_data</span><span class="o">.</span><span class="n">current_trial_number</span> <span class="o">-</span> <span class="mi">1</span>
</span><span id="TrialEnd.__init__-873"><a href="#TrialEnd.__init__-873"><span class="linenos">873</span></a>
</span><span id="TrialEnd.__init__-874"><a href="#TrialEnd.__init__-874"><span class="linenos">874</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">arduino_trial_end</span><span class="p">(</span><span class="n">arduino_controller</span><span class="p">)</span>
</span><span id="TrialEnd.__init__-875"><a href="#TrialEnd.__init__-875"><span class="linenos">875</span></a>
</span><span id="TrialEnd.__init__-876"><a href="#TrialEnd.__init__-876"><span class="linenos">876</span></a>        <span class="c1">#######TRIAL NUMBER IS INCREMENTED INSIDE OF END_TRIAL#######</span>
</span><span id="TrialEnd.__init__-877"><a href="#TrialEnd.__init__-877"><span class="linenos">877</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_trial</span><span class="p">(</span><span class="n">exp_data</span><span class="p">):</span>
</span><span id="TrialEnd.__init__-878"><a href="#TrialEnd.__init__-878"><span class="linenos">878</span></a>            <span class="n">program_schedule</span> <span class="o">=</span> <span class="n">main_gui</span><span class="o">.</span><span class="n">windows</span><span class="p">[</span><span class="s2">&quot;Program Schedule&quot;</span><span class="p">]</span>
</span><span id="TrialEnd.__init__-879"><a href="#TrialEnd.__init__-879"><span class="linenos">879</span></a>            <span class="c1"># if the experiment is over update the licks for the final trial</span>
</span><span id="TrialEnd.__init__-880"><a href="#TrialEnd.__init__-880"><span class="linenos">880</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">update_schedule_licks</span><span class="p">(</span><span class="n">logical_trial</span><span class="p">,</span> <span class="n">exp_data</span><span class="p">)</span>
</span><span id="TrialEnd.__init__-881"><a href="#TrialEnd.__init__-881"><span class="linenos">881</span></a>            <span class="n">program_schedule</span><span class="o">.</span><span class="n">refresh_end_trial</span><span class="p">(</span><span class="n">logical_trial</span><span class="p">)</span>
</span><span id="TrialEnd.__init__-882"><a href="#TrialEnd.__init__-882"><span class="linenos">882</span></a>
</span><span id="TrialEnd.__init__-883"><a href="#TrialEnd.__init__-883"><span class="linenos">883</span></a>            <span class="n">trigger</span><span class="p">(</span><span class="s2">&quot;STOP&quot;</span><span class="p">)</span>
</span><span id="TrialEnd.__init__-884"><a href="#TrialEnd.__init__-884"><span class="linenos">884</span></a>            <span class="c1"># return from the call / kill the working thread</span>
</span><span id="TrialEnd.__init__-885"><a href="#TrialEnd.__init__-885"><span class="linenos">885</span></a>            <span class="k">return</span>
</span><span id="TrialEnd.__init__-886"><a href="#TrialEnd.__init__-886"><span class="linenos">886</span></a>
</span><span id="TrialEnd.__init__-887"><a href="#TrialEnd.__init__-887"><span class="linenos">887</span></a>        <span class="c1"># update licks for this trial</span>
</span><span id="TrialEnd.__init__-888"><a href="#TrialEnd.__init__-888"><span class="linenos">888</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">update_schedule_licks</span><span class="p">(</span><span class="n">logical_trial</span><span class="p">,</span> <span class="n">exp_data</span><span class="p">)</span>
</span><span id="TrialEnd.__init__-889"><a href="#TrialEnd.__init__-889"><span class="linenos">889</span></a>
</span><span id="TrialEnd.__init__-890"><a href="#TrialEnd.__init__-890"><span class="linenos">890</span></a>        <span class="k">match</span> <span class="n">prev_state</span><span class="p">:</span>
</span><span id="TrialEnd.__init__-891"><a href="#TrialEnd.__init__-891"><span class="linenos">891</span></a>            <span class="k">case</span> <span class="s2">&quot;TTC&quot;</span><span class="p">:</span>
</span><span id="TrialEnd.__init__-892"><a href="#TrialEnd.__init__-892"><span class="linenos">892</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">update_ttc_actual</span><span class="p">(</span><span class="n">logical_trial</span><span class="p">,</span> <span class="n">exp_data</span><span class="p">)</span>
</span><span id="TrialEnd.__init__-893"><a href="#TrialEnd.__init__-893"><span class="linenos">893</span></a>                <span class="n">trigger</span><span class="p">(</span><span class="s2">&quot;ITI&quot;</span><span class="p">)</span>
</span><span id="TrialEnd.__init__-894"><a href="#TrialEnd.__init__-894"><span class="linenos">894</span></a>            <span class="k">case</span> <span class="s2">&quot;SAMPLE&quot;</span><span class="p">:</span>
</span><span id="TrialEnd.__init__-895"><a href="#TrialEnd.__init__-895"><span class="linenos">895</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">update_raster_plots</span><span class="p">(</span><span class="n">exp_data</span><span class="p">,</span> <span class="n">logical_trial</span><span class="p">,</span> <span class="n">main_gui</span><span class="p">)</span>
</span><span id="TrialEnd.__init__-896"><a href="#TrialEnd.__init__-896"><span class="linenos">896</span></a>                <span class="n">trigger</span><span class="p">(</span><span class="s2">&quot;ITI&quot;</span><span class="p">)</span>
</span><span id="TrialEnd.__init__-897"><a href="#TrialEnd.__init__-897"><span class="linenos">897</span></a>            <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
</span><span id="TrialEnd.__init__-898"><a href="#TrialEnd.__init__-898"><span class="linenos">898</span></a>                <span class="c1"># cases not explicitly defined go here</span>
</span><span id="TrialEnd.__init__-899"><a href="#TrialEnd.__init__-899"><span class="linenos">899</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;UNDEFINED PREVIOUS TRANSITION IN TRIAL END STATE&quot;</span><span class="p">)</span>
</span><span id="TrialEnd.__init__-900"><a href="#TrialEnd.__init__-900"><span class="linenos">900</span></a>
</span><span id="TrialEnd.__init__-901"><a href="#TrialEnd.__init__-901"><span class="linenos">901</span></a>        <span class="n">main_gui</span><span class="o">.</span><span class="n">windows</span><span class="p">[</span><span class="s2">&quot;Program Schedule&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">refresh_end_trial</span><span class="p">(</span><span class="n">logical_trial</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>This function transitions the program into the <code>SAMPLE</code> state. We can only reach this state from <code>TTC</code> if 3 licks or more are detected in <code>TTC</code>.</p>

<p>We transition into <code>SAMPLE</code> by resetting licks to zero to count only sample time licks for trial, updating the actual <code>TTC</code> time taken before engaging in the
trial, cancelling the scheduled <code>TTC</code> to <code>TRIAL END</code> transition, instructing Arduino to begin opening valves when licks occur, and updating state start time.</p>

<h2 id="parameters">Parameters</h2>

<ul>
<li><strong>exp_data</strong> (<em>ExperimentProcessData</em>): Reference to the <code>models.experiment_process_data</code>. Here we use it to update program df with trial licks, increment trial,
check if current trial is the final trial, and other data operations.</li>
<li><strong>main_gui</strong> (<em>MainGUI</em>): A reference to <code>views.main_gui</code> MainGUI instance, this is used to update elements inside the GUI window(s). Here we use it to
update program schedule and populate raster plots with trial licks.</li>
<li><strong>arduino_controller</strong> (<em>ArduinoManager</em>): A reference to the <code>controllers.arduino_control</code> instance, this is the method by which the Arduino is communicated
with in the program. Used here to tell Arduino to stop opening valves when licks are detected.</li>
<li><strong>prev_state</strong> (<em>str</em>): prev_state is used to decide which end of trial operations should be executed.</li>
<li><strong>trigger</strong> (<em>Callback method</em>): This callback is passed in so the <code>ITI</code> state can be triggered after <code>TRIAL END</code> logic is complete.</li>
</ul>

<h2 id="methods">Methods</h2>

<ul>
<li><code>update_ttc_time</code>(exp_data, logical_trial)
Updates program schedule dataframe with actual time used in the <code>TTC</code> state.</li>
</ul>
</div>


                            </div>
                            <div id="TrialEnd.arduino_trial_end" class="classattr">
                                        <input id="TrialEnd.arduino_trial_end-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">arduino_trial_end</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">arduino_controller</span><span class="p">:</span> <span class="n">controllers</span><span class="o">.</span><span class="n">arduino_control</span><span class="o">.</span><span class="n">ArduinoManager</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="TrialEnd.arduino_trial_end-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TrialEnd.arduino_trial_end"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TrialEnd.arduino_trial_end-903"><a href="#TrialEnd.arduino_trial_end-903"><span class="linenos">903</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">arduino_trial_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arduino_controller</span><span class="p">:</span> <span class="n">ArduinoManager</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="TrialEnd.arduino_trial_end-904"><a href="#TrialEnd.arduino_trial_end-904"><span class="linenos">904</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="TrialEnd.arduino_trial_end-905"><a href="#TrialEnd.arduino_trial_end-905"><span class="linenos">905</span></a><span class="sd">        Send rig door up and tell Arduino to stop accepting licks.</span>
</span><span id="TrialEnd.arduino_trial_end-906"><a href="#TrialEnd.arduino_trial_end-906"><span class="linenos">906</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TrialEnd.arduino_trial_end-907"><a href="#TrialEnd.arduino_trial_end-907"><span class="linenos">907</span></a>        <span class="n">up_command</span> <span class="o">=</span> <span class="s2">&quot;UP</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
</span><span id="TrialEnd.arduino_trial_end-908"><a href="#TrialEnd.arduino_trial_end-908"><span class="linenos">908</span></a>        <span class="n">arduino_controller</span><span class="o">.</span><span class="n">send_command</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">up_command</span><span class="p">)</span>
</span><span id="TrialEnd.arduino_trial_end-909"><a href="#TrialEnd.arduino_trial_end-909"><span class="linenos">909</span></a>
</span><span id="TrialEnd.arduino_trial_end-910"><a href="#TrialEnd.arduino_trial_end-910"><span class="linenos">910</span></a>        <span class="n">stop_command</span> <span class="o">=</span> <span class="s2">&quot;STOP OPEN VALVES</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
</span><span id="TrialEnd.arduino_trial_end-911"><a href="#TrialEnd.arduino_trial_end-911"><span class="linenos">911</span></a>        <span class="n">arduino_controller</span><span class="o">.</span><span class="n">send_command</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">stop_command</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Send rig door up and tell Arduino to stop accepting licks.</p>
</div>


                            </div>
                            <div id="TrialEnd.end_trial" class="classattr">
                                        <input id="TrialEnd.end_trial-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">end_trial</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">exp_data</span><span class="p">:</span> <span class="n">models</span><span class="o">.</span><span class="n">experiment_process_data</span><span class="o">.</span><span class="n">ExperimentProcessData</span></span><span class="return-annotation">) -> <span class="nb">bool</span>:</span></span>

                <label class="view-source-button" for="TrialEnd.end_trial-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TrialEnd.end_trial"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TrialEnd.end_trial-913"><a href="#TrialEnd.end_trial-913"><span class="linenos">913</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">end_trial</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exp_data</span><span class="p">:</span> <span class="n">ExperimentProcessData</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="TrialEnd.end_trial-914"><a href="#TrialEnd.end_trial-914"><span class="linenos">914</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="TrialEnd.end_trial-915"><a href="#TrialEnd.end_trial-915"><span class="linenos">915</span></a><span class="sd">        This method checks if current trial is the last trial. If it is, we return true to the calling code.</span>
</span><span id="TrialEnd.end_trial-916"><a href="#TrialEnd.end_trial-916"><span class="linenos">916</span></a><span class="sd">        If false, we increment current_trial_number, return false, and proceed to next trial.</span>
</span><span id="TrialEnd.end_trial-917"><a href="#TrialEnd.end_trial-917"><span class="linenos">917</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TrialEnd.end_trial-918"><a href="#TrialEnd.end_trial-918"><span class="linenos">918</span></a>        <span class="n">current_trial</span> <span class="o">=</span> <span class="n">exp_data</span><span class="o">.</span><span class="n">current_trial_number</span>
</span><span id="TrialEnd.end_trial-919"><a href="#TrialEnd.end_trial-919"><span class="linenos">919</span></a>        <span class="n">max_trials</span> <span class="o">=</span> <span class="n">exp_data</span><span class="o">.</span><span class="n">exp_var_entries</span><span class="p">[</span><span class="s2">&quot;Num Trials&quot;</span><span class="p">]</span>
</span><span id="TrialEnd.end_trial-920"><a href="#TrialEnd.end_trial-920"><span class="linenos">920</span></a>
</span><span id="TrialEnd.end_trial-921"><a href="#TrialEnd.end_trial-921"><span class="linenos">921</span></a>        <span class="k">if</span> <span class="n">current_trial</span> <span class="o">&gt;=</span> <span class="n">max_trials</span><span class="p">:</span>
</span><span id="TrialEnd.end_trial-922"><a href="#TrialEnd.end_trial-922"><span class="linenos">922</span></a>            <span class="k">return</span> <span class="kc">True</span>
</span><span id="TrialEnd.end_trial-923"><a href="#TrialEnd.end_trial-923"><span class="linenos">923</span></a>
</span><span id="TrialEnd.end_trial-924"><a href="#TrialEnd.end_trial-924"><span class="linenos">924</span></a>        <span class="n">exp_data</span><span class="o">.</span><span class="n">current_trial_number</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="TrialEnd.end_trial-925"><a href="#TrialEnd.end_trial-925"><span class="linenos">925</span></a>        <span class="k">return</span> <span class="kc">False</span>
</span></pre></div>


            <div class="docstring"><p>This method checks if current trial is the last trial. If it is, we return true to the calling code.
If false, we increment current_trial_number, return false, and proceed to next trial.</p>
</div>


                            </div>
                            <div id="TrialEnd.update_ttc_actual" class="classattr">
                                        <input id="TrialEnd.update_ttc_actual-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">update_ttc_actual</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">logical_trial</span><span class="p">:</span> <span class="nb">int</span>,</span><span class="param">	<span class="n">exp_data</span><span class="p">:</span> <span class="n">models</span><span class="o">.</span><span class="n">experiment_process_data</span><span class="o">.</span><span class="n">ExperimentProcessData</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="TrialEnd.update_ttc_actual-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TrialEnd.update_ttc_actual"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TrialEnd.update_ttc_actual-927"><a href="#TrialEnd.update_ttc_actual-927"><span class="linenos">927</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_ttc_actual</span><span class="p">(</span>
</span><span id="TrialEnd.update_ttc_actual-928"><a href="#TrialEnd.update_ttc_actual-928"><span class="linenos">928</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">logical_trial</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">exp_data</span><span class="p">:</span> <span class="n">ExperimentProcessData</span>
</span><span id="TrialEnd.update_ttc_actual-929"><a href="#TrialEnd.update_ttc_actual-929"><span class="linenos">929</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="TrialEnd.update_ttc_actual-930"><a href="#TrialEnd.update_ttc_actual-930"><span class="linenos">930</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="TrialEnd.update_ttc_actual-931"><a href="#TrialEnd.update_ttc_actual-931"><span class="linenos">931</span></a><span class="sd">        Update the actual ttc time take in the program schedule with the max time value,</span>
</span><span id="TrialEnd.update_ttc_actual-932"><a href="#TrialEnd.update_ttc_actual-932"><span class="linenos">932</span></a><span class="sd">        since we reached trial end we know we took the max time allowed</span>
</span><span id="TrialEnd.update_ttc_actual-933"><a href="#TrialEnd.update_ttc_actual-933"><span class="linenos">933</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TrialEnd.update_ttc_actual-934"><a href="#TrialEnd.update_ttc_actual-934"><span class="linenos">934</span></a>        <span class="n">program_df</span> <span class="o">=</span> <span class="n">exp_data</span><span class="o">.</span><span class="n">program_schedule_df</span>
</span><span id="TrialEnd.update_ttc_actual-935"><a href="#TrialEnd.update_ttc_actual-935"><span class="linenos">935</span></a>
</span><span id="TrialEnd.update_ttc_actual-936"><a href="#TrialEnd.update_ttc_actual-936"><span class="linenos">936</span></a>        <span class="n">ttc_column_value</span> <span class="o">=</span> <span class="n">program_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">logical_trial</span><span class="p">,</span> <span class="s2">&quot;TTC&quot;</span><span class="p">]</span>
</span><span id="TrialEnd.update_ttc_actual-937"><a href="#TrialEnd.update_ttc_actual-937"><span class="linenos">937</span></a>        <span class="n">program_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">logical_trial</span><span class="p">,</span> <span class="s2">&quot;TTC Actual&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ttc_column_value</span>
</span></pre></div>


            <div class="docstring"><p>Update the actual ttc time take in the program schedule with the max time value,
since we reached trial end we know we took the max time allowed</p>
</div>


                            </div>
                            <div id="TrialEnd.update_schedule_licks" class="classattr">
                                        <input id="TrialEnd.update_schedule_licks-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">update_schedule_licks</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">logical_trial</span><span class="p">:</span> <span class="nb">int</span>,</span><span class="param">	<span class="n">exp_data</span><span class="p">:</span> <span class="n">models</span><span class="o">.</span><span class="n">experiment_process_data</span><span class="o">.</span><span class="n">ExperimentProcessData</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="TrialEnd.update_schedule_licks-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TrialEnd.update_schedule_licks"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TrialEnd.update_schedule_licks-939"><a href="#TrialEnd.update_schedule_licks-939"><span class="linenos">939</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_schedule_licks</span><span class="p">(</span>
</span><span id="TrialEnd.update_schedule_licks-940"><a href="#TrialEnd.update_schedule_licks-940"><span class="linenos">940</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">logical_trial</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">exp_data</span><span class="p">:</span> <span class="n">ExperimentProcessData</span>
</span><span id="TrialEnd.update_schedule_licks-941"><a href="#TrialEnd.update_schedule_licks-941"><span class="linenos">941</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="TrialEnd.update_schedule_licks-942"><a href="#TrialEnd.update_schedule_licks-942"><span class="linenos">942</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Update the licks for each side in the program schedule df for this trial&quot;&quot;&quot;</span>
</span><span id="TrialEnd.update_schedule_licks-943"><a href="#TrialEnd.update_schedule_licks-943"><span class="linenos">943</span></a>        <span class="n">program_df</span> <span class="o">=</span> <span class="n">exp_data</span><span class="o">.</span><span class="n">program_schedule_df</span>
</span><span id="TrialEnd.update_schedule_licks-944"><a href="#TrialEnd.update_schedule_licks-944"><span class="linenos">944</span></a>        <span class="n">event_data</span> <span class="o">=</span> <span class="n">exp_data</span><span class="o">.</span><span class="n">event_data</span>
</span><span id="TrialEnd.update_schedule_licks-945"><a href="#TrialEnd.update_schedule_licks-945"><span class="linenos">945</span></a>
</span><span id="TrialEnd.update_schedule_licks-946"><a href="#TrialEnd.update_schedule_licks-946"><span class="linenos">946</span></a>        <span class="n">licks_sd_one</span> <span class="o">=</span> <span class="n">event_data</span><span class="o">.</span><span class="n">side_one_licks</span>
</span><span id="TrialEnd.update_schedule_licks-947"><a href="#TrialEnd.update_schedule_licks-947"><span class="linenos">947</span></a>        <span class="n">licks_sd_two</span> <span class="o">=</span> <span class="n">event_data</span><span class="o">.</span><span class="n">side_two_licks</span>
</span><span id="TrialEnd.update_schedule_licks-948"><a href="#TrialEnd.update_schedule_licks-948"><span class="linenos">948</span></a>
</span><span id="TrialEnd.update_schedule_licks-949"><a href="#TrialEnd.update_schedule_licks-949"><span class="linenos">949</span></a>        <span class="n">program_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">logical_trial</span><span class="p">,</span> <span class="s2">&quot;Port 1 Licks&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">licks_sd_one</span>
</span><span id="TrialEnd.update_schedule_licks-950"><a href="#TrialEnd.update_schedule_licks-950"><span class="linenos">950</span></a>
</span><span id="TrialEnd.update_schedule_licks-951"><a href="#TrialEnd.update_schedule_licks-951"><span class="linenos">951</span></a>        <span class="n">program_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">logical_trial</span><span class="p">,</span> <span class="s2">&quot;Port 2 Licks&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">licks_sd_two</span>
</span></pre></div>


            <div class="docstring"><p>Update the licks for each side in the program schedule df for this trial</p>
</div>


                            </div>
                            <div id="TrialEnd.update_raster_plots" class="classattr">
                                        <input id="TrialEnd.update_raster_plots-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">update_raster_plots</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">exp_data</span><span class="p">:</span> <span class="n">models</span><span class="o">.</span><span class="n">experiment_process_data</span><span class="o">.</span><span class="n">ExperimentProcessData</span>,</span><span class="param">	<span class="n">logical_trial</span><span class="p">:</span> <span class="nb">int</span>,</span><span class="param">	<span class="n">main_gui</span><span class="p">:</span> <span class="n">views</span><span class="o">.</span><span class="n">main_gui</span><span class="o">.</span><span class="n">MainGUI</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="TrialEnd.update_raster_plots-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TrialEnd.update_raster_plots"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TrialEnd.update_raster_plots-953"><a href="#TrialEnd.update_raster_plots-953"><span class="linenos">953</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_raster_plots</span><span class="p">(</span>
</span><span id="TrialEnd.update_raster_plots-954"><a href="#TrialEnd.update_raster_plots-954"><span class="linenos">954</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">exp_data</span><span class="p">:</span> <span class="n">ExperimentProcessData</span><span class="p">,</span> <span class="n">logical_trial</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">main_gui</span><span class="p">:</span> <span class="n">MainGUI</span>
</span><span id="TrialEnd.update_raster_plots-955"><a href="#TrialEnd.update_raster_plots-955"><span class="linenos">955</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="TrialEnd.update_raster_plots-956"><a href="#TrialEnd.update_raster_plots-956"><span class="linenos">956</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Instruct raster windows to update with new lick timestamps&quot;&quot;&quot;</span>
</span><span id="TrialEnd.update_raster_plots-957"><a href="#TrialEnd.update_raster_plots-957"><span class="linenos">957</span></a>        <span class="c1"># gather lick timestamp data from the event data model</span>
</span><span id="TrialEnd.update_raster_plots-958"><a href="#TrialEnd.update_raster_plots-958"><span class="linenos">958</span></a>        <span class="n">lick_stamps</span> <span class="o">=</span> <span class="n">exp_data</span><span class="o">.</span><span class="n">event_data</span><span class="o">.</span><span class="n">get_lick_timestamps</span><span class="p">(</span><span class="n">logical_trial</span><span class="p">)</span>
</span><span id="TrialEnd.update_raster_plots-959"><a href="#TrialEnd.update_raster_plots-959"><span class="linenos">959</span></a>
</span><span id="TrialEnd.update_raster_plots-960"><a href="#TrialEnd.update_raster_plots-960"><span class="linenos">960</span></a>        <span class="c1"># send it to raster windows</span>
</span><span id="TrialEnd.update_raster_plots-961"><a href="#TrialEnd.update_raster_plots-961"><span class="linenos">961</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">window</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">main_gui</span><span class="o">.</span><span class="n">windows</span><span class="p">[</span><span class="s2">&quot;Raster Plot&quot;</span><span class="p">]):</span>
</span><span id="TrialEnd.update_raster_plots-962"><a href="#TrialEnd.update_raster_plots-962"><span class="linenos">962</span></a>            <span class="n">window</span><span class="o">.</span><span class="n">update_plot</span><span class="p">(</span><span class="n">lick_stamps</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">logical_trial</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Instruct raster windows to update with new lick timestamps</p>
</div>


                            </div>
                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>